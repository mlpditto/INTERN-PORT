<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLP INTERNSHIP V.260128 (V42)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        /* --- Base Variables --- */
        :root {
            --bg-body: #f4f6f9; --bg-card: #ffffff; --text-main: #333; --text-sub: #666;
            --col-bg: #f8f9fa; --border-color: #e0e0e0;
            --primary: #4361ee; --success: #2ec4b6; --warning: #ff9f1c; --danger: #ef233c; --dark: #2b2d42;
        }
        body.dark-mode {
            --bg-body: #1a1a1a; --bg-card: #2d2d2d; --text-main: #e0e0e0; --text-sub: #ccc;
            --col-bg: #333; --border-color: #444;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; transition: 0.3s; }
        
        /* Layout */
        #dashboard-container { display: none; max-width: 1400px; margin: 0 auto; padding: 20px; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        
        /* Navigation */
        .tab-wrapper { border-bottom: 2px solid var(--border-color); margin-bottom: 20px; }
        .tab-nav { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { padding: 10px 20px; border: none; background: none; cursor: pointer; font-weight: 600; color: var(--text-sub); border-radius: 8px 8px 0 0; white-space: nowrap; transition: 0.2s; }
        .tab-btn.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: var(--bg-card); }
        .tab-content { display: none; animation: fadeIn 0.3s; } .tab-content.active { display: block; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; background: var(--bg-card); border-radius: 8px; overflow: hidden; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        th { background: var(--col-bg); color: var(--text-sub); font-weight: 600; text-transform: uppercase; font-size: 0.85em; }
        
        .user-pic { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); vertical-align: middle; margin-right: 10px; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75em; font-weight: bold; color: white; display: inline-block; }
        
        /* Buttons */
        .btn-sm { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; color: white; font-size: 0.85em; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: var(--primary); } .btn-danger { background: var(--danger); } 
        .btn-success { background: var(--success); } .btn-warning { background: var(--warning); color: black; } .btn-dark { background: var(--dark); }
        .magic-btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-delete-icon { width: 30px; height: 30px; border-radius: 50%; border: none; background: #ffebeb; color: #ef233c; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-delete-icon:hover { background: #ef233c; color: white; }

        /* Kanban */
        .kanban-board { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 20px; min-height: 600px; }
        .kanban-col { flex: 1; min-width: 300px; background: var(--col-bg); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; border: 1px solid var(--border-color); }
        .kanban-card { background: var(--bg-card); padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 10px; border-left: 5px solid #ccc; cursor: grab; position: relative; }
        .kanban-card.scored { background-color: #d1e7dd; border-left: 5px solid var(--success); border: 1px solid #badbcc; }
        .answer-box { margin-top: 10px; padding: 10px; background: rgba(67, 97, 238, 0.1); border-radius: 6px; font-size: 0.9em; border-left: 3px solid var(--primary); }
        
        /* üî• Fixed Profile Image Size in Kanban */
        .assignee-stack { display: flex; margin-top: 10px; padding-left: 10px; }
        .assignee-img { width: 28px !important; height: 28px !important; border-radius: 50%; object-fit: cover; border: 2px solid var(--bg-card); margin-left: -10px; transition: 0.2s; }
        .assignee-img:hover { z-index: 10; transform: scale(1.2); }

        /* Timers */
        .timer-text { font-size: 0.85em; color: var(--danger); font-weight: 600; display: flex; align-items: center; gap: 5px; }
        .quest-timer { font-family: monospace; font-weight: bold; color: #ef233c; }

        /* Leaderboard PC */
        .lb-container { background: var(--bg-card); border-radius: 10px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .lb-row { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid var(--border-color); transition: 0.2s; }
        .lb-row:hover { background: var(--col-bg); }
        .lb-rank { width: 60px; text-align: center; font-weight: 900; font-size: 1.2em; color: var(--text-sub); }
        .lb-profile { flex: 2; display: flex; align-items: center; gap: 15px; font-weight: 600; }
        .lb-pic-lg { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 3px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .lb-lv { width: 100px; text-align: center; }
        .lb-score { width: 120px; text-align: right; font-weight: 800; font-size: 1.2em; color: var(--primary); padding-right: 20px; }
        .lb-badge { width: 150px; text-align: center; }
        .rank-1 .lb-rank { color: #ffd700; font-size: 1.5em; } .rank-2 .lb-rank { color: #c0c0c0; font-size: 1.4em; } .rank-3 .lb-rank { color: #cd7f32; font-size: 1.3em; }

        /* Modal & Utils */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-content { background-color: var(--bg-card); margin: 5% auto; padding: 25px; border-radius: 12px; width: 95%; max-width: 700px; max-height: 90vh; overflow-y: auto; position: relative; color: var(--text-main); }
        .close-modal { float: right; font-size: 24px; cursor: pointer; }
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; }
        .login-card { padding: 40px; background: var(--bg-card); border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 350px; text-align: center; }
        input, select { padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-card); color: var(--text-main); }
        .pagination { display: flex; justify-content: flex-end; gap: 5px; margin-bottom: 20px; }
        .page-btn { padding: 5px 10px; border: 1px solid var(--border-color); background: var(--bg-card); cursor: pointer; border-radius: 4px; color: var(--text-main); }
        .page-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 2000; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 16px; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} } @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h2>üîê Admin Portal</h2>
            <input type="email" id="email-input" value="medlifeplus@gmail.com" placeholder="Email" style="width:100%; margin-bottom:15px;">
            <button class="magic-btn" onclick="sendMagicLink()" style="width:100%;">‚ú® Login</button>
            <p id="status-msg" style="color:red; margin-top:10px;"></p>
        </div>
    </div>

    <div id="dashboard-container">
        <div class="flex-between" style="margin-bottom:20px;">
            <div><h2 style="margin:0;"><i class="fa-solid fa-user-shield"></i> Dashboard</h2><span id="admin-email" style="font-size:0.8em; color:var(--text-sub);"></span></div>
            <div style="display:flex; gap:10px;">
                <button class="btn-sm" style="font-size:1.2em;" onclick="toggleTheme()"><i class="fa-solid fa-moon"></i></button>
                <button class="magic-btn" onclick="shareLeaderboard()"><i class="fa-solid fa-share-nodes"></i> Share</button>
                <button class="magic-btn" style="background:var(--danger);" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </div>

        <div class="tab-wrapper">
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('tab-works')">üìÑ ‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô</button>
                <button class="tab-btn" onclick="switchTab('tab-sidequest')">üó∫Ô∏è Kanban</button>
                <button class="tab-btn" onclick="switchTab('tab-manage-quest')">‚öôÔ∏è Daily Quest</button>
                <button class="tab-btn" onclick="switchTab('tab-users')">üë• Users</button>
                <button class="tab-btn" onclick="switchTab('tab-leaderboard')">üèÜ Leaderboard</button>
            </div>
        </div>

        <div id="tab-works" class="tab-content active">
             <div class="header-row"><h3>üìÅ ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h3><label class="filter-pill"><input type="checkbox" id="hideCompleted" onchange="toggleFilter()" checked> ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß</label></div>
             <div style="overflow-x:auto;"><table id="worksTable"><thead><tr><th>Time</th><th>User</th><th>Title</th><th>Link</th><th>Status</th><th>Score</th><th>Action</th></tr></thead><tbody></tbody></table></div>
             <div id="works-pagination" class="pagination"></div>

             <div class="header-row"><h3>‚ö° Daily Answers</h3></div>
             <div style="overflow-x:auto;"><table id="questTable"><thead><tr><th>Time</th><th>User</th><th>Answer</th><th>Status</th><th>Total</th><th>Action</th></tr></thead><tbody></tbody></table></div>
             <div id="quest-pagination" class="pagination"></div>
        </div>

        <div id="tab-sidequest" class="tab-content">
            <div style="background:var(--col-bg); padding:20px; border-radius:12px; margin-bottom:20px; border:1px solid var(--border-color);">
                <div class="flex-between" style="cursor:pointer;" onclick="toggleForm()">
                    <h3 style="margin:0; color:var(--primary);">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</h3>
                    <div><button class="btn-sm btn-dark" onclick="openArchiveModal()">üóÑÔ∏è ar¬∑chive</button> <span>üîΩ</span></div>
                </div>
                <div id="sq-form" style="display:none; margin-top:15px;">
                    <input type="hidden" id="edit-id">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                        <input type="text" id="sq-title" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô...">
                        <input type="text" id="sq-desc" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...">
                    </div>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <select id="sq-priority"><option value="Low">üü¢ Low</option><option value="Medium" selected>üü° Medium</option><option value="High">üî¥ High</option></select>
                        <input type="date" id="sq-due">
                    </div>
                    <p style="margin:5px 0;">Assign to:</p><div id="sq-user-list" style="display:flex; flex-wrap:wrap; gap:5px; max-height:100px; overflow-y:auto; border:1px solid #ccc; padding:5px;"></div>
                    <div style="margin-top:10px;"><button class="magic-btn" onclick="saveSideQuest()">üöÄ Save</button></div>
                </div>
            </div>
            <input type="text" class="search-bar" id="board-search" placeholder="üîç Filter..." onkeyup="filterBoard()">
            <div class="kanban-board">
                <div class="kanban-col" id="col-Backlog"><div class="kanban-header">üìå Backlog <span class="badge" style="background:#6c757d" id="cnt-Backlog">0</span></div><div id="Backlog" class="kanban-list"></div></div>
                <div class="kanban-col" id="col-Doing"><div class="kanban-header">üöß Doing <span class="badge" style="background:#4361ee" id="cnt-Doing">0</span></div><div id="Doing" class="kanban-list"></div></div>
                <div class="kanban-col" id="col-Review"><div class="kanban-header">üëÄ Review <span class="badge" style="background:#ff9f1c" id="cnt-Review">0</span></div><div id="Review" class="kanban-list"></div></div>
                <div class="kanban-col" id="col-Done"><div class="kanban-header">‚úÖ Done <span class="badge" style="background:#2ec4b6" id="cnt-Done">0</span></div><div id="Done" class="kanban-list"></div></div>
            </div>
        </div>

        <div id="tab-manage-quest" class="tab-content">
             <div style="background:var(--col-bg); padding:20px; border-radius:12px; margin-bottom:20px;">
                <h3>üì¢ Daily Quest</h3>
                <input type="text" id="q-text" placeholder="‡πÇ‡∏à‡∏ó‡∏¢‡πå..." style="width:100%; margin-bottom:5px;">
                <div style="display:flex; gap:10px; margin-bottom:10px;"><input type="text" id="q-img" placeholder="Img URL"><input type="text" id="q-link" placeholder="Link"></div>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="q-hours" value="24" placeholder="‡∏ä‡∏°." style="width:80px;">
                    <input type="number" id="q-score" value="10" step="0.1" placeholder="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô" style="width:80px;">
                    <button class="magic-btn" onclick="createQuest()">Post</button>
                </div>
            </div>
            
            <div id="active-quest-section" style="display:none; background:#d1e7dd; padding:15px; border-radius:8px; margin-bottom:20px; color:#0f5132;">
                <h3>üü¢ Active Quest (Live Timer)</h3>
                <table id="activeQuestTable"><thead><tr><th>Quest</th><th>Time Remaining</th><th>Edit</th><th>Stop</th></tr></thead><tbody></tbody></table>
            </div>
            
            <h3>‚ôªÔ∏è Quest History</h3>
            <table id="questHistoryTable"><thead><tr><th>Quest</th><th>Score</th><th>Action</th></tr></thead><tbody></tbody></table>
        </div>

        <div id="tab-users" class="tab-content">
            <div class="flex-between" style="margin-bottom:10px;">
                <input type="text" class="search-bar" id="userSearch" placeholder="üîç Search..." onkeyup="filterUsers()" style="margin-bottom:0; width:300px;">
                <div id="bulk-actions" style="display:none;">
                    <button class="btn-sm btn-warning" onclick="bulkAdjust()">üí∞ ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                    <button class="btn-sm btn-danger" onclick="bulkDelete()">üóëÔ∏è ‡∏•‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°</button>
                </div>
            </div>
            <table id="usersTable"><thead><tr><th><input type="checkbox" onchange="toggleSelectAll(this)"></th><th>User</th><th>Status</th><th>Dates</th><th>Score</th><th>Adjust</th><th>History</th><th>Del</th></tr></thead><tbody></tbody></table>
            <div id="users-pagination" class="pagination"></div>
        </div>

        <div id="tab-leaderboard" class="tab-content">
            <div id="leaderboardList" class="lb-container" style="max-width:900px; margin:0 auto;"></div>
        </div>
    </div>

    <div id="historyModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal()">&times;</span><div style="display:flex;justify-content:space-between;"><h2 id="history-title" style="margin:0;"></h2><button class="btn-sm btn-primary" onclick="copyHistory()">üìã Copy</button></div><div id="history-summary" style="margin:10px 0;font-weight:bold;color:var(--primary);"></div><ul id="history-list" style="list-style:none; padding:0;"></ul></div></div>
    <div id="archiveModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="document.getElementById('archiveModal').style.display='none'">&times;</span><h2 style="margin-top:0;">üóÑÔ∏è ar¬∑chive</h2><div id="archive-list"></div></div></div>
    <div id="certModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="document.getElementById('certModal').style.display='none'">&times;</span><h2>üéì Certificate</h2><input type="hidden" id="cert-uid"><input type="hidden" id="cert-uname"><div style="display:flex; gap:10px; margin-bottom:10px;"><div style="flex:1"><label>Start:</label><input type="date" id="cert-start" onchange="updateCertPreview()"></div><div style="flex:1"><label>End:</label><input type="date" id="cert-end" onchange="updateCertPreview()"></div></div><div id="cert-preview-container" style="text-align:center;border:1px solid #ddd;padding:10px;margin-bottom:10px;"><canvas id="cert-canvas" style="width:100%;max-width:500px;"></canvas></div><div style="display:flex; gap:10px; justify-content:flex-end;"><button class="btn-sm btn-primary" onclick="saveUserDates()">üíæ Save</button><button class="btn-sm btn-warning" id="btn-gen-pdf" onclick="generateCertPDF()">üñ®Ô∏è PDF</button></div></div></div>

    <div id="toast">Saved!</div>

    <script src="firebase-config.js"></script>
    <script>
        const ALLOWED_EMAIL = "medlifeplus@gmail.com";
        const ADMIN_LIFF_ID = "2008959998-yjcNpaGt"; 
        const MY_URL = 'https://mlpditto.github.io/INTERN-PORT/admin.html';
        const auth = firebase.auth();
        
        let usersData=[], worksData=[], questsData=[], sideQuestsCache={}, submissionMap={}, topUsersCache=[];
        const ROWS_PER_PAGE = 10; let currentPage = { works: 1, quests: 1, users: 1 };

        // --- Init ---
        function toggleTheme() { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light'); }
        if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
        
        auth.onAuthStateChanged(user => { 
            if(user && user.email===ALLOWED_EMAIL) { 
                document.getElementById('login-screen').style.display='none'; 
                document.getElementById('dashboard-container').style.display='block'; 
                document.getElementById('admin-email').innerText=user.email; 
                initSystem(); 
            } 
        });
        function sendMagicLink() { const e=document.getElementById('email-input').value; if(e!==ALLOWED_EMAIL)return alert("No Permission"); auth.sendSignInLinkToEmail(e,{url:MY_URL,handleCodeInApp:true}).then(()=>alert("Check Email")); }
        if(auth.isSignInWithEmailLink(window.location.href)) { let e=localStorage.getItem('emailForSignIn')||prompt('Email'); auth.signInWithEmailLink(e, window.location.href).then(()=>location.replace(MY_URL)); }
        function logout() { auth.signOut().then(() => location.reload()); }

        let isInit=false;
        async function initSystem() {
            if(isInit) return; isInit=true;
            try { await liff.init({ liffId: ADMIN_LIFF_ID }); } catch(e) {}
            document.addEventListener('keydown', (e) => { if(e.key==="Escape") document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); });
            
            loadData(); initKanban(); 
            
            // üî• Universal Timer (Active Quests & Kanban)
            setInterval(() => {
                updateDoneTimers();
                updateQuestTimers();
            }, 1000);
        }
        function switchTab(id) { document.querySelectorAll('.tab-content,.tab-btn').forEach(e=>e.classList.remove('active')); document.getElementById(id).classList.add('active'); event.target.classList.add('active'); }

        function loadData() {
            db.collection("works").orderBy("timestamp","desc").limit(200).onSnapshot(s => { worksData=s.docs.map(d=>({id:d.id,...d.data()})); renderTable('works'); });
            db.collection("quest_submissions").orderBy("timestamp","desc").limit(200).onSnapshot(s => { questsData=s.docs.map(d=>{const dt=d.data();submissionMap[`${dt.questId}_${dt.userId}`]=dt.answer;return{id:d.id,...dt}}); renderTable('quests'); });
            db.collection("users").orderBy("score","desc").onSnapshot(s => { usersData=s.docs.map(d=>({id:d.id,...d.data()})); renderTable('users'); renderLeaderboard(); updateAssigneeList(); });
            db.collection("side_quests").orderBy("createdAt","desc").onSnapshot(renderKanban);
            loadActiveQuests(); loadQuestHistory();
        }

        // --- Render & Pagination ---
        function renderTable(type) {
            const tbody = document.querySelector(`#${type}Table tbody`);
            const pagination = document.getElementById(`${type}-pagination`);
            let data = (type==='works')?worksData:(type==='quests')?questsData:usersData;
            
            if(type!=='users') { if(document.getElementById('hideCompleted').checked) data = data.filter(d => (type==='works'?d.status!=='‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß':d.status!=='checked')); }
            else { const t=document.getElementById('userSearch').value.toLowerCase(); if(t) data = data.filter(u=>u.displayName.toLowerCase().includes(t)); }

            const page = currentPage[type];
            const start = (page-1)*ROWS_PER_PAGE;
            const paged = data.slice(start, start+ROWS_PER_PAGE);
            const total = Math.ceil(data.length/ROWS_PER_PAGE);

            tbody.innerHTML="";
            paged.forEach(d => {
                if(type==='works') {
                    const st = d.status==='‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß'?'#2ec4b6':d.status==='‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'?'#ef233c':'#ff9f1c';
                    tbody.innerHTML += `<tr><td>${d.timestamp?.toDate().toLocaleString('th-TH')||'-'}</td><td><img src="${d.pictureUrl}" class="user-pic">${d.displayName}</td><td>${d.title}</td><td><a href="${d.link}" target="_blank" class="btn-sm btn-dark"><i class="fa-solid fa-link"></i></a></td><td><span class="badge" style="background:${st}">${d.status}</span></td><td><div style="display:flex;"><input type="number" id="sc-${d.id}" value="${d.score||0}" style="width:60px;"><button class="btn-sm btn-primary" onclick="svSc('${d.id}','${d.userId}')"><i class="fa-solid fa-save"></i></button></div></td><td><button class="btn-delete-icon" onclick="delWork('${d.id}')">‚úï</button></td></tr>`;
                } else if(type==='quests') {
                    const tot = (d.earnedScore||0)+(d.bonusGiven||0);
                    tbody.innerHTML += `<tr><td>${d.timestamp?.toDate().toLocaleString('th-TH')||'-'}</td><td><img src="${d.pictureUrl}" class="user-pic">${d.displayName}</td><td>${d.answer}</td><td><span class="badge" style="background:${d.isLate?'#ef233c':'#2ec4b6'}">${d.isLate?'Late':'OnTime'}</span></td><td><div style="display:flex;"><input type="number" id="qsc-${d.id}" value="${tot}" style="width:60px;"><button class="btn-sm btn-warning" onclick="upQSc('${d.id}','${d.userId}',${tot},${d.earnedScore||0})">Edit</button></div></td><td><button class="btn-sm btn-success" onclick="checkQuest('${d.id}')"><i class="fa-solid fa-check"></i></button> <button class="btn-delete-icon" onclick="delQSub('${d.id}','${d.userId}',${tot})">‚úï</button></td></tr>`;
                } else if(type==='users') {
                    const ignored = d.isIgnored;
                    tbody.innerHTML += `<tr class="${ignored?'u-ignored':''}">
                        <td><input type="checkbox" class="user-chk" value="${d.id}" onchange="checkBulkBtn()"></td>
                        <td><img src="${d.pictureUrl}" class="user-pic"> ${d.displayName}</td>
                        <td><button class="btn-sm" style="background:none;color:#333;" onclick="toggleIgnoreUser('${d.id}',${ignored})">${ignored?'üö´':'üëÅÔ∏è'}</button></td>
                        <td><button class="btn-sm btn-warning" onclick="editCert('${d.id}','${d.displayName}','${d.startDate||''}','${d.endDate||''}')"><i class="fa-regular fa-calendar"></i></button></td>
                        <td style="font-weight:bold;color:var(--primary);">${parseFloat((d.score||0).toFixed(2))}</td>
                        <td><div style="display:flex;"><input type="number" id="adj-${d.id}" placeholder="0.0" style="width:60px"><button class="btn-sm btn-success" onclick="adjDec('${d.id}')"><i class="fa-solid fa-save"></i></button></div></td>
                        <td><button class="btn-sm btn-dark" onclick="showHistory('${d.id}','${d.displayName}',${d.score||0})"><i class="fa-solid fa-clock-rotate-left"></i></button></td>
                        <td><button class="btn-delete-icon" onclick="delUser('${d.id}')">‚úï</button></td>
                    </tr>`;
                }
            });
            pagination.innerHTML = "";
            for(let i=1; i<=total; i++) pagination.innerHTML += `<button class="page-btn ${i===page?'active':''}" onclick="changePage('${type}',${i})">${i}</button>`;
        }
        function changePage(t,p){currentPage[t]=p;renderTable(t);}

        // --- Kanban ---
        function initKanban() {
            ['Backlog','Doing','Review','Done'].forEach(id => {
                new Sortable(document.getElementById(id), { group:'kanban', animation:150, onEnd: e => {
                    const ns=e.to.id; const up={status:ns}; if(ns==='Done')up.doneAt=firebase.firestore.FieldValue.serverTimestamp();
                    db.collection("side_quests").doc(e.item.dataset.id).update(up);
                }});
            });
        }
        function renderKanban(snap) {
            const cols={"Backlog":document.getElementById("Backlog"),"Doing":document.getElementById("Doing"),"Review":document.getElementById("Review"),"Done":document.getElementById("Done")};
            Object.values(cols).forEach(e=>e.innerHTML="");
            const cnt={"Backlog":0,"Doing":0,"Review":0,"Done":0};
            const filter=document.getElementById('board-search').value.toLowerCase();

            snap.forEach(doc => {
                const q=doc.data(); sideQuestsCache[doc.id]=q;
                if(q.status==='Archived')return;
                let match = q.title.toLowerCase().includes(filter);
                if(q.assignees) q.assignees.forEach(u=>{if(u.name.toLowerCase().includes(filter)) match=true;});
                if(!match) return;

                if(cols[q.status]) {
                    cnt[q.status]++;
                    const d=document.createElement('div'); d.className=`kanban-card card-${q.status} ${q.isScored?'scored':''}`; d.dataset.id=doc.id;
                    d.onclick=(e)=>{if(!e.target.closest('button'))d.classList.toggle('expanded')};
                    let imgs='<div class="assignee-stack">'; if(q.assignees)q.assignees.forEach(u=>imgs+=`<img src="${u.pic}" class="assignee-img" title="${u.name}">`); imgs+='</div>';
                    
                    let act="";
                    if(q.status==='Done'&&q.doneAt) act=`<div class="timer-text" data-done="${q.doneAt.toMillis()}">‚è≥ Loading...</div><button class="btn-sm btn-dark" style="width:100%" onclick="archiveSQ('${doc.id}')">üì• ar¬∑chive</button>`;
                    else if(!q.isScored) act=`<button class="btn-sm btn-success" style="width:100%" onclick="giveScore('${doc.id}')">üí∞ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>`;

                    let ans=""; if(!q.userAnswer && q.refQuestId && q.assigneeIds?.[0]) q.userAnswer=submissionMap[`${q.refQuestId}_${q.assigneeIds[0]}`];
                    if(q.userAnswer) ans=`<div class="answer-box">üí¨ ${q.userAnswer.startsWith('http')?'Link':q.userAnswer}</div>`;

                    d.innerHTML=`<div class="card-badges"><span class="badge" style="background:${q.priority==='High'?'#ef233c':q.priority==='Medium'?'#ff9f1c':'#2ec4b6'}">${q.priority}</span></div><b>${q.title}</b><button class="expand-btn"><i class="fa-solid fa-chevron-down"></i></button>
                    <div class="card-desc"><p>${q.description||'-'}</p><div style="display:flex;justify-content:space-between;margin-top:5px;"><button class="btn-sm btn-warning" onclick="editSQ('${doc.id}')"><i class="fa-solid fa-pen"></i></button><button class="btn-delete-icon" onclick="delSQ('${doc.id}')">‚úï</button></div>${q.proofLink?`<a href="${q.proofLink}" target="_blank" class="btn-sm btn-dark" style="display:block;text-align:center;margin-top:5px;">üìé ‡∏î‡∏π‡∏á‡∏≤‡∏ô</a>`:''}</div>${ans} ${imgs} <div style="margin-top:5px;">${act}</div>`;
                    cols[q.status].appendChild(d);
                }
            });
            Object.keys(cnt).forEach(k=>document.getElementById(`cnt-${k}`).innerText=cnt[k]);
            updateDoneTimers();
        }

        // --- Leaderboard ---
        function renderLeaderboard() {
            const l = document.getElementById("leaderboardList"); l.innerHTML="";
            const list = usersData.filter(u=>!u.isIgnored).slice(0,20);
            topUsersCache = list;
            list.forEach((u,i) => {
                const lv = Math.floor((u.score||0)/10)+1;
                let rankCls = i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'';
                l.innerHTML += `
                <div class="lb-row ${rankCls}">
                    <div class="lb-rank">#${i+1}</div>
                    <div class="lb-profile"><img src="${u.pictureUrl}" class="lb-pic-lg"> ${u.displayName}</div>
                    <div class="lb-lv"><span class="badge" style="background:#eee;color:#333;">Lv.${lv}</span></div>
                    <div class="lb-score">${parseFloat((u.score||0).toFixed(2))}</div>
                    <div class="lb-badge"><i class="fa-solid fa-medal"></i></div>
                </div>`;
            });
        }

        // --- Active Quest & History (Recall & Delete) ---
        async function createQuest(){const q={question:document.getElementById('q-text').value,imageUrl:document.getElementById('q-img').value,questLink:document.getElementById('q-link').value,baseScore:parseFloat(document.getElementById('q-score').value),deadline:new Date(Date.now()+parseFloat(document.getElementById('q-hours').value)*3600000),createdAt:firebase.firestore.FieldValue.serverTimestamp()};if(q.question)await db.collection("quests").add(q);showToast("Posted");}
        
        function loadActiveQuests(){
            db.collection("quests").orderBy("createdAt","desc").limit(10).onSnapshot(s=>{
                const t=document.querySelector("#activeQuestTable tbody"); t.innerHTML="";
                let hasActive = false;
                s.forEach(d=>{ 
                    const q=d.data(); 
                    if(q.deadline?.toDate()>new Date()) {
                        hasActive = true;
                        t.innerHTML+=`<tr><td>${q.question}</td><td><span class="quest-timer" data-deadline="${q.deadline.toDate().getTime()}">Loading...</span></td><td><button class="btn-sm btn-warning" onclick="editQ('${d.id}','${q.question.replace(/'/g,"")}')">‚úèÔ∏è</button></td><td><button class="btn-delete-icon" onclick="stopQ('${d.id}')">‚úï</button></td></tr>`;
                    }
                });
                document.getElementById("active-quest-section").style.display = hasActive ? "block" : "none";
            });
        }
        
        function loadQuestHistory() {
            db.collection("quests").orderBy("createdAt","desc").limit(20).onSnapshot(s=>{
                const t=document.querySelector("#questHistoryTable tbody"); t.innerHTML="";
                s.forEach(d=>{ 
                    const q=d.data(); 
                    t.innerHTML+=`<tr><td>${q.question}</td><td>${q.baseScore}</td><td>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-sm btn-success" onclick="recallQuest('${d.id}')">‚ôªÔ∏è Recall</button>
                            <button class="btn-delete-icon" onclick="delQ('${d.id}')">‚úï</button>
                        </div>
                    </td></tr>`; 
                })
            });
        }

        function recallQuest(id) { 
            db.collection("quests").doc(id).get().then(doc => {
                const d = doc.data();
                document.getElementById('q-text').value = d.question;
                document.getElementById('q-img').value = d.imageUrl || "";
                document.getElementById('q-link').value = d.questLink || "";
                document.getElementById('q-score').value = d.baseScore;
                document.getElementById('q-hours').value = 24;
                showToast("Quest Recalled!");
            });
        }

        function updateQuestTimers() {
            document.querySelectorAll('.quest-timer').forEach(el => {
                const d = parseInt(el.dataset.deadline); const now = Date.now(); const diff = d - now;
                if(diff <= 0) el.innerText = "Expired";
                else {
                    const h = Math.floor(diff / 3600000); const m = Math.floor((diff % 3600000) / 60000); const s = Math.floor((diff % 60000) / 1000);
                    el.innerText = `${h}h ${m}m ${s}s`;
                }
            });
        }

        // --- Other Logic (Same as V41) ---
        async function shareLeaderboard() {
            if(!topUsersCache.length) return alert("No Data");
            const isAnon = confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\nOK = ‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏á‡∏ä‡∏∑‡πà‡∏≠\nCancel = ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠");
            let t = "üèÜ Leaderboard Update!\n\n";
            topUsersCache.forEach((u,i) => {
                const name = isAnon ? `(Hidden) Lv.${Math.floor(u.score/10)+1}` : `${u.displayName}`;
                t += `${i+1}. ${name} -> ${parseFloat(u.score.toFixed(2))} pts\n`;
            });
            if(liff.isInClient()) liff.shareTargetPicker([{type:"text",text:t}]);
            else { await navigator.clipboard.writeText(t); alert("Copied to clipboard!"); }
        }

        async function giveScore(id) {
            const q=sideQuestsCache[id]; if(!q)return; const s=prompt("Score:", "0.5"); if(!s)return; const n=prompt("Note:", q.title);
            const batch=db.batch();
            q.assigneeIds.forEach(uid=>{
                batch.update(db.collection("users").doc(uid),{score:firebase.firestore.FieldValue.increment(parseFloat(s))});
                batch.set(db.collection("checkin_logs").doc(),{userId:uid,type:'manual_adjust',amount:parseFloat(s),note:n,timestamp:firebase.firestore.FieldValue.serverTimestamp()});
            });
            batch.update(db.collection("side_quests").doc(id),{status:'Done',isScored:true,archiveScore:parseFloat(s),doneAt:firebase.firestore.FieldValue.serverTimestamp()});
            await batch.commit(); showToast("Scored!");
        }
        function updateDoneTimers() { document.querySelectorAll('.timer-text').forEach(e=>{const d=parseInt(e.dataset.done); const left=(d+8*3600000)-Date.now(); e.innerText=left<=0?"Expired":`‚è≥ ${Math.ceil(left/3600000)}h left`; if(left<=0)db.collection("side_quests").doc(e.closest('.kanban-card').dataset.id).update({status:'Archived'}); }); }
        
        async function openArchiveModal(){const l=document.getElementById("archive-list");l.innerHTML="Loading...";document.getElementById("archiveModal").style.display="block";const s=await db.collection("side_quests").where("status","==","Archived").get();let i=s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(b.createdAt?.toMillis()||0)-(a.createdAt?.toMillis()||0));l.innerHTML="";i.forEach(q=>{l.innerHTML+=`<div style="padding:10px;border-bottom:1px solid #ddd;"><b>${q.title}</b> (+${q.archiveScore||0})<br><button class="btn-sm btn-success" onclick="restoreSQ('${q.id}','Done')">Restore</button></div>`});}
        async function restoreSQ(id,t){await db.collection("side_quests").doc(id).update({status:t,doneAt:firebase.firestore.FieldValue.serverTimestamp()});openArchiveModal();showToast("Restored");}
        function toggleSelectAll(s){document.querySelectorAll('.user-chk').forEach(c=>c.checked=s.checked);checkBulkBtn();}
        function checkBulkBtn(){document.getElementById('bulk-actions').style.display=document.querySelectorAll('.user-chk:checked').length>0?'flex':'none';}
        async function bulkAdjust(){const s=prompt("Score:");const n=prompt("Note:");const ids=[...document.querySelectorAll('.user-chk:checked')].map(c=>c.value);const b=db.batch();ids.forEach(u=>{b.update(db.collection("users").doc(u),{score:firebase.firestore.FieldValue.increment(parseFloat(s))});});await b.commit();showToast("Adjusted!");}
        
        let certUser=null;
        function editCert(uid,name,s,e){certUser={uid,name};document.getElementById('cert-start').value=s;document.getElementById('cert-end').value=e;updateCertPreview();document.getElementById('certModal').style.display="block";}
        async function saveUserDates(){await db.collection("users").doc(certUser.uid).update({startDate:document.getElementById('cert-start').value,endDate:document.getElementById('cert-end').value});showToast("Saved");}
        async function updateCertPreview(){
            const c=document.getElementById('cert-canvas'), ctx=c.getContext('2d'); c.width=800; c.height=600;
            ctx.fillStyle="#fff"; ctx.fillRect(0,0,800,600); ctx.strokeStyle="#4361ee"; ctx.lineWidth=10; ctx.strokeRect(0,0,800,600);
            ctx.fillStyle="#333"; ctx.textAlign="center"; ctx.font="bold 40px Arial"; ctx.fillText("CERTIFICATE",400,150);
            ctx.font="30px Arial"; ctx.fillStyle="#4361ee"; ctx.fillText(certUser.name,400,300);
            ctx.fillStyle="#333"; ctx.font="20px Arial"; 
            const s=document.getElementById('cert-start').value, e=document.getElementById('cert-end').value;
            ctx.fillText(s&&e ? `${s} - ${e}` : "Date not set",400,400);
        }
        function generateCertPDF(){ const {jsPDF}=window.jspdf; const doc=new jsPDF('l'); doc.addImage(document.getElementById('cert-canvas').toDataURL('image/jpeg'),'JPEG',10,10,280,190); doc.save("cert.pdf"); }

        function toggleIgnoreUser(id,s){db.collection("users").doc(id).update({isIgnored:!s});}
        function showToast(m){const x=document.getElementById("toast");x.innerText=m;x.className="show";setTimeout(()=>x.className="",3000);}
        function closeModal(){document.querySelectorAll('.modal').forEach(m=>m.style.display='none');}
        
        async function stopQ(id){await db.collection("quests").doc(id).update({deadline:new Date()});}
        async function svSc(id,uid){const v=parseFloat(document.getElementById(`sc-${id}`).value);await db.collection("works").doc(id).update({score:v,status:'‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß'});await db.collection("users").doc(uid).update({score:firebase.firestore.FieldValue.increment(v)});showToast("Saved");}
        async function delWork(id){if(confirm("Del?"))await db.collection("works").doc(id).delete();}
        async function upQSc(id,uid,n,old){if(confirm("Update?")){const diff=n-old;await db.collection("quest_submissions").doc(id).update({earnedScore:n,status:'checked'});await db.collection("users").doc(uid).update({score:firebase.firestore.FieldValue.increment(diff)});showToast("Updated");}}
        async function delQSub(id,uid,s){if(confirm("Del?")){await db.collection("quest_submissions").doc(id).delete();await db.collection("users").doc(uid).update({score:firebase.firestore.FieldValue.increment(-s)});}}
        async function delUser(id){if(confirm("Del?"))await db.collection("users").doc(id).delete();}
        async function adjDec(id){const v=prompt("Val:");if(v){const n=prompt("Note");const b=db.batch();b.update(db.collection("users").doc(id),{score:firebase.firestore.FieldValue.increment(parseFloat(v))});b.set(db.collection("checkin_logs").doc(),{userId:id,type:'manual',amount:parseFloat(v),note:n});await b.commit();showToast("Saved");}}
        async function showHistory(id,n,s){document.getElementById('historyModal').style.display='block';/*Use V38 Logic*/}
        function copyHistory(){alert("Copied");}
        function updateAssigneeList(){const d=document.getElementById('sq-user-list');d.innerHTML="";usersData.forEach(u=>{if(!u.isIgnored)d.innerHTML+=`<label style="margin-right:5px"><input type="checkbox" class="sq-user-check" value="${u.id}" data-name="${u.displayName}" data-pic="${u.pictureUrl}"> ${u.displayName}</label>`});}
        function saveSideQuest(){/*V40 Logic*/}
        function toggleForm(){const f=document.getElementById('sq-form');f.style.display=f.style.display==='none'?'block':'none';}
        function resetForm(){document.getElementById('sq-form').style.display='none';}
        function filterBoard(){renderKanban({forEach:cb=>{Object.values(sideQuestsCache).forEach(q=>cb({data:()=>q,id:Object.keys(sideQuestsCache).find(k=>sideQuestsCache[k]===q)}))}});}
        async function delSQ(id){if(confirm("Del?"))await db.collection("side_quests").doc(id).delete();}
        function editSQ(id){const q=sideQuestsCache[id];document.getElementById('edit-id').value=id;document.getElementById('sq-title').value=q.title;document.getElementById('sq-form').style.display='block';}
        async function archiveSQ(id){if(confirm("Archive?"))await db.collection("side_quests").doc(id).update({status:'Archived'});}
        async function editQ(id,q){const nq=prompt("Edit Q:",q);if(nq)await db.collection("quests").doc(id).update({question:nq});}
        async function bulkDelete(){if(confirm("Delete All Selected?")){const ids=[...document.querySelectorAll('.user-chk:checked')].map(c=>c.value);ids.forEach(u=>db.collection("users").doc(u).delete());}}
        async function delQ(id){if(confirm("Delete Quest History?"))await db.collection("quests").doc(id).delete();}
    </script>
</body>
</html>
