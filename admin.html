<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLP INTERNSHIP V.260125</title>
    
    <link rel="stylesheet" href="style.css">
    
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        /* CSS ‡πÄ‡∏î‡∏¥‡∏° */
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background: #f0f2f5; font-family: sans-serif; }
        #dashboard-container { display: none; }
        .login-card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 90%; }
        .input-group { margin-top: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; color: #666; font-size: 0.9em; }
        .input-group input, .input-group textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        .magic-btn { background: #007bff; color: white; border: none; border-radius: 6px; padding: 12px; width: 100%; margin-top: 20px; font-size: 16px; cursor: pointer; transition: 0.2s; font-weight: bold; }
        .magic-btn:hover { background: #0056b3; }
        
        /* Dashboard & Tabs */
        .tab-nav { display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px; overflow-x: auto; }
        .tab-btn { padding: 15px 20px; cursor: pointer; border: none; background: none; font-weight: 600; color: var(--gray); white-space: nowrap; }
        .tab-btn.active { color: #007bff; border-bottom: 3px solid #007bff; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        
        /* Tables & UI */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #555; }
        .btn-sm { padding: 5px 10px; border:none; border-radius:4px; cursor:pointer; color:white; font-size:0.9em;}
        .btn-primary { background:#007bff; } .btn-danger { background:#dc3545; } .btn-secondary { background:#6c757d; } .btn-success { background:#28a745; } .btn-warning { background:#ffc107; color:black; } .btn-dark { background:#343a40; }
        .badge { padding:4px 8px; border-radius:10px; font-size:0.8em; }
        
        /* Quest & Leaderboard */
        .quest-create-card { background:#fff3cd; padding:20px; border-radius:8px; border:1px solid #ffeeba; margin-bottom:20px; }
        .active-quest-card { background:#d4edda; padding:15px; border-radius:8px; border:1px solid #c3e6cb; margin-bottom:20px; }
        .leaderboard-card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid #ffd700; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .rank-1 { border-left-color: #FFD700; background: #fffbe6; } 
        .rank-2 { border-left-color: #C0C0C0; } 
        .rank-3 { border-left-color: #CD7F32; } 
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h2>üîê Admin Access</h2>
            <div id="login-form">
                <div class="input-group"><label>Email</label><input type="email" id="email-input" value="medlifeplus@gmail.com"></div>
                <button class="magic-btn" id="send-btn" onclick="sendMagicLink()">‚ú® ‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏•</button>
            </div>
            <div id="status-msg" style="margin-top:15px; color:red;"></div>
        </div>
    </div>

    <div id="dashboard-container" class="container" style="max-width: 1000px; padding: 20px; margin:0 auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
            <h2>üë®‚Äçüíª Admin Dashboard</h2>
            <div style="display:flex; gap:5px; align-items:center;">
                <span id="admin-email" style="color:#666; font-size:0.9em; margin-right:5px;"></span>
                <button class="btn-sm btn-success" onclick="shareLeaderboard()">üì§ ‡πÅ‡∏ä‡∏£‡πå‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                <button class="btn-sm btn-secondary" onclick="location.reload()">üîÑ</button>
                <button class="btn-sm btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('tab-users')">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
            <button class="tab-btn" onclick="switchTab('tab-works')">üìÑ ‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô</button>
            <button class="tab-btn" onclick="switchTab('tab-quest')">‚ö° Daily Quest</button>
            <button class="tab-btn" onclick="switchTab('tab-leaderboard')">üèÜ Leaderboard</button>
        </div>

        <div id="tab-users" class="tab-content active">
            <input type="text" id="userSearch" style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ddd; border-radius:8px;" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." onkeyup="filterUsers()">
            <div style="overflow-x:auto;">
                <table id="usersTable"><thead><tr><th>‡∏£‡∏π‡∏õ</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th><th>‡∏•‡∏ö</th></tr></thead><tbody></tbody></table>
            </div>
        </div>

        <div id="tab-works" class="tab-content">
            <div style="overflow-x:auto;">
                <table id="worksTable">
                    <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th><th>‡∏•‡∏¥‡∏á‡∏Å‡πå</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</th><th>‡∏•‡∏ö</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="tab-quest" class="tab-content">
            <div class="quest-create-card">
                <h3>üì¢ ‡∏™‡∏£‡πâ‡∏≤‡∏á Quest ‡πÉ‡∏´‡∏°‡πà</h3>
                <div class="input-group" style="margin-top:0;">
                    <label>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° / ‡πÇ‡∏à‡∏ó‡∏¢‡πå:</label>
                    <input type="text" id="q-text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏õ‡∏ö‡πâ‡∏≤‡∏á?">
                </div>
                <div class="input-group">
                    <label>‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Optional):</label>
                    <input type="text" id="q-img" placeholder="‡∏ß‡∏≤‡∏á URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡πÄ‡∏ä‡πà‡∏ô https://...)">
                </div>
                <div class="input-group">
                    <label>‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ô‡∏ö/‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏° (Optional):</label>
                    <input type="text" id="q-link" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á">
                </div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <div style="flex:1;">
                        <label>‡∏´‡∏°‡∏î‡πÄ‡∏Ç‡∏ï (‡∏ä‡∏°.):</label>
                        <input type="number" id="q-hours" value="24" style="width:100%; padding:8px;">
                    </div>
                    <div style="flex:1;">
                        <label>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</label>
                        <input type="number" id="q-score" value="10" style="width:100%; padding:8px;">
                    </div>
                </div>
                <button class="magic-btn" onclick="createQuest()" style="background:#ffc107; color:black; margin-top:15px;">üöÄ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® Quest</button>
            </div>

            <div id="active-quest-section" style="display:none;">
                <div class="active-quest-card">
                    <h3 style="color:#155724; margin-top:0;">‚ö° Quest ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á Active</h3>
                    <div style="overflow-x:auto;">
                        <table id="activeQuestTable">
                            <thead><tr><th>‡πÇ‡∏à‡∏ó‡∏¢‡πå</th><th>‡∏´‡∏°‡∏î‡πÄ‡∏Ç‡∏ï</th><th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th><th>‡∏¢‡∏∏‡∏ï‡∏¥ (‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ History)</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div style="display:flex; gap:20px; flex-wrap:wrap;">
                <div style="flex:1; min-width:300px;">
                    <h3>üìù ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                    <div style="overflow-x:auto;">
                        <table id="questTable">
                            <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡πÇ‡∏ö‡∏ô‡∏±‡∏™</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                
                <div style="flex:1; min-width:300px; border-left:1px solid #eee; padding-left:10px;">
                    <h3>‚ôªÔ∏è ‡∏Ñ‡∏•‡∏±‡∏á Quest (‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥)</h3>
                    <div style="overflow-x:auto; max-height:400px;">
                        <table id="questHistoryTable">
                            <thead><tr><th>‡πÇ‡∏à‡∏ó‡∏¢‡πå</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-leaderboard" class="tab-content">
            <div id="leaderboardList" style="max-width:600px; margin:0 auto;"></div>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        // CONFIG
        const ALLOWED_EMAIL = "medlifeplus@gmail.com";
        const ADMIN_LIFF_ID = "2008959998-yjcNpaGt"; // ‚ö†Ô∏è ‡πÉ‡∏™‡πà ID Admin
        const MY_URL = 'https://mlpditto.github.io/INTERN-PORT/admin.html'; // ‚ö†Ô∏è ‡πÉ‡∏™‡πà URL Admin

        const auth = firebase.auth();
        let topUsersCache = [];

        // --- Login ---
        if (auth.isSignInWithEmailLink(window.location.href)) {
            let email = window.localStorage.getItem('emailForSignIn') || window.prompt('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á:');
            auth.signInWithEmailLink(email, window.location.href).then(() => {
                window.localStorage.removeItem('emailForSignIn');
                window.location.replace(MY_URL);
            }).catch((e) => alert(e.message));
        }
        function sendMagicLink() {
            const email = document.getElementById('email-input').value;
            if(email !== ALLOWED_EMAIL) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á");
            auth.sendSignInLinkToEmail(email, { url: MY_URL, handleCodeInApp: true })
                .then(() => { window.localStorage.setItem('emailForSignIn', email); alert("‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå Login ‡∏Ñ‡∏£‡∏±‡∏ö"); })
                .catch(e => alert(e.message));
        }
        auth.onAuthStateChanged((user) => {
            if (user && user.email === ALLOWED_EMAIL) {
                document.getElementById('login-screen').style.display='none';
                document.getElementById('dashboard-container').style.display='block';
                document.getElementById('admin-email').innerText = user.email;
                initSystem();
            }
        });
        function logout() { auth.signOut().then(() => location.reload()); }

        // --- Init ---
        let isInit = false;
        async function initSystem() {
            if(isInit) return; isInit = true;
            try { await liff.init({ liffId: ADMIN_LIFF_ID }); } catch(e) {}
            loadUsers(); loadWorks(); loadQuestSubmissions(); loadQuestHistory(); loadActiveQuests();
        }
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el=>el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
        }

        // --- Users ---
        function loadUsers() {
            db.collection("users").orderBy("score", "desc").onSnapshot(snap => {
                const tb = document.querySelector("#usersTable tbody"); const lb = document.getElementById("leaderboardList");
                tb.innerHTML = ""; lb.innerHTML = ""; topUsersCache = []; let rank = 1;
                snap.forEach(doc => {
                    const u = doc.data(); const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : '';
                    tb.innerHTML += `<tr class="user-row"><td><img src="${u.pictureUrl}" width="30" style="border-radius:50%"></td><td>${u.displayName}</td><td>${u.score}</td>
                    <td><button class="btn-sm btn-primary" onclick="adj('${doc.id}', 1)">+1</button> <button class="btn-sm btn-danger" onclick="adj('${doc.id}', -1)">-1</button></td>
                    <td><button class="btn-sm btn-danger" onclick="delUser('${doc.id}')">‡∏•‡∏ö</button></td></tr>`;
                    if (rank <= 10) {
                        topUsersCache.push(`${rank}. ${u.displayName} (${u.score})`);
                        lb.innerHTML += `<div class="leaderboard-card ${rankClass}"><div style="display:flex; align-items:center; gap:10px;"><h2 style="margin:0; color:#444; width:30px;">#${rank}</h2><img src="${u.pictureUrl}" style="width:40px; height:40px; border-radius:50%;"><b>${u.displayName}</b></div><span class="badge" style="background:${rank===1?'#FFD700':'#eee'}; color:${rank===1?'#000':'#333'}; font-size:1em;">${u.score} ‚≠êÔ∏è</span></div>`;
                    }
                    rank++;
                });
            });
        }
        async function shareLeaderboard() {
            if (topUsersCache.length === 0) return alert("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            const text = "üèÜ ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:\n\n" + topUsersCache.join("\n") + "\n\n(‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: " + new Date().toLocaleTimeString('th-TH') + ")";
            if (liff.isInClient()) { try { await liff.shareTargetPicker([{ type: "text", text: text }]); } catch (e) { alert("Error: " + e.message); } }
            else { try { await navigator.clipboard.writeText(text); alert("üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß! ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô LINE ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö"); } catch (err) { prompt("Copy ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:", text); } }
        }

        // --- Works ---
        function loadWorks() {
            db.collection("works").orderBy("timestamp", "desc").limit(50).onSnapshot((snapshot) => {
                const tbody = document.querySelector("#worksTable tbody"); tbody.innerHTML = "";
                snapshot.forEach(doc => {
                    const w = doc.data(); const id = doc.id;
                    const statusColor = w.status === '‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß' ? '#d4edda' : w.status === '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' ? '#f8d7da' : '#fff3cd';
                    const feedbackText = w.feedback ? `<div style="font-size:0.8em; color:#007bff; margin-top:5px;">üí¨ "${w.feedback}"</div>` : "";
                    tbody.innerHTML += `<tr><td>${w.timestamp ? w.timestamp.toDate().toLocaleString('th-TH') : ".."}</td><td>${w.displayName}</td><td>${w.title}</td><td><a href="${w.link}" target="_blank" class="btn-sm btn-secondary" style="text-decoration:none;">Link</a></td><td><select onchange="updateStatus('${id}', this.value)" style="padding:5px; border-radius:4px; background:${statusColor}"><option value="‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à" ${w.status==='‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à'?'selected':''}>‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à</option><option value="‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß" ${w.status==='‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß'?'selected':''}>‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß</option><option value="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" ${w.status==='‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'?'selected':''}>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</option></select></td><td><button class="btn-sm btn-primary" onclick="addFeedback('${id}', '${w.feedback||''}')">üìù</button>${feedbackText}</td><td><button class="btn-sm btn-danger" onclick="delWork('${id}', '${w.title}')">‡∏•‡∏ö</button></td></tr>`;
                });
            });
        }

        // --- Quest System ---
        async function createQuest() {
            const text = document.getElementById('q-text').value;
            const hours = parseInt(document.getElementById('q-hours').value);
            const score = parseInt(document.getElementById('q-score').value);
            const imgUrl = document.getElementById('q-img').value;
            const linkUrl = document.getElementById('q-link').value;
            if(!text) return alert("‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
            const deadline = new Date(); deadline.setHours(deadline.getHours() + hours);
            if(confirm(`‡∏™‡∏£‡πâ‡∏≤‡∏á Quest: "${text}"?`)) {
                await db.collection("quests").add({ 
                    question: text, imageUrl: imgUrl, questLink: linkUrl, baseScore: score, 
                    deadline: firebase.firestore.Timestamp.fromDate(deadline), 
                    createdAt: firebase.firestore.FieldValue.serverTimestamp() 
                });
                alert("Quest Created!"); 
                document.getElementById('q-text').value = ""; document.getElementById('q-img').value = ""; document.getElementById('q-link').value = "";
            }
        }

        // Active Quests (Updated Logic)
        function loadActiveQuests() {
            db.collection("quests").orderBy("createdAt", "desc").onSnapshot(snapshot => {
                const tb = document.querySelector("#activeQuestTable tbody");
                const section = document.getElementById("active-quest-section");
                tb.innerHTML = "";
                const now = new Date();
                let hasActive = false;

                snapshot.forEach(doc => {
                    const q = doc.data();
                    if(q.deadline && q.deadline.toDate() > now) {
                        hasActive = true;
                        const safeQ = q.question.replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                        const safeImg = (q.imageUrl||"").replace(/'/g, "&#39;");
                        const safeLink = (q.questLink||"").replace(/'/g, "&#39;");
                        const timeLeft = Math.floor((q.deadline.toDate() - now) / (1000 * 60 * 60)); 

                        tb.innerHTML += `
                            <tr>
                                <td>${q.question}</td>
                                <td><span class="badge" style="background:#28a745;">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${timeLeft} ‡∏ä‡∏°.</span></td>
                                <td><button class="btn-sm btn-warning" onclick="editActiveQuest('${doc.id}', '${safeQ}', '${safeImg}', '${safeLink}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
                                <td><button class="btn-sm btn-dark" onclick="stopQuest('${doc.id}')">‚õî ‡∏¢‡∏∏‡∏ï‡∏¥ (Stop)</button></td>
                            </tr>
                        `;
                    }
                });
                if(hasActive) section.style.display = "block"; else section.style.display = "none";
            });
        }

        // Logic ‡∏¢‡∏∏‡∏ï‡∏¥ (Stop) - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏°‡∏î‡πÄ‡∏Ç‡∏ï‡πÄ‡∏õ‡πá‡∏ô "‡∏≠‡∏î‡∏µ‡∏ï" (‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏¢‡∏à‡∏≤‡∏Å Active ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô History)
        async function stopQuest(questId) {
            if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏∏‡∏ï‡∏¥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ô‡∏µ‡πâ?\n(‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ User ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏±‡∏ö)")) {
                try {
                    const past = new Date();
                    past.setSeconds(past.getSeconds() - 1); // ‡∏´‡∏°‡∏î‡πÄ‡∏Ç‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠ 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß
                    await db.collection("quests").doc(questId).update({
                        deadline: firebase.firestore.Timestamp.fromDate(past)
                    });
                } catch(e) { alert(e.message); }
            }
        }

        async function editActiveQuest(id, currentQ, currentImg, currentLink) {
            const newQ = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏à‡∏ó‡∏¢‡πå:", currentQ); if(newQ === null) return;
            const newImg = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):", currentImg);
            const newLink = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ô‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):", currentLink);
            try { await db.collection("quests").doc(id).update({ question: newQ, imageUrl: newImg, questLink: newLink }); } catch(e) { alert("Error: " + e.message); }
        }

        function loadQuestSubmissions() {
            db.collection("quest_submissions").orderBy("timestamp", "desc").limit(30).onSnapshot(snapshot => {
                const tbody = document.querySelector("#questTable tbody"); tbody.innerHTML = "";
                snapshot.forEach(doc => {
                    const d = doc.data();
                    let bonusBtn = d.bonusGiven ? `<span class="badge" style="background:#28a745;">+${d.bonusGiven}</span>` : `<button class="btn-sm btn-primary" onclick="giveBonus('${doc.id}', '${d.userId}', '${d.displayName}')">+Bonus</button>`;
                    tbody.innerHTML += `<tr><td>${d.displayName}</td><td>${d.answer}</td><td><span class="badge" style="background:${d.isLate?'#dc3545':'#28a745'}">${d.isLate?'‡∏ä‡πâ‡∏≤':'‡∏ó‡∏±‡∏ô'}</span></td><td>${bonusBtn}</td></tr>`;
                });
            });
        }
        
        // History (‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏° deleteQuest ‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£)
        function loadQuestHistory() {
            db.collection("quests").orderBy("createdAt", "desc").limit(20).onSnapshot(snapshot => {
                const tbody = document.querySelector("#questHistoryTable tbody"); tbody.innerHTML = "";
                snapshot.forEach(doc => {
                    const q = doc.data();
                    const safeQ = q.question.replace(/'/g, "\\'");
                    const safeImg = (q.imageUrl || "").replace(/'/g, "\\'");
                    const safeLink = (q.questLink || "").replace(/'/g, "\\'");
                    
                    tbody.innerHTML += `<tr>
                        <td style="font-size:0.9em;">${q.question}</td>
                        <td>${q.baseScore}</td>
                        <td>
                            <button class="btn-sm btn-secondary" onclick="reuseQuest('${safeQ}', ${q.baseScore}, '${safeImg}', '${safeLink}')" title="‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥">‚ôªÔ∏è</button>
                            <button class="btn-sm btn-danger" onclick="deleteQuest('${doc.id}')" title="‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£" style="margin-left:5px;">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
            });
        }
        
        async function deleteQuest(questId) { if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö Quest ‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£?")) { try { await db.collection("quests").doc(questId).delete(); } catch(e) { alert("Error: " + e.message); } } }
        
        function reuseQuest(qText, qScore, qImg, qLink) {
            document.getElementById('q-text').value = qText; document.getElementById('q-score').value = qScore;
            document.getElementById('q-img').value = qImg || ""; document.getElementById('q-link').value = qLink || "";
            document.querySelector('.quest-create-card').scrollIntoView({behavior: 'smooth'});
        }

        async function giveBonus(subId, userId, name) {
            const amount = prompt(`‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© ${name} ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà‡∏î‡∏µ?`, "5");
            if(amount) {
                const pts = parseInt(amount); const batch = db.batch();
                batch.update(db.collection("users").doc(userId), { score: firebase.firestore.FieldValue.increment(pts) });
                batch.update(db.collection("quest_submissions").doc(subId), { bonusGiven: pts });
                await batch.commit();
            }
        }

        // --- Helpers ---
        function filterUsers() { const t = document.getElementById('userSearch').value.toLowerCase(); document.querySelectorAll('.user-row').forEach(r => r.style.display = r.innerText.toLowerCase().includes(t)?'':'none'); }
        async function adj(uid, v) { db.collection("users").doc(uid).update({ score: firebase.firestore.FieldValue.increment(v) }); }
        async function delUser(uid) { if(confirm("‡∏•‡∏ö?")) db.collection("users").doc(uid).delete(); }
        async function delWork(wid, t) { if(confirm("‡∏•‡∏ö "+t+"?")) db.collection("works").doc(wid).delete(); }
        async function updateStatus(docId, val) { db.collection("works").doc(docId).update({ status: val }); }
        async function addFeedback(docId, val) { const f = prompt("Comment:", val); if(f!==null) db.collection("works").doc(docId).update({ feedback: f }); }

    </script>
</body>
</html>
