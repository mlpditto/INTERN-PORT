<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLP INTERNSHIP V.260126 (Final Fixed)</title>
    
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        :root {
            --bg-body: #f4f6f9; --bg-card: #ffffff; --text-main: #333; --text-sub: #666;
            --col-bg: #f8f9fa; --border-color: #e0e0e0;
            --primary: #4361ee; --success: #2ec4b6; --warning: #ff9f1c; --danger: #ef233c; --dark: #2b2d42;
        }
        body.dark-mode {
            --bg-body: #1a1a1a; --bg-card: #2d2d2d; --text-main: #e0e0e0; --text-sub: #aaa;
            --col-bg: #333; --border-color: #444;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; transition: 0.3s; }
        
        /* Layout & Utilities */
        #dashboard-container { display: none; max-width: 1400px; margin: 0 auto; padding: 20px; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .btn-icon { background: none; border: none; font-size: 1.2em; cursor: pointer; color: var(--text-main); }
        
        /* Login */
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; }
        .login-card { background: var(--bg-card); padding: 40px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; }
        .input-group input, .input-group select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-card); color: var(--text-main); margin-top: 5px; box-sizing: border-box; }
        .magic-btn { background: var(--primary); color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; margin-top: 20px; cursor: pointer; font-weight: bold; }

        /* Navigation */
        .tab-nav { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; overflow-x: auto; gap: 10px; }
        .tab-btn { padding: 10px 20px; border: none; background: none; cursor: pointer; font-weight: 600; color: var(--text-sub); border-radius: 8px 8px 0 0; white-space: nowrap; }
        .tab-btn.active { background: var(--bg-card); color: var(--primary); border-bottom: 3px solid var(--primary); }
        .tab-content { display: none; animation: fadeIn 0.3s; } .tab-content.active { display: block; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; background: var(--bg-card); border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background: var(--col-bg); color: var(--text-sub); }
        
        /* UI Components */
        .btn-sm { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; color: white; font-size: 0.85em; font-weight: 500; transition: 0.2s; margin: 0 2px; }
        .btn-primary { background: var(--primary); } .btn-danger { background: var(--danger); } 
        .btn-success { background: var(--success); } .btn-warning { background: var(--warning); color: black; } 
        .btn-dark { background: var(--dark); }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.75em; font-weight: bold; color: white; display: inline-block; }
        .user-pic { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); vertical-align: middle; margin-right: 10px; }

        /* üî• KANBAN BOARD */
        .kanban-board { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 20px; align-items: stretch; min-height: 500px; }
        .kanban-col { flex: 1; min-width: 300px; background: var(--col-bg); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; border: 1px solid var(--border-color); }
        .kanban-header { font-weight: bold; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; }
        .kanban-list { flex: 1; min-height: 100px; }
        .kanban-card { 
            background: var(--bg-card); padding: 15px; border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 10px; 
            border-left: 5px solid #ccc; cursor: grab; transition: transform 0.2s, box-shadow 0.2s; position: relative;
        }
        .kanban-card:active { cursor: grabbing; transform: rotate(2deg); }
        .kanban-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .card-Backlog { border-left-color: #6c757d; } .card-Doing { border-left-color: #4361ee; }
        .card-Review { border-left-color: #ff9f1c; } .card-Done { border-left-color: #2ec4b6; }

        .card-badges { display: flex; gap: 5px; margin-bottom: 8px; flex-wrap: wrap; }
        .badge-pill { padding: 2px 8px; border-radius: 10px; font-size: 0.7em; color: white; display: inline-flex; align-items: center; gap: 3px; }
        .p-high { background: #ef233c; } .p-med { background: #ff9f1c; } .p-low { background: #2ec4b6; }
        .assignee-stack { display: flex; margin-top: 10px; }
        .assignee-img { width: 28px; height: 28px; border-radius: 50%; border: 2px solid var(--bg-card); margin-right: -10px; transition: 0.2s; }
        .assignee-img:hover { transform: translateY(-5px); z-index: 10; margin-right: 0; }

        /* Expandable Card */
        .card-desc { display: none; font-size: 0.9em; color: var(--text-sub); margin: 10px 0; border-top: 1px solid var(--border-color); padding-top: 5px; }
        .kanban-card.expanded .card-desc { display: block; }
        .expand-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; color: var(--text-sub); cursor: pointer; }

        /* Search Bar */
        .search-bar { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-main); margin-bottom: 15px; }

        /* Toast */
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 999; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 17px; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }

        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

        /* Leaderboard */
        .leaderboard-card { background: var(--bg-card); padding: 10px 15px; margin-bottom: 10px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; border-left: 5px solid #ddd; }
        .rank-1 { border-color: #ffd700; background: linear-gradient(to right, rgba(255,215,0,0.1), var(--bg-card)); }
        .rank-2 { border-color: #c0c0c0; } .rank-3 { border-color: #cd7f32; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h2>üîê Admin Portal</h2>
            <div id="login-form">
                <div class="input-group"><input type="email" id="email-input" value="medlifeplus@gmail.com" placeholder="Email"></div>
                <button class="magic-btn" onclick="sendMagicLink()">‚ú® Login</button>
            </div>
            <div id="status-msg" style="margin-top:10px; color:red;"></div>
        </div>
    </div>

    <div id="dashboard-container">
        <div class="flex-between" style="margin-bottom:20px;">
            <div>
                <h2 style="margin:0;">üë®‚Äçüíª Admin Dashboard</h2>
                <span id="admin-email" style="font-size:0.8em; color:var(--text-sub);"></span>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
                <button class="btn-icon" onclick="toggleTheme()" title="Dark Mode">üåì</button>
                <button class="magic-btn" style="width:auto; margin:0; padding:8px 15px;" onclick="shareLeaderboard()">üì§ Share</button>
                <button class="magic-btn" style="width:auto; margin:0; padding:8px 15px; background:var(--danger);" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('tab-works')">üìÑ ‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô</button>
            <button class="tab-btn" onclick="switchTab('tab-sidequest')">üó∫Ô∏è Kanban Board</button>
            <button class="tab-btn" onclick="switchTab('tab-manage-quest')">‚öôÔ∏è Daily Quest</button>
            <button class="tab-btn" onclick="switchTab('tab-users')">üë• Users</button>
            <button class="tab-btn" onclick="switchTab('tab-leaderboard')">üèÜ Leaderboard</button>
        </div>

        <div id="tab-works" class="tab-content active">
             <h3>üìÅ ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h3>
             <div style="overflow-x:auto;"><table id="worksTable"><thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á</th><th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th><th>‡∏•‡∏¥‡∏á‡∏Å‡πå</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡∏•‡∏ö</th></tr></thead><tbody></tbody></table></div>
             <h3>‚ö° Daily Answers</h3>
             <div style="overflow-x:auto;"><table id="questTable"><thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á</th><th>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody></tbody></table></div>
        </div>

        <div id="tab-sidequest" class="tab-content">
            <div style="background:var(--col-bg); padding:20px; border-radius:12px; margin-bottom:20px; border:1px solid var(--border-color);">
                <div class="flex-between" style="cursor:pointer;" onclick="toggleForm()">
                    <h3 style="margin:0; color:var(--primary);">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÉ‡∏´‡∏°‡πà (New Task)</h3>
                    <span>üîΩ</span>
                </div>
                <div id="sq-form" style="display:none; margin-top:15px;">
                    <div class="input-group">
                        <input type="text" id="sq-title" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô...">
                        <input type="text" id="sq-desc" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...">
                    </div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <select id="sq-priority" style="flex:1; padding:10px; border-radius:8px;">
                            <option value="Low">üü¢ Priority: Low</option>
                            <option value="Medium" selected>üü° Priority: Medium</option>
                            <option value="High">üî¥ Priority: High</option>
                        </select>
                        <input type="date" id="sq-due" style="flex:1;">
                    </div>
                    <p style="margin:10px 0 5px 0;">Assign to:</p>
                    <div id="sq-user-list" style="display:flex; flex-wrap:wrap; gap:5px; max-height:100px; overflow-y:auto; border:1px solid #ccc; padding:5px;">Loading...</div>
                    <button class="magic-btn" onclick="createSideQuest()">üöÄ Create Task</button>
                </div>
            </div>

            <input type="text" class="search-bar" id="board-search" placeholder="üîç Filter tasks..." onkeyup="filterBoard()">

            <div class="kanban-board">
                <div class="kanban-col">
                    <div class="kanban-header">üìå Backlog <span class="badge" style="background:#6c757d" id="cnt-Backlog">0</span></div>
                    <div id="Backlog" class="kanban-list"></div>
                </div>
                <div class="kanban-col">
                    <div class="kanban-header">üöß Doing <span class="badge" style="background:#4361ee" id="cnt-Doing">0</span></div>
                    <div id="Doing" class="kanban-list"></div>
                </div>
                <div class="kanban-col">
                    <div class="kanban-header">üëÄ Review <span class="badge" style="background:#ff9f1c" id="cnt-Review">0</span></div>
                    <div id="Review" class="kanban-list"></div>
                </div>
                <div class="kanban-col">
                    <div class="kanban-header">‚úÖ Done <span class="badge" style="background:#2ec4b6" id="cnt-Done">0</span></div>
                    <div id="Done" class="kanban-list"></div>
                </div>
            </div>
        </div>

        <div id="tab-manage-quest" class="tab-content">
             <div style="background:var(--col-bg); padding:20px; border-radius:12px; margin-bottom:20px;">
                <h3>üì¢ ‡∏™‡∏£‡πâ‡∏≤‡∏á Daily Quest</h3>
                <input type="text" id="q-text" placeholder="‡πÇ‡∏à‡∏ó‡∏¢‡πå..." style="width:100%; padding:10px; margin-bottom:5px; border-radius:5px; border:1px solid #ddd;">
                <div style="display:flex; gap:10px;"><input type="text" id="q-img" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ" style="flex:1; padding:10px; border-radius:5px; border:1px solid #ddd;"><input type="text" id="q-link" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ô‡∏ö" style="flex:1; padding:10px; border-radius:5px; border:1px solid #ddd;"></div>
                <div style="display:flex; gap:10px; margin-top:10px;"><input type="number" id="q-hours" value="24" placeholder="‡∏ä‡∏°." style="width:60px; padding:10px; border-radius:5px; border:1px solid #ddd;"><input type="number" id="q-score" value="10" placeholder="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô" style="width:60px; padding:10px; border-radius:5px; border:1px solid #ddd;"><button class="magic-btn" style="margin-top:0;" onclick="createQuest()">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button></div>
            </div>
            
            <div id="active-quest-section" style="display:none; background:#d4edda; padding:15px; border-radius:8px; margin-bottom:20px;">
                <h3 style="color:#155724; margin:0;">üü¢ Active</h3>
                <table id="activeQuestTable"><thead><tr><th>‡πÇ‡∏à‡∏ó‡∏¢‡πå</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th><th>‡∏¢‡∏∏‡∏ï‡∏¥</th></tr></thead><tbody></tbody></table>
            </div>
            
            <h3>‚ôªÔ∏è ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h3>
            <table id="questHistoryTable"><thead><tr><th>‡πÇ‡∏à‡∏ó‡∏¢‡πå</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody></tbody></table>
        </div>

        <div id="tab-users" class="tab-content">
            <input type="text" class="search-bar" id="userSearch" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." onkeyup="filterUsers()">
            <table id="usersTable"><thead><tr><th>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th><th>Level</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡∏õ‡∏£‡∏±‡∏ö</th><th>‡∏•‡∏ö</th></tr></thead><tbody></tbody></table>
        </div>

        <div id="tab-leaderboard" class="tab-content"><div id="leaderboardList" style="max-width:700px; margin:0 auto;"></div></div>
    </div>

    <div id="toast">Action Completed!</div>

    <script src="firebase-config.js"></script>
    <script>
        const ALLOWED_EMAIL = "medlifeplus@gmail.com";
        const ADMIN_LIFF_ID = "2008959998-yjcNpaGt"; // ‚ö†Ô∏è ‡πÉ‡∏™‡πà ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const MY_URL = 'https://mlpditto.github.io/INTERN-PORT/admin.html'; // ‚ö†Ô∏è ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const auth = firebase.auth();
        let topUsersCache = [];

        // --- Dark Mode ---
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        }
        if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');

        // --- Auth Logic ---
        if (auth.isSignInWithEmailLink(window.location.href)) { let email = localStorage.getItem('emailForSignIn') || prompt('Email:'); auth.signInWithEmailLink(email, window.location.href).then(() => { localStorage.removeItem('emailForSignIn'); location.replace(MY_URL); }); }
        function sendMagicLink() { const email = document.getElementById('email-input').value; if(email!==ALLOWED_EMAIL) return alert("No Permission"); auth.sendSignInLinkToEmail(email, { url:MY_URL, handleCodeInApp:true }).then(() => { localStorage.setItem('emailForSignIn',email); alert("Check Email"); }); }
        auth.onAuthStateChanged(user => { if(user && user.email===ALLOWED_EMAIL) { document.getElementById('login-screen').style.display='none'; document.getElementById('dashboard-container').style.display='block'; document.getElementById('admin-email').innerText=user.email; initSystem(); } });
        function logout() { auth.signOut().then(() => location.reload()); }

        // --- Init ---
        let isInit = false;
        async function initSystem() {
            if(isInit) return; isInit = true;
            try { await liff.init({ liffId: ADMIN_LIFF_ID }); } catch(e) {}
            loadWorks(); loadQuestSubmissions(); loadActiveQuests(); loadQuestHistory(); loadUsers(); loadSideQuests();
        }
        function switchTab(id) { document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active')); document.getElementById(id).classList.add('active'); event.target.classList.add('active'); }

        // --- üî• SIDE QUEST (KANBAN) ---
        function loadSideQuests() {
            db.collection("side_quests").orderBy("createdAt", "desc").onSnapshot(snap => {
                const containers = { "Backlog": document.getElementById("Backlog"), "Doing": document.getElementById("Doing"), "Review": document.getElementById("Review"), "Done": document.getElementById("Done") };
                Object.values(containers).forEach(c => c.innerHTML = "");
                const counts = { "Backlog": 0, "Doing": 0, "Review": 0, "Done": 0 };

                snap.forEach(doc => {
                    const q = doc.data();
                    if(containers[q.status]) {
                        counts[q.status]++;
                        containers[q.status].appendChild(createCard(doc.id, q));
                    }
                });
                
                Object.keys(counts).forEach(k => document.getElementById(`cnt-${k}`).innerText = counts[k]);
                initSortable();
            });
        }

        function createCard(id, q) {
            const div = document.createElement('div');
            div.className = `kanban-card card-${q.status}`;
            div.setAttribute('data-id', id);
            div.onclick = (e) => { if(!e.target.closest('button')) div.classList.toggle('expanded'); };
            
            const pClass = q.priority === 'High' ? 'p-high' : q.priority === 'Low' ? 'p-low' : 'p-med';
            const dateStr = q.dueDate ? `üìÖ ${new Date(q.dueDate).toLocaleDateString('th-TH', {day:'numeric', month:'short'})}` : '';
            
            let assigneesHtml = '<div class="assignee-stack">';
            if(q.assignees) q.assignees.forEach(u => assigneesHtml += `<img src="${u.pic}" title="${u.name}" class="assignee-img" loading="lazy">`);
            assigneesHtml += '</div>';

            div.innerHTML = `
                <div class="card-badges">
                    <span class="badge-pill ${pClass}">${q.priority||'Medium'}</span>
                    ${dateStr ? `<span class="badge-pill" style="background:#666">${dateStr}</span>` : ''}
                </div>
                <div style="font-weight:bold; margin-bottom:5px;">${q.title}</div>
                <button class="expand-btn">‚åÑ</button>
                <div class="card-desc">
                    <p>${q.description||'-'}</p>
                    ${q.proofLink ? `<a href="${q.proofLink}" target="_blank" class="btn-sm btn-dark" style="text-decoration:none; display:block; text-align:center; margin-bottom:5px;">üìé ‡∏î‡∏π‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á</a>` : ''}
                    <button class="btn-sm btn-danger" onclick="deleteSideQuest('${id}')">üóëÔ∏è Delete</button>
                </div>
                ${assigneesHtml}
            `;
            return div;
        }

        function initSortable() {
            ['Backlog', 'Doing', 'Review', 'Done'].forEach(colId => {
                new Sortable(document.getElementById(colId), {
                    group: 'shared', animation: 150,
                    onEnd: function (evt) {
                        const newStatus = evt.to.id;
                        db.collection("side_quests").doc(evt.item.getAttribute('data-id')).update({ status: newStatus })
                          .then(() => showToast(`Moved to ${newStatus}!`));
                    }
                });
            });
        }

        function createSideQuest() {
            const title = document.getElementById("sq-title").value;
            const desc = document.getElementById("sq-desc").value;
            const priority = document.getElementById("sq-priority").value;
            const dueDate = document.getElementById("sq-due").value;
            const checkboxes = document.querySelectorAll('.sq-user-check:checked');
            let selectedUsers = [];
            checkboxes.forEach(cb => selectedUsers.push({ uid: cb.value, name: cb.dataset.name, pic: cb.dataset.pic }));

            if(!title) return alert("Missing Title");
            
            db.collection("side_quests").add({
                title, description: desc, priority, dueDate,
                assignees: selectedUsers, assigneeIds: selectedUsers.map(u => u.uid),
                status: "Backlog", createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => { showToast("Task Created!"); document.getElementById("sq-title").value = ""; toggleForm(); });
        }

        function toggleForm() { const f = document.getElementById("sq-form"); f.style.display = f.style.display === "none" ? "block" : "none"; }
        function filterBoard() { const term = document.getElementById("board-search").value.toLowerCase(); document.querySelectorAll('.kanban-card').forEach(c => { c.style.display = c.innerText.toLowerCase().includes(term) ? 'block' : 'none'; }); }
        function showToast(msg) { const x = document.getElementById("toast"); x.innerText = msg; x.className = "show"; setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000); }
        async function deleteSideQuest(id) { if(confirm("Delete?")) await db.collection("side_quests").doc(id).delete(); }

        // --- ‚öôÔ∏è Daily Quest (Fixed Buttons) ---
        async function createQuest() {
            const q = {
                question: document.getElementById('q-text').value,
                imageUrl: document.getElementById('q-img').value,
                questLink: document.getElementById('q-link').value,
                baseScore: parseFloat(document.getElementById('q-score').value),
                deadline: new Date(Date.now() + parseFloat(document.getElementById('q-hours').value) * 36e5),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            if (q.question && confirm("‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® Quest ‡∏ô‡∏µ‡πâ?")) {
                await db.collection("quests").add(q);
                alert("‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!"); document.getElementById('q-text').value = "";
            }
        }

        function loadActiveQuests() {
            db.collection("quests").orderBy("createdAt", "desc").onSnapshot(s => {
                const tb = document.querySelector("#activeQuestTable tbody");
                const section = document.getElementById("active-quest-section");
                tb.innerHTML = "";
                let hasActive = false;
                const now = new Date();

                s.forEach(doc => {
                    const q = doc.data();
                    if (q.deadline?.toDate() > now) {
                        hasActive = true;
                        const safeQ = q.question.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                        const safeImg = (q.imageUrl || "").replace(/'/g, "\\'");
                        const safeLink = (q.questLink || "").replace(/'/g, "\\'");
                        const timeLeft = Math.ceil((q.deadline.toDate() - now) / 36e5);

                        tb.innerHTML += `
                            <tr>
                                <td>${q.question}</td>
                                <td><span class="badge" style="background:#28a745">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${timeLeft} ‡∏ä‡∏°.</span></td>
                                <td><button class="btn-sm btn-warning" onclick="editQ('${doc.id}', '${safeQ}', '${safeImg}', '${safeLink}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
                                <td><button class="btn-sm btn-danger" onclick="stopQ('${doc.id}')">‚õî ‡∏¢‡∏∏‡∏ï‡∏¥</button></td>
                            </tr>`;
                    }
                });
                section.style.display = hasActive ? "block" : "none";
            });
        }

        async function stopQ(id) { if (confirm("‡∏¢‡∏∏‡∏ï‡∏¥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ô‡∏µ‡πâ?")) await db.collection("quests").doc(id).update({ deadline: new Date(Date.now() - 1000) }); }
        async function editQ(id, q, i, l) {
            const nQ = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏à‡∏ó‡∏¢‡πå:", q); if (nQ === null) return;
            const nI = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ:", i); const nL = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ô‡∏ö:", l);
            await db.collection("quests").doc(id).update({ question: nQ, imageUrl: nI, questLink: nL });
        }

        function loadQuestHistory() {
            db.collection("quests").orderBy("createdAt", "desc").limit(20).onSnapshot(s => {
                const tb = document.querySelector("#questHistoryTable tbody"); tb.innerHTML = "";
                s.forEach(doc => {
                    const q = doc.data();
                    const safeQ = q.question.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                    const safeImg = (q.imageUrl || "").replace(/'/g, "\\'");
                    const safeLink = (q.questLink || "").replace(/'/g, "\\'");
                    tb.innerHTML += `<tr><td>${q.question}</td><td>${q.baseScore}</td><td><button class="btn-sm btn-success" onclick="reuse('${safeQ}', ${q.baseScore}, '${safeImg}', '${safeLink}')">‚ôªÔ∏è ‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥</button> <button class="btn-sm btn-danger" onclick="delQ('${doc.id}')">üóëÔ∏è</button></td></tr>`;
                });
            });
        }
        function reuse(q, s, i, l) { document.getElementById('q-text').value = q; document.getElementById('q-score').value = s; document.getElementById('q-img').value = i; document.getElementById('q-link').value = l; document.querySelector('.tab-content.active').scrollIntoView({ behavior: 'smooth' }); }
        async function delQ(id) { if (confirm("‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£?")) await db.collection("quests").doc(id).delete(); }

        // --- Other Logic ---
        function loadUsers(){ db.collection("users").orderBy("score","desc").onSnapshot(s=>{ const tb=document.querySelector("#usersTable tbody"); const lb=document.getElementById("leaderboardList"); const sel=document.getElementById("sq-user-list"); tb.innerHTML=""; lb.innerHTML=""; sel.innerHTML=""; topUsersCache=[]; let r=1; s.forEach(d=>{ const u=d.data(); tb.innerHTML+=`<tr><td><img src="${u.pictureUrl}" class="user-pic">${u.displayName}</td><td>Lv.${Math.floor(u.score/10)+1}</td><td>${u.score.toFixed(1)}</td><td><button class="btn-sm btn-primary" onclick="adj('${d.id}',1)">+1</button></td><td>üóëÔ∏è</td></tr>`; sel.innerHTML+=`<label style="margin-right:10px; font-size:0.9em;"><input type="checkbox" class="sq-user-check" value="${d.id}" data-name="${u.displayName}" data-pic="${u.pictureUrl}"> ${u.displayName}</label>`; if(r<=20){ topUsersCache.push(`${r}. ${u.displayName} (${u.score.toFixed(1)})`); let cls='rank-other',ic='‚≠ê'; if(r===1){cls='rank-1';ic='üåü';}else if(r===2){cls='rank-2';ic='ü•à';}else if(r===3){cls='rank-3';ic='ü•â';} lb.innerHTML+=`<div class="leaderboard-card ${cls}"><div style="display:flex; align-items:center;"><b style="width:30px">#${r}</b><img src="${u.pictureUrl}" class="user-pic">${u.displayName}</div><div><b>${u.score.toFixed(1)}</b> ${ic}</div></div>`; } r++; }); }) }
        function loadWorks() { db.collection("works").orderBy("timestamp","desc").limit(50).onSnapshot(s=>{ const t=document.querySelector("#worksTable tbody"); t.innerHTML=""; s.forEach(d=>{ const w=d.data(); t.innerHTML+=`<tr><td>${w.timestamp?.toDate().toLocaleString('th-TH')||''}</td><td><img src="${w.pictureUrl}" class="user-pic">${w.displayName}</td><td>${w.title}</td><td><a href="${w.link}" target="_blank">Link</a></td><td>${w.status}</td><td><input type="number" step="0.1" id="sc-${d.id}" value="${w.score||0}" style="width:50px"><button onclick="svSc('${d.id}','${w.userId}',${w.score||0})">üíæ</button></td><td><button class="btn-sm btn-danger" onclick="delWork('${d.id}')">üóëÔ∏è</button></td></tr>`}) }) }
        function loadQuestSubmissions() { db.collection("quest_submissions").orderBy("timestamp","desc").limit(50).onSnapshot(s=>{ const t=document.querySelector("#questTable tbody"); t.innerHTML=""; s.forEach(d=>{ const q=d.data(); let ans=q.answer; if(ans.startsWith('http')) ans=`<a href="${ans}" target="_blank">Link</a>`; t.innerHTML+=`<tr><td>${q.timestamp?.toDate().toLocaleString('th-TH')||''}</td><td><img src="${q.pictureUrl}" class="user-pic">${q.displayName}</td><td>${ans}</td><td>${q.isLate?'‡∏ä‡πâ‡∏≤':'‡∏ó‡∏±‡∏ô'}</td><td><input type="number" step="0.1" id="qsc-${d.id}" value="${(q.earnedScore||0)+(q.bonusGiven||0)}" style="width:50px"><button onclick="upQSc('${d.id}','${q.userId}',${(q.earnedScore||0)+(q.bonusGiven||0)},${q.earnedScore||0})">‡πÅ‡∏Å‡πâ</button></td><td><button class="btn-sm btn-danger" onclick="delQSub('${d.id}','${q.userId}',${(q.earnedScore||0)+(q.bonusGiven||0)})">üóëÔ∏è</button></td></tr>`}) }) }

        // --- Helpers ---
        async function svSc(wid,uid,old){ const n=parseFloat(document.getElementById('sc-'+wid).value)||0; if(n==old)return; db.collection("works").doc(wid).update({score:n,status:"‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß"}); db.collection("users").doc(uid).update({score:firebase.firestore.FieldValue.increment(n-old)}); showToast("Score Saved!"); }
        async function delWork(id){ if(confirm("Delete?")) db.collection("works").doc(id).delete(); }
        async function upQSc(id,uid,cur,base){ const n=parseFloat(document.getElementById('qsc-'+id).value)||0; const bonus=parseFloat((n-base).toFixed(2)); if(confirm("Update?")) { db.collection("quest_submissions").doc(id).update({bonusGiven:bonus}); db.collection("users").doc(uid).update({score:firebase.firestore.FieldValue.increment(n-cur)}); showToast("Score Updated!"); } }
        async function delQSub(id,uid,sc){ if(confirm("Delete?")) { db.collection("quest_submissions").doc(id).delete(); db.collection("users").doc(uid).update({score:firebase.firestore.FieldValue.increment(-sc)}); } }
        async function adj(id,v){ db.collection("users").doc(id).update({score:firebase.firestore.FieldValue.increment(v)}); }
        function filterUsers(){ const t=document.getElementById('userSearch').value.toLowerCase(); document.querySelectorAll('#usersTable tbody tr').forEach(r=>r.style.display=r.innerText.toLowerCase().includes(t)?'':'none'); }
        async function shareLeaderboard(){ if(!topUsersCache.length)return alert("No Data"); const t="üèÜ Top Scores:\n"+topUsersCache.slice(0,10).join("\n"); if(liff.isInClient())liff.shareTargetPicker([{type:"text",text:t}]); else navigator.clipboard.writeText(t).then(()=>alert("Copied")); }

    </script>
</body>
</html>
