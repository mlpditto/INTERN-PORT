<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLP INTERNSHIP V.260126 (V21)</title>
    
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        /* ... (CSS ‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ... */
        :root {
            --bg-body: #f4f6f9; --bg-card: #ffffff; --text-main: #333; --text-sub: #666;
            --col-bg: #f8f9fa; --border-color: #e0e0e0;
            --primary: #4361ee; --success: #2ec4b6; --warning: #ff9f1c; --danger: #ef233c; --dark: #2b2d42;
        }
        body.dark-mode {
            --bg-body: #1a1a1a; --bg-card: #2d2d2d; --text-main: #e0e0e0; --text-sub: #aaa;
            --col-bg: #333; --border-color: #444;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; transition: 0.3s; }
        #dashboard-container { display: none; max-width: 1400px; margin: 0 auto; padding: 20px; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .btn-icon { background: none; border: none; font-size: 1.2em; cursor: pointer; color: var(--text-main); }
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; }
        .login-card { background: var(--bg-card); padding: 40px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; }
        .input-group input, .input-group select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-card); color: var(--text-main); margin-top: 5px; box-sizing: border-box; }
        .magic-btn { background: var(--primary); color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; margin-top: 20px; cursor: pointer; font-weight: bold; }
        .tab-nav { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; overflow-x: auto; gap: 10px; }
        .tab-btn { padding: 10px 20px; border: none; background: none; cursor: pointer; font-weight: 600; color: var(--text-sub); border-radius: 8px 8px 0 0; white-space: nowrap; }
        .tab-btn.active { background: var(--bg-card); color: var(--primary); border-bottom: 3px solid var(--primary); }
        .tab-content { display: none; animation: fadeIn 0.3s; } .tab-content.active { display: block; }
        table { width: 100%; border-collapse: collapse; background: var(--bg-card); border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background: var(--col-bg); color: var(--text-sub); }
        .btn-sm { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; color: white; font-size: 0.85em; font-weight: 500; transition: 0.2s; margin: 0 2px; }
        .btn-primary { background: var(--primary); } .btn-danger { background: var(--danger); } 
        .btn-success { background: var(--success); } .btn-warning { background: var(--warning); color: black; } 
        .btn-dark { background: var(--dark); }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.75em; font-weight: bold; color: white; display: inline-block; }
        .user-pic { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); vertical-align: middle; margin-right: 10px; }
        
        /* üî• Modal Styles (History) */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: var(--bg-card); margin: 10% auto; padding: 20px; border-radius: 12px; width: 90%; max-width: 600px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3); color: var(--text-main); }
        .close-modal { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-modal:hover { color: var(--text-main); }
        .history-list { list-style: none; padding: 0; margin-top: 10px; max-height: 300px; overflow-y: auto; }
        .history-item { padding: 10px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; font-size: 0.9em; }
        .history-item.bonus { background: rgba(46, 196, 182, 0.1); border-radius: 5px; margin-bottom: 5px; border: none; font-weight: bold; color: var(--success); }

        /* Filter Checkbox */
        .filter-control { margin-bottom: 15px; display: flex; align-items: center; gap: 8px; font-weight: 600; color: var(--text-sub); cursor: pointer; user-select: none; }
        .filter-control input { width: 18px; height: 18px; cursor: pointer; }

        /* ... (CSS ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å V19) ... */
        .kanban-board { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 20px; align-items: stretch; min-height: 500px; }
        .kanban-col { flex: 1; min-width: 300px; background: var(--col-bg); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; border: 1px solid var(--border-color); }
        .kanban-header { font-weight: bold; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; }
        .kanban-list { flex: 1; min-height: 100px; }
        .kanban-card { background: var(--bg-card); padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 10px; border-left: 5px solid #ccc; cursor: grab; position: relative; }
        .card-Backlog { border-left-color: #6c757d; } .card-Doing { border-left-color: #4361ee; }
        .card-Review { border-left-color: #ff9f1c; } .card-Done { border-left-color: #2ec4b6; }
        .search-bar { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-main); margin-bottom: 15px; }
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 999; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 17px; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} } @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} } @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
        .leaderboard-card { background: var(--bg-card); padding: 10px 15px; margin-bottom: 10px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; border-left: 5px solid #ddd; }
        .rank-1 { border-color: #ffd700; background: linear-gradient(to right, rgba(255,215,0,0.1), var(--bg-card)); } .rank-2 { border-color: #c0c0c0; } .rank-3 { border-color: #cd7f32; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h2>üîê Admin Portal</h2>
            <div id="login-form">
                <div class="input-group"><input type="email" id="email-input" value="medlifeplus@gmail.com" placeholder="Email"></div>
                <button class="magic-btn" onclick="sendMagicLink()">‚ú® Login</button>
            </div>
            <div id="status-msg" style="margin-top:10px; color:red;"></div>
        </div>
    </div>

    <div id="dashboard-container">
        <div class="flex-between" style="margin-bottom:20px;">
            <div><h2 style="margin:0;">üë®‚Äçüíª Admin Dashboard</h2><span id="admin-email" style="font-size:0.8em; color:var(--text-sub);"></span></div>
            <div style="display:flex; gap:10px; align-items:center;">
                <button class="btn-icon" onclick="toggleTheme()" title="Dark Mode">üåì</button>
                <button class="magic-btn" style="width:auto; margin:0; padding:8px 15px;" onclick="shareLeaderboard()">üì§ Share</button>
                <button class="magic-btn" style="width:auto; margin:0; padding:8px 15px; background:var(--danger);" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('tab-works')">üìÑ ‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô</button>
            <button class="tab-btn" onclick="switchTab('tab-sidequest')">üó∫Ô∏è Kanban Board</button>
            <button class="tab-btn" onclick="switchTab('tab-manage-quest')">‚öôÔ∏è Daily Quest</button>
            <button class="tab-btn" onclick="switchTab('tab-users')">üë• Users</button>
            <button class="tab-btn" onclick="switchTab('tab-leaderboard')">üèÜ Leaderboard</button>
        </div>

        <div id="tab-works" class="tab-content active">
             <label class="filter-control">
                <input type="checkbox" id="hideCompleted" onchange="toggleFilter()" checked> 
                ‡∏ã‡πà‡∏≠‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß / ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
             </label>

             <h3>üìÅ ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h3>
             <div style="overflow-x:auto;">
                 <table id="worksTable">
                     <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á</th><th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th><th>‡∏•‡∏¥‡∏á‡∏Å‡πå</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡∏•‡∏ö</th></tr></thead>
                     <tbody></tbody>
                 </table>
             </div>
             <h3>‚ö° Daily Answers</h3>
             <div style="overflow-x:auto;">
                 <table id="questTable">
                     <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á</th><th>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                     <tbody></tbody>
                 </table>
             </div>
        </div>

        <div id="tab-sidequest" class="tab-content">
            <div style="background:var(--col-bg); padding:20px; border-radius:12px; margin-bottom:20px; border:1px solid var(--border-color);">
                <div class="flex-between" style="cursor:pointer;" onclick="toggleForm()"><h3 style="margin:0; color:var(--primary);">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÉ‡∏´‡∏°‡πà</h3><span>üîΩ</span></div>
                <div id="sq-form" style="display:none; margin-top:15px;">
                    <div class="input-group"><input type="text" id="sq-title" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô..."><input type="text" id="sq-desc" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..."></div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <select id="sq-priority" style="flex:1;"><option value="Low">üü¢ Low</option><option value="Medium" selected>üü° Medium</option><option value="High">üî¥ High</option></select>
                        <input type="date" id="sq-due" style="flex:1;">
                    </div>
                    <p style="margin:10px 0 5px 0;">Assign to:</p><div id="sq-user-list" style="display:flex; flex-wrap:wrap; gap:5px; max-height:100px; overflow-y:auto; border:1px solid #ccc; padding:5px;">Loading...</div>
                    <button class="magic-btn" onclick="createSideQuest()">üöÄ Create</button>
                </div>
            </div>
            <input type="text" class="search-bar" id="board-search" placeholder="üîç Filter tasks..." onkeyup="filterBoard()">
            <div class="kanban-board">
                <div class="kanban-col"><div class="kanban-header">üìå Backlog <span class="badge" style="background:#6c757d" id="cnt-Backlog">0</span></div><div id="Backlog" class="kanban-list"></div></div>
                <div class="kanban-col"><div class="kanban-header">üöß Doing <span class="badge" style="background:#4361ee" id="cnt-Doing">0</span></div><div id="Doing" class="kanban-list"></div></div>
                <div class="kanban-col"><div class="kanban-header">üëÄ Review <span class="badge" style="background:#ff9f1c" id="cnt-Review">0</span></div><div id="Review" class="kanban-list"></div></div>
                <div class="kanban-col"><div class="kanban-header">‚úÖ Done <span class="badge" style="background:#2ec4b6" id="cnt-Done">0</span></div><div id="Done" class="kanban-list"></div></div>
            </div>
        </div>

        <div id="tab-manage-quest" class="tab-content">
             <div style="background:var(--col-bg); padding:20px; border-radius:12px; margin-bottom:20px;">
                <h3>üì¢ ‡∏™‡∏£‡πâ‡∏≤‡∏á Daily Quest</h3>
                <input type="text" id="q-text" placeholder="‡πÇ‡∏à‡∏ó‡∏¢‡πå..." style="width:100%; padding:10px; margin-bottom:5px;">
                <div style="display:flex; gap:10px;"><input type="text" id="q-img" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ" style="flex:1;"><input type="text" id="q-link" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ô‡∏ö" style="flex:1;"></div>
                <div style="display:flex; gap:10px; margin-top:10px;"><input type="number" id="q-hours" value="24" placeholder="‡∏ä‡∏°." style="width:60px;"><input type="number" id="q-score" value="10" placeholder="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô" style="width:60px;"><button class="magic-btn" style="margin-top:0;" onclick="createQuest()">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button></div>
            </div>
            <div id="active-quest-section" style="display:none; background:#d4edda; padding:15px; border-radius:8px; margin-bottom:20px;"><h3 style="color:#155724; margin:0;">üü¢ Active</h3><table id="activeQuestTable"><thead><tr><th>‡πÇ‡∏à‡∏ó‡∏¢‡πå</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th><th>‡∏¢‡∏∏‡∏ï‡∏¥</th></tr></thead><tbody></tbody></table></div>
            <h3>‚ôªÔ∏è ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h3><table id="questHistoryTable"><thead><tr><th>‡πÇ‡∏à‡∏ó‡∏¢‡πå</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody></tbody></table>
        </div>

        <div id="tab-users" class="tab-content">
            <input type="text" class="search-bar" id="userSearch" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." onkeyup="filterUsers()">
            <table id="usersTable"><thead><tr><th>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th><th>Level</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡∏õ‡∏£‡∏±‡∏ö</th><th>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</th><th>‡∏•‡∏ö</th></tr></thead><tbody></tbody></table>
        </div>

        <div id="tab-leaderboard" class="tab-content"><div id="leaderboardList" style="max-width:700px; margin:0 auto;"></div></div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2 id="history-title" style="margin-top:0;">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2>
            <div id="history-summary" style="margin-bottom:15px; font-weight:bold; color:var(--primary);"></div>
            <ul id="history-list" class="history-list">
                </ul>
        </div>
    </div>

    <div id="toast">Action Completed!</div>

    <script src="firebase-config.js"></script>
    <script>
        const ALLOWED_EMAIL = "medlifeplus@gmail.com";
        const ADMIN_LIFF_ID = "2008959998-yjcNpaGt"; 
        const MY_URL = 'https://mlpditto.github.io/INTERN-PORT/admin.html';
        const auth = firebase.auth();
        let topUsersCache = [];

        // Auth & Theme
        function toggleTheme() { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light'); }
        if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
        if (auth.isSignInWithEmailLink(window.location.href)) { let email = localStorage.getItem('emailForSignIn') || prompt('Email:'); auth.signInWithEmailLink(email, window.location.href).then(() => { localStorage.removeItem('emailForSignIn'); location.replace(MY_URL); }); }
        function sendMagicLink() { const email = document.getElementById('email-input').value; if(email!==ALLOWED_EMAIL) return alert("No Permission"); auth.sendSignInLinkToEmail(email, { url:MY_URL, handleCodeInApp:true }).then(() => { localStorage.setItem('emailForSignIn',email); alert("Check Email"); }); }
        auth.onAuthStateChanged(user => { if(user && user.email===ALLOWED_EMAIL) { document.getElementById('login-screen').style.display='none'; document.getElementById('dashboard-container').style.display='block'; document.getElementById('admin-email').innerText=user.email; initSystem(); } });
        function logout() { auth.signOut().then(() => location.reload()); }

        // Init
        let isInit = false;
        async function initSystem() {
            if(isInit) return; isInit = true;
            try { await liff.init({ liffId: ADMIN_LIFF_ID }); } catch(e) {}
            loadWorks(); loadQuestSubmissions(); loadActiveQuests(); loadQuestHistory(); loadUsers(); loadSideQuests();
        }
        function switchTab(id) { document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active')); document.getElementById(id).classList.add('active'); event.target.classList.add('active'); }

        // --- üî• 1. Filter Logic (‡∏ã‡πà‡∏≠‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß) ---
        function toggleFilter() {
            loadWorks(); // Reload tables
            loadQuestSubmissions();
        }

        function loadWorks() {
            const hideChecked = document.getElementById('hideCompleted').checked;
            db.collection("works").orderBy("timestamp","desc").limit(100).onSnapshot(s=>{
                const t=document.querySelector("#worksTable tbody"); t.innerHTML="";
                s.forEach(d=>{ 
                    const w=d.data();
                    // Filter Logic: ‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡πä‡∏Å‡∏ñ‡∏π‡∏Å ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏∑‡∏≠ "‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß" ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
                    if (hideChecked && w.status === "‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß") return;

                    const statusColor = w.status==='‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß'?'#2ec4b6':w.status==='‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'?'#ef233c':'#ff9f1c';
                    t.innerHTML+=`<tr>
                        <td style="font-size:0.8em;">${w.timestamp?.toDate().toLocaleString('th-TH')||''}</td>
                        <td><div style="display:flex; align-items:center;"><img src="${w.pictureUrl||'https://via.placeholder.com/35'}" class="user-pic">${w.displayName}</div></td>
                        <td>${w.title}</td>
                        <td><a href="${w.link}" target="_blank" class="btn-sm btn-dark">Link</a></td>
                        <td><span class="badge" style="background:${statusColor}">${w.status}</span></td>
                        <td><div style="display:flex; align-items:center;"><input type="number" step="0.1" id="sc-${d.id}" value="${w.score||0}" style="width:50px"><button class="btn-sm btn-primary" onclick="svSc('${d.id}','${w.userId}',${w.score||0})">üíæ</button></div></td>
                        <td><button class="btn-sm btn-danger" onclick="delWork('${d.id}')">üóëÔ∏è</button></td>
                    </tr>`
                }) 
            }) 
        }

        function loadQuestSubmissions() {
            const hideChecked = document.getElementById('hideCompleted').checked;
            db.collection("quest_submissions").orderBy("timestamp","desc").limit(100).onSnapshot(s=>{ 
                const t=document.querySelector("#questTable tbody"); t.innerHTML=""; 
                s.forEach(d=>{ 
                    const q=d.data();
                    // Filter Logic: ‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡πä‡∏Å‡∏ñ‡∏π‡∏Å ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "checked" (‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡πÅ‡∏Å‡πâ) ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°
                    // ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ Bonus ‡πÅ‡∏•‡πâ‡∏ß (‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤ Admin ‡∏î‡∏π‡πÅ‡∏•‡πâ‡∏ß) ‡∏Å‡πá‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß
                    const isChecked = q.status === 'checked' || (q.bonusGiven !== undefined && q.bonusGiven !== 0);
                    if (hideChecked && isChecked) return;

                    let ans=q.answer; if(ans.startsWith('http')) ans=`<a href="${ans}" target="_blank" class="btn-sm btn-dark">üîó Link</a>`;
                    const totalScore = (q.earnedScore||0)+(q.bonusGiven||0);
                    
                    t.innerHTML+=`<tr>
                        <td style="font-size:0.8em;">${q.timestamp?.toDate().toLocaleString('th-TH')||''}</td>
                        <td><div style="display:flex; align-items:center;"><img src="${q.pictureUrl||'https://via.placeholder.com/35'}" class="user-pic">${q.displayName}</div></td>
                        <td>${ans}</td>
                        <td><span class="badge" style="background:${q.isLate?'#ef233c':'#2ec4b6'}">${q.isLate?'‡∏ä‡πâ‡∏≤':'‡∏ó‡∏±‡∏ô'}</span></td>
                        <td>
                            <div style="display:flex; align-items:center;">
                                <input type="number" step="0.1" id="qsc-${d.id}" value="${totalScore}" style="width:50px">
                                <button class="btn-sm btn-warning" onclick="upQSc('${d.id}','${q.userId}',${totalScore},${q.earnedScore||0})">‡πÅ‡∏Å‡πâ</button>
                            </div>
                        </td>
                        <td><button class="btn-sm btn-danger" onclick="delQSub('${d.id}','${q.userId}',${totalScore})">‡∏•‡∏ö</button></td>
                    </tr>`
                }) 
            }) 
        }

        // --- üî• 2. Users & History Logic ---
        function loadUsers(){ 
            db.collection("users").orderBy("score","desc").onSnapshot(s=>{ 
                const tb=document.querySelector("#usersTable tbody"); const lb=document.getElementById("leaderboardList"); const sel=document.getElementById("sq-user-list"); 
                tb.innerHTML=""; lb.innerHTML=""; sel.innerHTML=""; topUsersCache=[]; let r=1; 
                s.forEach(d=>{ 
                    const u=d.data(); 
                    const score=parseFloat((u.score||0).toFixed(2));
                    
                    tb.innerHTML+=`<tr class="u-row">
                        <td><div style="display:flex; align-items:center;"><img src="${u.pictureUrl}" class="user-pic">${u.displayName}</div></td>
                        <td><span class="badge" style="background:#eee; color:#555">Lv.${Math.floor(score/10)+1}</span></td>
                        <td style="font-weight:bold; color:#4361ee; font-size:1.1em;">${score}</td>
                        <td><div style="display:flex; gap:5px;"><input type="number" step="0.1" id="adj-${d.id}" placeholder="0.0" style="width:50px"><button class="btn-sm btn-success" onclick="adjDec('${d.id}')">üíæ</button></div></td>
                        <td><button class="btn-sm btn-dark" onclick="showHistory('${d.id}', '${u.displayName}', ${score})">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button></td>
                        <td><button class="btn-sm btn-danger" onclick="delUser('${d.id}')">üóëÔ∏è</button></td>
                    </tr>`;
                    
                    sel.innerHTML+=`<label style="margin-right:10px;"><input type="checkbox" class="sq-user-check" value="${d.id}" data-name="${u.displayName}" data-pic="${u.pictureUrl}"> ${u.displayName}</label>`; 
                    if(r<=20){ topUsersCache.push(`${r}. ${u.displayName} (${score})`); let cls='rank-other',ic='‚≠ê'; if(r===1){cls='rank-1';ic='üåü';}else if(r===2){cls='rank-2';ic='ü•à';}else if(r===3){cls='rank-3';ic='ü•â';} lb.innerHTML+=`<div class="leaderboard-card ${cls}"><div style="display:flex; align-items:center;"><b style="width:30px">#${r}</b><img src="${u.pictureUrl}" class="user-pic">${u.displayName}</div><div><b>${score}</b> ${ic}</div></div>`; } r++; 
                }); 
            }) 
        }

        // --- History Modal Logic ---
        async function showHistory(userId, name, totalScore) {
            const modal = document.getElementById("historyModal");
            const list = document.getElementById("history-list");
            const title = document.getElementById("history-title");
            const summary = document.getElementById("history-summary");
            
            title.innerText = `üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${name}`;
            list.innerHTML = "<p style='text-align:center;'>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...</p>";
            modal.style.display = "block";

            let worksScore = 0;
            let questScore = 0;
            let html = "";

            try {
                // 1. ‡∏î‡∏∂‡∏á‡∏á‡∏≤‡∏ô (Works)
                const worksSnap = await db.collection("works").where("userId", "==", userId).get();
                worksSnap.forEach(doc => {
                    const w = doc.data();
                    if(w.score > 0) {
                        worksScore += w.score;
                        html += `<li class="history-item"><span>üìÅ ${w.title}</span> <span>+${w.score}</span></li>`;
                    }
                });

                // 2. ‡∏î‡∏∂‡∏á Quest
                const questSnap = await db.collection("quest_submissions").where("userId", "==", userId).get();
                questSnap.forEach(doc => {
                    const q = doc.data();
                    const earned = (q.earnedScore || 0) + (q.bonusGiven || 0);
                    if(earned > 0) {
                        questScore += earned;
                        const shortAns = q.answer.length > 20 ? q.answer.substring(0, 20)+"..." : q.answer;
                        html += `<li class="history-item"><span>‚ö° Q: ${shortAns}</span> <span>+${earned}</span></li>`;
                    }
                });

                // 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á (‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡πÉ‡∏™‡πà‡πÉ‡∏à / ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô)
                // Total = Works + Quests + Others
                // Others = Total - Works - Quests
                const others = totalScore - worksScore - questScore;
                
                // Render
                list.innerHTML = "";
                if (others !== 0) {
                    list.innerHTML += `<li class="history-item bonus"><span>‚ù§Ô∏è ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡πÉ‡∏™‡πà‡πÉ‡∏à / ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô / ‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏¥‡πÄ‡∏®‡∏©</span> <span>${others > 0 ? '+' : ''}${others.toFixed(2)}</span></li>`;
                }
                list.innerHTML += html;
                
                summary.innerHTML = `‡∏£‡∏ß‡∏°: ${totalScore.toFixed(2)} (‡∏á‡∏≤‡∏ô: ${worksScore} | Quest: ${questScore} | ‡∏≠‡∏∑‡πà‡∏ô‡πÜ: ${others.toFixed(2)})`;

            } catch(e) {
                list.innerHTML = `<p style="color:red">Error: ${e.message}</p>`;
            }
        }

        function closeModal() { document.getElementById("historyModal").style.display = "none"; }
        window.onclick = function(event) { if (event.target == document.getElementById("historyModal")) closeModal(); }

        // --- Helpers ---
        async function adjDec(id) { const v=parseFloat(document.getElementById(`adj-${id}`).value); if(isNaN(v)||v===0)return; if(confirm(`‡∏õ‡∏£‡∏±‡∏ö ${v}?`)){ await db.collection("users").doc(id).update({score:firebase.firestore.FieldValue.increment(v)}); document.getElementById(`adj-${id}`).value=""; } }
        async function svSc(wid,uid,old){ const n=parseFloat(document.getElementById('sc-'+wid).value)||0; if(n==old)return; db.collection("works").doc(wid).update({score:n, status:"‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß"}); db.collection("users").doc(uid).update({score:firebase.firestore.FieldValue.increment(n-old)}); showToast("Saved"); }
        async function upQSc(id,uid,cur,base){ const n=parseFloat(document.getElementById('qsc-'+id).value)||0; const bonus=parseFloat((n-base).toFixed(2)); if(confirm("Update?")) { db.collection("quest_submissions").doc(id).update({bonusGiven:bonus, status:'checked'}); db.collection("users").doc(uid).update({score:firebase.firestore.FieldValue.increment(n-cur)}); showToast("Updated"); } }
        async function delWork(id){ if(confirm("Del?")) db.collection("works").doc(id).delete(); }
        async function delQSub(id,uid,sc){ if(confirm("Del?")) { db.collection("quest_submissions").doc(id).delete(); db.collection("users").doc(uid).update({score:firebase.firestore.FieldValue.increment(-sc)}); } }
        async function delUser(id){ if(confirm("Del User?")) db.collection("users").doc(id).delete(); }
        function filterUsers(){ const t=document.getElementById('userSearch').value.toLowerCase(); document.querySelectorAll('.u-row').forEach(r=>r.style.display=r.innerText.toLowerCase().includes(t)?'':'none'); }
        async function shareLeaderboard(){ if(!topUsersCache.length)return alert("No Data"); const t="üèÜ Top Scores:\n"+topUsersCache.slice(0,10).join("\n"); if(liff.isInClient())liff.shareTargetPicker([{type:"text",text:t}]); else navigator.clipboard.writeText(t).then(()=>alert("Copied")); }
        function showToast(msg) { const x = document.getElementById("toast"); x.innerText = msg; x.className = "show"; setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000); }

        // Kanban & Side Quest (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° - ‡∏¢‡πà‡∏≠)
        function loadSideQuests() { db.collection("side_quests").orderBy("createdAt", "desc").onSnapshot(s => { const c = { "Backlog": document.getElementById("Backlog"), "Doing": document.getElementById("Doing"), "Review": document.getElementById("Review"), "Done": document.getElementById("Done") }; Object.values(c).forEach(el => el.innerHTML = ""); const cnt = { "Backlog": 0, "Doing": 0, "Review": 0, "Done": 0 }; s.forEach(d => { const q = d.data(); if(c[q.status]) { cnt[q.status]++; c[q.status].appendChild(createCard(d.id, q)); } }); Object.keys(cnt).forEach(k => document.getElementById(`cnt-${k}`).innerText = cnt[k]); initSortable(); }); }
        function createCard(id, q) { const d=document.createElement('div'); d.className=`kanban-card card-${q.status}`; d.setAttribute('data-id',id); d.onclick=(e)=>{if(!e.target.closest('button'))d.classList.toggle('expanded')}; let as='<div class="assignee-stack">'; if(q.assignees)q.assignees.forEach(u=>as+=`<img src="${u.pic}" class="assignee-img">`); as+='</div>'; d.innerHTML=`<div class="card-badges"><span class="badge-pill p-${q.priority}">${q.priority}</span></div><b>${q.title}</b><button class="expand-btn">‚åÑ</button><div class="card-desc"><p>${q.description||'-'}</p>${q.proofLink?`<a href="${q.proofLink}" target="_blank" class="btn-sm btn-dark">üìé ‡∏á‡∏≤‡∏ô</a>`:''}<button class="btn-sm btn-danger" onclick="delSQ('${id}')">üóëÔ∏è</button></div>${as}`; return d; }
        function initSortable() { ['Backlog','Doing','Review','Done'].forEach(id=>{ new Sortable(document.getElementById(id),{group:'shared',animation:150,onEnd:e=>{db.collection("side_quests").doc(e.item.getAttribute('data-id')).update({status:e.to.id})}}) }) }
        async function createSideQuest() { const t=document.getElementById("sq-title").value, d=document.getElementById("sq-desc").value, p=document.getElementById("sq-priority").value, date=document.getElementById("sq-due").value; const chk=document.querySelectorAll('.sq-user-check:checked'); let u=[]; chk.forEach(c=>u.push({uid:c.value,name:c.dataset.name,pic:c.dataset.pic})); if(!t)return alert("Title?"); db.collection("side_quests").add({title:t,description:d,priority:p,dueDate:date,assignees:u,assigneeIds:u.map(x=>x.uid),status:"Backlog",createdAt:firebase.firestore.FieldValue.serverTimestamp()}).then(()=>{showToast("Created");toggleForm()}); }
        function toggleForm(){const f=document.getElementById("sq-form");f.style.display=f.style.display==="none"?"block":"none"}
        function filterBoard(){const t=document.getElementById("board-search").value.toLowerCase();document.querySelectorAll('.kanban-card').forEach(c=>{c.style.display=c.innerText.toLowerCase().includes(t)?'block':'none'})}
        async function delSQ(id){if(confirm("Del?"))await db.collection("side_quests").doc(id).delete()}
        
        // Quest Create
        async function createQuest(){ const q={question:document.getElementById('q-text').value, imageUrl:document.getElementById('q-img').value, questLink:document.getElementById('q-link').value, baseScore:parseFloat(document.getElementById('q-score').value), deadline:new Date(Date.now()+parseFloat(document.getElementById('q-hours').value)*36e5), createdAt:firebase.firestore.FieldValue.serverTimestamp()}; if(q.question&&confirm("Post?")) await db.collection("quests").add(q); }
        function loadActiveQuests(){ db.collection("quests").orderBy("createdAt","desc").onSnapshot(s=>{ const t=document.querySelector("#activeQuestTable tbody"); t.innerHTML=""; let h=false; s.forEach(d=>{ const q=d.data(); if(q.deadline?.toDate()>new Date()){ h=true; const safeQ=q.question.replace(/'/g,"\\'").replace(/"/g,"&quot;"); t.innerHTML+=`<tr><td>${q.question}</td><td>${Math.ceil((q.deadline.toDate()-new Date())/36e5)}h</td><td><button class="btn-sm btn-warning" onclick="editQ('${d.id}','${safeQ}','${(q.imageUrl||"").replace(/'/g,"\\'")}','${(q.questLink||"").replace(/'/g,"\\'")}')">‚úèÔ∏è</button></td><td><button class="btn-sm btn-danger" onclick="stopQ('${d.id}')">‚õî</button></td></tr>` } }); document.getElementById("active-quest-section").style.display=h?"block":"none"; }) }
        async function stopQ(id){if(confirm("Stop?"))await db.collection("quests").doc(id).update({deadline:new Date(Date.now()-1000)})}
        async function editQ(id,q,i,l){const nq=prompt("Q",q);if(!nq)return;const ni=prompt("Img",i),nl=prompt("Lnk",l);await db.collection("quests").doc(id).update({question:nq,imageUrl:ni,questLink:nl})}
        function loadQuestHistory(){ db.collection("quests").orderBy("createdAt","desc").limit(20).onSnapshot(s=>{ const t=document.querySelector("#questHistoryTable tbody"); t.innerHTML=""; s.forEach(d=>{ const q=d.data(); const safeQ=q.question.replace(/'/g,"\\'").replace(/"/g,"&quot;"); t.innerHTML+=`<tr><td>${q.question}</td><td>${q.baseScore}</td><td><button class="btn-sm btn-success" onclick="reuse('${safeQ}',${q.baseScore},'${(q.imageUrl||"").replace(/'/g,"\\'")}','${(q.questLink||"").replace(/'/g,"\\'")}')">‚ôªÔ∏è</button> <button class="btn-sm btn-danger" onclick="delQ('${d.id}')">üóëÔ∏è</button></td></tr>` }) }) }
        function reuse(q,s,i,l){document.getElementById('q-text').value=q;document.getElementById('q-score').value=s;document.getElementById('q-img').value=i;document.getElementById('q-link').value=l;document.querySelector('.tab-content.active').scrollIntoView({behavior:'smooth'})}
        async function delQ(id){if(confirm("Del?"))await db.collection("quests").doc(id).delete()}

    </script>
</body>
</html>
