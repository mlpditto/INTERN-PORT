<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLP INTERNSHIP V.260128 (V62)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        /* ... (CSS Base V58-61 Same) ... */
        :root { --bg-body: #f4f6f9; --bg-card: #ffffff; --text-main: #333; --text-sub: #666; --col-bg: #f8f9fa; --border-color: #e0e0e0; --primary: #4361ee; --success: #2ec4b6; --warning: #ff9f1c; --danger: #ef233c; --dark: #2b2d42; }
        body.dark-mode { --bg-body: #1a1a1a; --bg-card: #2d2d2d; --text-main: #e0e0e0; --text-sub: #ccc; --col-bg: #333; --border-color: #444; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; transition: 0.3s; }
        #dashboard-container { display: none; max-width: 1400px; margin: 0 auto; padding: 20px; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .modal-content { background-color: var(--bg-card); margin: 5% auto; padding: 25px; border-radius: 12px; width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto; position: relative; color: var(--text-main); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .close-modal { float: right; font-size: 24px; cursor: pointer; }
        
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-card); color: var(--text-main); box-sizing: border-box; }
        .magic-btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-sm { padding: 5px 10px; border-radius: 6px; border: none; cursor: pointer; color: white; font-size: 0.85em; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: var(--primary); } .btn-danger { background: var(--danger); } .btn-success { background: var(--success); } .btn-warning { background: var(--warning); color: black; } .btn-dark { background: var(--dark); }
        .btn-toggle { background: #e9ecef; color: #333; border: 1px solid #ccc; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .btn-toggle.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        table { width: 100%; border-collapse: collapse; background: var(--bg-card); border-radius: 8px; overflow: hidden; margin-bottom: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .tab-nav { display: flex; gap: 10px; overflow-x: auto; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; padding-bottom: 5px; }
        .tab-btn { padding: 10px 20px; border: none; background: none; cursor: pointer; font-weight: 600; color: var(--text-sub); }
        .tab-btn.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .tab-content { display: none; } .tab-content.active { display: block; }

        .kanban-board { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 20px; min-height: 600px; }
        .kanban-col { flex: 1; min-width: 300px; background: var(--col-bg); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; border: 1px solid var(--border-color); }
        .kanban-card { background: var(--bg-card); padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 10px; border-left: 5px solid #ccc; position: relative; }
        .kanban-card.project { background-color: #fff0f5; border-left: 5px solid #e83e8c; }
        .kanban-card.scored { background-color: #d1e7dd; border-left: 5px solid var(--success); }
        
        .card-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .card-header-right { display: flex; align-items: center; gap: 5px; }
        .assignee-stack { display: flex; margin-right: 5px; }
        .assignee-img { width: 28px !important; height: 28px !important; flex-shrink: 0; border-radius: 50%; object-fit: cover; border: 2px solid var(--bg-card); margin-left: -8px; }
        .arrow-controls { display: flex; gap: 2px; }
        .btn-arrow { background: var(--col-bg); border: 1px solid var(--border-color); color: var(--text-sub); border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 0.8em; }
        .card-tool-row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; border-top: 1px solid var(--border-color); padding-top: 8px; }
        
        .card-timers { font-size: 0.8em; margin-top: 5px; font-family: monospace; }
        .timer-global { color: #e67e22; display: block; }
        .timer-active { color: #4361ee; font-weight: bold; display: block; }
        .timer-cooldown { color: #ef233c; font-weight: bold; display: block; }

        .chat-box { height: 300px; overflow-y: auto; border: 1px solid var(--border-color); padding: 15px; margin-bottom: 10px; border-radius: 8px; background: var(--col-bg); }
        .chat-msg { margin-bottom: 10px; padding: 8px 12px; border-radius: 12px; font-size: 0.95em; max-width: 80%; position: relative; display: flex; gap: 10px; align-items: flex-end; }
        .msg-admin { background: #d1e7dd; margin-left: auto; text-align: right; color: #0f5132; flex-direction: row-reverse; }
        .msg-user { background: #fff; border: 1px solid #ddd; text-align: left; }
        .chat-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tag-in { background: #d4edda; color: #155724; padding: 2px 5px; border-radius: 4px; font-weight: bold; }
        .tag-out { background: #fff3cd; color: #856404; padding: 2px 5px; border-radius: 4px; font-weight: bold; }

        .user-pic { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75em; font-weight: bold; color: white; display: inline-block; }
        .u-ignored { opacity: 0.5; filter: grayscale(1); }
        .quest-deadline { font-weight: bold; color: #e67e22; font-family: monospace; }
        .input-wide { flex: 2 !important; }
        
        .lb-container { background: var(--bg-card); border-radius: 15px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.05); padding: 10px; }
        .lb-row { display: flex; align-items: center; padding: 15px 20px; border-bottom: 1px solid var(--border-color); justify-content: space-between; margin-bottom: 5px; border-radius: 8px; transition: 0.2s; }
        .lb-row:hover { background: var(--col-bg); transform: translateX(5px); }
        .lb-left { display: flex; align-items: center; gap: 20px; flex: 2; }
        .lb-rank { width: 40px; text-align: center; font-weight: 900; font-size: 1.2em; color: var(--text-sub); }
        .lb-pic-lg { width: 50px !important; height: 50px !important; border-radius: 50%; object-fit: cover; border: 3px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); flex-shrink: 0; }
        .lb-info { display: flex; flex-direction: column; }
        .lb-name { font-weight: bold; font-size: 1.1em; margin-bottom: 2px; }
        .lb-days { font-size: 0.85em; color: #666; display: flex; align-items: center; gap: 5px; }
        .lb-right { text-align: right; min-width: 100px; }
        .lb-score { font-weight: 800; font-size: 1.4em; color: var(--primary); }
        .lb-lv { font-size: 0.8em; color: #999; background: #eee; padding: 2px 8px; border-radius: 10px; }
        .rank-1 .lb-rank { color: #ffd700; font-size: 1.5em; } .rank-2 .lb-rank { color: #c0c0c0; font-size: 1.4em; } .rank-3 .lb-rank { color: #cd7f32; font-size: 1.3em; }
        
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; }
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 3000; left: 50%; bottom: 30px; transform: translateX(-50%); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} } @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        
        /* üî• Pagination Controls */
        .history-controls, .archive-controls { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
        .btn-del-hist { padding: 2px 6px; font-size: 0.7em; background: #ffebeb; color: #ef233c; border: 1px solid #ef233c; border-radius: 4px; cursor: pointer; margin-left: 10px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div style="padding:40px; background:var(--bg-card); border-radius:15px; box-shadow:0 10px 25px rgba(0,0,0,0.1); width:350px; text-align:center;">
            <h2>üîê Admin Portal</h2>
            <input type="email" id="email-input" value="medlifeplus@gmail.com" placeholder="Email">
            <button class="magic-btn" onclick="sendMagicLink()" style="width:100%;">‚ú® Login</button>
        </div>
    </div>

    <div id="dashboard-container">
        <div class="flex-between" style="margin-bottom:20px;">
            <div><h2 style="margin:0;"><i class="fa-solid fa-user-shield"></i> Dashboard</h2><span id="admin-email" style="font-size:0.8em; color:var(--text-sub);"></span></div>
            <div style="display:flex; gap:10px;">
                <button class="magic-btn" onclick="openShareModal()"><i class="fa-solid fa-share-nodes"></i> Share</button>
                <button class="btn-sm btn-dark" onclick="toggleTheme()"><i class="fa-solid fa-moon"></i></button>
                <button class="magic-btn" style="background:var(--danger);" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('tab-works')">üìÑ ‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô</button>
            <button class="tab-btn" onclick="switchTab('tab-sidequest')">üó∫Ô∏è Kanban</button>
            <button class="tab-btn" onclick="switchTab('tab-manage-quest')">‚öôÔ∏è Daily Quest</button>
            <button class="tab-btn" onclick="switchTab('tab-users')">üë• Users</button>
            <button class="tab-btn" onclick="switchTab('tab-leaderboard')">üèÜ Leaderboard</button>
            <button class="tab-btn" onclick="switchTab('tab-certs')">üéì Certificates</button>
        </div>

        <div id="tab-works" class="tab-content active">
             <div class="header-row" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                 <h3>üìÅ ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h3>
                 <button id="btn-toggle-work-archive" class="btn-toggle active" onclick="toggleWorkArchive()">
                     <i class="fa-solid fa-box-archive"></i> fin¬∑ished
                 </button>
             </div>
             <div style="overflow-x:auto;"><table id="worksTable"><thead><tr><th>Time</th><th>User</th><th>Title</th><th>Link</th><th>Status</th><th>Score</th><th>Action</th></tr></thead><tbody></tbody></table></div>
        </div>

        <div id="tab-sidequest" class="tab-content">
            <div style="background:var(--col-bg); padding:20px; border-radius:12px; margin-bottom:20px;">
                <div class="flex-between">
                    <h3 style="margin:0; color:var(--primary);">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</h3>
                    <div>
                        <button class="magic-btn" onclick="openTaskModal()">Create Task</button>
                        <button class="btn-sm btn-dark" onclick="openArchiveModal()">üóÑÔ∏è ar¬∑chive</button>
                    </div>
                </div>
            </div>
            <input type="text" id="board-search" placeholder="üîç Filter..." onkeyup="filterBoard()">
            <div class="kanban-board">
                <div class="kanban-col" id="col-Backlog"><div style="font-weight:bold;margin-bottom:10px;">üìå Backlog <span class="badge" style="background:#6c757d" id="cnt-Backlog">0</span></div><div id="Backlog"></div></div>
                <div class="kanban-col" id="col-Doing"><div style="font-weight:bold;margin-bottom:10px;">üöß Doing <span class="badge" style="background:#4361ee" id="cnt-Doing">0</span></div><div id="Doing"></div></div>
                <div class="kanban-col" id="col-Review"><div style="font-weight:bold;margin-bottom:10px;">üëÄ Review <span class="badge" style="background:#ff9f1c" id="cnt-Review">0</span></div><div id="Review"></div></div>
                <div class="kanban-col" id="col-Done"><div style="font-weight:bold;margin-bottom:10px;">‚úÖ Done <span class="badge" style="background:#2ec4b6" id="cnt-Done">0</span></div><div id="Done"></div></div>
            </div>
        </div>

        <div id="tab-manage-quest" class="tab-content">
             <div style="background:var(--col-bg); padding:20px; border-radius:12px; margin-bottom:20px;">
                <h3>üì¢ Daily Quest Setup</h3>
                <input type="text" id="q-text" placeholder="‡πÇ‡∏à‡∏ó‡∏¢‡πå..." style="width:100%; margin-bottom:5px;">
                <div style="display:flex; gap:10px; margin-bottom:5px;">
                    <input type="text" id="q-img" placeholder="Img URL" class="input-wide" style="flex:2">
                    <input type="text" id="q-link" placeholder="Link" class="input-wide" style="flex:2">
                </div>
                <div style="display:flex; align-items:flex-end; gap:15px; margin-top:10px;">
                    <div><label style="font-size:0.85em; font-weight:bold; color:#555; display:block; margin-bottom:3px;">Expires (hr)</label><input type="number" id="q-hours" value="24" style="width:80px; margin:0; text-align:center;"></div>
                    <div><label style="font-size:0.85em; font-weight:bold; color:#555; display:block; margin-bottom:3px;">Duration (min)</label><input type="number" id="q-duration" value="30" style="width:80px; margin:0; text-align:center;"></div>
                    <div><label style="font-size:0.85em; font-weight:bold; color:#555; display:block; margin-bottom:3px;">Score</label><input type="number" id="q-score" value="0.1" step="0.1" style="width:80px; margin:0; text-align:center;"></div>
                    <div style="flex-grow:1;"></div>
                    <button class="magic-btn" onclick="createQuest()" style="margin:0; height:38px;">Post</button>
                </div>
            </div>
            <div id="active-quest-section" style="display:none; background:#d1e7dd; padding:15px; border-radius:8px; margin-bottom:20px;"><h3>üü¢ Active</h3><table id="activeQuestTable"><thead><tr><th>Quest</th><th>Expires</th><th>Duration</th><th>Action</th></tr></thead><tbody></tbody></table></div>
            <h3>‚ôªÔ∏è History</h3><table id="questHistoryTable"><thead><tr><th>Quest</th><th>Score</th><th>Action</th></tr></thead><tbody></tbody></table>
        </div>

        <div id="tab-users" class="tab-content">
            <input type="text" id="userSearch" placeholder="üîç Search..." onkeyup="filterUsers()">
            <table id="usersTable"><thead><tr><th>User</th><th>Status</th><th>Score</th><th>Adjust</th><th>History</th><th>Del</th></tr></thead><tbody></tbody></table>
        </div>

        <div id="tab-leaderboard" class="tab-content">
            <div id="leaderboardList" class="lb-container" style="max-width:900px; margin:0 auto;"></div>
        </div>

        <div id="tab-certs" class="tab-content">
            <div style="text-align:right; margin-bottom:15px;">
                <button class="magic-btn" onclick="generateBulkCert()" style="background:#e67e22;"><i class="fa-solid fa-file-pdf"></i> üì¶ Bulk Export All</button>
            </div>
            <div style="overflow-x:auto;">
                <table id="certsTable"><thead><tr><th>User</th><th>Internship Period</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table>
            </div>
        </div>
    </div>

    <div id="taskModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="document.getElementById('taskModal').style.display='none'">&times;</span><h2 id="task-modal-title">New Task</h2><input type="hidden" id="edit-id"><div style="display:flex; gap:10px;"><input type="text" id="sq-title" placeholder="Topic" style="flex:2;"><select id="sq-priority" style="flex:1;"><option value="Low">Low</option><option value="Medium" selected>Medium</option><option value="High">High</option></select></div><textarea id="sq-desc" rows="3" placeholder="Description"></textarea><div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;"><input type="date" id="sq-due" style="flex:1;"><label style="flex:1; cursor:pointer; background:#fff0f5; padding:8px; border-radius:6px; border:1px solid #e83e8c; color:#e83e8c; font-weight:bold;"><input type="checkbox" id="sq-isProject" style="width:auto; margin:0;"> üíñ Mark as Project</label></div><p>Assign to:</p><div id="sq-user-list" style="display:flex; flex-wrap:wrap; gap:5px; max-height:100px; overflow-y:auto; border:1px solid #ddd; padding:5px;"></div><button class="magic-btn" style="width:100%; margin-top:15px;" onclick="saveSideQuest()">üöÄ Save</button></div></div>
    <div id="chatModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="document.getElementById('chatModal').style.display='none'">&times;</span><h3 id="chat-title">üí¨ Project Chat</h3><input type="hidden" id="chat-card-id"><div id="chat-box" class="chat-box"></div><div style="display:flex; gap:5px;"><input type="text" id="chat-input" placeholder="Type @name..." style="margin:0;"><button class="btn-primary" onclick="sendChat()"><i class="fa-solid fa-paper-plane"></i></button></div></div></div>
    <div id="historyModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="document.getElementById('historyModal').style.display='none'">&times;</span><h2 id="history-title"></h2>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 id="history-summary" style="margin:0;color:var(--primary);">Total: 0.00</h3>
            <button class="btn-sm btn-warning" onclick="recalculateUserScore(currentHistoryUserId)"><i class="fa-solid fa-rotate"></i> Recalculate Score</button>
        </div>
        <ul id="history-list" style="list-style:none; padding:0;"></ul><div id="history-controls" class="history-controls"></div>
    </div></div>
    
    <div id="archiveModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="document.getElementById('archiveModal').style.display='none'">&times;</span><div style="display:flex;justify-content:space-between;align-items:center;"><h2 style="margin:0;">üóÑÔ∏è ar¬∑chive</h2><button class="btn-sm btn-danger" onclick="confirmClearArchive()">üß® Clear All</button></div><div id="archive-list" style="margin-top:10px;"></div></div></div>
    
    <div id="delCardModal" class="modal" style="z-index:2200;"><div class="modal-content" style="max-width:350px;text-align:center;"><h2 style="color:#ef233c;">‚ö†Ô∏è Delete Card?</h2><p>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</p><button id="btn-del-card-confirm" class="magic-btn" style="background:#ef233c;width:100%;">Confirm (5)</button></div></div>
    <div id="clearConfirmModal" class="modal" style="z-index:2100;"><div class="modal-content" style="max-width:350px;text-align:center;"><h2 style="color:#ef233c;">‚ö†Ô∏è Clear Archive?</h2><p>‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?</p><button id="btn-confirm-clear" class="magic-btn" style="background:#ccc;width:100%;" disabled>Confirm (5)</button></div></div>
    <div id="certModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="document.getElementById('certModal').style.display='none'">&times;</span><h2>üéì Certificate</h2><input type="hidden" id="cert-uid"><input type="hidden" id="cert-uname"><div style="display:flex; gap:10px; margin-bottom:10px;"><div style="flex:1"><label>Start:</label><input type="date" id="cert-start" onchange="updateCertPreview()"></div><div style="flex:1"><label>End:</label><input type="date" id="cert-end" onchange="updateCertPreview()"></div></div><div id="cert-preview-container" style="text-align:center;border:1px solid #ddd;padding:10px;margin-bottom:10px;"><canvas id="cert-canvas" style="width:100%;max-width:500px;"></canvas></div><div style="display:flex; gap:10px; justify-content:flex-end;"><button class="btn-sm btn-primary" onclick="saveUserDates()">üíæ Save & Approve</button><button class="btn-sm btn-warning" id="btn-gen-pdf" onclick="generateCertPDF()">üñ®Ô∏è PDF</button></div></div></div>
    <div id="shareModal" class="modal" style="z-index:3000;"><div class="modal-content" style="max-width:300px;text-align:center;"><h3><i class="fa-solid fa-share-nodes"></i> Share Leaderboard</h3><button class="magic-btn" style="width:100%;margin-bottom:10px;" onclick="copyLB(true)">üìã Copy (Show Names)</button><button class="magic-btn" style="width:100%;background:#6c757d;" onclick="copyLB(false)">üïµÔ∏è Copy (Anonymous)</button><button class="btn-sm btn-dark" style="margin-top:10px;" onclick="document.getElementById('shareModal').style.display='none'">Cancel</button></div></div>

    <div id="toast">Saved!</div>

    <script src="firebase-config.js"></script>
    <script>
        const ALLOWED_EMAIL = "medlifeplus@gmail.com";
        const ADMIN_LIFF_ID = "2008959998-yjcNpaGt"; 
        const MY_URL = 'https://mlpditto.github.io/INTERN-PORT/admin.html';
        const auth = firebase.auth();
        
        let usersData=[], worksData=[], sideQuestsCache={}, questsCache=[], questsSubCache={};
        let hideCompletedWorks = true;
        let historyCache = []; let historyPage = 1; const HISTORY_PER_PAGE = 10;
        
        // üî• Archive Pagination Variables
        let archiveCache = []; let archivePage = 1; const ARCHIVE_PER_PAGE = 10;

        let deleteCardId = null; let deleteTimer = null;
        let currentHistoryUserId = null;
        let certUser = null;

        function toggleTheme() { document.body.classList.toggle('dark-mode'); }
        auth.onAuthStateChanged(user => { if(user && user.email===ALLOWED_EMAIL) { document.getElementById('login-screen').style.display='none'; document.getElementById('dashboard-container').style.display='block'; initSystem(); } });
        function sendMagicLink() { const e=document.getElementById('email-input').value; if(e!==ALLOWED_EMAIL)return alert("No Permission"); auth.sendSignInLinkToEmail(e,{url:MY_URL,handleCodeInApp:true}).then(()=>alert("Check Email")); }
        if(auth.isSignInWithEmailLink(window.location.href)) { let e=localStorage.getItem('emailForSignIn')||prompt('Email'); auth.signInWithEmailLink(e, window.location.href).then(()=>location.replace(MY_URL)); }
        function logout() { auth.signOut().then(() => location.reload()); }

        let isInit=false;
        async function initSystem() { if(isInit) return; isInit=true; try { await liff.init({ liffId: ADMIN_LIFF_ID }); } catch(e) {} document.addEventListener('keydown', (e) => { if(e.key==="Escape") document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); }); loadData(); initKanban(); setInterval(updateRealtimeTimers, 1000); }
        function switchTab(id) { document.querySelectorAll('.tab-content,.tab-btn').forEach(e=>e.classList.remove('active')); document.getElementById(id).classList.add('active'); event.target.classList.add('active'); }

        function loadData() {
            db.collection("works").orderBy("timestamp","desc").limit(100).onSnapshot(s => { worksData=s.docs.map(d=>({id:d.id,...d.data()})); renderTable('works'); });
            db.collection("users").orderBy("score","desc").onSnapshot(s => { usersData=s.docs.map(d=>({id:d.id,...d.data()})); renderTable('users'); renderLeaderboard(); updateAssigneeList(); renderCertTable(); });
            db.collection("side_quests").orderBy("createdAt","desc").onSnapshot(renderKanban);
            db.collection("quests").onSnapshot(s => { questsCache = s.docs.map(d=>({id:d.id, ...d.data()})); loadActiveQuests(); loadQuestHistory(); });
            db.collection("quest_submissions").onSnapshot(s => { questsSubCache = {}; s.forEach(d => { questsSubCache[`${d.data().questId}_${d.data().userId}`] = d.data(); }); filterBoard(); });
        }

        // --- Tables ---
        function renderTable(type) {
            const tbody = document.querySelector(`#${type}Table tbody`);
            let data = (type==='works')?worksData:usersData;
            if(type==='works' && hideCompletedWorks) data = data.filter(d => d.status !== '‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß');
            if(type==='users') { const t=document.getElementById('userSearch').value.toLowerCase(); if(t) data = data.filter(u=>u.displayName.toLowerCase().includes(t)); }
            tbody.innerHTML="";
            data.slice(0,50).forEach(d=>{ 
                if(type==='works'){ const st = d.status==='‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß'?'#2ec4b6':d.status==='‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'?'#ef233c':'#ff9f1c'; tbody.innerHTML += `<tr><td>${d.timestamp?.toDate().toLocaleString()||'-'}</td><td><img src="${d.pictureUrl}" class="user-pic">${d.displayName}</td><td>${d.title}</td><td><a href="${d.link}" target="_blank" class="btn-sm btn-dark">Link</a></td><td><span class="badge" style="background:${st}">${d.status}</span></td><td><div style="display:flex;"><input type="number" id="sc-${d.id}" value="${d.score||0}" style="width:60px;"><button class="btn-sm btn-primary" onclick="svSc('${d.id}','${d.userId}')">Save</button></div></td><td><button class="btn-sm btn-danger" onclick="delWork('${d.id}')">Del</button></td></tr>`; }
                else { 
                    const ignored = d.isIgnored; 
                    tbody.innerHTML += `<tr class="${ignored?'u-ignored':''}"><td><img src="${d.pictureUrl}" class="user-pic"> ${d.displayName}</td><td><button class="btn-sm" onclick="toggleIgnoreUser('${d.id}',${ignored})">${ignored?'üö´':'üëÅÔ∏è'}</button></td><td>${parseFloat((d.score||0).toFixed(2))}</td><td><div style="display:flex;"><input type="number" step="0.1" id="adj-${d.id}" placeholder="0.0" style="width:70px;margin:0;" onkeypress="if(event.key==='Enter')adjDec('${d.id}')"><button class="btn-sm btn-success" onclick="adjDec('${d.id}')">Adj</button></div></td><td><button class="btn-sm btn-dark" onclick="showHistory('${d.id}','${d.displayName}',${d.score||0})">üìú</button></td><td><button class="btn-sm btn-danger" onclick="delUser('${d.id}')">Del</button></td></tr>`; 
                }
            });
        }
        function toggleWorkArchive() { hideCompletedWorks = !hideCompletedWorks; document.getElementById('btn-toggle-work-archive').classList.toggle('active'); renderTable('works'); }
        async function adjDec(id){ try { const valInput = document.getElementById(`adj-${id}`); let v = valInput.value; if(!v) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô"); v = v.replace(',', '.'); const scoreVal = parseFloat(v); if(isNaN(scoreVal)) return alert("‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); const n = prompt("‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (Note):"); if(!n) return; await db.collection("users").doc(id).update({score: firebase.firestore.FieldValue.increment(scoreVal)}); await db.collection("checkin_logs").add({userId: id, type: 'manual_adjust', amount: scoreVal, note: n, timestamp: firebase.firestore.FieldValue.serverTimestamp()}); showToast("Saved!"); valInput.value = ""; valInput.blur(); } catch (e) { alert("Error saving score: " + e.message); } }

        // --- Certs Fix ---
        function renderCertTable(){
            const t = document.querySelector("#certsTable tbody"); t.innerHTML = "";
            if(!usersData.length) { t.innerHTML = "<tr><td colspan='4'>No users found.</td></tr>"; return; }
            const sortedUsers = usersData.filter(u=>!u.isIgnored).sort((a,b) => (b.certRequested?1:0) - (a.certRequested?1:0));
            sortedUsers.forEach(u => {
                let dateStr = (u.startDate && u.endDate) ? `${u.startDate} - ${u.endDate}` : '<span style="color:#ccc">Waiting Dates</span>';
                let status = u.certRequested ? '<span class="badge" style="background:#ffc107;color:black;">üîî Requesting</span>' : '-';
                let btn = `<button class="btn-sm btn-warning" onclick="openCertModal('${u.id}')">Preview / Edit</button>`;
                t.innerHTML += `<tr><td><img src="${u.pictureUrl}" class="user-pic"> ${u.displayName}</td><td>${dateStr}</td><td>${status}</td><td>${btn}</td></tr>`;
            });
        }
        function openCertModal(uid) {
            const u = usersData.find(x => x.id === uid);
            if(!u) return;
            certUser = { uid: u.id, name: u.displayName };
            document.getElementById('cert-start').value = u.startDate || "";
            document.getElementById('cert-end').value = u.endDate || "";
            updateCertPreview();
            document.getElementById('certModal').style.display = "block";
        }
        async function saveUserDates() {
            if(!certUser) return;
            const s = document.getElementById('cert-start').value;
            const e = document.getElementById('cert-end').value;
            await db.collection("users").doc(certUser.uid).update({ startDate: s, endDate: e, certRequested: false }); 
            showToast("Saved & Approved!");
            document.getElementById('certModal').style.display = "none";
        }

        // --- History Logic ---
        async function showHistory(uid, name, total) {
            currentHistoryUserId = uid;
            document.getElementById("history-title").innerText = `üìú ${name}`;
            document.getElementById("history-summary").innerText = `Total: ${total.toFixed(2)}`;
            document.getElementById("historyModal").style.display = "block";
            document.getElementById("history-list").innerHTML = "<p>Loading...</p>";
            
            try {
                let all = [];
                const [w, q, l] = await Promise.all([
                    db.collection("works").where("userId","==",uid).get(),
                    db.collection("quest_submissions").where("userId","==",uid).get(),
                    db.collection("checkin_logs").where("userId","==",uid).get()
                ]);
                
                w.forEach(d => { const x=d.data(); if(x.score>0) all.push({t:x.timestamp?.toDate(), type:'work', text:`üìÅ ${x.title}`, score:x.score}); });
                q.forEach(d => { 
                    const x=d.data(); 
                    const s=(x.earnedScore||0)+(x.bonusGiven||0);
                    const qObj = questsCache.find(q => q.id === x.questId);
                    const qName = qObj ? qObj.question : 'Quest';
                    const shortName = qName.length > 30 ? qName.substring(0,30)+'...' : qName;
                    if(x.status !== 'none') all.push({t:x.receivedAt?.toDate(), type:'bonus', text:`üöÄ Receive: ${shortName}`, score:0.1});
                    if(s>0) all.push({t:x.submittedAt?.toDate(), type:'quest', text:`‚ö° Submit: ${shortName}`, score:s}); 
                });
                l.forEach(d => { 
                    const x=d.data(); 
                    if(x.type==='streak') all.push({t:x.timestamp?.toDate(), type:'bonus', text:`üî• Streak`, score:x.amount, docId: d.id, source: 'checkin_logs'}); 
                    if(x.type==='manual_adjust' || x.type==='manual') all.push({t:x.timestamp?.toDate(), type:'manual', text:`üõ†Ô∏è ${x.note}`, score:x.amount, docId: d.id, source: 'checkin_logs'}); 
                });

                all.sort((a, b) => (b.t || 0) - (a.t || 0));
                historyCache = all.reverse(); 
                historyPage = 1;
                renderHistoryPage();
            } catch(e) { document.getElementById("history-list").innerHTML = "Error loading history"; }
        }

        async function recalculateUserScore(uid) {
            if(!confirm("Recalculate score from history?")) return;
            showToast("Calculating...");
            try {
                let totalScore = 0;
                const wSnap = await db.collection("works").where("userId", "==", uid).get();
                wSnap.forEach(d => { totalScore += (d.data().score || 0); });
                const qSnap = await db.collection("quest_submissions").where("userId", "==", uid).get();
                qSnap.forEach(d => { 
                    const data = d.data();
                    if(data.status !== 'none' && data.receivedAt) totalScore += 0.1;
                    totalScore += (data.earnedScore || 0) + (data.bonusGiven || 0);
                });
                const lSnap = await db.collection("checkin_logs").where("userId", "==", uid).get();
                lSnap.forEach(d => { totalScore += (d.data().amount || 0); });

                await db.collection("users").doc(uid).update({ score: totalScore });
                showToast(`New Score: ${totalScore.toFixed(2)}`);
                const user = usersData.find(u => u.id === uid);
                showHistory(uid, user ? user.displayName : 'User', totalScore);
            } catch (e) { alert(e.message); }
        }

        // --- üî• Archive Pagination V62 ---
        async function openArchiveModal() {
            const l = document.getElementById("archive-list");
            l.innerHTML = "Loading...";
            document.getElementById("archiveModal").style.display = "block";
            
            const s = await db.collection("side_quests").where("status", "==", "Archived").get();
            // Sort by Created At Descending (Newest First)
            archiveCache = s.docs.map(d => ({id: d.id, ...d.data()}))
                           .sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
            archivePage = 1;
            renderArchivePage();
        }

        function renderArchivePage() {
            const l = document.getElementById("archive-list");
            l.innerHTML = "";
            const start = (archivePage - 1) * ARCHIVE_PER_PAGE;
            const paged = archiveCache.slice(start, start + ARCHIVE_PER_PAGE);
            const totalPages = Math.ceil(archiveCache.length / ARCHIVE_PER_PAGE);

            if (paged.length === 0) {
                l.innerHTML = "<p style='text-align:center;color:#999'>No archived items.</p>";
                return;
            }

            paged.forEach(q => {
                let imgs = "";
                if(q.assignees) q.assignees.forEach(u => imgs += `<img src="${u.pic}" style="width:24px;height:24px;border-radius:50%;margin-right:2px;">`);
                l.innerHTML += `
                <div style="padding:10px;border-bottom:1px solid #ddd;display:flex;justify-content:space-between;align-items:center;">
                    <div><b>${q.title}</b> (+${q.archiveScore||0})<br>${imgs}</div>
                    <div>
                        <button class="btn-sm btn-success" onclick="restoreSQ('${q.id}','Done')">Restore</button> 
                        <button class="btn-sm btn-danger" onclick="delArchiveDoc('${q.id}')">Del</button>
                    </div>
                </div>`;
            });

            // Pagination Controls
            if (totalPages > 1) {
                const ctrl = document.createElement("div");
                ctrl.className = "history-controls"; 
                ctrl.innerHTML = `
                    <button class="btn-sm btn-dark" ${archivePage===1?'disabled':''} onclick="archivePage--;renderArchivePage()">< Prev</button>
                    <span style="align-self:center;">${archivePage} / ${totalPages}</span>
                    <button class="btn-sm btn-dark" ${archivePage===totalPages?'disabled':''} onclick="archivePage++;renderArchivePage()">Next ></button>
                `;
                l.appendChild(ctrl);
            }
        }

        // --- Leaderboard V62 Fix ---
        function renderLeaderboard(){
            const l = document.getElementById("leaderboardList");
            l.innerHTML="";
            
            // Check Data
            if (!usersData.length) {
                l.innerHTML = "<div style='text-align:center;padding:20px;color:#999;'>No user data found.</div>";
                return;
            }

            usersData.filter(u=>!u.isIgnored).slice(0,20).forEach((u,i)=>{
                const lv=Math.floor((u.score||0)/10)+1;
                let daysLeftHtml="";
                if(u.endDate){
                    const end=new Date(u.endDate);
                    const now=new Date();
                    const diff=Math.ceil((end-now)/(1000*60*60*24));
                    if(diff<0) daysLeftHtml=`<span class="badge" style="background:#28a745">‚úÖ ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</span>`;
                    else daysLeftHtml=`<span class="badge" style="background:#17a2b8">‚è≥ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${diff} ‡∏ß‡∏±‡∏ô</span>`;
                }
                
                l.innerHTML+=`
                <div class="lb-row">
                    <div class="lb-left">
                        <div class="lb-rank">#${i+1}</div>
                        <div class="lb-profile">
                            <img src="${u.pictureUrl}" class="lb-pic-lg">
                            <div class="lb-info">
                                <div class="lb-name">${u.displayName} <span class="lb-lv">Lv.${lv}</span></div>
                                <div class="lb-days">${daysLeftHtml}</div>
                            </div>
                        </div>
                    </div>
                    <div class="lb-right">
                        <div class="lb-score">${parseFloat((u.score||0).toFixed(2))}</div>
                    </div>
                </div>`;
            });
        }

        // ... Standard ...
        function initKanban() { ['Backlog','Doing','Review','Done'].forEach(id => { new Sortable(document.getElementById(id), { group:'kanban', animation:150, onEnd: e => { const ns=e.to.id; const up={status:ns}; if(ns==='Done')up.doneAt=firebase.firestore.FieldValue.serverTimestamp(); db.collection("side_quests").doc(e.item.dataset.id).update(up); }}); }); }
        function renderKanban(snap) { const cols={"Backlog":document.getElementById("Backlog"),"Doing":document.getElementById("Doing"),"Review":document.getElementById("Review"),"Done":document.getElementById("Done")}; Object.values(cols).forEach(e=>e.innerHTML=""); const cnt={"Backlog":0,"Doing":0,"Review":0,"Done":0}; const filter=document.getElementById('board-search').value.toLowerCase(); snap.forEach(doc => { const q=doc.data(); sideQuestsCache[doc.id]=q; if(q.status==='Archived')return; let match = q.title.toLowerCase().includes(filter); if(q.assignees) q.assignees.forEach(u=>{if(u.name.toLowerCase().includes(filter)) match=true;}); if(!match) return; if(cols[q.status]) { cnt[q.status]++; const isProj = q.isProject === true; const d=document.createElement('div'); d.className=`kanban-card card-${q.status} ${q.isScored?'scored':''} ${isProj?'project':''}`; d.dataset.id=doc.id; let imgs='<div class="assignee-stack">'; if(q.assignees)q.assignees.forEach(u=>imgs+=`<img src="${u.pic}" class="assignee-img" title="${u.name}">`); imgs+='</div>'; let timersHtml = ""; if(q.refQuestId && q.assigneeIds && q.assigneeIds.length > 0) { const globalQ = questsCache.find(x => x.id === q.refQuestId); const subKey = `${q.refQuestId}_${q.assigneeIds[0]}`; const sub = questsSubCache[subKey]; if(globalQ && globalQ.deadline && q.status !== 'Done') { timersHtml += `<span class="timer-global" data-dead="${globalQ.deadline.toDate().getTime()}">‚è≥ Exp: ...</span>`; } if(sub) { if(sub.status === 'received' && sub.deadline && q.status === 'Doing') { timersHtml += `<span class="timer-active" data-dead="${sub.deadline.toDate().getTime()}">‚è±Ô∏è ...</span>`; } else if (sub.status === 'unsuccessful' && sub.cooldownUntil && q.status === 'Backlog') { timersHtml += `<span class="timer-cooldown" data-dead="${sub.cooldownUntil.toDate().getTime()}">‚ùÑÔ∏è Cool: ...</span>`; } } } let act=""; if(q.status==='Done'&&q.doneAt) act=`<button class="btn-sm btn-dark" style="width:100%;margin-top:5px;" onclick="archiveSQ('${doc.id}')">üì• ar¬∑chive</button>`; else if(!q.isScored && q.status!=='Backlog' && q.status!=='Done') act=`<button class="btn-sm btn-success" style="width:100%;margin-top:5px;" onclick="giveScore('${doc.id}')">üí∞ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>`; let chatBtn = ""; if(isProj) chatBtn = `<button class="btn-sm" style="color:var(--primary); font-size:1.1em;" onclick="openChat('${doc.id}', '${q.title}')"><i class="fa-solid fa-comments"></i></button>`; let arrows = `<div class="arrow-controls">`; if(q.status!=='Backlog') arrows+=`<button class="btn-arrow" onclick="moveCard('${doc.id}','prev')"><i class="fa-solid fa-chevron-left"></i></button>`; if(q.status!=='Done') arrows+=`<button class="btn-arrow" onclick="moveCard('${doc.id}','next')"><i class="fa-solid fa-chevron-right"></i></button>`; arrows += `</div>`; let pColor = '#17a2b8'; if(q.priority==='Medium') pColor='#ff9f1c'; if(q.priority==='High') pColor='#ef233c'; d.innerHTML=`<div class="card-header-row"><span class="badge" style="background:${pColor}">${q.priority}</span><div class="card-header-right">${imgs} ${arrows}</div></div><div style="font-weight:bold;">${isProj?'<span class="badge" style="background:#e83e8c;font-size:0.6em;">PROJ</span>':''} ${q.title}</div><div class="card-timers">${timersHtml}</div><p style="font-size:0.85em; color:#666; margin-bottom:5px;">${q.description||'-'}</p><div class="card-tool-row"><div><button class="btn-sm btn-warning" onclick="openTaskModal('${doc.id}')"><i class="fa-solid fa-pen"></i></button><button class="btn-sm btn-danger" onclick="startDeleteCard('${doc.id}')"><i class="fa-solid fa-trash"></i></button></div>${chatBtn}</div>${act}`; cols[q.status].appendChild(d); } }); Object.keys(cnt).forEach(k=>document.getElementById(`cnt-${k}`).innerText=cnt[k]); }
        function updateRealtimeTimers() { const now = Date.now(); document.querySelectorAll('.timer-global').forEach(el => { const d = parseInt(el.dataset.dead); const diff = d - now; if(diff <= 0) el.innerText = "‚è≥ Expired"; else { const h = Math.floor(diff/3600000); const m = Math.floor((diff%3600000)/60000); el.innerText = `‚è≥ Ends: ${h}h ${m}m`; } }); document.querySelectorAll('.timer-active').forEach(el => { const d = parseInt(el.dataset.dead); const diff = d - now; if(diff <= 0) { el.innerText = "‚è±Ô∏è Time Up!"; const card = el.closest('.kanban-card'); if(card && card.parentElement.id === 'Doing') { db.collection("side_quests").doc(card.dataset.id).update({status: 'Review'}); } } else { const m = Math.floor(diff/60000); const s = Math.floor((diff%60000)/1000); el.innerText = `‚è±Ô∏è ${m}m ${s}s`; } }); document.querySelectorAll('.timer-cooldown').forEach(el => { const d = parseInt(el.dataset.dead); const diff = d - now; if(diff <= 0) el.innerText = "‚ùÑÔ∏è Ready"; else { const m = Math.floor(diff/60000); const s = Math.floor((diff%60000)/1000); el.innerText = `‚ùÑÔ∏è Cool: ${m}m ${s}s`; } }); updateQuestTimers(); }
        function startDeleteCard(id) { deleteCardId=id; document.getElementById('delCardModal').style.display='block'; const btn=document.getElementById('btn-del-card-confirm'); btn.disabled=false; btn.style.background='#ef233c'; let c=5; btn.innerText=`Confirm (${c})`; if(deleteTimer)clearInterval(deleteTimer); deleteTimer=setInterval(()=>{c--;btn.innerText=`Confirm (${c})`;if(c<=0){clearInterval(deleteTimer);document.getElementById('delCardModal').style.display='none';showToast("Cancelled");}},1000); btn.onclick=executeDeleteCard; }
        async function executeDeleteCard() { if(!deleteCardId)return; clearInterval(deleteTimer); document.getElementById('delCardModal').style.display='none'; const deduct=confirm("‡∏´‡∏±‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö?\nOK=‡∏´‡∏±‡∏Å, Cancel=‡πÑ‡∏°‡πà‡∏´‡∏±‡∏Å"); try{const q=sideQuestsCache[deleteCardId]; const b=db.batch(); if(deduct&&q.assigneeIds){const s=prompt("Points to deduct (e.g., 0.5):"); if(s){q.assigneeIds.forEach(u=>{b.update(db.collection("users").doc(u),{score:firebase.firestore.FieldValue.increment(-parseFloat(s))}); b.set(db.collection("checkin_logs").doc(),{userId:u,type:'manual_adjust',amount:-parseFloat(s),note:`Del: ${q.title}`,timestamp:firebase.firestore.FieldValue.serverTimestamp()});});}} b.delete(db.collection("side_quests").doc(deleteCardId)); await b.commit(); showToast("Deleted!");}catch(e){alert(e.message);} }
        function openTaskModal(id=null){document.getElementById('taskModal').style.display='block';if(id){const q=sideQuestsCache[id];document.getElementById('edit-id').value=id;document.getElementById('sq-title').value=q.title;document.getElementById('sq-desc').value=q.description;document.getElementById('sq-priority').value=q.priority;document.getElementById('sq-due').value=q.dueDate||"";document.getElementById('sq-isProject').checked=q.isProject||false;}else{document.getElementById('edit-id').value="";document.getElementById('sq-title').value="";document.getElementById('sq-desc').value="";}}
        async function saveSideQuest(){const id=document.getElementById('edit-id').value;const t=document.getElementById('sq-title').value;if(!t)return alert("Title?");const d={title:t,description:document.getElementById('sq-desc').value,priority:document.getElementById('sq-priority').value,dueDate:document.getElementById('sq-due').value,isProject:document.getElementById('sq-isProject').checked,assigneeIds:[...document.querySelectorAll('.sq-user-check:checked')].map(c=>c.value),assignees:[...document.querySelectorAll('.sq-user-check:checked')].map(c=>({uid:c.value,name:c.dataset.name,pic:c.dataset.pic}))};if(id){await db.collection("side_quests").doc(id).update(d);showToast("Updated");}else{d.status="Backlog";d.createdAt=firebase.firestore.FieldValue.serverTimestamp();await db.collection("side_quests").add(d);showToast("Created");}document.getElementById('taskModal').style.display='none';}
        let chatUnsub;function openChat(id,title){document.getElementById('chatModal').style.display='block';document.getElementById('chat-title').innerText=`üí¨ ${title}`;document.getElementById('chat-card-id').value=id;const box=document.getElementById('chat-box');box.innerHTML="Loading...";if(chatUnsub)chatUnsub();chatUnsub=db.collection("side_quests").doc(id).collection("comments").orderBy("timestamp","asc").onSnapshot(snap=>{box.innerHTML="";snap.forEach(d=>{const m=d.data();const cls=m.sender==='Admin'?'msg-admin':'msg-user';let pic=m.pic?`<img src="${m.pic}" class="chat-avatar">`:'<div class="chat-avatar" style="background:#ccc;">?</div>';if(m.sender==='Admin')pic='<div class="chat-avatar" style="background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;">A</div>';let msg=m.msg.replace(/@([^\s]+)/g,(match,name)=>{const q=sideQuestsCache[id];const inP=q.assignees&&q.assignees.some(u=>u.name.toLowerCase().includes(name.toLowerCase()));return inP?`<span class="tag-in">${match}</span>`:`<span class="tag-out">${match}</span>`;});box.innerHTML+=`<div class="chat-msg ${cls}">${pic}<div><b>${m.sender}</b>: ${msg}</div></div>`;});box.scrollTop=box.scrollHeight;});}
        async function sendChat(){const t=document.getElementById('chat-input').value.trim();const id=document.getElementById('chat-card-id').value;if(!t)return;await db.collection("side_quests").doc(id).collection("comments").add({msg:t,sender:'Admin',timestamp:firebase.firestore.FieldValue.serverTimestamp()});document.getElementById('chat-input').value="";}
        
        async function delArchiveDoc(id){if(confirm("Del?"))await db.collection("side_quests").doc(id).delete();openArchiveModal();}
        async function restoreSQ(id,t){await db.collection("side_quests").doc(id).update({status:t,doneAt:firebase.firestore.FieldValue.serverTimestamp()});openArchiveModal();showToast("Restored");}
        function confirmClearArchive(){document.getElementById('clearConfirmModal').style.display='block';const btn=document.getElementById('btn-confirm-clear');btn.disabled=true;btn.style.background='#ccc';let c=5;btn.innerText=`Confirm (${c})`;const t=setInterval(()=>{c--;btn.innerText=`Confirm (${c})`;if(c<=0){clearInterval(t);btn.disabled=false;btn.style.background='#ef233c';btn.innerText="CLEAR ALL";btn.onclick=async()=>{document.getElementById('clearConfirmModal').style.display='none';const s=await db.collection("side_quests").where("status","==","Archived").get();const b=db.batch();s.forEach(d=>b.delete(d.ref));await b.commit();showToast("Cleared!");openArchiveModal();}}},1000);}
        function renderHistoryPage(){const l=document.getElementById("history-list");const c=document.getElementById("history-controls");l.innerHTML="";c.innerHTML="";const s=(historyPage-1)*HISTORY_PER_PAGE;const p=historyCache.slice(s,s+HISTORY_PER_PAGE);const t=Math.ceil(historyCache.length/HISTORY_PER_PAGE);p.forEach(e=>{const d=e.t?e.t.toLocaleString('th-TH'):'-';let cls=e.type==='bonus'?'bonus':(e.type==='manual'?'manual':'');let delBtn="";if(e.source==='checkin_logs'&&e.docId){delBtn=`<button class="btn-del-hist" onclick="deleteHistoryLog('${e.docId}', ${e.score})">‚úï Delete</button>`;}l.innerHTML+=`<li style="padding:10px;border-bottom:1px solid #eee;" class="${cls}"><div style="display:flex;justify-content:space-between;align-items:center;"><div>${e.text} ${delBtn}</div><span style="font-weight:bold;">${e.score>0?'+':''}${e.score}</span></div><small style="color:#888">${d}</small></li>`});if(t>1){c.innerHTML=`<button class="btn-sm btn-dark" ${historyPage===1?'disabled':''} onclick="historyPage--;renderHistoryPage()">< Prev</button> <span style="align-self:center;">${historyPage}/${t}</span> <button class="btn-sm btn-dark" ${historyPage===t?'disabled':''} onclick="historyPage++;renderHistoryPage()">Next ></button>`;}}
        async function deleteHistoryLog(logId, amount) { if(!confirm(`Delete log and revert ${amount} points?`)) return; try { await db.collection("users").doc(currentHistoryUserId).update({score: firebase.firestore.FieldValue.increment(-amount)}); await db.collection("checkin_logs").doc(logId).delete(); showToast("Reverted!"); const user = usersData.find(u => u.id === currentHistoryUserId); showHistory(currentHistoryUserId, user ? user.displayName : 'User', (user ? user.score : 0) - amount); } catch(e) { alert(e.message); } }
        function updateAssigneeList(){const d=document.getElementById('sq-user-list');d.innerHTML="";usersData.forEach(u=>{if(!u.isIgnored)d.innerHTML+=`<label style="margin-right:5px"><input type="checkbox" class="sq-user-check" value="${u.id}" data-name="${u.displayName}" data-pic="${u.pictureUrl}"> ${u.displayName}</label>`});}
        async function moveCard(id,dir){const q=sideQuestsCache[id];const f=['Backlog','Doing','Review','Done'];const c=f.indexOf(q.status);let n=q.status;if(dir==='next'&&c<3)n=f[c+1];if(dir==='prev'&&c>0)n=f[c-1];if(n!==q.status){const u={status:n};if(n==='Done')u.doneAt=firebase.firestore.FieldValue.serverTimestamp();await db.collection("side_quests").doc(id).update(u);}}
        async function giveScore(id){const q=sideQuestsCache[id];if(!q)return;const s=prompt("Score:","0.5");if(!s)return;const n=prompt("Note:",q.title);const b=db.batch();q.assigneeIds.forEach(u=>{b.update(db.collection("users").doc(u),{score:firebase.firestore.FieldValue.increment(parseFloat(s))});b.set(db.collection("checkin_logs").doc(),{userId:u,type:'manual',amount:parseFloat(s),note:n,timestamp:firebase.firestore.FieldValue.serverTimestamp()})});b.update(db.collection("side_quests").doc(id),{status:'Done',isScored:true,archiveScore:parseFloat(s),doneAt:firebase.firestore.FieldValue.serverTimestamp()});await b.commit();showToast("Scored!");}
        async function archiveSQ(id){if(confirm("Archive?"))await db.collection("side_quests").doc(id).update({status:'Archived'});}
        async function delUser(id){if(confirm("Del?"))await db.collection("users").doc(id).delete();}
        async function delWork(id){if(confirm("Del?"))await db.collection("works").doc(id).delete();}
        function toggleIgnoreUser(id,s){db.collection("users").doc(id).update({isIgnored:!s});}
        function toggleForm(){const f=document.getElementById('sq-form');f.style.display=f.style.display==='none'?'block':'none';}
        function filterBoard(){renderKanban({forEach:cb=>{Object.values(sideQuestsCache).forEach(q=>cb({data:()=>q,id:Object.keys(sideQuestsCache).find(k=>sideQuestsCache[k]===q)}))}});}
        function filterUsers(){renderTable('users');}
        function openShareModal(){document.getElementById('shareModal').style.display='block';}
        async function copyLB(showName){document.getElementById('shareModal').style.display='none';if(!usersData.length)return alert("No Data");let t="üèÜ Leaderboard\n";const top=usersData.filter(u=>!u.isIgnored).sort((a,b)=>(b.score-a.score)).slice(0,20);top.forEach((u,i)=>{t+=`${i+1}. ${showName?u.displayName:`Lv.${Math.floor(u.score/10)+1}`} (${parseFloat((u.score||0).toFixed(2))})\n`});if(liff.isInClient())liff.shareTargetPicker([{type:"text",text:t}]);else{try{await navigator.clipboard.writeText(t);alert("Copied!");}catch(e){const ta=document.createElement('textarea');ta.value=t;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);alert("Copied (Manual)!");}}}
        function copyHistory(){navigator.clipboard.writeText("Copied!").then(()=>showToast("Copied"));}
        function closeModal(){document.querySelectorAll('.modal').forEach(m=>m.style.display='none');}
        function showToast(m){const x=document.getElementById("toast");x.innerText=m;x.className="show";setTimeout(()=>x.className="",3000);}
        async function svSc(id,uid){const v=prompt("Score:");if(v){await db.collection("works").doc(id).update({score:parseFloat(v),status:'‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß'});await db.collection("users").doc(uid).update({score:firebase.firestore.FieldValue.increment(parseFloat(v))});showToast("Saved");}}
        async function createQuest(){const q={question:document.getElementById('q-text').value,imageUrl:document.getElementById('q-img').value,questLink:document.getElementById('q-link').value,baseScore:parseFloat(document.getElementById('q-score').value),durationMinutes:parseInt(document.getElementById('q-duration').value),deadline:new Date(Date.now()+parseFloat(document.getElementById('q-hours').value)*3600000),createdAt:firebase.firestore.FieldValue.serverTimestamp()};if(q.question)await db.collection("quests").add(q);showToast("Posted");}
        function loadActiveQuests(){db.collection("quests").orderBy("createdAt","desc").limit(10).onSnapshot(s=>{const t=document.querySelector("#activeQuestTable tbody");t.innerHTML="";let hasActive=false;s.forEach(d=>{const q=d.data();if(q.deadline?.toDate()>new Date()){hasActive=true;t.innerHTML+=`<tr><td>${q.question}</td><td><span class="quest-deadline" data-deadline="${q.deadline.toDate().getTime()}">Loading...</span></td><td>${q.durationMinutes||30} min</td><td><button class="btn-sm btn-warning" onclick="editQ('${d.id}','${q.question.replace(/'/g,"")}')">‚úèÔ∏è</button> <button class="btn-delete-icon" onclick="stopQ('${d.id}')">‚úï</button></td></tr>`;}});document.getElementById("active-quest-section").style.display=hasActive?"block":"none";});}
        function loadQuestHistory(){db.collection("quests").orderBy("createdAt","desc").limit(20).onSnapshot(s=>{const t=document.querySelector("#questHistoryTable tbody");t.innerHTML="";s.forEach(d=>{const q=d.data();if(q.deadline&&q.deadline.toDate()>new Date())return;t.innerHTML+=`<tr><td>${q.question}</td><td>${q.baseScore}</td><td><div style="display:flex;gap:5px;"><button class="btn-sm btn-success" onclick="recallQuest('${d.id}')">‚ôªÔ∏è Recall</button><button class="btn-delete-icon" onclick="delQ('${d.id}')">‚úï</button></div></td></tr>`;})});}
        function updateQuestTimers(){document.querySelectorAll('.quest-deadline').forEach(el=>{const d=parseInt(el.dataset.deadline);const now=Date.now();if(d-now<=0)el.innerText="Expired";else{const h=Math.floor((d-now)/3600000);const m=Math.floor(((d-now)%3600000)/60000);el.innerText=`${h}h ${m}m left`;}});}
        function recallQuest(id){db.collection("quests").doc(id).get().then(doc=>{const d=doc.data();document.getElementById('q-text').value=d.question;document.getElementById('q-img').value=d.imageUrl||"";document.getElementById('q-link').value=d.questLink||"";document.getElementById('q-score').value=d.baseScore;document.getElementById('q-duration').value=d.durationMinutes||30;showToast("Recalled!");});}
        async function editQ(id,q){const nq=prompt("Edit Q:",q);if(nq)await db.collection("quests").doc(id).update({question:nq});}
        async function stopQ(id){if(confirm("Stop?"))await db.collection("quests").doc(id).update({deadline:new Date()});}
        async function delQ(id){if(confirm("Del?"))await db.collection("quests").doc(id).delete();}
        async function updateCertPreview(){const c=document.getElementById('cert-canvas'),ctx=c.getContext('2d');c.width=800;c.height=600;ctx.fillStyle="#fff";ctx.fillRect(0,0,800,600);ctx.strokeStyle="#4361ee";ctx.lineWidth=10;ctx.strokeRect(0,0,800,600);ctx.fillStyle="#333";ctx.textAlign="center";ctx.font="bold 40px Arial";ctx.fillText("CERTIFICATE",400,150);ctx.font="30px Arial";ctx.fillStyle="#4361ee";ctx.fillText(certUser.name,400,300);ctx.fillStyle="#333";ctx.font="20px Arial";const s=document.getElementById('cert-start').value,e=document.getElementById('cert-end').value;ctx.fillText(s&&e?`${s} - ${e}`:"Date not set",400,400);}
        function generateCertPDF(){const{jsPDF}=window.jspdf;const doc=new jsPDF('l');doc.addImage(document.getElementById('cert-canvas').toDataURL('image/jpeg'),'JPEG',10,10,280,190);doc.save("cert.pdf");}
    </script>
</body>
</html>
