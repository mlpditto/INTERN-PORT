<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLP-INTERN-PORT</title>
    
    <link rel="stylesheet" href="style.css">
    
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        /* Login Screen Style */
        #login-screen {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; background: #f0f2f5; font-family: sans-serif;
        }
        #dashboard-container { display: none; }
        
        .login-card {
            background: white; padding: 40px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center;
            max-width: 400px; width: 90%;
        }
        .input-group { margin-top: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; color: #666; font-size: 0.9em; }
        .input-group input {
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px;
            font-size: 16px; box-sizing: border-box;
        }
        .magic-btn {
            background: #007bff; color: white; border: none; border-radius: 6px;
            padding: 12px; width: 100%; margin-top: 20px; font-size: 16px; cursor: pointer;
            transition: 0.2s; font-weight: bold;
        }
        .magic-btn:hover { background: #0056b3; }
        .magic-btn:disabled { background: #ccc; cursor: not-allowed; }
        
        #status-msg { margin-top: 15px; font-size: 0.9em; line-height: 1.5; }
        .success-msg { color: #28a745; background: #d4edda; padding: 10px; border-radius: 4px; }
        .error-msg { color: #dc3545; }

        /* Dashboard Styles */
        .tab-nav { display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px; overflow-x: auto; }
        .tab-btn { padding: 15px 20px; cursor: pointer; border: none; background: none; font-weight: 600; color: var(--gray); white-space: nowrap; }
        .tab-btn.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #555; }
        .action-group { display: flex; gap: 5px; }
        .btn-icon { padding: 5px 10px; font-size: 14px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h2>üîê Admin Access</h2>
            <p style="color: #666;">‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÅ‡∏ö‡∏ö‡πÑ‡∏£‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Magic Link)</p>
            
            <div id="login-form">
                <div class="input-group">
                    <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</label>
                    <input type="email" id="email-input" placeholder="medlifeplus@gmail.com" value="medlifeplus@gmail.com">
                </div>
                <button class="magic-btn" id="send-btn" onclick="sendMagicLink()">‚ú® ‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏•</button>
            </div>

            <div id="status-msg"></div>
        </div>
    </div>

    <div id="dashboard-container" class="container" style="max-width: 1000px; padding-top: 20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap: wrap; gap: 10px;">
            <h2>üë®‚Äçüíª Admin Dashboard</h2>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <span id="admin-email" style="font-size: 0.9em; color: #666;"></span>
                <button class="btn btn-sm btn-danger" onclick="logout()">Logout</button>
                <button class="btn btn-sm btn-secondary" onclick="location.reload()">üîÑ Refresh</button>
                <button class="btn btn-sm" style="background-color: #00B900; color: white;" onclick="shareLeaderboard()">üì§ ‡πÅ‡∏ä‡∏£‡πå‡∏ú‡∏•</button>
            </div>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('tab-users')">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
            <button class="tab-btn" onclick="switchTab('tab-works')">üìÑ ‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô</button>
            <button class="tab-btn" onclick="switchTab('tab-leaderboard')">üèÜ Leaderboard</button>
        </div>

        <div id="tab-users" class="tab-content active">
            <div class="card">
                <input type="text" id="userSearch" style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ddd; border-radius:8px;" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." onkeyup="filterUsers()">
                <div style="overflow-x:auto;"><table id="usersTable"><thead><tr><th>‡∏£‡∏π‡∏õ</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>Level</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th><th>‡∏•‡∏ö</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>
        <div id="tab-works" class="tab-content">
            <div class="card"><div style="overflow-x:auto;"><table id="worksTable"><thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th><th>‡∏•‡∏¥‡∏á‡∏Å‡πå</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏•‡∏ö</th></tr></thead><tbody></tbody></table></div></div>
        </div>
        <div id="tab-leaderboard" class="tab-content">
            <div class="grid-container" id="leaderboardGrid"></div>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        // üîí CONFIG
        const ALLOWED_EMAIL = "medlifeplus@gmail.com";
        const ADMIN_LIFF_ID = "2008959998-yjcNpaGt"; // ‡πÉ‡∏™‡πà LIFF ID ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        
        // ‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏´‡∏ô‡πâ‡∏≤ Admin ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πä‡∏∞‡πÜ
        const MY_URL = 'https://mlpditto.github.io/INTERN-PORT/admin.html'; 

        const auth = firebase.auth();

        // --- 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ---
        if (auth.isSignInWithEmailLink(window.location.href)) {
            // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πà: ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Login ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            let email = window.localStorage.getItem('emailForSignIn');
            if (!email) {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î ‡∏´‡∏£‡∏∑‡∏≠ Browser ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥ ‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡πÄ‡∏°‡∏•‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö
                email = window.prompt('‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á:');
            }
            
            if(email) {
                document.getElementById('status-msg').innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô...";
                auth.signInWithEmailLink(email, window.location.href)
                    .then((result) => {
                        window.localStorage.removeItem('emailForSignIn'); // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á
                        // redirect ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πâ‡∏≤‡∏á URL ‡∏ó‡∏µ‡πà‡∏¢‡∏≤‡∏ß‡πÜ ‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏õ ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ï‡∏≤
                        window.location.replace(MY_URL); 
                    })
                    .catch((error) => {
                        document.getElementById('status-msg').innerHTML = `<span class="error-msg">Error: ${error.message}</span>`;
                    });
            }
        }

        // --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå (Magic Link) ---
        function sendMagicLink() {
            const email = document.getElementById('email-input').value.trim();
            const btn = document.getElementById('send-btn');
            const status = document.getElementById('status-msg');

            // Gatekeeper: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡πÄ‡∏•‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏ß‡∏•‡∏≤
            if (email !== ALLOWED_EMAIL) {
                status.innerHTML = `<span class="error-msg">‚õî ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö</span>`;
                return;
            }

            const actionCodeSettings = {
                url: MY_URL, // ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
                handleCodeInApp: true
            };

            btn.disabled = true;
            btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";

            auth.sendSignInLinkToEmail(email, actionCodeSettings)
                .then(() => {
                    window.localStorage.setItem('emailForSignIn', email); // ‡∏à‡∏≥‡πÄ‡∏°‡∏•‡πÑ‡∏ß‡πâ
                    status.innerHTML = `
                        <div class="success-msg">
                            <b>‚úÖ ‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!</b><br>
                            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ Inbox (‡∏´‡∏£‡∏∑‡∏≠ Junk) ‡∏Ç‡∏≠‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏• <b>${email}</b><br>
                            ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                        </div>`;
                    btn.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°
                    document.getElementById('login-form').style.display = 'none';
                })
                .catch((error) => {
                    btn.disabled = false;
                    btn.innerText = "‚ú® ‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏•";
                    status.innerHTML = `<span class="error-msg">‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}</span>`;
                });
        }

        // --- 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
        auth.onAuthStateChanged((user) => {
            if (user) {
                if (user.email === ALLOWED_EMAIL) {
                    // ‚úÖ Login ‡∏ú‡πà‡∏≤‡∏ô
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('dashboard-container').style.display = 'block';
                    document.getElementById('admin-email').innerText = user.email;
                    initSystem();
                } else {
                    alert(`‡∏≠‡∏µ‡πÄ‡∏°‡∏• ${user.email} ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ñ‡∏£‡∏±‡∏ö`);
                    auth.signOut();
                }
            }
        });

        function logout() {
            if(confirm("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?")) auth.signOut().then(() => location.reload());
        }

        // --- System & Tab Logic (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
        let isInit = false;
        async function initSystem() {
            if(isInit) return; isInit = true;
            try { await liff.init({ liffId: ADMIN_LIFF_ID }); } catch(e) {}
            loadUsers(); loadWorks();
        }
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô loadUsers, loadWorks, delete, share ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÉ‡∏™‡πà‡∏ï‡πà‡∏≠‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà)
        // ... Copy Logic ‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ...
        
        let allUsers = [];
        function loadUsers() {
             db.collection("users").orderBy("score", "desc").onSnapshot((snapshot) => {
                const userTable = document.querySelector("#usersTable tbody");
                const leaderboard = document.getElementById("leaderboardGrid");
                userTable.innerHTML = ""; leaderboard.innerHTML = "";
                allUsers = [];
                let rank = 1;
                snapshot.forEach(doc => {
                    const u = doc.data();
                    const uid = doc.id;
                    const level = Math.floor(u.score / 10) + 1;
                    allUsers.push({ uid, ...u, level });
                    userTable.innerHTML += `<tr>
                        <td><img src="${u.pictureUrl}" style="width:30px; border-radius:50%"></td>
                        <td class="u-name">${u.displayName}</td>
                        <td><span class="badge" style="background:#eee">Lv.${level}</span></td>
                        <td style="font-weight:bold;">${u.score}</td>
                        <td><div class="action-group"><button class="btn btn-sm btn-primary" onclick="adjScore('${uid}', 1)">+1</button><button class="btn btn-sm btn-danger" onclick="adjScore('${uid}', -1)">-1</button><button class="btn btn-sm btn-secondary" onclick="setScore('${uid}')">Set</button></div></td>
                        <td><button class="btn btn-sm btn-danger" onclick="deleteUser('${uid}', '${u.displayName}')">üóëÔ∏è</button></td>
                    </tr>`;
                    if (rank <= 10) { leaderboard.innerHTML += `<div class="card text-center" style="margin-bottom:0"><h4>#${rank} ${u.displayName}</h4><div class="badge badge-gold">${u.score} ‡πÅ‡∏ï‡πâ‡∏°</div></div>`; }
                    rank++;
                });
            });
        }
        function loadWorks() {
             db.collection("works").orderBy("timestamp", "desc").limit(50).onSnapshot((snapshot) => {
                const tbody = document.querySelector("#worksTable tbody");
                tbody.innerHTML = "";
                snapshot.forEach(doc => {
                    const w = doc.data();
                    const id = doc.id;
                    tbody.innerHTML += `<tr><td>${w.timestamp?w.timestamp.toDate().toLocaleString('th-TH'):'..'}</td><td>${w.displayName}</td><td>${w.title}</td><td><a href="${w.link}" target="_blank" class="btn btn-sm btn-secondary">‡πÄ‡∏õ‡∏¥‡∏î</a></td>
                    <td><select onchange="updateStatus('${id}', this.value)"><option ${w.status==='‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à'?'selected':''}>‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à</option><option ${w.status==='‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß'?'selected':''}>‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß</option><option ${w.status==='‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'?'selected':''}>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</option></select></td>
                    <td><button class="btn btn-sm btn-danger" onclick="deleteWork('${id}', '${w.title}')">üóëÔ∏è</button></td></tr>`;
                });
            });
        }
        // Helper functions
        async function deleteWork(docId, title) { if(confirm(`‡∏•‡∏ö‡∏á‡∏≤‡∏ô "${title}"?`)) try { await db.collection("works").doc(docId).delete(); } catch(e) { alert(e.message); } }
        async function deleteUser(uid, name) { if (confirm(`‡∏•‡∏ö User "${name}"?`)) try { await db.collection("users").doc(uid).delete(); } catch (e) { alert(e.message); } }
        async function adjScore(uid, val) { try { await db.collection("users").doc(uid).update({ score: firebase.firestore.FieldValue.increment(val) }); } catch(e) { alert(e.message); } }
        async function setScore(uid) { let val = prompt("‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡∏°‡πà:"); if(val) await db.collection("users").doc(uid).update({ score: parseInt(val) }); }
        async function updateStatus(docId, newStatus) { try { await db.collection("works").doc(docId).update({ status: newStatus }); } catch(e) { alert(e.message); } }
        function filterUsers() { const term = document.getElementById('userSearch').value.toLowerCase(); document.querySelectorAll('.user-row').forEach(row => { row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none'; }); }
        async function shareLeaderboard() { if (!liff.isLoggedIn()) { liff.login(); return; } if (liff.isApiAvailable('shareTargetPicker')) liff.shareTargetPicker([{type:"text", text:"Share Feature"}]); }
    </script>
</body>
</html>

