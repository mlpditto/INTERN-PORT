<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLP INTERNSHIP V.260125</title>
    <link rel="stylesheet" href="style.css">
    
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        /* CSS ‡πÄ‡∏î‡∏¥‡∏° */
        body{font-family:sans-serif; background:#f0f2f5; margin:0;}
        #login-screen { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; }
        #dashboard-container { display:none; max-width:1100px; margin:20px auto; padding:20px; }
        .login-card { background:white; padding:40px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1); width:90%; max-width:400px; text-align:center; }
        .input-group { margin-top:15px; text-align:left; } .input-group input { width:100%; padding:10px; border:1px solid #ccc; border-radius:5px; box-sizing:border-box; }
        .magic-btn { background:#007bff; color:white; border:none; padding:12px; width:100%; border-radius:5px; margin-top:20px; cursor:pointer; font-weight:bold; }
        
        /* Dashboard Elements */
        .tab-nav { display:flex; border-bottom:2px solid #ddd; margin-bottom:20px; overflow-x:auto; }
        .tab-btn { padding:15px 20px; border:none; background:none; cursor:pointer; font-weight:bold; color:#666; white-space:nowrap; }
        .tab-btn.active { color:#007bff; border-bottom:3px solid #007bff; }
        .tab-content { display:none; } .tab-content.active { display:block; }
        
        /* Tables */
        table { width:100%; border-collapse:collapse; background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 5px rgba(0,0,0,0.05); margin-bottom:20px; }
        th, td { padding:12px; text-align:left; border-bottom:1px solid #eee; vertical-align:middle; }
        th { background:#f8f9fa; color:#555; font-size:0.9em; }
        
        /* Components */
        .btn-sm { padding:5px 10px; border-radius:4px; border:none; cursor:pointer; color:white; font-size:0.85em; margin:2px; }
        .btn-primary { background:#007bff; } .btn-danger { background:#dc3545; } .btn-success { background:#28a745; } .btn-warning { background:#ffc107; color:black; } .btn-dark { background:#343a40; }
        .badge { padding:4px 8px; border-radius:10px; font-size:0.8em; color:white; }
        .user-pic { width:35px; height:35px; border-radius:50%; object-fit:cover; border:1px solid #ddd; vertical-align:middle; margin-right:8px; }
        
        /* Sections */
        .section-header { display:flex; justify-content:space-between; align-items:center; background:#e9ecef; padding:10px 15px; border-radius:5px 5px 0 0; font-weight:bold; color:#495057; }
        .quest-create-card, .active-quest-card { background:white; padding:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.05); margin-bottom:20px; }
        .active-quest-card { border-left:5px solid #28a745; background:#f4fbf6; }
        .leaderboard-card { background:white; padding:10px 15px; margin-bottom:10px; border-radius:8px; display:flex; align-items:center; justify-content:space-between; border-left:5px solid #ddd; }
        .rank-1 { border-color:#ffd700; } .rank-2 { border-color:#c0c0c0; } .rank-3 { border-color:#cd7f32; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h2>üîê Admin Check</h2>
            <div id="login-form">
                <div class="input-group"><label>Email</label><input type="email" id="email-input" value="medlifeplus@gmail.com"></div>
                <button class="magic-btn" onclick="sendMagicLink()">‚ú® ‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏•</button>
            </div>
            <div id="status-msg" style="margin-top:15px; color:red;"></div>
        </div>
    </div>

    <div id="dashboard-container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>üë®‚Äçüíª Admin Dashboard</h2>
            <div>
                <button class="btn-sm btn-success" onclick="shareLeaderboard()">üì§ ‡πÅ‡∏ä‡∏£‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                <button class="btn-sm btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('tab-works')">üìÑ ‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô & Quest</button>
            <button class="tab-btn" onclick="switchTab('tab-manage-quest')">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Quest</button>
            <button class="tab-btn" onclick="switchTab('tab-users')">üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ & ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
            <button class="tab-btn" onclick="switchTab('tab-leaderboard')">üèÜ Leaderboard</button>
        </div>

        <div id="tab-works" class="tab-content active">
            
            <div class="section-header">üìÅ ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ / ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô</div>
            <div style="overflow-x:auto;">
                <table id="worksTable">
                    <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á</th><th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th><th>‡∏•‡∏¥‡∏á‡∏Å‡πå</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</th><th>‡∏•‡∏ö</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="section-header" style="margin-top:30px;">‚ö° Quest Submissions (‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô)</div>
            <div style="overflow-x:auto;">
                <table id="questTable">
                    <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á</th><th>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="tab-manage-quest" class="tab-content">
            <div class="quest-create-card">
                <h3>üì¢ ‡∏™‡∏£‡πâ‡∏≤‡∏á Quest ‡πÉ‡∏´‡∏°‡πà</h3>
                <div class="input-group"><input type="text" id="q-text" placeholder="‡πÇ‡∏à‡∏ó‡∏¢‡πå..."></div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <input type="text" id="q-img" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ (Optional)" style="flex:1;">
                    <input type="text" id="q-link" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ô‡∏ö (Optional)" style="flex:1;">
                </div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <input type="number" id="q-hours" value="24" placeholder="‡∏ä‡∏°." style="width:80px;">
                    <input type="number" id="q-score" value="10" placeholder="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô" style="width:80px;">
                    <button class="btn-sm btn-warning" style="flex:1; font-size:1em;" onclick="createQuest()">üöÄ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® Quest</button>
                </div>
            </div>

            <div id="active-quest-section" style="display:none;">
                <div class="active-quest-card">
                    <h3 style="color:#155724; margin:0 0 10px 0;">üü¢ ‡∏Å‡∏≥‡∏•‡∏±‡∏á Active</h3>
                    <table id="activeQuestTable" style="margin:0;">
                        <thead><tr><th>‡πÇ‡∏à‡∏ó‡∏¢‡πå</th><th>‡∏´‡∏°‡∏î‡πÄ‡∏Ç‡∏ï</th><th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th><th>‡∏¢‡∏∏‡∏ï‡∏¥</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <h3>‚ôªÔ∏è ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Quest</h3>
            <table id="questHistoryTable">
                <thead><tr><th>‡πÇ‡∏à‡∏ó‡∏¢‡πå</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="tab-users" class="tab-content">
            <input type="text" id="userSearch" style="width:100%; padding:10px; margin-bottom:10px;" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." onkeyup="filterUsers()">
            <table id="usersTable"><thead><tr><th>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th><th>Level</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</th><th>‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡∏•‡∏ö</th></tr></thead><tbody></tbody></table>
        </div>

        <div id="tab-leaderboard" class="tab-content">
            <div id="leaderboardList" style="max-width:600px; margin:0 auto;"></div>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        const ALLOWED_EMAIL = "medlifeplus@gmail.com";
        const ADMIN_LIFF_ID = "2008959998-yjcNpaGt"; // ‚ö†Ô∏è ID Admin
        const MY_URL = 'https://mlpditto.github.io/INTERN-PORT/admin.html'; // ‚ö†Ô∏è URL Admin

        const auth = firebase.auth();
        let topUsersCache = [];

        // --- Login ---
        if (auth.isSignInWithEmailLink(window.location.href)) {
            let email = window.localStorage.getItem('emailForSignIn') || prompt('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•:');
            auth.signInWithEmailLink(email, window.location.href).then(() => {
                localStorage.removeItem('emailForSignIn'); location.replace(MY_URL);
            }).catch(e => alert(e.message));
        }
        function sendMagicLink() {
            const email = document.getElementById('email-input').value;
            if(email !== ALLOWED_EMAIL) return alert("No Permission");
            auth.sendSignInLinkToEmail(email, { url: MY_URL, handleCodeInApp: true })
                .then(() => { localStorage.setItem('emailForSignIn', email); alert("‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ñ‡∏£‡∏±‡∏ö"); });
        }
        auth.onAuthStateChanged(user => {
            if(user && user.email===ALLOWED_EMAIL) {
                document.getElementById('login-screen').style.display='none';
                document.getElementById('dashboard-container').style.display='block';
                initSystem();
            }
        });
        function logout() { auth.signOut().then(() => location.reload()); }

        // --- System ---
        let isInit = false;
        async function initSystem() {
            if(isInit) return; isInit = true;
            try { await liff.init({ liffId: ADMIN_LIFF_ID }); } catch(e) {}
            loadWorks(); loadQuestSubmissions(); loadActiveQuests(); loadQuestHistory(); loadUsers();
        }
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
            document.getElementById(id).classList.add('active'); event.target.classList.add('active');
        }

        // --- 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (Works) ---
        function loadWorks() {
            db.collection("works").orderBy("timestamp", "desc").limit(50).onSnapshot(snap => {
                const tb = document.querySelector("#worksTable tbody"); tb.innerHTML = "";
                snap.forEach(doc => {
                    const w = doc.data(); const id = doc.id;
                    const statusColor = w.status==='‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß'?'#d4edda':w.status==='‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'?'#f8d7da':'#fff3cd';
                    const scoreVal = w.score || 0;
                    
                    tb.innerHTML += `<tr>
                        <td style="font-size:0.8em;">${w.timestamp?.toDate().toLocaleString('th-TH')||''}</td>
                        <td><img src="${w.pictureUrl||'https://via.placeholder.com/35'}" class="user-pic">${w.displayName}</td>
                        <td>${w.title}</td>
                        <td><a href="${w.link}" target="_blank" class="btn-sm btn-dark">Link</a></td>
                        <td>
                            <select onchange="updateStatus('${id}', this.value)" style="background:${statusColor}; border:none; padding:5px; border-radius:4px;">
                                <option value="‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à" ${w.status==='‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à'?'selected':''}>‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à</option>
                                <option value="‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß" ${w.status==='‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß'?'selected':''}>‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß</option>
                                <option value="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" ${w.status==='‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'?'selected':''}>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</option>
                            </select>
                        </td>
                        <td>
                            <div style="display:flex; align-items:center;">
                                <input type="number" id="score-w-${id}" value="${scoreVal}" style="width:50px; padding:2px;" placeholder="0">
                                <button class="btn-sm btn-primary" onclick="saveWorkScore('${id}', '${w.userId}', ${scoreVal})">üíæ</button>
                            </div>
                        </td>
                        <td><button class="btn-sm btn-primary" onclick="addFeedback('${id}', '${w.feedback||''}')">üí¨</button>${w.feedback?`<span style="font-size:0.8em; color:blue;"> ‚úîÔ∏è</span>`:''}</td>
                        <td><button class="btn-sm btn-danger" onclick="delWork('${id}', '${w.title}')">üóëÔ∏è</button></td>
                    </tr>`;
                });
            });
        }

        async function saveWorkScore(workId, userId, oldScore) {
            const newScore = parseFloat(document.getElementById(`score-w-${workId}`).value) || 0;
            if(newScore === oldScore) return; // ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£

            const diff = newScore - oldScore;
            try {
                const batch = db.batch();
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏ô‡∏á‡∏≤‡∏ô
                batch.update(db.collection("works").doc(workId), { score: newScore, status: "‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß" }); // ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô = ‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° User
                batch.update(db.collection("users").doc(userId), { score: firebase.firestore.FieldValue.increment(diff) });
                
                await batch.commit();
                alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (${oldScore} -> ${newScore})\n‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏° ${diff}`);
            } catch(e) { alert("Error: " + e.message); }
        }

        // --- 2. ‡∏ï‡∏£‡∏ß‡∏à Quest (Quest Submissions) ---
        function loadQuestSubmissions() {
            db.collection("quest_submissions").orderBy("timestamp", "desc").limit(50).onSnapshot(snap => {
                const tb = document.querySelector("#questTable tbody"); tb.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data(); const id = doc.id;
                    const totalScore = (d.earnedScore || 0) + (d.bonusGiven || 0);
                    const statusBadge = d.isLate ? '<span class="badge" style="background:#dc3545">‡∏™‡πà‡∏á‡∏ä‡πâ‡∏≤</span>' : '<span class="badge" style="background:#28a745">‡∏ó‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</span>';
                    
                    tb.innerHTML += `<tr>
                        <td style="font-size:0.8em;">${d.timestamp?.toDate().toLocaleString('th-TH')||''}</td>
                        <td><img src="${d.pictureUrl||'https://via.placeholder.com/35'}" class="user-pic">${d.displayName}</td>
                        <td>${d.answer}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <div style="display:flex; align-items:center;">
                                <input type="number" id="score-q-${id}" value="${totalScore}" style="width:50px; padding:2px;">
                                <button class="btn-sm btn-warning" onclick="updateQuestScore('${id}', '${d.userId}', ${totalScore}, ${d.earnedScore||0})">‡πÅ‡∏Å‡πâ</button>
                            </div>
                        </td>
                        <td><button class="btn-sm btn-danger" onclick="delQuestSub('${id}', '${d.userId}', ${totalScore})">‡∏•‡∏ö</button></td>
                    </tr>`;
                });
            });
        }

        async function updateQuestScore(subId, userId, currentTotal, baseEarned) {
            // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡∏ó‡∏µ‡πà bonusGiven ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà Admin ‡∏Å‡∏£‡∏≠‡∏Å
            // Total = Base + Bonus  =>  Bonus = NewTotal - Base
            const newTotal = parseFloat(document.getElementById(`score-q-${subId}`).value);
            if(isNaN(newTotal)) return;

            const newBonus = newTotal - baseEarned;
            const diff = newTotal - currentTotal; // ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏õ‡∏ö‡∏ß‡∏Å/‡∏•‡∏ö User

            if(confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô ${newTotal}?\n(‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏õ‡∏£‡∏±‡∏ö Bonus ‡πÄ‡∏õ‡πá‡∏ô ${newBonus})`)) {
                const batch = db.batch();
                batch.update(db.collection("quest_submissions").doc(subId), { bonusGiven: newBonus });
                batch.update(db.collection("users").doc(userId), { score: firebase.firestore.FieldValue.increment(diff) });
                await batch.commit();
            }
        }

        async function delQuestSub(subId, userId, scoreToRemove) {
            if(confirm("‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?\n(‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢)")) {
                const batch = db.batch();
                batch.delete(db.collection("quest_submissions").doc(subId));
                batch.update(db.collection("users").doc(userId), { score: firebase.firestore.FieldValue.increment(-scoreToRemove) });
                await batch.commit();
            }
        }

        // --- 3. Manage Quests ---
        async function createQuest() {
            const q={ question:getID('q-text').value, imageUrl:getID('q-img').value, questLink:getID('q-link').value, baseScore:parseInt(getID('q-score').value), deadline: new Date(Date.now() + parseInt(getID('q-hours').value)*3600000), createdAt: firebase.firestore.FieldValue.serverTimestamp() };
            if(!q.question) return alert("‡πÉ‡∏™‡πà‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Å‡πà‡∏≠‡∏ô");
            if(confirm("‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® Quest?")) { await db.collection("quests").add(q); alert("Done!"); getID('q-text').value=""; }
        }
        function getID(id){ return document.getElementById(id); }

        function loadActiveQuests() {
            db.collection("quests").orderBy("createdAt", "desc").onSnapshot(snap => {
                const tb = document.querySelector("#activeQuestTable tbody"); tb.innerHTML = "";
                let hasActive = false; const now = new Date();
                snap.forEach(doc => {
                    const q = doc.data();
                    if(q.deadline?.toDate() > now) {
                        hasActive = true;
                        const safeQ=q.question.replace(/'/g,"\\'"), safeImg=(q.imageUrl||"").replace(/'/g,"\\'"), safeLink=(q.questLink||"").replace(/'/g,"\\'");
                        tb.innerHTML += `<tr><td>${q.question}</td><td>${Math.ceil((q.deadline.toDate()-now)/36e5)} ‡∏ä‡∏°.</td>
                        <td><button class="btn-sm btn-warning" onclick="editQ('${doc.id}','${safeQ}','${safeImg}','${safeLink}')">‚úèÔ∏è</button></td>
                        <td><button class="btn-sm btn-dark" onclick="stopQ('${doc.id}')">‚õî</button></td></tr>`;
                    }
                });
                document.getElementById("active-quest-section").style.display = hasActive?"block":"none";
            });
        }
        async function stopQ(id) { if(confirm("‡∏¢‡∏∏‡∏ï‡∏¥ Quest?")) db.collection("quests").doc(id).update({deadline: new Date(Date.now()-1000)}); }
        async function editQ(id,q,i,l) { const nQ=prompt("‡πÇ‡∏à‡∏ó‡∏¢‡πå",q), nI=prompt("‡∏£‡∏π‡∏õ",i), nL=prompt("‡∏•‡∏¥‡∏á‡∏Å‡πå",l); if(nQ) db.collection("quests").doc(id).update({question:nQ, imageUrl:nI, questLink:nL}); }

        function loadQuestHistory() {
            db.collection("quests").orderBy("createdAt","desc").limit(20).onSnapshot(snap=>{
                const tb=document.querySelector("#questHistoryTable tbody"); tb.innerHTML="";
                snap.forEach(doc=>{ const q=doc.data(); tb.innerHTML+=`<tr><td>${q.question}</td><td>${q.baseScore}</td><td><button class="btn-sm btn-secondary" onclick="reuse('${q.question.replace(/'/g,"\\'")}','${q.baseScore}','${(q.imageUrl||"").replace(/'/g,"\\'")}','${(q.questLink||"").replace(/'/g,"\\'")}')">‚ôªÔ∏è</button> <button class="btn-sm btn-danger" onclick="delQ('${doc.id}')">üóëÔ∏è</button></td></tr>`; });
            });
        }
        function reuse(q,s,i,l){ getID('q-text').value=q; getID('q-score').value=s; getID('q-img').value=i; getID('q-link').value=l; document.querySelector('.quest-create-card').scrollIntoView({behavior:'smooth'}); }
        async function delQ(id){ if(confirm("‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£?")) db.collection("quests").doc(id).delete(); }

        // --- 4. Users ---
        function loadUsers() {
            db.collection("users").orderBy("score","desc").onSnapshot(snap=>{
                const tb=document.querySelector("#usersTable tbody"); const lb=document.getElementById("leaderboardList");
                tb.innerHTML=""; lb.innerHTML=""; topUsersCache=[]; let r=1;
                snap.forEach(doc=>{
                    const u=doc.data(); const lv=Math.floor(u.score/10)+1;
                    tb.innerHTML+=`<tr class="u-row"><td><img src="${u.pictureUrl}" class="user-pic">${u.displayName}</td><td>Lv.${lv}</td><td>${u.score.toFixed(1)}</td>
                    <td><button class="btn-sm btn-primary" onclick="adj('${doc.id}',1)">+1</button><button class="btn-sm btn-danger" onclick="adj('${doc.id}',-1)">-1</button></td><td><button class="btn-sm btn-danger" onclick="delUser('${doc.id}')">üóëÔ∏è</button></td></tr>`;
                    if(r<=10){ topUsersCache.push(`${r}. ${u.displayName} (${u.score.toFixed(1)})`); lb.innerHTML+=`<div class="leaderboard-card rank-${r}"><div style="display:flex; align-items:center;"><b style="width:30px">#${r}</b><img src="${u.pictureUrl}" class="user-pic">${u.displayName}</div><span>${u.score.toFixed(1)} ‚≠ê</span></div>`; } r++;
                });
            });
        }
        function filterUsers(){ const t=getID('userSearch').value.toLowerCase(); document.querySelectorAll('.u-row').forEach(r=>r.style.display=r.innerText.toLowerCase().includes(t)?'':'none'); }
        async function adj(id,v){ db.collection("users").doc(id).update({score:firebase.firestore.FieldValue.increment(v)}); }
        async function delUser(id){ if(confirm("‡∏•‡∏ö User?")) db.collection("users").doc(id).delete(); }
        async function shareLeaderboard(){ 
            if(!topUsersCache.length) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            const t = "üèÜ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:\n"+topUsersCache.join("\n");
            if(liff.isInClient()) liff.shareTargetPicker([{type:"text",text:t}]); else navigator.clipboard.writeText(t).then(()=>alert("Copied!")).catch(()=>prompt("Copy:",t));
        }

        // Helpers
        async function updateStatus(id,v){ db.collection("works").doc(id).update({status:v}); }
        async function addFeedback(id,v){ const f=prompt("Feedback:",v); if(f!==null) db.collection("works").doc(id).update({feedback:f}); }
        async function delWork(id,t){ if(confirm("‡∏•‡∏ö "+t+"?")) db.collection("works").doc(id).delete(); }

    </script>
</body>
</html>
