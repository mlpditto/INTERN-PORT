<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLP INTERNSHIP V.260126 (V17 - Side Quest)</title>
    <link rel="stylesheet" href="style.css">
    
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        /* Base */
        body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f4f6f9; margin:0;}
        #login-screen { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; }
        #dashboard-container { display:none; max-width:1200px; margin:20px auto; padding:20px; }
        
        /* Login */
        .login-card { background:white; padding:40px; border-radius:15px; box-shadow:0 10px 25px rgba(0,0,0,0.1); width:90%; max-width:400px; text-align:center; }
        .input-group input { width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box; margin-top:5px; }
        .magic-btn { background:#4361ee; color:white; border:none; padding:12px; width:100%; border-radius:8px; margin-top:20px; cursor:pointer; font-weight:bold; transition:0.2s; }
        
        /* Navigation */
        .tab-nav { display:flex; border-bottom:2px solid #e0e0e0; margin-bottom:20px; overflow-x:auto; gap:10px; padding-bottom:5px; }
        .tab-btn { padding:10px 20px; border:none; background:none; cursor:pointer; font-weight:600; color:#777; border-radius:8px; transition:0.2s; white-space:nowrap; }
        .tab-btn:hover { background:#eef2f6; color:#333; }
        .tab-btn.active { background:#eef2ff; color:#4361ee; }
        .tab-content { display:none; animation:fadeIn 0.3s; } .tab-content.active { display:block; }
        
        /* UI Elements */
        .btn-sm { padding:6px 12px; border-radius:6px; border:none; cursor:pointer; color:white; font-size:0.85em; font-weight:500; transition:0.2s; margin:0 2px; }
        .btn-primary { background:#4361ee; } .btn-danger { background:#ef233c; } .btn-success { background:#2ec4b6; } .btn-warning { background:#ff9f1c; color:white; } .btn-dark { background:#2b2d42; }
        .badge { padding:5px 10px; border-radius:20px; font-size:0.75em; font-weight:bold; color:white; display:inline-block; }
        .user-pic { width:36px; height:36px; border-radius:50%; object-fit:cover; border:2px solid #fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); vertical-align:middle; margin-right:10px; }
        
        /* Table */
        table { width:100%; border-collapse:collapse; background:white; border-radius:12px; overflow:hidden; box-shadow:0 2px 10px rgba(0,0,0,0.03); margin-bottom:20px; }
        th, td { padding:15px; text-align:left; border-bottom:1px solid #f0f0f0; vertical-align:middle; }
        th { background:#fafafa; color:#555; font-weight:600; font-size:0.9em; text-transform:uppercase; letter-spacing:0.5px; }
        
        /* Leaderboard */
        .leaderboard-card { background:white; padding:15px 20px; margin-bottom:12px; border-radius:12px; display:flex; align-items:center; justify-content:space-between; box-shadow:0 2px 8px rgba(0,0,0,0.04); border-left:6px solid transparent; }
        .rank-1 { border-left-color:#FFD700; background:linear-gradient(to right, #fffdf0, #fff); } 
        .rank-2 { border-left-color:#C0C0C0; background:linear-gradient(to right, #f8f9fa, #fff); } 
        .rank-3 { border-left-color:#CD7F32; background:linear-gradient(to right, #fffaf5, #fff); }
        .rank-other { border-left-color:#4361ee; }

        /* üî• KANBAN BOARD STYLES */
        .kanban-board { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 20px; align-items: flex-start; }
        .kanban-col { flex: 1; min-width: 260px; background: #f8f9fa; border-radius: 12px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .kanban-header { font-weight: bold; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; color:#444; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .kanban-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 10px; border-left: 4px solid #4361ee; transition: transform 0.2s; position: relative; }
        .kanban-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .kanban-card h4 { margin: 0 0 5px 0; font-size: 1em; color: #333; }
        .kanban-card p { margin: 0 0 10px 0; font-size: 0.85em; color: #666; }
        .assignee-list { display: flex; margin-bottom: 10px; }
        .assignee-img { width: 25px; height: 25px; border-radius: 50%; border: 2px solid white; margin-right: -8px; }
        .kanban-actions { display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; }

        /* User Select Modal */
        .user-select-container { max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 6px; background: #fff; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .user-checkbox { display: flex; align-items: center; gap: 5px; padding: 5px; cursor: pointer; }
        .user-checkbox:hover { background: #f0f0f0; border-radius: 4px; }
        
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h2>üîê Admin Portal</h2>
            <div id="login-form">
                <div class="input-group"><input type="email" id="email-input" value="medlifeplus@gmail.com" placeholder="Email"></div>
                <button class="magic-btn" onclick="sendMagicLink()">‚ú® ‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏•</button>
            </div>
            <div id="status-msg" style="margin-top:15px; color:#ef233c;"></div>
        </div>
    </div>

    <div id="dashboard-container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <div><h2 style="margin:0; color:#2b2d42;">üë®‚Äçüíª Admin Dashboard</h2><span id="admin-email" style="color:#888; font-size:0.9em;"></span></div>
            <div style="display:flex; gap:10px;">
                <button class="btn-sm btn-success" onclick="shareLeaderboard()">üì§ ‡πÅ‡∏ä‡∏£‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                <button class="btn-sm btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('tab-works')">üìÑ ‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô</button>
            <button class="tab-btn" onclick="switchTab('tab-sidequest')">üó∫Ô∏è Side Quest</button>
            <button class="tab-btn" onclick="switchTab('tab-manage-quest')">‚öôÔ∏è Daily Quest</button>
            <button class="tab-btn" onclick="switchTab('tab-users')">üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
            <button class="tab-btn" onclick="switchTab('tab-leaderboard')">üèÜ Leaderboard</button>
        </div>

        <div id="tab-works" class="tab-content active">
            <h3>üìÅ ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ & Daily Quest</h3>
            <div style="overflow-x:auto;"><table id="worksTable"><thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á</th><th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th><th>‡∏•‡∏¥‡∏á‡∏Å‡πå</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</th><th>‡∏•‡∏ö</th></tr></thead><tbody></tbody></table></div>
            <h3 style="margin-top:30px;">‚ö° Daily Answers</h3>
            <div style="overflow-x:auto;"><table id="questTable"><thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á</th><th>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody></tbody></table></div>
        </div>

        <div id="tab-sidequest" class="tab-content">
            <div style="background:#eef2ff; padding:20px; border-radius:12px; margin-bottom:20px; border:1px solid #c7d2fe;">
                <h3 style="margin-top:0; color:#4361ee;">‚ûï ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à (Side Quest)</h3>
                <input type="text" id="sq-title" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à (‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏≠‡∏≤‡∏™‡∏≤)" style="width:100%; padding:10px; margin-bottom:10px; border-radius:6px; border:1px solid #ccc;">
                <textarea id="sq-desc" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..." style="width:100%; padding:10px; margin-bottom:10px; border-radius:6px; border:1px solid #ccc;"></textarea>
                
                <p style="margin:5px 0; font-weight:bold; color:#555;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (‡∏Å‡∏•‡∏∏‡πà‡∏°/‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß):</p>
                <div id="sq-user-list" class="user-select-container">Loading users...</div>
                
                <button class="btn-sm btn-primary" style="margin-top:10px; font-size:1em; padding:10px 20px;" onclick="createSideQuest()">üöÄ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>
            </div>

            <div class="kanban-board">
                <div class="kanban-col">
                    <div class="kanban-header">üìå Backlog <span class="badge" style="background:#6c757d" id="count-backlog">0</span></div>
                    <div id="col-Backlog"></div>
                </div>
                <div class="kanban-col">
                    <div class="kanban-header">üöß Doing <span class="badge" style="background:#007bff" id="count-doing">0</span></div>
                    <div id="col-Doing"></div>
                </div>
                <div class="kanban-col">
                    <div class="kanban-header">üëÄ Review <span class="badge" style="background:#ffc107; color:black;" id="count-review">0</span></div>
                    <div id="col-Review"></div>
                </div>
                <div class="kanban-col">
                    <div class="kanban-header">‚úÖ Done <span class="badge" style="background:#28a745" id="count-done">0</span></div>
                    <div id="col-Done"></div>
                </div>
            </div>
        </div>

        <div id="tab-manage-quest" class="tab-content">
            <div style="background:white; padding:20px; border-radius:12px; margin-bottom:20px;">
                <h3>üì¢ ‡∏™‡∏£‡πâ‡∏≤‡∏á Daily Quest</h3>
                <input type="text" id="q-text" placeholder="‡πÇ‡∏à‡∏ó‡∏¢‡πå..." style="width:100%; padding:10px; margin-bottom:5px;">
                <div style="display:flex; gap:10px;"><input type="text" id="q-img" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ" style="flex:1;"><input type="text" id="q-link" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ô‡∏ö" style="flex:1;"></div>
                <div style="display:flex; gap:10px; margin-top:10px;"><input type="number" id="q-hours" value="24" placeholder="‡∏ä‡∏°." style="width:60px;"><input type="number" id="q-score" value="10" placeholder="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô" style="width:60px;"><button class="btn-sm btn-warning" style="flex:1;" onclick="createQuest()">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button></div>
            </div>
            <div id="active-quest-section" style="display:none; background:#d4edda; padding:15px; border-radius:8px; margin-bottom:20px;">
                <h3 style="color:#155724; margin:0;">üü¢ Active</h3><table id="activeQuestTable" style="margin-top:10px; background:none; box-shadow:none;"><thead><tr><th>‡πÇ‡∏à‡∏ó‡∏¢‡πå</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th><th>‡∏¢‡∏∏‡∏ï‡∏¥</th></tr></thead><tbody></tbody></table>
            </div>
            <h3>‚ôªÔ∏è ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h3><table id="questHistoryTable"><thead><tr><th>‡πÇ‡∏à‡∏ó‡∏¢‡πå</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody></tbody></table>
        </div>

        <div id="tab-users" class="tab-content">
            <input type="text" id="userSearch" style="width:100%; padding:12px; margin-bottom:15px;" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." onkeyup="filterUsers()">
            <table id="usersTable"><thead><tr><th>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th><th>Level</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡∏õ‡∏£‡∏±‡∏ö</th><th>‡∏•‡∏ö</th></tr></thead><tbody></tbody></table>
        </div>

        <div id="tab-leaderboard" class="tab-content"><div id="leaderboardList" style="max-width:700px; margin:0 auto;"></div></div>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        const ALLOWED_EMAIL = "medlifeplus@gmail.com";
        const ADMIN_LIFF_ID = "2008959998-yjcNpaGt"; // ‚ö†Ô∏è ID Admin
        const MY_URL = 'https://mlpditto.github.io/INTERN-PORT/admin.html'; // ‚ö†Ô∏è URL Admin

        const auth = firebase.auth();
        let topUsersCache = [];
        let allUsersList = []; // For select box

        // Login Logic
        if (auth.isSignInWithEmailLink(window.location.href)) {
            let email = window.localStorage.getItem('emailForSignIn') || prompt('Email:');
            auth.signInWithEmailLink(email, window.location.href).then(() => { localStorage.removeItem('emailForSignIn'); location.replace(MY_URL); }).catch(e => alert(e.message));
        }
        function sendMagicLink() {
            const email = document.getElementById('email-input').value;
            if(email!==ALLOWED_EMAIL) return alert("No Permission");
            auth.sendSignInLinkToEmail(email, { url:MY_URL, handleCodeInApp:true }).then(() => { localStorage.setItem('emailForSignIn',email); alert("Check Email"); });
        }
        auth.onAuthStateChanged(user => {
            if(user && user.email===ALLOWED_EMAIL) { document.getElementById('login-screen').style.display='none'; document.getElementById('dashboard-container').style.display='block'; document.getElementById('admin-email').innerText=user.email; initSystem(); }
        });
        function logout() { auth.signOut().then(() => location.reload()); }

        // System Init
        let isInit = false;
        async function initSystem() {
            if(isInit) return; isInit = true;
            try { await liff.init({ liffId: ADMIN_LIFF_ID }); } catch(e) {}
            loadWorks(); loadQuestSubmissions(); loadActiveQuests(); loadQuestHistory(); loadUsers(); loadSideQuests();
        }
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
            document.getElementById(id).classList.add('active'); event.target.classList.add('active');
        }

        // --- Side Quest Logic ---
        function loadSideQuests() {
            db.collection("side_quests").orderBy("createdAt", "desc").onSnapshot(snap => {
                const cols = { "Backlog": getID("col-Backlog"), "Doing": getID("col-Doing"), "Review": getID("col-Review"), "Done": getID("col-Done") };
                const counts = { "Backlog": 0, "Doing": 0, "Review": 0, "Done": 0 };
                Object.values(cols).forEach(c => c.innerHTML = "");

                snap.forEach(doc => {
                    const q = doc.data();
                    counts[q.status]++;
                    
                    // Render Assignees
                    let assigneesHtml = '<div class="assignee-list">';
                    if(q.assignees && q.assignees.length > 0) {
                        q.assignees.forEach(u => { assigneesHtml += `<img src="${u.pic}" title="${u.name}" class="assignee-img">`; });
                    } else { assigneesHtml += '<span style="font-size:0.8em; color:#999;">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</span>'; }
                    assigneesHtml += '</div>';

                    // Buttons
                    let btns = "";
                    if(q.status !== "Backlog") btns += `<button class="btn-sm btn-dark" onclick="moveSideQuest('${doc.id}', '${prevStatus(q.status)}')">‚¨ÖÔ∏è</button>`;
                    if(q.status !== "Done") btns += `<button class="btn-sm btn-primary" onclick="moveSideQuest('${doc.id}', '${nextStatus(q.status)}')">‚û°Ô∏è</button>`;
                    btns += `<button class="btn-sm btn-danger" style="margin-left:auto;" onclick="deleteSideQuest('${doc.id}')">üóëÔ∏è</button>`;

                    const card = document.createElement("div");
                    card.className = "kanban-card";
                    card.innerHTML = `<h4>${q.title}</h4><p>${q.description}</p>${assigneesHtml}<div class="kanban-actions">${btns}</div>`;
                    
                    if(cols[q.status]) cols[q.status].appendChild(card);
                });

                Object.keys(counts).forEach(k => getID(`count-${k.toLowerCase()}`).innerText = counts[k]);
            });
        }

        function prevStatus(s) { if(s==="Doing")return "Backlog"; if(s==="Review")return "Doing"; if(s==="Done")return "Review"; return s; }
        function nextStatus(s) { if(s==="Backlog")return "Doing"; if(s==="Doing")return "Review"; if(s==="Review")return "Done"; return s; }
        
        async function moveSideQuest(id, status) { await db.collection("side_quests").doc(id).update({ status: status }); }
        async function deleteSideQuest(id) { if(confirm("‡∏•‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ô‡∏µ‡πâ?")) await db.collection("side_quests").doc(id).delete(); }

        async function createSideQuest() {
            const title = getID("sq-title").value;
            const desc = getID("sq-desc").value;
            
            // Collect Selected Users
            const checkboxes = document.querySelectorAll('.sq-user-check:checked');
            let selectedUsers = [];
            checkboxes.forEach(cb => {
                selectedUsers.push({ uid: cb.value, name: cb.dataset.name, pic: cb.dataset.pic });
            });

            if(!title) return alert("‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
            if(selectedUsers.length === 0) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô");

            await db.collection("side_quests").add({
                title: title,
                description: desc,
                assignees: selectedUsers,
                assigneeIds: selectedUsers.map(u => u.uid), // Array of IDs for querying
                status: "Backlog",
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            alert("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÅ‡∏•‡πâ‡∏ß!");
            getID("sq-title").value = ""; getID("sq-desc").value = "";
            document.querySelectorAll('.sq-user-check').forEach(c => c.checked = false);
        }

        // --- Users & Render Select Box ---
        function loadUsers() {
            db.collection("users").orderBy("score","desc").onSnapshot(snap => {
                const tb = document.querySelector("#usersTable tbody"); const lb = getID("leaderboardList"); const sel = getID("sq-user-list");
                tb.innerHTML = ""; lb.innerHTML = ""; sel.innerHTML = ""; topUsersCache = []; let r=1;

                snap.forEach(doc => {
                    const u = doc.data(); const score = parseFloat((u.score||0).toFixed(2));
                    // Table
                    tb.innerHTML += `<tr class="u-row"><td><div style="display:flex; align-items:center;"><img src="${u.pictureUrl}" class="user-pic">${u.displayName}</div></td><td>Lv.${Math.floor(score/10)+1}</td><td>${score}</td><td><button class="btn-sm btn-primary" onclick="adj('${doc.id}',1)">+1</button><button class="btn-sm btn-danger" onclick="adj('${doc.id}',-1)">-1</button></td><td><button class="btn-sm btn-danger" onclick="delUser('${doc.id}')">üóëÔ∏è</button></td></tr>`;
                    
                    // Leaderboard (Top 20)
                    if(r<=20) {
                        let cls='rank-other', ic='‚≠ê'; if(r===1){cls='rank-1';ic='üåü';}else if(r===2){cls='rank-2';ic='ü•à';}else if(r===3){cls='rank-3';ic='ü•â';}
                        topUsersCache.push(`${r}. ${u.displayName} (${score})`);
                        lb.innerHTML += `<div class="leaderboard-card ${cls}"><div style="display:flex; align-items:center;"><b style="width:30px">#${r}</b><img src="${u.pictureUrl}" class="user-pic">${u.displayName}</div><div><b>${score}</b> ${ic}</div></div>`;
                    } r++;

                    // Side Quest User Select List
                    sel.innerHTML += `<label class="user-checkbox"><input type="checkbox" class="sq-user-check" value="${doc.id}" data-name="${u.displayName}" data-pic="${u.pictureUrl}"><img src="${u.pictureUrl}" style="width:20px; height:20px; border-radius:50%; margin-right:5px;">${u.displayName}</label>`;
                });
            });
        }

        // --- Other Logic (Works, Quests) ---
        function loadWorks() { /* ...Logic ‡πÄ‡∏î‡∏¥‡∏°... */ db.collection("works").orderBy("timestamp","desc").limit(50).onSnapshot(s=>{ const t=document.querySelector("#worksTable tbody"); t.innerHTML=""; s.forEach(d=>{ const w=d.data(); t.innerHTML+=`<tr><td>${w.timestamp?.toDate().toLocaleString('th-TH')||''}</td><td>${w.displayName}</td><td>${w.title}</td><td><a href="${w.link}" target="_blank">Link</a></td><td>${w.status}</td><td><input type="number" step="0.1" id="sc-${d.id}" value="${w.score||0}" style="width:50px"><button onclick="svSc('${d.id}','${w.userId}',${w.score||0})">üíæ</button></td><td><button onclick="fb('${d.id}')">üí¨</button></td><td><button onclick="delWork('${d.id}')">üóëÔ∏è</button></td></tr>`}) }) }
        function loadQuestSubmissions() { /* ...Logic ‡πÄ‡∏î‡∏¥‡∏°... */ db.collection("quest_submissions").orderBy("timestamp","desc").limit(50).onSnapshot(s=>{ const t=document.querySelector("#questTable tbody"); t.innerHTML=""; s.forEach(d=>{ const q=d.data(); let ans=q.answer; if(ans.startsWith('http')) ans=`<a href="${ans}" target="_blank">Link</a>`; t.innerHTML+=`<tr><td>${q.timestamp?.toDate().toLocaleString('th-TH')||''}</td><td>${q.displayName}</td><td>${ans}</td><td>${q.isLate?'‡∏ä‡πâ‡∏≤':'‡∏ó‡∏±‡∏ô'}</td><td><input type="number" step="0.1" id="qsc-${d.id}" value="${(q.earnedScore||0)+(q.bonusGiven||0)}" style="width:50px"><button onclick="upQSc('${d.id}','${q.userId}',${(q.earnedScore||0)+(q.bonusGiven||0)},${q.earnedScore||0})">‡πÅ‡∏Å‡πâ</button></td><td><button onclick="delQSub('${d.id}','${q.userId}',${(q.earnedScore||0)+(q.bonusGiven||0)})">‡∏•‡∏ö</button></td></tr>`}) }) }
        // ... (Functions ‡∏¢‡πà‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ó‡∏µ‡πà: svSc, fb, delWork, upQSc, delQSub, createQuest, etc. ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ logic ‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å V16) ...
        
        // Shortened Helpers for V17 Integration
        async function svSc(wid,uid,old){ const n=parseFloat(getID('sc-'+wid).value)||0; if(n==old)return; db.collection("works").doc(wid).update({score:n,status:"‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß"}); db.collection("users").doc(uid).update({score:firebase.firestore.FieldValue.increment(n-old)}); }
        async function fb(id){ const f=prompt("Feedback"); if(f) db.collection("works").doc(id).update({feedback:f}); }
        async function delWork(id){ if(confirm("Del?")) db.collection("works").doc(id).delete(); }
        async function upQSc(id,uid,cur,base){ const n=parseFloat(getID('qsc-'+id).value)||0; const bonus=parseFloat((n-base).toFixed(2)); if(confirm("Update?")) { db.collection("quest_submissions").doc(id).update({bonusGiven:bonus}); db.collection("users").doc(uid).update({score:firebase.firestore.FieldValue.increment(n-cur)}); } }
        async function delQSub(id,uid,sc){ if(confirm("Del?")) { db.collection("quest_submissions").doc(id).delete(); db.collection("users").doc(uid).update({score:firebase.firestore.FieldValue.increment(-sc)}); } }
        
        async function createQuest(){ const q={question:getID('q-text').value, imageUrl:getID('q-img').value, questLink:getID('q-link').value, baseScore:parseFloat(getID('q-score').value), deadline:new Date(Date.now()+parseFloat(getID('q-hours').value)*36e5), createdAt:firebase.firestore.FieldValue.serverTimestamp()}; if(q.question&&confirm("Post?")) await db.collection("quests").add(q); }
        function loadActiveQuests(){ db.collection("quests").orderBy("createdAt","desc").onSnapshot(s=>{ const t=document.querySelector("#activeQuestTable tbody"); t.innerHTML=""; let h=false; s.forEach(d=>{ const q=d.data(); if(q.deadline?.toDate()>new Date()){ h=true; t.innerHTML+=`<tr><td>${q.question}</td><td>${Math.ceil((q.deadline.toDate()-new Date())/36e5)}h</td><td>‚úèÔ∏è</td><td><button onclick="stopQ('${d.id}')">‚õî</button></td></tr>` } }); getID("active-quest-section").style.display=h?"block":"none"; }) }
        async function stopQ(id){ if(confirm("Stop?")) db.collection("quests").doc(id).update({deadline:new Date(Date.now()-1000)}); }
        function loadQuestHistory(){ db.collection("quests").orderBy("createdAt","desc").limit(20).onSnapshot(s=>{ const t=document.querySelector("#questHistoryTable tbody"); t.innerHTML=""; s.forEach(d=>{ const q=d.data(); t.innerHTML+=`<tr><td>${q.question}</td><td>${q.baseScore}</td><td>‚ôªÔ∏è <button onclick="delQ('${d.id}')">üóëÔ∏è</button></td></tr>` }) }) }
        async function delQ(id){ if(confirm("Del?")) db.collection("quests").doc(id).delete(); }

        // Utils
        function getID(id){ return document.getElementById(id); }
        function filterUsers(){ const t=getID('userSearch').value.toLowerCase(); document.querySelectorAll('.u-row').forEach(r=>r.style.display=r.innerText.toLowerCase().includes(t)?'':'none'); }
        async function adj(id,v){ db.collection("users").doc(id).update({score:firebase.firestore.FieldValue.increment(v)}); }
        async function delUser(id){ if(confirm("Del?")) db.collection("users").doc(id).delete(); }
        async function shareLeaderboard(){ if(!topUsersCache.length)return alert("No Data"); const t="üèÜ Top Scores:\n"+topUsersCache.slice(0,10).join("\n"); if(liff.isInClient())liff.shareTargetPicker([{type:"text",text:t}]); else navigator.clipboard.writeText(t).then(()=>alert("Copied")); }

    </script>
</body>
</html>
