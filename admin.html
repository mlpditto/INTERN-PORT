<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLP INTERNSHIP V.260128 (V40)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        /* --- Theme Variables --- */
        :root {
            --bg-body: #f4f6f9; --bg-card: #ffffff; --text-main: #333; --text-sub: #666;
            --col-bg: #f8f9fa; --border-color: #e0e0e0;
            --primary: #4361ee; --success: #2ec4b6; --warning: #ff9f1c; --danger: #ef233c; --dark: #2b2d42;
            --scored-bg: #d1e7dd; --scored-border: #badbcc; /* ‡∏™‡∏µ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß */
        }
        body.dark-mode {
            --bg-body: #1a1a1a; --bg-card: #2d2d2d; --text-main: #e0e0e0; --text-sub: #cccccc; /* Increased Contrast */
            --col-bg: #333; --border-color: #444;
            --scored-bg: #155724; --scored-border: #0f3d19;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; transition: 0.3s; }
        
        /* Layout */
        #dashboard-container { display: none; max-width: 1400px; margin: 0 auto; padding: 20px; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        
        /* Navigation (Scrollable) */
        .tab-wrapper { display: flex; align-items: center; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; position: relative; }
        .tab-nav { display: flex; overflow-x: auto; gap: 10px; flex: 1; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; padding-bottom: 5px; }
        .tab-nav::-webkit-scrollbar { height: 0px; }
        .tab-btn { padding: 10px 20px; border: none; background: none; cursor: pointer; font-weight: 600; color: var(--text-sub); border-radius: 8px 8px 0 0; white-space: nowrap; transition: 0.2s; }
        .tab-btn.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: var(--bg-card); }
        .tab-btn:hover { background: rgba(0,0,0,0.05); }
        .tab-content { display: none; animation: fadeIn 0.3s; } .tab-content.active { display: block; }

        /* Tables & Pagination */
        table { width: 100%; border-collapse: collapse; background: var(--bg-card); border-radius: 8px; overflow: hidden; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        th { background: var(--col-bg); color: var(--text-sub); font-weight: 600; text-transform: uppercase; font-size: 0.85em; }
        .pagination { display: flex; justify-content: flex-end; gap: 5px; margin-bottom: 20px; }
        .page-btn { padding: 5px 10px; border: 1px solid var(--border-color); background: var(--bg-card); cursor: pointer; border-radius: 4px; color: var(--text-main); }
        .page-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* Buttons & Inputs */
        .btn-sm { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; color: white; font-size: 0.85em; font-weight: 500; transition: 0.2s; margin: 0 2px; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: var(--primary); } .btn-danger { background: var(--danger); } 
        .btn-success { background: var(--success); } .btn-warning { background: var(--warning); color: black; } .btn-dark { background: var(--dark); }
        .magic-btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .magic-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        input, select { padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-card); color: var(--text-main); }

        /* Kanban Enhanced */
        .kanban-board { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 20px; align-items: stretch; min-height: 600px; }
        .kanban-col { flex: 1; min-width: 320px; background: var(--col-bg); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; border: 1px solid var(--border-color); transition: background 0.2s; }
        .kanban-col.drag-over { background: rgba(67, 97, 238, 0.1); border: 2px dashed var(--primary); } /* Drag Feedback */
        .kanban-card { background: var(--bg-card); padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 10px; border-left: 5px solid #ccc; cursor: grab; position: relative; transition: transform 0.2s; }
        .kanban-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        /* üî• Scored Card Style */
        .kanban-card.scored { background-color: var(--scored-bg); border: 1px solid var(--scored-border); border-left: 5px solid var(--success); }
        .kanban-card.scored::after { content: "\f00c"; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; top: 10px; right: 10px; color: var(--success); opacity: 0.5; }

        .card-Backlog { border-left-color: #6c757d; } .card-Doing { border-left-color: #4361ee; } .card-Review { border-left-color: #ff9f1c; } .card-Done { border-left-color: #2ec4b6; }
        .assignee-stack { display: flex; margin-top: 10px; padding-left: 10px; }
        .assignee-img { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; border: 2px solid var(--bg-card); margin-left: -10px; transition: 0.2s; }
        .assignee-img:hover { z-index: 10; transform: scale(1.2); }

        /* Components */
        .user-pic { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); vertical-align: middle; margin-right: 10px; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75em; font-weight: bold; color: white; display: inline-block; }
        .answer-box { margin-top: 10px; padding: 10px; background: rgba(67, 97, 238, 0.1); border-radius: 6px; font-size: 0.9em; border-left: 3px solid var(--primary); }
        .timer-text { font-size: 0.85em; color: var(--danger); font-weight: 600; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-content { background-color: var(--bg-card); margin: 5% auto; padding: 25px; border-radius: 12px; width: 95%; max-width: 700px; position: relative; color: var(--text-main); max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .close-modal { float: right; font-size: 24px; cursor: pointer; color: var(--text-sub); }
        .close-modal:hover { color: var(--text-main); }

        /* Cert Preview */
        #cert-preview-container { margin: 15px 0; border: 1px solid #ddd; padding: 10px; text-align: center; background: #fff; color: #000; }
        #cert-canvas { width: 100%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        /* Utility */
        .u-ignored { opacity: 0.5; filter: grayscale(1); }
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 2000; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 16px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} } @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <div id="login-screen" style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh;">
        <div class="login-card" style="padding:40px; background:var(--bg-card); border-radius:15px; box-shadow:0 10px 25px rgba(0,0,0,0.1); width:350px; text-align:center;">
            <h2>üîê Admin Portal</h2>
            <input type="email" id="email-input" value="medlifeplus@gmail.com" placeholder="Email" style="width:100%; margin-bottom:15px;">
            <button class="magic-btn" onclick="sendMagicLink()" style="width:100%;">‚ú® Login</button>
            <p id="status-msg" style="color:red; margin-top:10px;"></p>
        </div>
    </div>

    <div id="dashboard-container">
        <div class="flex-between" style="margin-bottom:20px;">
            <div><h2 style="margin:0;"><i class="fa-solid fa-user-shield"></i> Admin Dashboard</h2><span id="admin-email" style="font-size:0.8em; color:var(--text-sub);"></span></div>
            <div style="display:flex; gap:10px;">
                <button class="btn-sm" style="background:transparent; color:var(--text-main); font-size:1.2em;" onclick="toggleTheme()"><i class="fa-solid fa-moon"></i></button>
                <button class="magic-btn" onclick="shareLeaderboard()"><i class="fa-solid fa-share-nodes"></i> Share</button>
                <button class="magic-btn" style="background:var(--danger);" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </div>

        <div class="tab-wrapper">
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('tab-works')">üìÑ ‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô</button>
                <button class="tab-btn" onclick="switchTab('tab-sidequest')">üó∫Ô∏è Kanban</button>
                <button class="tab-btn" onclick="switchTab('tab-manage-quest')">‚öôÔ∏è Daily Quest</button>
                <button class="tab-btn" onclick="switchTab('tab-users')">üë• Users</button>
                <button class="tab-btn" onclick="switchTab('tab-leaderboard')">üèÜ Leaderboard</button>
            </div>
        </div>

        <div id="tab-works" class="tab-content active">
             <div class="header-row"><h3><i class="fa-solid fa-folder-open"></i> ‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h3><label class="filter-pill"><input type="checkbox" id="hideCompleted" onchange="toggleFilter()" checked> ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß</label></div>
             <div style="overflow-x:auto;"><table id="worksTable"><thead><tr><th>Time</th><th>User</th><th>Title</th><th>Link</th><th>Status</th><th>Score</th><th>Action</th></tr></thead><tbody></tbody></table></div>
             <div id="works-pagination" class="pagination"></div>

             <div class="header-row"><h3><i class="fa-solid fa-bolt"></i> Daily Answers</h3></div>
             <div style="overflow-x:auto;"><table id="questTable"><thead><tr><th>Time</th><th>User</th><th>Answer</th><th>Status</th><th>Total Score</th><th>Action</th></tr></thead><tbody></tbody></table></div>
             <div id="quest-pagination" class="pagination"></div>
        </div>

        <div id="tab-sidequest" class="tab-content">
            <div style="background:var(--col-bg); padding:20px; border-radius:12px; margin-bottom:20px; border:1px solid var(--border-color);">
                <div class="flex-between" style="cursor:pointer;" onclick="toggleForm()">
                    <h3 style="margin:0; color:var(--primary);"><i class="fa-solid fa-plus-circle"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</h3>
                    <div><button class="btn-sm btn-dark" onclick="openArchiveModal()"><i class="fa-solid fa-box-archive"></i> ar¬∑chive</button> <i class="fa-solid fa-chevron-down"></i></div>
                </div>
                <div id="sq-form" style="display:none; margin-top:15px;">
                    <input type="hidden" id="edit-id">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                        <input type="text" id="sq-title" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô...">
                        <input type="text" id="sq-desc" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...">
                    </div>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <select id="sq-priority"><option value="Low">üü¢ Low</option><option value="Medium" selected>üü° Medium</option><option value="High">üî¥ High</option></select>
                        <input type="date" id="sq-due">
                    </div>
                    <p style="margin:5px 0;">Assign to:</p><div id="sq-user-list" style="display:flex; flex-wrap:wrap; gap:5px; max-height:100px; overflow-y:auto; border:1px solid #ccc; padding:5px;"></div>
                    <div style="margin-top:10px;">
                        <button class="magic-btn" onclick="saveSideQuest()">üöÄ Create/Save</button>
                        <button class="btn-sm btn-dark" onclick="resetForm()">Cancel</button>
                    </div>
                </div>
            </div>
            <input type="text" class="search-bar" id="board-search" placeholder="üîç Filter tasks or assignee..." onkeyup="filterBoard()">
            <div class="kanban-board">
                <div class="kanban-col" id="col-Backlog"><div class="kanban-header">üìå Backlog <span class="badge" style="background:#6c757d" id="cnt-Backlog">0</span></div><div id="Backlog" class="kanban-list"></div></div>
                <div class="kanban-col" id="col-Doing"><div class="kanban-header">üöß Doing <span class="badge" style="background:#4361ee" id="cnt-Doing">0</span></div><div id="Doing" class="kanban-list"></div></div>
                <div class="kanban-col" id="col-Review"><div class="kanban-header">üëÄ Review <span class="badge" style="background:#ff9f1c" id="cnt-Review">0</span></div><div id="Review" class="kanban-list"></div></div>
                <div class="kanban-col" id="col-Done"><div class="kanban-header">‚úÖ Done <span class="badge" style="background:#2ec4b6" id="cnt-Done">0</span></div><div id="Done" class="kanban-list"></div></div>
            </div>
        </div>

        <div id="tab-manage-quest" class="tab-content">
             <div style="background:var(--col-bg); padding:20px; border-radius:12px; margin-bottom:20px;">
                <h3>üì¢ Post Daily Quest</h3>
                <input type="text" id="q-text" placeholder="‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°..." style="width:100%; margin-bottom:5px;">
                <div style="display:flex; gap:10px; margin-bottom:10px;"><input type="text" id="q-img" placeholder="Image URL"><input type="text" id="q-link" placeholder="Ext Link"></div>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="q-hours" value="24" placeholder="Hours" style="width:80px;">
                    <input type="number" id="q-score" value="10" step="0.1" placeholder="Score" style="width:80px;">
                    <button class="magic-btn" onclick="createQuest()">Post</button>
                </div>
            </div>
            <div id="active-quest-section" style="display:none; background:#d1e7dd; padding:15px; border-radius:8px; margin-bottom:20px; color:#0f5132;"><h3>üü¢ Active Quest</h3><table id="activeQuestTable"><thead><tr><th>Quest</th><th>Time Left</th><th>Edit</th><th>Stop</th></tr></thead><tbody></tbody></table></div>
            <h3>‚ôªÔ∏è History</h3><table id="questHistoryTable"><thead><tr><th>Quest</th><th>Score</th><th>Action</th></tr></thead><tbody></tbody></table>
        </div>

        <div id="tab-users" class="tab-content">
            <div class="flex-between" style="margin-bottom:10px;">
                <input type="text" class="search-bar" id="userSearch" placeholder="üîç Search user..." onkeyup="filterUsers()" style="margin-bottom:0; width:300px;">
                <div id="bulk-actions" style="display:none;">
                    <button class="btn-sm btn-warning" onclick="bulkAdjust()">üí∞ ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                    <button class="btn-sm btn-danger" onclick="bulkDelete()">üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                </div>
            </div>
            <table id="usersTable"><thead><tr><th><input type="checkbox" onchange="toggleSelectAll(this)"></th><th>User</th><th>Status</th><th>Dates</th><th>Score</th><th>Adjust</th><th>History</th><th>Del</th></tr></thead><tbody></tbody></table>
            <div id="users-pagination" class="pagination"></div>
        </div>

        <div id="tab-leaderboard" class="tab-content"><div id="leaderboardList" style="max-width:700px; margin:0 auto;"></div></div>
    </div>

    <div id="historyModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal()">&times;</span><div style="display:flex;justify-content:space-between;"><h2 id="history-title" style="margin:0;"></h2><button class="btn-sm btn-primary" onclick="copyHistory()">üìã Copy</button></div><div id="history-summary" style="margin:10px 0; font-weight:bold; color:var(--primary);"></div><ul id="history-list" style="list-style:none; padding:0;"></ul></div></div>
    
    <div id="archiveModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="document.getElementById('archiveModal').style.display='none'">&times;</span><h2 style="margin-top:0;">üóÑÔ∏è ar¬∑chive</h2><div id="archive-list"></div></div></div>
    
    <div id="certModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('certModal').style.display='none'">&times;</span>
            <h2>üéì Certificate Settings</h2>
            <input type="hidden" id="cert-uid"><input type="hidden" id="cert-uname">
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <div style="flex:1"><label>Start:</label><input type="date" id="cert-start" onchange="updateCertPreview()"></div>
                <div style="flex:1"><label>End:</label><input type="date" id="cert-end" onchange="updateCertPreview()"></div>
            </div>
            <div id="cert-preview-container"><canvas id="cert-canvas"></canvas></div>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button class="btn-sm btn-primary" onclick="saveUserDates()">üíæ Save Date</button>
                <button class="btn-sm btn-warning" id="btn-gen-pdf" onclick="generateCertPDF()">üñ®Ô∏è Download PDF</button>
            </div>
        </div>
    </div>

    <div id="toast">Saved!</div>

    <script src="firebase-config.js"></script>
    <script>
        const ALLOWED_EMAIL = "medlifeplus@gmail.com";
        const ADMIN_LIFF_ID = "2008959998-yjcNpaGt"; 
        const MY_URL = 'https://mlpditto.github.io/INTERN-PORT/admin.html';
        const auth = firebase.auth();
        
        // Data Caches
        let usersData = [], worksData = [], questsData = [], sideQuestsCache = {};
        let submissionMap = {};
        
        // Pagination State
        const ROWS_PER_PAGE = 10;
        let currentPage = { works: 1, quests: 1, users: 1 };

        // --- Init & Auth ---
        function toggleTheme() { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light'); }
        if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
        
        auth.onAuthStateChanged(user => { 
            if(user && user.email===ALLOWED_EMAIL) { 
                document.getElementById('login-screen').style.display='none'; 
                document.getElementById('dashboard-container').style.display='block'; 
                document.getElementById('admin-email').innerText=user.email; 
                initSystem(); 
            } 
        });
        function sendMagicLink() { const e = document.getElementById('email-input').value; if(e!==ALLOWED_EMAIL)return alert("No Permission"); auth.sendSignInLinkToEmail(e, {url:MY_URL, handleCodeInApp:true}).then(()=>alert("Check Email")); }
        if (auth.isSignInWithEmailLink(window.location.href)) { let e=localStorage.getItem('emailForSignIn')||prompt('Email'); auth.signInWithEmailLink(e, window.location.href).then(()=>location.replace(MY_URL)); }
        function logout() { auth.signOut().then(() => location.reload()); }

        // --- System Logic ---
        let isInit = false;
        async function initSystem() {
            if(isInit) return; isInit = true;
            try { await liff.init({ liffId: ADMIN_LIFF_ID }); } catch(e) {}
            
            // Listeners
            document.addEventListener('keydown', (e) => { if(e.key === "Escape") document.querySelectorAll('.modal').forEach(m => m.style.display='none'); });
            
            loadData();
            initKanban();
            setInterval(updateDoneTimers, 60000);
        }
        function switchTab(id) { 
            document.querySelectorAll('.tab-content, .tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active'); 
            event.target.classList.add('active');
        }

        function loadData() {
            // Works
            db.collection("works").orderBy("timestamp","desc").limit(200).onSnapshot(s => { 
                worksData = s.docs.map(d => ({id: d.id, ...d.data()})); renderTable('works'); 
            });
            // Quests Sub
            db.collection("quest_submissions").orderBy("timestamp","desc").limit(200).onSnapshot(s => { 
                questsData = s.docs.map(d => {
                    const dta = d.data(); submissionMap[`${dta.questId}_${dta.userId}`] = dta.answer;
                    return {id: d.id, ...dta};
                }); 
                renderTable('quests'); 
            });
            // Users
            db.collection("users").orderBy("score","desc").onSnapshot(s => { 
                usersData = s.docs.map(d => ({id: d.id, ...d.data()})); 
                renderTable('users'); renderLeaderboard(); updateAssigneeList();
            });
            // Side Quests
            db.collection("side_quests").orderBy("createdAt","desc").onSnapshot(renderKanban);
            // Active Quests
            loadActiveQuests(); loadQuestHistory();
        }

        // --- Rendering & Pagination ---
        function renderTable(type) {
            const tableBody = document.querySelector(`#${type}Table tbody`);
            const pagination = document.getElementById(`${type}-pagination`);
            let data = (type==='works') ? worksData : (type==='quests') ? questsData : usersData;
            
            // Filter (if works/quests)
            if(type !== 'users') {
                const hide = document.getElementById('hideCompleted').checked;
                if(hide) data = data.filter(d => (type==='works' ? d.status!=='‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß' : d.status!=='checked'));
            } else {
                // Filter User Search
                const term = document.getElementById('userSearch').value.toLowerCase();
                if(term) data = data.filter(u => u.displayName.toLowerCase().includes(term));
            }

            // Pagination Logic
            const page = currentPage[type];
            const start = (page - 1) * ROWS_PER_PAGE;
            const pagedData = data.slice(start, start + ROWS_PER_PAGE);
            const totalPages = Math.ceil(data.length / ROWS_PER_PAGE);

            tableBody.innerHTML = "";
            
            pagedData.forEach(d => {
                if(type === 'works') {
                    const st = d.status==='‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß'?'#2ec4b6':d.status==='‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'?'#ef233c':'#ff9f1c';
                    tableBody.innerHTML += `<tr><td>${d.timestamp?.toDate().toLocaleString('th-TH')||'-'}</td><td><img src="${d.pictureUrl}" class="user-pic">${d.displayName}</td><td>${d.title}</td><td><a href="${d.link}" target="_blank" class="btn-sm btn-dark"><i class="fa-solid fa-link"></i></a></td><td><span class="badge" style="background:${st}">${d.status}</span></td><td><input type="number" id="sc-${d.id}" value="${d.score||0}" style="width:60px;text-align:center;"><button class="btn-sm btn-primary" onclick="svSc('${d.id}','${d.userId}')"><i class="fa-solid fa-save"></i></button></td><td><button class="btn-sm btn-danger" onclick="delWork('${d.id}')"><i class="fa-solid fa-trash"></i></button></td></tr>`;
                } else if(type === 'quests') {
                    const tot = (d.earnedScore||0)+(d.bonusGiven||0);
                    let ans = d.answer; if(ans.startsWith('http')) ans=`<a href="${ans}" target="_blank">Link</a>`;
                    tableBody.innerHTML += `<tr><td>${d.timestamp?.toDate().toLocaleString('th-TH')||'-'}</td><td><img src="${d.pictureUrl}" class="user-pic">${d.displayName}</td><td>${ans}</td><td><span class="badge" style="background:${d.isLate?'#ef233c':'#2ec4b6'}">${d.isLate?'Late':'OnTime'}</span></td><td><input type="number" id="qsc-${d.id}" value="${tot}" style="width:60px;"><button class="btn-sm btn-warning" onclick="upQSc('${d.id}','${d.userId}',${tot},${d.earnedScore||0})">Edit</button></td><td><button class="btn-sm btn-success" onclick="checkQuest('${d.id}')"><i class="fa-solid fa-check"></i></button> <button class="btn-sm btn-danger" onclick="delQSub('${d.id}','${d.userId}',${tot})"><i class="fa-solid fa-trash"></i></button></td></tr>`;
                } else if(type === 'users') {
                    const isIgnored = d.isIgnored;
                    tableBody.innerHTML += `<tr class="${isIgnored?'u-ignored':''}">
                        <td><input type="checkbox" class="user-chk" value="${d.id}" onchange="checkBulkBtn()"></td>
                        <td><img src="${d.pictureUrl}" class="user-pic"> ${d.displayName}</td>
                        <td><button class="btn-sm" style="background:none;color:#333;" onclick="toggleIgnoreUser('${d.id}',${isIgnored})">${isIgnored?'üö´':'üëÅÔ∏è'}</button></td>
                        <td><button class="btn-sm btn-warning" onclick="editCert('${d.id}','${d.displayName}','${d.startDate||''}','${d.endDate||''}')"><i class="fa-regular fa-calendar"></i></button></td>
                        <td style="font-weight:bold;color:var(--primary);">${parseFloat((d.score||0).toFixed(2))}</td>
                        <td><input type="number" id="adj-${d.id}" placeholder="0.0" style="width:60px"><button class="btn-sm btn-success" onclick="adjDec('${d.id}')"><i class="fa-solid fa-save"></i></button></td>
                        <td><button class="btn-sm btn-dark" onclick="showHistory('${d.id}','${d.displayName}',${d.score||0})"><i class="fa-solid fa-clock-rotate-left"></i></button></td>
                        <td><button class="btn-sm btn-danger" onclick="delUser('${d.id}')"><i class="fa-solid fa-trash"></i></button></td>
                    </tr>`;
                }
            });

            // Render Pagination Buttons
            pagination.innerHTML = "";
            for(let i=1; i<=totalPages; i++) {
                pagination.innerHTML += `<button class="page-btn ${i===page?'active':''}" onclick="changePage('${type}',${i})">${i}</button>`;
            }
        }
        function changePage(type, p) { currentPage[type] = p; renderTable(type); }

        // --- Kanban Logic (Updated) ---
        function initKanban() {
            ['Backlog','Doing','Review','Done'].forEach(id => {
                new Sortable(document.getElementById(id), {
                    group: 'kanban', animation: 150, ghostClass: 'drag-ghost',
                    onEnd: e => {
                        const ns = e.to.id; 
                        const updates = {status: ns};
                        if(ns==='Done') updates.doneAt = firebase.firestore.FieldValue.serverTimestamp();
                        db.collection("side_quests").doc(e.item.dataset.id).update(updates);
                    }
                });
            });
        }
        function renderKanban(snapshot) {
            const cols = { "Backlog": document.getElementById("Backlog"), "Doing": document.getElementById("Doing"), "Review": document.getElementById("Review"), "Done": document.getElementById("Done") };
            Object.values(cols).forEach(e => e.innerHTML = "");
            const counts = { "Backlog":0, "Doing":0, "Review":0, "Done":0 };
            const filter = document.getElementById('board-search').value.toLowerCase();

            snapshot.forEach(doc => {
                const q = doc.data();
                sideQuestsCache[doc.id] = q;
                
                // Filter
                let match = (q.title.toLowerCase().includes(filter));
                if(q.assignees) q.assignees.forEach(u => { if(u.name.toLowerCase().includes(filter)) match = true; });
                if(!match) return;

                // Auto Archive Check (8h)
                if(q.status === 'Archived') return;

                if(cols[q.status]) {
                    counts[q.status]++;
                    // Scored Class
                    const scoredClass = q.isScored ? 'scored' : '';
                    
                    // Card HTML
                    const d = document.createElement('div');
                    d.className = `kanban-card card-${q.status} ${scoredClass}`;
                    d.dataset.id = doc.id;
                    d.onclick = (e) => { if(!e.target.closest('button')) d.classList.toggle('expanded'); };

                    let imgs = '<div class="assignee-stack">';
                    if(q.assignees) q.assignees.forEach(u => imgs += `<img src="${u.pic}" class="assignee-img" title="${u.name}">`);
                    imgs += '</div>';

                    // Actions
                    let actions = "";
                    if(q.status === 'Done' && q.doneAt) {
                        actions = `<div class="timer-text" data-done="${q.doneAt.toMillis()}">‚è≥ Loading...</div><button class="btn-sm btn-dark" style="width:100%" onclick="archiveSQ('${doc.id}')">üì• ar¬∑chive</button>`;
                    } else if (!q.isScored) {
                        actions = `<button class="btn-sm btn-success" style="width:100%" onclick="giveScore('${doc.id}')">üí∞ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>`;
                    }

                    // Answer
                    let ans = ""; 
                    // Cross check map
                    if(!q.userAnswer && q.refQuestId && q.assigneeIds?.[0]) q.userAnswer = submissionMap[`${q.refQuestId}_${q.assigneeIds[0]}`];
                    if(q.userAnswer) {
                        let aTxt = q.userAnswer; if(aTxt.startsWith('http')) aTxt=`<a href="${aTxt}" target="_blank">Link</a>`;
                        ans = `<div class="answer-box">üí¨ ${aTxt}</div>`;
                    }

                    d.innerHTML = `<div class="card-badges"><span class="badge" style="background:${getPriColor(q.priority)}">${q.priority}</span></div>
                    <b>${q.title}</b><button class="expand-btn"><i class="fa-solid fa-chevron-down"></i></button>
                    <div class="card-desc">
                        <p>${q.description||'-'}</p>
                        <div style="display:flex;justify-content:space-between;margin-top:5px;">
                            <button class="btn-sm btn-warning" onclick="editSQ('${doc.id}')"><i class="fa-solid fa-pen"></i></button>
                            <button class="btn-sm btn-danger" onclick="delSQ('${doc.id}')"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    ${ans} ${imgs} <div style="margin-top:5px;">${actions}</div>`;
                    
                    cols[q.status].appendChild(d);
                }
            });
            Object.keys(counts).forEach(k => document.getElementById(`cnt-${k}`).innerText = counts[k]);
            updateDoneTimers();
        }
        function getPriColor(p){ return p==='High'?'#ef233c':p==='Medium'?'#ff9f1c':'#2ec4b6'; }
        
        // --- Kanban Actions ---
        async function giveScore(id) {
            const q = sideQuestsCache[id];
            if(!q || !q.assigneeIds?.length) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö");
            const sc = prompt("üí∞ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡πÑ‡∏î‡πâ):", "0.5"); if(!sc) return;
            const note = prompt("üìù Note:", q.title); if(!note) return;
            
            try {
                const batch = db.batch();
                q.assigneeIds.forEach(uid => {
                    batch.update(db.collection("users").doc(uid), { score: firebase.firestore.FieldValue.increment(parseFloat(sc)) });
                    batch.set(db.collection("checkin_logs").doc(), { userId:uid, type:'manual_adjust', amount:parseFloat(sc), note:note, timestamp:firebase.firestore.FieldValue.serverTimestamp() });
                });
                // Update Card
                batch.update(db.collection("side_quests").doc(id), { status:'Done', isScored:true, archiveScore:parseFloat(sc), doneAt:firebase.firestore.FieldValue.serverTimestamp() });
                await batch.commit(); showToast("Scored & Moved to Done!");
            } catch(e) { alert(e.message); }
        }
        
        async function archiveSQ(id) { if(confirm("‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ ar¬∑chive?")) await db.collection("side_quests").doc(id).update({status:'Archived'}); }
        
        // --- Archive & Restore ---
        async function openArchiveModal() {
            const l = document.getElementById("archive-list"); l.innerHTML = "Loading..."; document.getElementById("archiveModal").style.display="block";
            const s = await db.collection("side_quests").where("status","==","Archived").get(); // Client Sort
            let items = s.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=>(b.createdAt?.toMillis()||0)-(a.createdAt?.toMillis()||0));
            
            l.innerHTML = "";
            if(items.length===0) l.innerHTML="<p style='text-align:center'>Empty</p>";
            items.forEach(q => {
                let imgs=""; if(q.assignees) q.assignees.forEach(u=>imgs+=`<img src="${u.pic}" style="width:20px;height:20px;border-radius:50%;">`);
                let scoreInfo = q.archiveScore ? `<span style="color:green;font-weight:bold;">(+${q.archiveScore})</span>` : "";
                
                l.innerHTML += `<div style="padding:10px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between;">
                    <div><b>${q.title}</b> ${scoreInfo} <br>${imgs} <small>${q.description||""}</small></div>
                    <div>
                        <button class="btn-sm btn-dark" onclick="restoreSQ('${q.id}','Backlog')">üìå</button>
                        <button class="btn-sm btn-dark" onclick="restoreSQ('${q.id}','Doing')">üöß</button>
                        <button class="btn-sm btn-dark" onclick="restoreSQ('${q.id}','Done')">‚úÖ</button>
                    </div>
                </div>`;
            });
        }
        async function restoreSQ(id, to) { await db.collection("side_quests").doc(id).update({status:to, doneAt: to==='Done'?firebase.firestore.FieldValue.serverTimestamp():null}); openArchiveModal(); showToast("Restored!"); }

        // --- Bulk Actions & Users ---
        function toggleSelectAll(source) { document.querySelectorAll('.user-chk').forEach(c => c.checked = source.checked); checkBulkBtn(); }
        function checkBulkBtn() { document.getElementById('bulk-actions').style.display = document.querySelectorAll('.user-chk:checked').length > 0 ? 'flex' : 'none'; }
        
        async function bulkAdjust() {
            const sc = prompt("‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö (e.g. 0.5 ‡∏´‡∏£‡∏∑‡∏≠ -1):"); if(!sc) return;
            const note = prompt("‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:"); if(!note) return;
            const ids = Array.from(document.querySelectorAll('.user-chk:checked')).map(c => c.value);
            const batch = db.batch();
            ids.forEach(uid => {
                batch.update(db.collection("users").doc(uid), { score: firebase.firestore.FieldValue.increment(parseFloat(sc)) });
                batch.set(db.collection("checkin_logs").doc(), { userId:uid, type:'manual_adjust', amount:parseFloat(sc), note:note, timestamp:firebase.firestore.FieldValue.serverTimestamp() });
            });
            await batch.commit(); showToast(`Adjusted ${ids.length} users!`); document.querySelectorAll('.user-chk').forEach(c=>c.checked=false); checkBulkBtn();
        }

        // --- Certificate & Privacy ---
        let certUser = null;
        function editCert(uid, name, start, end) {
            certUser = {uid, name};
            document.getElementById('cert-uid').value = uid; document.getElementById('cert-start').value = start; document.getElementById('cert-end').value = end;
            updateCertPreview();
            document.getElementById('certModal').style.display = "block";
        }
        
        async function updateCertPreview() {
            const canvas = document.getElementById('cert-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 800; canvas.height = 600;
            
            // Draw Cert Background
            ctx.fillStyle = "#fff"; ctx.fillRect(0,0,800,600);
            ctx.strokeStyle = "#4361ee"; ctx.lineWidth = 10; ctx.strokeRect(0,0,800,600);
            
            // Text
            const name = certUser.name;
            const s = document.getElementById('cert-start').value;
            const e = document.getElementById('cert-end').value;
            
            ctx.fillStyle = "#333"; ctx.font = "bold 40px Arial"; ctx.textAlign = "center";
            ctx.fillText("CERTIFICATE OF COMPLETION", 400, 150);
            ctx.font = "20px Arial"; ctx.fillText("This is to certify that", 400, 220);
            ctx.fillStyle = "#4361ee"; ctx.font = "bold 50px Arial";
            ctx.fillText(name, 400, 290);
            ctx.fillStyle = "#333"; ctx.font = "20px Arial";
            ctx.fillText("Has successfully completed the internship program", 400, 360);
            
            if(s && e) ctx.fillText(`From ${s} to ${e}`, 400, 420);
            else ctx.fillText("(Date not set)", 400, 420);
            
            // Show Button Logic
            document.getElementById('btn-gen-pdf').style.display = (s && e) ? 'inline-block' : 'none';
        }

        async function saveUserDates() {
            await db.collection("users").doc(certUser.uid).update({ startDate: document.getElementById('cert-start').value, endDate: document.getElementById('cert-end').value });
            showToast("Date Saved"); updateCertPreview();
        }

        function generateCertPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape' });
            const canvas = document.getElementById('cert-canvas');
            const imgData = canvas.toDataURL('image/jpeg', 1.0);
            doc.addImage(imgData, 'JPEG', 10, 10, 280, 190);
            doc.save(`${certUser.name}_Certificate.pdf`);
        }

        async function shareLeaderboard() {
            if(!topUsersCache.length) return alert("No data");
            const privacy = confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n(OK = ‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏á‡∏ä‡∏∑‡πà‡∏≠, Cancel = ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠)");
            let t = "üèÜ Top Scores:\n";
            topUsersCache.slice(0,20).forEach((u, i) => {
                if(privacy) t += `${i+1}. (${u.score}) Lv.${u.lv}\n`;
                else t += `${i+1}. ${u.displayName} (${u.score}) Lv.${u.lv}\n`;
            });
            if(liff.isInClient()) liff.shareTargetPicker([{type:"text",text:t}]);
            else navigator.clipboard.writeText(t).then(()=>alert("Copied!"));
        }

        // --- Helpers ---
        function updateAssigneeList() {
            const div = document.getElementById('sq-user-list'); div.innerHTML = "";
            usersData.forEach(u => { if(!u.isIgnored) div.innerHTML += `<label style="margin-right:10px;font-size:0.9em;"><input type="checkbox" class="sq-user-check" value="${u.id}" data-name="${u.displayName}" data-pic="${u.pictureUrl}"> ${u.displayName}</label>`; });
        }
        function toggleForm() { const f=document.getElementById('sq-form'); f.style.display=f.style.display==='none'?'block':'none'; }
        function resetForm() { document.getElementById('sq-form').style.display='none'; document.getElementById('edit-id').value=""; document.getElementById('sq-title').value=""; }
        async function saveSideQuest() {
            const id = document.getElementById('edit-id').value;
            const t = document.getElementById('sq-title').value;
            const d = document.getElementById('sq-desc').value;
            const p = document.getElementById('sq-priority').value;
            const date = document.getElementById('sq-due').value;
            const chk = document.querySelectorAll('.sq-user-check:checked');
            let assignees = []; chk.forEach(c => assignees.push({uid:c.value, name:c.dataset.name, pic:c.dataset.pic}));
            
            if(!t) return alert("Title?");
            const data = { title:t, description:d, priority:p, dueDate:date, assignees:assignees, assigneeIds:assignees.map(x=>x.uid) };
            
            if(id) { await db.collection("side_quests").doc(id).update(data); showToast("Updated"); }
            else { data.status="Backlog"; data.createdAt=firebase.firestore.FieldValue.serverTimestamp(); await db.collection("side_quests").add(data); showToast("Created"); }
            resetForm();
        }
        function editSQ(id) {
            const q = sideQuestsCache[id]; if(!q) return;
            document.getElementById('edit-id').value = id; document.getElementById('sq-title').value = q.title; document.getElementById('sq-desc').value = q.description; document.getElementById('sq-priority').value = q.priority; document.getElementById('sq-due').value = q.dueDate || "";
            document.querySelectorAll('.sq-user-check').forEach(c => c.checked = (q.assigneeIds||[]).includes(c.value));
            document.getElementById('sq-form').style.display='block';
        }
        async function delSQ(id) { if(confirm("Delete?")) await db.collection("side_quests").doc(id).delete(); }
        function updateDoneTimers() { document.querySelectorAll('.timer-text').forEach(e => { const d=parseInt(e.dataset.done); const left = (d + 8*3600000) - Date.now(); e.innerText = left<=0 ? "Expired" : `‚è≥ ${Math.ceil(left/3600000)}h left`; if(left<=0) db.collection("side_quests").doc(e.closest('.kanban-card').dataset.id).update({status:'Archived'}); }); }
        
        function filterBoard() { renderKanban({forEach:cb=>{ Object.values(sideQuestsCache).forEach(q=>cb({data:()=>q, id:Object.keys(sideQuestsCache).find(k=>sideQuestsCache[k]===q)})) }}); } // Re-trigger render
        function toggleIgnoreUser(id, s) { db.collection("users").doc(id).update({isIgnored:!s}); }
        async function adjDec(id) { const v=prompt("Score:"); if(v) { const n=prompt("Note:"); await db.collection("users").doc(id).update({score:firebase.firestore.FieldValue.increment(parseFloat(v))}); await db.collection("checkin_logs").add({userId:id, type:'manual_adjust', amount:parseFloat(v), note:n, timestamp:firebase.firestore.FieldValue.serverTimestamp()}); showToast("Saved"); }}
        async function showHistory(uid, name, tot) { 
            const m=document.getElementById("historyModal"); document.getElementById("history-title").innerText=name; document.getElementById("history-summary").innerText=`Total: ${tot.toFixed(2)}`; m.style.display="block"; 
            const l=document.getElementById("history-list"); l.innerHTML="Loading...";
            let html=""; 
            // Simplified history load for brevity - in real app, merge logs
            const logs = await db.collection("checkin_logs").where("userId","==",uid).orderBy("timestamp","desc").limit(20).get();
            logs.forEach(d => { const g=d.data(); html += `<li style="padding:10px;border-bottom:1px solid #eee;">${g.type} (${g.note||'-'}) : <b>${g.amount}</b> <br><small>${g.timestamp?.toDate().toLocaleString()}</small></li>`; });
            l.innerHTML = html || "No recent history";
        }
        function closeModal() { document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); }
        async function delUser(id) { if(confirm("Del?")) await db.collection("users").doc(id).delete(); }
        
        // Active Quest Logic (Simplified)
        async function createQuest() { const q={question:document.getElementById('q-text').value, imageUrl:document.getElementById('q-img').value, questLink:document.getElementById('q-link').value, baseScore:parseFloat(document.getElementById('q-score').value), deadline:new Date(Date.now()+parseFloat(document.getElementById('q-hours').value)*3600000), createdAt:firebase.firestore.FieldValue.serverTimestamp()}; if(q.question) await db.collection("quests").add(q); showToast("Posted"); }
        function loadActiveQuests() { db.collection("quests").orderBy("createdAt","desc").limit(5).onSnapshot(s => { const t=document.querySelector("#activeQuestTable tbody"); t.innerHTML=""; s.forEach(d=>{ const q=d.data(); if(q.deadline?.toDate()>new Date()) t.innerHTML+=`<tr><td>${q.question}</td><td>${Math.ceil((q.deadline.toDate()-new Date())/3600000)}h</td><td>...</td><td><button class="btn-sm btn-danger" onclick="stopQ('${d.id}')">Stop</button></td></tr>`; }) }); }
        async function stopQ(id) { await db.collection("quests").doc(id).update({deadline:new Date()}); }
        function loadQuestHistory() { db.collection("quests").orderBy("createdAt","desc").limit(10).onSnapshot(s=>{ const t=document.querySelector("#questHistoryTable tbody"); t.innerHTML=""; s.forEach(d=>{ const q=d.data(); t.innerHTML+=`<tr><td>${q.question}</td><td>${q.baseScore}</td><td><button onclick="delQ('${d.id}')">Del</button></td></tr>`; }) }); }
        async function delQ(id) { if(confirm("Del?")) await db.collection("quests").doc(id).delete(); }
        
        // Quest & Work Actions
        async function svSc(id, uid) { const s=parseFloat(document.getElementById(`sc-${id}`).value); await db.collection("works").doc(id).update({score:s, status:'‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß'}); await db.collection("users").doc(uid).update({score:firebase.firestore.FieldValue.increment(s)}); showToast("Saved"); }
        async function delWork(id) { if(confirm("Del?")) await db.collection("works").doc(id).delete(); }
        async function checkQuest(id) { await db.collection("quest_submissions").doc(id).update({status:'checked'}); showToast("Checked"); }
        async function upQSc(id, uid, tot, old) { const n=prompt("New Score:", tot); if(n) { const diff = parseFloat(n)-old; await db.collection("quest_submissions").doc(id).update({earnedScore:parseFloat(n), status:'checked'}); await db.collection("users").doc(uid).update({score:firebase.firestore.FieldValue.increment(diff)}); showToast("Updated"); } }
        async function delQSub(id, uid, sc) { if(confirm("Del?")) { await db.collection("quest_submissions").doc(id).delete(); await db.collection("users").doc(uid).update({score:firebase.firestore.FieldValue.increment(-sc)}); } }
        
        function renderLeaderboard() { 
            const l = document.getElementById("leaderboardList"); l.innerHTML=""; 
            usersData.filter(u=>!u.isIgnored).slice(0,10).forEach((u,i) => {
               l.innerHTML += `<div class="leaderboard-card rank-${i+1}"><div style="display:flex;align-items:center;"><b style="width:30px">#${i+1}</b><img src="${u.pictureUrl}" class="user-pic">${u.displayName}</div><b>${parseFloat((u.score||0).toFixed(2))}</b></div>`;
            });
        }
        function copyHistory() { alert("Use generic history logic here"); } // Implemented in prev version, can reuse
    </script>
</body>
</html>

