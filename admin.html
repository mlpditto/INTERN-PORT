<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLP INTERNSHIP PORT</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <div id="liffPreviewModal" class="modal" style="display:none; z-index:9999;">
        <div class="modal-content"
            style="max-width:400px; padding:0; background:black; border-radius:30px; border:8px solid #333; height:80vh; overflow:hidden; position:relative;">
            <div
                style="background:#333; color:white; padding:10px; text-align:center; position:absolute; top:0; width:100%; z-index:10;">
                <span onclick="closeLiffPreview()"
                    style="font-size:24px; cursor:pointer; color:white; position:absolute; right:15px; top:5px;">&times;</span>
                <span style="font-size:0.9em;">üì± LIFF Preview (Admin Mode)</span>
            </div>
            <iframe id="liff-frame" style="width:100%; height:100%; border:none; background:white; margin-top:40px;"
                src=""></iframe>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        /* ... (CSS Base V58-62) ... */
        :root {
            --bg-body: #f4f6f9;
            --bg-card: #ffffff;
            --text-main: #333;
            --text-sub: #666;
            --col-bg: #f8f9fa;
            --border-color: #e0e0e0;
            --primary: #4361ee;
            --success: #2ec4b6;
            --warning: #ff9f1c;
            --danger: #ef233c;
            --dark: #2b2d42;
        }

        body.dark-mode {
            --bg-body: #1a1a1a;
            --bg-card: #2d2d2d;
            --text-main: #e0e0e0;
            --text-sub: #ccc;
            --col-bg: #333;
            --border-color: #444;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            transition: 0.3s;
        }

        #dashboard-container {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: var(--bg-card);
            margin: 5% auto;
            padding: 25px;
            border-radius: 12px;
            width: 95%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            color: var(--text-main);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .close-modal {
            float: right;
            font-size: 24px;
            cursor: pointer;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-card);
            color: var(--text-main);
            box-sizing: border-box;
        }

        .magic-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-sm {
            padding: 5px 10px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            color: white;
            font-size: 0.85em;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background: var(--primary);
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-warning {
            background: var(--warning);
            color: black;
        }

        .btn-dark {
            background: var(--dark);
        }

        .btn-toggle {
            background: #e9ecef;
            color: #333;
            border: 1px solid #ccc;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-toggle.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-card);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-nav {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
            padding-bottom: 5px;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-sub);
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .kanban-board {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding-bottom: 20px;
            min-height: 600px;
        }

        .kanban-col {
            flex: 1;
            min-width: 300px;
            background: var(--col-bg);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
        }

        .kanban-card {
            background: var(--bg-card);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 10px;
            border-left: 5px solid #ccc;
            position: relative;
        }

        .kanban-card.project {
            background-color: #fff0f5;
            border-left: 5px solid #e83e8c;
        }

        .kanban-card.scored {
            background-color: #d1e7dd;
            border-left: 5px solid var(--success);
        }

        .card-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .card-header-right {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .assignee-stack {
            display: flex;
            margin-right: 5px;
        }

        .assignee-img {
            width: 28px !important;
            height: 28px !important;
            flex-shrink: 0;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--bg-card);
            margin-left: -8px;
        }

        .arrow-controls {
            display: flex;
            gap: 2px;
        }

        .btn-arrow {
            background: var(--col-bg);
            border: 1px solid var(--border-color);
            color: var(--text-sub);
            border-radius: 4px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .card-tool-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            border-top: 1px solid var(--border-color);
            padding-top: 8px;
        }

        .card-timers {
            font-size: 0.8em;
            margin-top: 5px;
            font-family: monospace;
        }

        .timer-global {
            color: #e67e22;
            display: block;
        }

        .timer-active {
            color: #4361ee;
            font-weight: bold;
            display: block;
        }

        .timer-cooldown {
            color: #ef233c;
            font-weight: bold;
            display: block;
        }

        .chat-box {
            height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            background: var(--col-bg);
        }

        .chat-msg {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 0.95em;
            max-width: 80%;
            position: relative;
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .msg-admin {
            background: #d1e7dd;
            margin-left: auto;
            text-align: right;
            color: #0f5132;
            flex-direction: row-reverse;
        }

        .msg-user {
            background: #fff;
            border: 1px solid #ddd;
            text-align: left;
        }

        .chat-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .tag-in {
            background: #d4edda;
            color: #155724;
            padding: 2px 5px;
            border-radius: 4px;
            font-weight: bold;
        }

        .tag-out {
            background: #fff3cd;
            color: #856404;
            padding: 2px 5px;
            border-radius: 4px;
            font-weight: bold;
        }

        .user-pic {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: bold;
            color: white;
            display: inline-block;
        }

        .u-ignored {
            opacity: 0.5;
            filter: grayscale(1);
        }

        .quest-deadline {
            font-weight: bold;
            color: #e67e22;
            font-family: monospace;
        }

        .input-wide {
            flex: 2 !important;
        }

        .lb-container {
            background: var(--bg-card);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            padding: 10px;
        }

        .lb-row {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            justify-content: space-between;
            margin-bottom: 5px;
            border-radius: 8px;
            transition: 0.2s;
        }

        .lb-row:hover {
            background: var(--col-bg);
            transform: translateX(5px);
        }

        .lb-left {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 2;
        }

        .lb-mid {
            flex: 3;
            height: 60px;
            margin: 0 20px;
            position: relative;
            display: flex;
            align-items: flex-end;
            border-bottom: 1px solid #eee;
        }

        .chart-bar {
            background: var(--primary);
            opacity: 0.6;
            margin-right: 2px;
            min-width: 4px;
            border-radius: 2px 2px 0 0;
            position: absolute;
            bottom: 0;
            transition: height 0.3s;
        }

        .chart-bar:hover {
            opacity: 1;
            transform: scaleY(1.1);
        }

        .chart-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ef233c;
            opacity: 0.5;
            z-index: 0;
        }

        .chart-marker.start {
            background: #28a745;
        }

        .chart-marker span {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.6em;
            color: #666;
            white-space: nowrap;
        }

        .lb-rank {
            width: 40px;
            text-align: center;
            font-weight: 900;
            font-size: 1.2em;
            color: var(--text-sub);
        }

        .lb-pic-lg {
            width: 50px !important;
            height: 50px !important;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .lb-info {
            display: flex;
            flex-direction: column;
        }

        .lb-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 2px;
        }

        .lb-days {
            font-size: 0.85em;
            color: #666;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .lb-right {
            text-align: right;
            min-width: 100px;
        }

        .lb-score {
            font-weight: 800;
            font-size: 1.4em;
            color: var(--primary);
        }

        .lb-lv {
            font-size: 0.8em;
            color: #999;
            background: #eee;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .rank-1 .lb-rank {
            color: #ffd700;
            font-size: 1.5em;
        }

        .rank-2 .lb-rank {
            color: #c0c0c0;
            font-size: 1.4em;
        }

        .rank-3 .lb-rank {
            color: #cd7f32;
            font-size: 1.3em;
        }

        #login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 3000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
        }

        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }

        .history-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-del-hist {
            padding: 2px 6px;
            font-size: 0.7em;
            background: #ffebeb;
            color: #ef233c;
            border: 1px solid #ef233c;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }

        /* üî• Google Btn Style */
        .btn-google {
            background: #fff;
            color: #757575;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-family: 'Roboto', sans-serif;
            font-weight: 500;
        }

        .btn-google:hover {
            background: #f1f1f1;
        }

        .btn-google img {
            width: 20px;
            height: 20px;
        }

        /* üî• Quiz V71.4 Polish */
        .quiz-q-item {
            border: 1px solid #eee;
            padding: 20px;
            border-radius: 12px;
            background: #ffffff !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            margin-bottom: 15px;
        }

        .correct-circle-label {
            position: relative;
            width: 34px;
            height: 34px;
            cursor: pointer;
            display: inline-block;
            user-select: none;
        }

        .correct-circle-label input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            margin: 0;
            padding: 0;
            cursor: pointer;
            z-index: 2;
        }

        .correct-circle-label .circle-content {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            color: #777;
            font-weight: bold;
            transition: 0.2s all ease;
            font-size: 0.9em;
            pointer-events: none;
            /* Let clicks pass through to the input below */
            z-index: 1;
        }

        .correct-circle-label input:checked+.circle-content {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 0 8px rgba(67, 97, 238, 0.4);
        }



        .q-opt-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .q-opt-prefix {
            font-weight: bold;
            color: var(--primary);
            min-width: 25px;
            font-size: 1.1em;
            text-align: center;
        }
    </style>
</head>

<body>

    <div id="login-screen">
        <div
            style="padding:40px; background:var(--bg-card); border-radius:15px; box-shadow:0 10px 25px rgba(0,0,0,0.1); width:350px; text-align:center; border-top: 5px solid var(--primary);">
            <h2>üîê Admin Portal</h2>
            <p style="color:#666; font-size:0.9em; margin-bottom:20px;">Internal Use Only</p>

            <!-- Magic Link UI -->
            <input type="email" id="email-input" value="" placeholder="Enter Admin Email" style="margin-bottom:10px;">
            <button class="magic-btn" onclick="sendMagicLink()" style="width:100%;">
                ‚ú® Send Login Link
            </button>

            <div style="margin: 15px 0; color: #ccc; font-size: 0.8em; position: relative;">
                <span style="background: var(--bg-card); padding: 0 10px; position: relative; z-index: 1;">OR</span>
                <div style="position: absolute; top: 50%; left: 0; right: 0; border-top: 1px solid #eee; z-index: 0;">
                </div>
            </div>

            <!-- Login Options -->
            <div style="margin-bottom:15px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn-google magic-btn" onclick="loginWithGoogle()"
                    style="width:100%; background:white; color:#444; border:1px solid #ddd;">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google"
                        style="width:18px; vertical-align:middle; margin-right:8px;">
                    Google
                </button>
                <button class="btn-line magic-btn" onclick="loginWithLINE()"
                    style="background:#06c755; color:white; border:none;">
                    <i class="fa-brands fa-line" style="margin-right:5px;"></i>
                    LINE
                </button>
            </div>

            <div id="login-error" style="color:red; margin-top:10px; font-size:0.9em;"></div>

            <div
                style="margin-top: 15px; text-align: left; background: #fffde7; padding: 10px; border-radius: 8px; border: 1px solid #fff59d; font-size: 0.8em; color: #856404;">
                <b>üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô:</b><br>
                1. ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LINE: ‡πÉ‡∏´‡πâ‡∏Å‡∏î <b>"‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏õ‡∏Å‡∏ï‡∏¥"</b> (Chrome/Safari) ‡∏ó‡∏µ‡πà‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ Google
                Login<br>
                2. ‡∏´‡∏≤‡∏Å‡πÉ‡∏ä‡πâ Magic Link: ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡∏ü‡∏£‡∏µ‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô)
            </div>

            <div
                style="margin-top: 20px; font-size: 0.75em; color: #999; border-top: 1px solid #eee; padding-top: 10px;">
                Secure Access via Email, Google or LINE.<br>
            </div>
        </div>
    </div>

    <div id="dashboard-container">
        <div class="flex-between" style="margin-bottom:20px;">
            <div>
                <h2 style="margin:0;"><i class="fa-solid fa-user-shield"></i> Dashboard
                    <span
                        style="font-size:0.5em; background:#ff9f1c; padding:2px 8px; border-radius:10px; color:white; vertical-align:middle; font-weight:bold;">
                        LIFF: V77 | Admin: V77.7
                    </span>
                </h2>
                <span id="admin-email" style="font-size:0.8em; color:var(--text-sub);"></span>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-sm btn-info" onclick="openLiffPreview()"><i class="fa-solid fa-mobile-screen"></i> UI
                    Preview</button>
                <button class="magic-btn" onclick="openShareModal()"><i class="fa-solid fa-share-nodes"></i>
                    Share</button>
                <button class="btn-sm btn-dark" onclick="toggleTheme()"><i class="fa-solid fa-moon"></i></button>
                <button class="magic-btn" style="background:var(--danger);" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('tab-sidequest')">üó∫Ô∏è Kanban</button>
            <button class="tab-btn" onclick="switchTab('tab-assignments')">üì¶ Assignments</button>
            <button class="tab-btn" onclick="switchTab('tab-users')">üë• Users</button>
            <button class="tab-btn" onclick="switchTab('tab-leaderboard')">üèÜ Leaderboard</button>
            <button class="tab-btn" onclick="switchTab('tab-certs')">üéì Certificates</button>
        </div>

        <!-- Old tab-works removed -->

        <div id="tab-sidequest" class="tab-content active">

            <!-- Moved from Works Tab -->
            <div class="header-row"
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3>üìÅ & üìù </h3>
                <button id="btn-toggle-work-archive" class="btn-toggle active" onclick="toggleWorkArchive()">
                    <i class="fa-solid fa-box-archive"></i> fin¬∑ished
                </button>
            </div>

            <!-- Quiz Pending Review Section -->
            <div id="quiz-pending-section" style="margin-bottom:30px; display:none;">
                <h4 style="color:var(--primary); margin-bottom:10px;"><i class="fa-solid fa-clock-rotate-left"></i>
                    ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Pending Review / Late Requests)</h4>
                <div style="overflow-x:auto;">
                    <table id="pendingQuizzesTable">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>User</th>
                                <th>Quiz</th>
                                <th>Correct</th>
                                <th>Points to add</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <hr style="margin:20px 0; border:0; border-top:1px solid #ddd;">
            </div>

            <div
                style="overflow-x:auto; margin-bottom:40px; background:white; padding:15px; border-radius:12px; border:1px solid #eee;">
                <table id="worksTable">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>User</th>
                            <th>Title</th>
                            <th>Link</th>
                            <th>Status</th>
                            <th>Score</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <hr style="margin:30px 0; border:0; border-top:2px dashed #ddd;">

            <!-- Kanban Board Section -->
            <div style="background:var(--col-bg); padding:20px; border-radius:12px; margin-bottom:20px;">
                <div class="flex-between">
                    <h3 style="margin:0; color:var(--primary);">üó∫Ô∏è Kanban Board</h3>
                    <div>
                        <button class="magic-btn" onclick="openTaskModal()">‚ûï Create Task</button>
                        <button class="btn-sm btn-dark" onclick="openArchiveModal()">üóÑÔ∏è ar¬∑chive</button>
                    </div>
                </div>
            </div>
            <input type="text" id="board-search" placeholder="üîç Filter..." onkeyup="filterBoard()">
            <div class="kanban-board">
                <div class="kanban-col" id="col-Backlog">
                    <div style="font-weight:bold;margin-bottom:10px;">üìå Backlog <span class="badge"
                            style="background:#6c757d" id="cnt-Backlog">0</span></div>
                    <div id="Backlog"></div>
                </div>
                <div class="kanban-col" id="col-Doing">
                    <div style="font-weight:bold;margin-bottom:10px;">üöß Doing <span class="badge"
                            style="background:#4361ee" id="cnt-Doing">0</span></div>
                    <div id="Doing"></div>
                </div>
                <div class="kanban-col" id="col-Review">
                    <div style="font-weight:bold;margin-bottom:10px;">üëÄ Review <span class="badge"
                            style="background:#ff9f1c" id="cnt-Review">0</span></div>
                    <div id="Review"></div>
                </div>
                <div class="kanban-col" id="col-Done">
                    <div style="font-weight:bold;margin-bottom:10px;">‚úÖ Done <span class="badge"
                            style="background:#2ec4b6" id="cnt-Done">0</span></div>
                    <div id="Done"></div>
                </div>
            </div>
        </div>

        <div id="tab-assignments" class="tab-content">
            <!-- 1. Daily Quest Section -->
            <div
                style="background:#f8f9fa; padding:20px; border-radius:12px; margin-bottom:30px; border:1px solid #eee;">
                <h3
                    style="color:#d35400; display:flex; align-items:center; gap:10px; border-bottom:1px solid #ddd; padding-bottom:10px; margin-bottom:20px;">
                    <i class="fa-solid fa-scroll"></i> Daily Quest
                </h3>

                <div
                    style="background:white; padding:20px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.05); margin-bottom:20px;">
                    <h4 style="margin-top:0;">üì¢ Create New Quest</h4>
                    <input type="text" id="q-text" placeholder="‡πÇ‡∏à‡∏ó‡∏¢‡πå..." style="width:100%; margin-bottom:5px;">
                    <div style="display:flex; gap:10px; margin-bottom:5px;">
                        <input type="text" id="q-img" placeholder="Img URL" class="input-wide" style="flex:2">
                        <input type="text" id="q-link" placeholder="Link" class="input-wide" style="flex:2">
                        <input type="text" id="q-target-group-manual" placeholder="Target Group (Public, IT...)"
                            list="group-list" style="flex:2">
                    </div>
                    <div style="display:flex; align-items:flex-end; gap:15px; margin-top:10px;">
                        <div>
                            <label
                                style="font-size:0.85em; font-weight:bold; color:#555; display:block; margin-bottom:3px;">Expires
                                (hr)</label>
                            <input type="number" id="q-hours" value="24"
                                style="width:80px; margin:0; text-align:center;">
                        </div>
                        <div>
                            <label
                                style="font-size:0.85em; font-weight:bold; color:#555; display:block; margin-bottom:3px;">Duration
                                (min)</label>
                            <input type="number" id="q-duration" value="30"
                                style="width:80px; margin:0; text-align:center;">
                        </div>
                        <div>
                            <label
                                style="font-size:0.85em; font-weight:bold; color:#555; display:block; margin-bottom:3px;">Score</label>
                            <input type="number" id="q-score" value="0.1" step="0.1"
                                style="width:80px; margin:0; text-align:center;">
                        </div>
                        <div style="flex-grow:1;"></div>
                        <button class="magic-btn" onclick="createQuest()" style="margin:0; height:38px;">Post
                            Quest</button>
                    </div>
                </div>

                <div id="active-quest-section"
                    style="display:none; background:#d1e7dd; padding:15px; border-radius:8px; margin-bottom:20px;">
                    <h4 style="margin:0 0 10px 0; color:#0f5132;">üü¢ Active Quests</h4>
                    <table id="activeQuestTable">
                        <thead>
                            <tr>
                                <th>Quest</th>
                                <th>Expires</th>
                                <th>Duration</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div style="margin-top:20px;">
                    <h4 style="cursor:pointer; color:#666;"
                        onclick="document.getElementById('questHistoryTable').parentElement.style.display = document.getElementById('questHistoryTable').parentElement.style.display === 'none' ? 'block' : 'none'">
                        <i class="fa-solid fa-clock-rotate-left"></i> Quest History (Click to Toggle)
                    </h4>
                    <div style="display:none;">
                        <table id="questHistoryTable">
                            <thead>
                                <tr>
                                    <th>Quest</th>
                                    <th>Score</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 2. Quiz Section -->
            <div
                style="background:#e3f2fd; padding:20px; border-radius:12px; margin-bottom:30px; border:1px solid #bbdefb;">
                <div class="flex-between"
                    style="border-bottom:1px solid #90caf9; padding-bottom:10px; margin-bottom:20px;">
                    <h3 style="margin:0; color:#1565c0; display:flex; align-items:center; gap:10px;">
                        <i class="fa-solid fa-brain"></i> Quizzes
                    </h3>
                    <button class="magic-btn" onclick="openQuizModal()" style="background:#1565c0;">Create Quiz</button>
                </div>

                <!-- Active Quizzes -->
                <h4 style="color:#0d47a1; margin-bottom:10px;">üü¢ Active Quizzes (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)</h4>
                <div
                    style="overflow-x:auto; margin-bottom:30px; background:white; padding:15px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                    <table id="quizzesTableActive" style="width:100%;">
                        <thead>
                            <tr style="background:#e0f7fa;">
                                <th>Title</th>
                                <th>Questions</th>
                                <th>Score/Q</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Inactive / Templates -->

                <h4 style="color:#6c757d; margin-bottom:10px;">‚ö™ Inactive / Templates (‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤/‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï)</h4>
                <div
                    style="overflow-x:auto; background:white; padding:15px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                    <table id="quizzesTableInactive" style="width:100%; opacity:0.8;">
                        <thead>
                            <tr style="background:#f1f3f5;">
                                <th>Title</th>
                                <th>Questions</th>
                                <th>Score/Q</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-users" class="tab-content">
            <input type="text" id="userSearch" placeholder="üîç Search..." onkeyup="filterUsers()">
            <table id="usersTable">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Group</th>
                        <th>Status</th>
                        <th>Score</th>
                        <th>Adjust</th>
                        <th>History</th>
                        <th>Del</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="tab-leaderboard" class="tab-content">
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; max-width:900px; margin:0 auto 20px;">
                <h3 style="margin:0;"><i class="fa-solid fa-ranking-star"></i> Rankings</h3>
                <button class="btn-sm btn-info" onclick="openDivisionsModal()"><i class="fa-solid fa-shield-halved"></i>
                    Manage Divisions</button>
            </div>
            <div id="leaderboardList" class="lb-container" style="max-width:900px; margin:0 auto;"></div>
        </div>

        <div id="tab-certs" class="tab-content">
            <div style="text-align:right; margin-bottom:15px;">
                <button class="magic-btn" onclick="generateBulkCert()" style="background:#e67e22;"><i
                        class="fa-solid fa-file-pdf"></i> üì¶ Bulk Export All</button>
            </div>
            <div style="overflow-x:auto;">
                <table id="certsTable">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Full Name (Certificate)</th>
                            <th>Internship Period</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="taskModal" class="modal">
            <div class="modal-content"><span class="close-modal"
                    onclick="document.getElementById('taskModal').style.display='none'">&times;</span>
                <h2 id="task-modal-title">New Task</h2><input type="hidden" id="edit-id">
                <div style="display:flex; gap:10px;"><input type="text" id="sq-title" placeholder="Topic"
                        style="flex:2;"><select id="sq-priority" style="flex:1;">
                        <option value="Low">Low</option>
                        <option value="Medium" selected>Medium</option>
                        <option value="High">High</option>
                    </select></div><textarea id="sq-desc" rows="3" placeholder="Description"></textarea>
                <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;"><input type="date"
                        id="sq-due" style="flex:1;"><label
                        style="flex:1; cursor:pointer; background:#fff0f5; padding:8px; border-radius:6px; border:1px solid #e83e8c; color:#e83e8c; font-weight:bold;"><input
                            type="checkbox" id="sq-isProject" style="width:auto; margin:0;"> üíñ Mark as Project</label>
                </div>
                <p>Assign to:</p>
                <div id="sq-user-list"
                    style="display:flex; flex-wrap:wrap; gap:5px; max-height:100px; overflow-y:auto; border:1px solid #ddd; padding:5px;">
                </div><button class="magic-btn" style="width:100%; margin-top:15px;" onclick="saveSideQuest()">üöÄ
                    Save</button>
            </div>
        </div>
        <div id="chatModal" class="modal">
            <div class="modal-content"><span class="close-modal"
                    onclick="document.getElementById('chatModal').style.display='none'">&times;</span>
                <h3 id="chat-title">üí¨ Project Chat</h3><input type="hidden" id="chat-card-id">
                <div id="chat-box" class="chat-box"></div>
                <div style="display:flex; gap:5px;"><input type="text" id="chat-input" placeholder="Type @name..."
                        style="margin:0;"><button class="btn-primary" onclick="sendChat()"><i
                            class="fa-solid fa-paper-plane"></i></button></div>
            </div>
        </div>
        <div id="historyModal" class="modal">
            <div class="modal-content"><span class="close-modal"
                    onclick="document.getElementById('historyModal').style.display='none'">&times;</span>
                <h2 id="history-title"></h2>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 id="history-summary" style="margin:0;color:var(--primary);">Total: 0.00</h3>
                    <button class="btn-sm btn-warning" onclick="recalculateUserScore(currentHistoryUserId)"><i
                            class="fa-solid fa-rotate"></i> Recalculate Score</button>
                </div>
                <ul id="history-list" style="list-style:none; padding:0;"></ul>
                <div id="history-controls" class="history-controls"></div>
            </div>
        </div>

        <div id="divisionsModal" class="modal">
            <div class="modal-content" style="max-width:500px; text-align:left;">
                <span class="close-modal" onclick="closeModal()">&times;</span>
                <h3>üõ°Ô∏è Manage Divisions (V77.8)</h3>
                <p style="font-size:0.85em; color:#666; margin-bottom:15px;">
                    Users from different Groups can be ranked together in a Division.
                </p>
                <div id="div-list-admin"
                    style="margin-bottom:20px; border:1px solid #eee; border-radius:8px; padding:10px; background:#fafafa; max-height:200px; overflow-y:auto;">
                    <!-- List of divisions -->
                </div>

                <h4 style="margin-bottom:10px;">‚ûï Add New Division</h4>
                <div style="display:flex; flex-direction:column; gap:10px;">
                    <input type="text" id="new-div-name" placeholder="Division Name (e.g. Division 1)">
                    <input type="text" id="new-div-groups" placeholder="Groups (comma separated): IT, Marketing...">
                    <button class="btn-primary" onclick="addDivision()" style="width:auto;">Add</button>
                </div>

                <button class="btn-success" style="width:100%; margin-top:20px; padding:12px;"
                    onclick="saveDivisions()">üöÄ Save All Config</button>
            </div>
        </div>
        <div id="archiveModal" class="modal">
            <div class="modal-content"><span class="close-modal"
                    onclick="document.getElementById('archiveModal').style.display='none'">&times;</span>
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <h2 style="margin:0;">üóÑÔ∏è ar¬∑chive</h2><button class="btn-sm btn-danger"
                        onclick="confirmClearArchive()">üß® Clear All</button>
                </div>
                <div id="archive-list" style="margin-top:10px;"></div>
            </div>
        </div>
        <div id="delCardModal" class="modal" style="z-index:2200;">
            <div class="modal-content" style="max-width:350px;text-align:center;">
                <h2 style="color:#ef233c;">‚ö†Ô∏è Delete Card?</h2>
                <p>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</p><button id="btn-del-card-confirm" class="magic-btn"
                    style="background:#ef233c;width:100%;">Confirm (5)</button>
            </div>
        </div>
        <div id="clearConfirmModal" class="modal" style="z-index:2100;">
            <div class="modal-content" style="max-width:350px;text-align:center;">
                <h2 style="color:#ef233c;">‚ö†Ô∏è Clear Archive?</h2>
                <p>‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?</p><button id="btn-confirm-clear" class="magic-btn"
                    style="background:#ccc;width:100%;" disabled>Confirm (5)</button>
            </div>
        </div>
        <div id="certModal" class="modal">
            <div class="modal-content"><span class="close-modal"
                    onclick="document.getElementById('certModal').style.display='none'">&times;</span>
                <h2>üéì Certificate</h2><input type="hidden" id="cert-uid"><input type="hidden" id="cert-uname">
                <div style="margin-bottom:15px;">
                    <label style="font-size:0.8em; color:#666;">Full Name (‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•):</label>
                    <input type="text" id="cert-fullname" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤..."
                        onkeyup="updateCertPreview()">
                </div>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <div style="flex:1"><label>Start:</label><input type="date" id="cert-start"
                            onchange="updateCertPreview()"></div>
                    <div style="flex:1"><label>End:</label><input type="date" id="cert-end"
                            onchange="updateCertPreview()">
                    </div>
                </div>
                <div id="cert-preview-container"
                    style="text-align:center; border:2px solid #ddd; padding:15px; margin-bottom:15px; background:#f9f9f9; border-radius:12px; overflow:hidden; display: flex; justify-content: center; align-items: center;">
                    <canvas id="cert-canvas" width="800" height="600"
                        style="max-width:100%; height:auto; border-radius:4px; box-shadow:0 4px 15px rgba(0,0,0,0.1);"></canvas>
                </div>
                <div style="display:flex; gap:10px; justify-content:flex-end;"><button class="btn-sm btn-primary"
                        onclick="saveUserDates()">üíæ Save & Approve</button><button class="btn-sm btn-warning"
                        id="btn-gen-pdf" onclick="generateCertPDF()">üñ®Ô∏è PDF</button></div>
            </div>
        </div>
        <div id="quizManageModal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <span class="close-modal"
                    onclick="document.getElementById('quizManageModal').style.display='none'">&times;</span>
                <h2 id="quiz-manage-title">Manage Quiz <span id="auto-save-status"
                        style="font-size:0.5em; color:var(--success); display:none; margin-left:10px;">Saved</span></h2>
                <input type="hidden" id="edit-quiz-id">
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <div style="flex:2;">
                        <label style="font-size:0.8em; color:#666;">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏° (Full Title)</label>
                        <input type="text" id="quiz-title" placeholder="Quiz Title (Full)">
                    </div>
                    <div style="flex:1;">
                        <label style="font-size:0.8em; color:#666;">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠ (Short)</label>
                        <input type="text" id="quiz-short-title" placeholder="Short Name">
                    </div>
                    <div style="flex:1;">
                        <label style="font-size:0.8em; color:#1565c0; font-weight:bold;">üéØ Target Group</label>
                        <input type="text" id="quiz-target-group" placeholder="e.g. Public, IT" list="group-list">
                        <datalist id="group-list">
                            <option value="Public">
                            <option value="IT">
                            <option value="Marketing">
                        </datalist>
                    </div>
                    <div style="flex:1;">
                        <label style="font-size:0.8em; color:#666;">Points (‡πÄ‡∏ï‡πá‡∏°)</label>
                        <input type="number" id="quiz-total-points" value="1.0" step="0.1">
                    </div>
                    <div
                        style="flex:1; display:flex; flex-direction:column; justify-content:flex-end; padding-bottom:10px;">
                        <label
                            style="cursor:pointer; background:var(--col-bg); border:1px solid var(--border-color); padding:8px; border-radius:6px; font-size:0.85em; font-weight:bold; color:var(--primary); display:flex; align-items:center; gap:5px; margin:0;">
                            <input type="checkbox" id="quiz-is-poll" onchange="updatePollUI()"
                                style="width:auto; margin:0;"> üó≥Ô∏è Poll Mode
                        </label>
                    </div>
                </div>
                <div style="display:flex; gap:10px; margin-top:5px; margin-bottom:10px;">
                    <div style="flex:1;">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2px;">
                            <label style="font-size:0.8em; color:#4361ee; font-weight:bold; margin:0;"><i
                                    class="fa-solid fa-calendar-play"></i> Start Time</label>
                            <button class="btn-sm btn-success"
                                style="padding:2px 8px; font-size:0.7em; background:#2ec4b6; margin:0;"
                                onclick="goLiveNow()">üöÄ Go Live</button>
                        </div>
                        <input type="datetime-local" id="quiz-start-time" lang="en-GB">
                    </div>
                    <div style="flex:1;">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2px;">
                            <label style="font-size:0.8em; color:#ef233c; font-weight:bold; margin:0;"><i
                                    class="fa-solid fa-hourglass-end"></i> Deadline</label>
                            <button class="btn-sm btn-danger" style="padding:2px 8px; font-size:0.7em; margin:0;"
                                onclick="endQuizNow()">üõë End Now</button>
                        </div>
                        <input type="datetime-local" id="quiz-deadline" lang="en-GB">
                    </div>
                </div>
                <textarea id="quiz-desc" placeholder="Description" style="margin-top:10px;"></textarea>
                <hr>
                <h3>Questions (<span id="quiz-q-counter">0</span>)</h3>
                <div
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; background:var(--col-bg); padding:10px; border-radius:8px;">
                    <div style="display:flex; gap:5px;">
                        <button class="btn-sm btn-dark" onclick="addQuestionUI()">+ Add New</button>
                    </div>
                    <div id="quiz-pagination-controls" style="display:flex; gap:10px; align-items:center;">
                        <button class="btn-sm btn-dark" onclick="moveQuizQ(-1)"><i class="fa-solid fa-chevron-left"></i>
                            Prev</button>
                        <span id="quiz-q-page-info" style="font-weight:bold; font-family:monospace;">1 / 1</span>
                        <button class="btn-sm btn-dark" onclick="moveQuizQ(1)">Next <i
                                class="fa-solid fa-chevron-right"></i></button>
                    </div>
                </div>
                <div id="quiz-questions-container"
                    style="min-height: 200px; text-align: left; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; background:#fff;">
                </div>
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button class="magic-btn" style="flex:2;" onclick="saveQuiz()">üíæ Save Quiz</button>
                    <button class="btn-sm btn-warning" style="flex:1;" onclick="saveAsTemplate()">üìë Template</button>
                </div>

            </div>
        </div>

        <!-- üî• Quiz Review Modal (Added to fix missing UI) -->
        <div id="quizReviewModal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <span class="close-modal"
                    onclick="document.getElementById('quizReviewModal').style.display='none'">&times;</span>
                <h3 style="color:var(--primary);"><i class="fa-solid fa-magnifying-glass"></i> Review Quiz Attempt</h3>
                <input type="hidden" id="review-attempt-id">
                <div id="review-quiz-container" style="max-height: 500px; overflow-y: auto; margin-top: 15px;">
                    <!-- Content injected by JS renderPendingQuizzes -> reviewQuiz -->
                </div>
                <div style="margin-top: 15px; text-align: right;">
                    <button class="btn-sm btn-dark"
                        onclick="document.getElementById('quizReviewModal').style.display='none'">Close</button>
                </div>
            </div>
        </div>

        <div id="pollResultModal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <span class="close-modal"
                    onclick="document.getElementById('pollResultModal').style.display='none'">&times;</span>
                <h3 style="color:var(--primary);"><i class="fa-solid fa-chart-pie"></i> Poll Results Summary</h3>
                <div id="poll-result-info" style="margin-bottom:15px; font-size:0.9em; color:#666;"></div>
                <div id="poll-result-container" style="max-height: 500px; overflow-y: auto;">
                    <!-- Result content injected by JS showPollResults -->
                </div>
                <div style="margin-top: 15px; text-align: right;">
                    <button class="btn-sm btn-dark"
                        onclick="document.getElementById('pollResultModal').style.display='none'">Close</button>
                </div>
            </div>
        </div>

        <div id="shareModal" class="modal" style="z-index:3000;">
            <div class="modal-content" style="max-width:300px;text-align:center;">
                <h3><i class="fa-solid fa-share-nodes"></i> Share Leaderboard</h3><button class="magic-btn"
                    style="width:100%;margin-bottom:10px;" onclick="copyLB(true)">üìã Copy (Show Names)</button><button
                    class="magic-btn" style="width:100%;background:#6c757d;" onclick="copyLB(false)">üïµÔ∏è Copy
                    (Anonymous)</button><button class="btn-sm btn-dark" style="margin-top:10px;"
                    onclick="document.getElementById('shareModal').style.display='none'">Cancel</button>
            </div>
        </div>

        <div id="toast">Saved!</div>

        <script src="firebase-config.js"></script>
        <script>
            const ALLOWED_EMAIL = "medlifeplus@gmail.com";
            const ADMIN_LIFF_ID = "2008959998-yjcNpaGt"; // ‚úÖ Shared LIFF ID
            const MY_URL = 'https://mlp-int.work/admin.html'; // V72.5 Updated to Custom Domain

            const auth = firebase.auth();

            let usersData = [], worksData = [], quizApprovedData = [], sideQuestsCache = {}, questsCache = [], questsSubCache = {};
            let hideCompletedWorks = true;
            let historyCache = []; let historyPage = 1; const HISTORY_PER_PAGE = 10;
            let archiveCache = []; let archivePage = 1; const ARCHIVE_PER_PAGE = 10;
            let deleteCardId = null; let deleteTimer = null;
            let currentHistoryUserId = null;
            let certUser = null;

            function toggleTheme() { document.body.classList.toggle('dark-mode'); }

            auth.onAuthStateChanged(user => {
                if (user) {
                    if (user.email === ALLOWED_EMAIL) {
                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('dashboard-container').style.display = 'block';
                        document.getElementById('admin-email').innerText = user.email;
                        initSystem();
                    } else {
                        // User logged in but not authorized
                        alert(`‚ùå Access Denied\nEmail: ${user.email}\nThis account is not authorized to access the Admin Portal.`);
                        auth.signOut(); // Force logout so they can try again
                    }
                }
            });

            // üî• Google Sign-In Logic
            // üî• Google Sign-In Logic
            function loginWithGoogle() {
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider)
                    .then((result) => {
                        // Success handled by onAuthStateChanged
                        console.log("Google Login Success:", result.user.email);
                    })
                    .catch((error) => {
                        console.error("Google Login Error:", error);
                        alert("Google Login Error: " + error.message);
                        document.getElementById('login-error').innerText = "Google Error: " + error.message;
                    });
            }

            // üî• LINE Login Logic (Admin)
            async function loginWithLINE() {
                try {
                    if (!liff.isLoggedIn()) {
                        liff.login();
                    } else {
                        const profile = await liff.getProfile();
                        const user = liff.getDecodedIDToken();
                        const lineEmail = user.email;

                        if (lineEmail === ALLOWED_EMAIL) {
                            // Custom token logic or manual trigger if already authorized
                            // For static admin, we just rely on onAuthStateChanged or manual UI switch
                            // If LINE email matches, we can use a "Backdoor" or Custom Auth
                            // alert("‚úÖ LINE Auths Success: " + lineEmail);
                            document.getElementById('login-screen').style.display = 'none';
                            document.getElementById('dashboard-container').style.display = 'block';
                            document.getElementById('admin-email').innerText = lineEmail + " (via LINE)";
                            initSystem();
                        } else {
                            alert("‚ùå Access Denied: Your LINE email (" + lineEmail + ") is not authorized.");
                        }
                    }
                } catch (e) {
                    document.getElementById('login-error').innerText = "LINE Error: " + e.message;
                }
            }

            // üî• Magic Link Logic (Replaces Google Sign-In)
            function sendMagicLink() {
                const email = document.getElementById('email-input').value;
                if (email !== ALLOWED_EMAIL) {
                    alert("‚ùå Access Denied: Email not authorized.");
                    return;
                }

                const actionCodeSettings = {
                    url: MY_URL,
                    handleCodeInApp: true
                };

                auth.sendSignInLinkToEmail(email, actionCodeSettings)
                    .then(() => {
                        window.localStorage.setItem('emailForSignIn', email);
                        alert("‚úÖ Link Sent! Check your email to login.");
                    })
                    .catch((error) => {
                        document.getElementById('login-error').innerText = "Error: " + error.message;
                    });
            }

            // Check for Magic Link on Load
            if (auth.isSignInWithEmailLink(window.location.href)) {
                let email = window.localStorage.getItem('emailForSignIn');
                if (!email) {
                    email = window.prompt('Please provide your email for confirmation');
                }
                auth.signInWithEmailLink(email, window.location.href)
                    .then((result) => {
                        window.localStorage.removeItem('emailForSignIn');
                        // Success! onAuthStateChanged will handle the rest
                        window.location.replace(MY_URL.split('?')[0]); // Clean URL
                    })
                    .catch((error) => {
                        document.getElementById('login-error').innerText = "Link Error: " + error.message;
                    });
            }
            function logout() { auth.signOut().then(() => location.reload()); }

            let isInit = false;
            async function initSystem() {
                if (isInit) return; isInit = true;

                // üî• V68: Load Data First (Firefox Protection)
                loadData();
                initKanban();
                initKanban();
                setInterval(updateRealtimeTimers, 1000);
                setInterval(updateQuizCountdown, 1000); // Quiz Countdown
                document.addEventListener('keydown', (e) => { if (e.key === "Escape") document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); });

                // Try LIFF independently (Only if ID is set)
                // Try LIFF independently (Only if ID is set and SDK loaded)
                if (ADMIN_LIFF_ID && window.liff) {
                    try { await liff.init({ liffId: ADMIN_LIFF_ID }); } catch (e) { console.warn("LIFF Init Failed (Non-critical):", e); }
                }
            }

            let quizzesData = [];
            let autoSaveTimer;

            function openQuizModal(id = null) {
                document.getElementById('quizManageModal').style.display = 'block';
                document.querySelector('#quizManageModal h2').innerHTML = 'Manage Quiz <small style="font-size:0.5em; opacity:0.5;">v77.7-STABLE</small>';
                const container = document.getElementById('quiz-questions-container');
                container.innerHTML = "";

                // Auto-save listeners
                setTimeout(() => {
                    const inputs = document.querySelectorAll('#quizManageModal input, #quizManageModal textarea');
                    inputs.forEach(el => el.addEventListener('input', triggerAutoSave));
                }, 500);

                if (id) {
                    const q = quizzesData.find(x => x.id === id);
                    fillQuizForm(q);
                    document.getElementById('edit-quiz-id').value = id;
                } else {
                    // Check for draft
                    const draft = localStorage.getItem('quiz_draft');
                    if (draft && confirm("‡∏û‡∏ö‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à (Draft) ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                        const data = JSON.parse(draft);
                        fillQuizForm(data);
                    } else {
                        resetQuizForm();
                        addQuestionUI();
                    }
                }
                updateQuizPagination();
            }

            function fillQuizForm(q) {
                document.getElementById('quiz-title').value = q.title || "";
                document.getElementById('quiz-short-title').value = q.shortTitle || "";
                document.getElementById('quiz-target-group').value = q.targetGroup || "Public";
                document.getElementById('quiz-total-points').value = q.totalPoints || 1.0;
                document.getElementById('quiz-desc').value = q.description || "";
                document.getElementById('quiz-is-poll').checked = q.isPoll || false;
                updatePollUI();

                const fmt = (d) => {
                    if (!d) return "";
                    // Handle both Firestore Timestamp and ISO string (from draft)
                    try {
                        // If it's a string (from draft), use it directly if it fits, else parse
                        if (typeof d === 'string') return d.slice(0, 16);
                        const dateObj = d.toDate ? d.toDate() : (d instanceof Date ? d : new Date(d));
                        if (isNaN(dateObj.getTime())) return "";
                        return dateObj.toISOString().slice(0, 16);
                    } catch (e) { return ""; }
                };

                document.getElementById('quiz-start-time').value = fmt(q.startTime);
                document.getElementById('quiz-deadline').value = fmt(q.deadline);

                document.getElementById('quiz-questions-container').innerHTML = "";
                if (q.questions) {
                    q.questions.forEach(item => addQuestionUI(item));
                }
                quizQPageIndex = 0;
            }

            function resetQuizForm() {
                document.getElementById('edit-quiz-id').value = "";
                document.getElementById('quiz-title').value = "";
                document.getElementById('quiz-short-title').value = "";
                document.getElementById('quiz-target-group').value = "Public";
                document.getElementById('quiz-total-points').value = 1.0;
                document.getElementById('quiz-desc').value = "";
                document.getElementById('quiz-is-poll').checked = false;
                updatePollUI();
                document.getElementById('quiz-start-time').value = "";
                document.getElementById('quiz-deadline').value = "";
                document.getElementById('quiz-questions-container').innerHTML = "";
                quizQPageIndex = 0;
            }

            function triggerAutoSave() {
                clearTimeout(autoSaveTimer);
                const status = document.getElementById('auto-save-status');
                status.style.display = 'inline';
                status.innerText = 'Typing...';
                status.style.color = '#f72585';

                autoSaveTimer = setTimeout(() => {
                    const data = getQuizFormData();
                    localStorage.setItem('quiz_draft', JSON.stringify(data));
                    status.innerText = 'Saved';
                    status.style.color = 'var(--success)';
                    setTimeout(() => status.style.display = 'none', 2000);
                }, 1000);
            }

            function getQuizFormData() {
                const title = document.getElementById('quiz-title').value.trim();
                const shortTitle = document.getElementById('quiz-short-title').value.trim();
                const targetGroup = document.getElementById('quiz-target-group').value.trim() || "Public";
                const description = document.getElementById('quiz-desc').value;
                const totalPoints = parseFloat(document.getElementById('quiz-total-points').value) || 1.0;
                const isPoll = document.getElementById('quiz-is-poll').checked;

                const qItems = document.querySelectorAll('.quiz-q-item');
                const questions = [];
                qItems.forEach(item => {
                    const qText = item.querySelector('.q-text').value;
                    const qType = item.querySelector('.q-type').value;
                    let opts = [];
                    let correct = 0;

                    if (qType === 'choice') {
                        opts = [...item.querySelectorAll('.q-opt')].map(i => i.value);
                        correct = [...item.querySelectorAll('.q-correct-check:checked')].map(c => parseInt(c.value));
                        if (correct.length === 0) correct = [0]; // Fallback
                    }

                    const timer = parseInt(item.querySelector('.q-timer').value) || 60;
                    questions.push({ q: qText, type: qType, options: opts, correct, timer });
                });

                return {
                    title, shortTitle, targetGroup, description, totalPoints, isPoll, questions,
                    startTime: document.getElementById('quiz-start-time').value,
                    deadline: document.getElementById('quiz-deadline').value
                };
            }

            let quizQPageIndex = 0;
            function updateQuizPagination() {
                updatePollUI();
                const items = document.querySelectorAll('.quiz-q-item');
                const total = items.length;
                if (quizQPageIndex >= total && total > 0) quizQPageIndex = total - 1;
                if (quizQPageIndex < 0) quizQPageIndex = 0;

                items.forEach((item, i) => {
                    item.style.display = (i === quizQPageIndex) ? 'block' : 'none';
                });

                document.getElementById('quiz-q-counter').innerText = total;
                document.getElementById('quiz-q-page-info').innerText = total > 0 ? `${quizQPageIndex + 1} / ${total}` : "0 / 0";
            }

            function moveQuizQ(dir) {
                const total = document.querySelectorAll('.quiz-q-item').length;
                quizQPageIndex += dir;
                if (quizQPageIndex < 0) quizQPageIndex = 0;
                if (quizQPageIndex >= total) quizQPageIndex = total - 1;
                updateQuizPagination();
            }



            function addQuestionUI(data = null) {
                const container = document.getElementById('quiz-questions-container');
                const qId = Date.now() + Math.floor(Math.random() * 1000);
                const div = document.createElement('div');
                div.className = 'quiz-q-item';
                div.dataset.qId = qId;
                const qType = data ? (data.type || 'choice') : 'choice';

                const options = data && data.options ? data.options : ['', '', '', ''];
                const rawCorrect = data && data.correct !== undefined ? data.correct : [0];
                const correct = Array.isArray(rawCorrect) ? rawCorrect.map(v => parseInt(v)) : [parseInt(rawCorrect)];

                div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                    <b style="color:var(--primary); font-size:1.1em;">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° Question</b>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <select class="q-type" onchange="toggleQType(this)" style="width:auto; margin:0; padding:4px; font-size:0.85em;">
                            <option value="choice" ${qType === 'choice' ? 'selected' : ''}>Choice</option>
                            <option value="short_answer" ${qType === 'short_answer' ? 'selected' : ''}>Short Answer</option>
                        </select>
                        <label style="font-size:0.8em; color:#666;">Timer (sec):</label>
                        <input type="number" class="q-timer" value="${data ? (data.timer || 60) : 60}" style="width:70px; margin:0; padding:4px;">
                        <button class="btn-sm btn-danger" onclick="if(confirm('Delete this question?')){this.closest('.quiz-q-item').remove(); updateQuizPagination();}" style="padding:6px 12px;">‚úï Delete</button>
                    </div>
                </div>
                <div style="margin-bottom:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                        <label style="font-size:0.9em; font-weight:bold;">‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: (Short Answer ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏≠‡∏ö)</label>
                        <button type="button" class="btn-sm" onclick="triggerSmartPaste(this)" title="‡∏ß‡∏≤‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å A. B. C. ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥" style="background:#e9f5ff; color:var(--primary); font-size:0.75em; padding:2px 10px; border:1px dashed var(--primary); border-radius:20px;">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> Smart Paste
                        </button>
                    </div>
                    <textarea class="q-text" onpaste="handleQuestionPaste(event, this)" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏≤‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (A., B., C.) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥..." style="height:80px; font-size:1em;">${data ? data.q : ''}</textarea>
                </div>
                
                <div class="options-container" style="display:${qType === 'choice' ? 'flex' : 'none'}; flex-direction:column; gap:8px; margin-bottom:15px;">
                    ${options.map((opt, i) => `
                        <div class="q-opt-row" style="display:flex; align-items:center; gap:8px;">
                            <span class="q-opt-prefix" style="min-width:20px;">${i + 1}.</span>
                            <input type="text" class="q-opt" value="${opt}" placeholder="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${i + 1}" style="flex:1; margin:0;">
                            ${options.length > 2 ? `<button type="button" onclick="removeOption(this)" style="width:30px; min-height:30px; padding:0; background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; border-radius:4px;">‚úï</button>` : ''}
                        </div>
                    `).join('')}
                </div>
                <div class="options-actions" style="display:${qType === 'choice' ? 'block' : 'none'}; margin-bottom:20px;">
                    <button type="button" class="btn-sm" onclick="addOption(this)" style="width:auto; padding:5px 15px; background:#e9f5ff; color:#007bff; border:1px solid #b8daff;"><i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Add Option)</button>
                </div>

                <div class="correct-container" style="display:${qType === 'choice' ? 'flex' : 'none'}; background:#f0f7ff; padding:15px; border-radius:12px; align-items:center; gap:20px; flex-wrap:wrap; border:1px solid #cce5ff;">
                    <label style="font-weight:bold; font-size:0.95em; color:#004085; white-space:nowrap;"><i class="fa-solid fa-check-double"></i> ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1):</label> 
                    <div class="correct-buttons-list" style="display:flex; gap:10px; flex-wrap:wrap;">
                        ${options.map((_, i) => `
                            <label class="correct-circle-label">
                                <input type="checkbox" name="q-correct-${qId}" value="${i}" id="corr-${qId}-${i}" class="q-correct-check" ${correct.includes(i) ? 'checked' : ''} onchange="triggerAutoSave()">
                                <span class="circle-content">${i + 1}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
                container.appendChild(div);
                if (!data) {
                    const total = document.querySelectorAll('.quiz-q-item').length;
                    quizQPageIndex = total - 1;
                }
                updateQuizPagination();
            }

            function toggleQType(el) {
                const item = el.closest('.quiz-q-item');
                const type = el.value;
                item.querySelector('.options-container').style.display = type === 'choice' ? 'flex' : 'none';
                item.querySelector('.options-actions').style.display = type === 'choice' ? 'block' : 'none';
                updatePollUI();
            }

            async function triggerSmartPaste(btn) {
                try {
                    const text = await navigator.clipboard.readText();
                    if (!text) { showToast("Clipboard ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö", "error"); return; }
                    processQuizPaste(text, btn.closest('.quiz-q-item'));
                } catch (e) {
                    showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Clipboard ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö", "error");
                }
            }

            function handleQuestionPaste(e, textarea) {
                const text = (e.clipboardData || window.clipboardData).getData('text');
                if (text && (text.includes('A.') || text.includes('B.') || text.includes('1.') || text.includes('2.'))) {
                    // Timeout to let paste happen, then check if we should process
                    setTimeout(() => {
                        if (confirm("‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                            processQuizPaste(text, textarea.closest('.quiz-q-item'));
                        }
                    }, 100);
                }
            }

            function processQuizPaste(text, item) {
                if (!text) return;
                const rawLines = text.split('\n');
                const optionRegex = /^([A-I]|[1-9])[\.\)\-\s\:]+(.*)/i;

                let questionLines = [];
                let optionsData = [];
                let optionsStarted = false;

                for (let line of rawLines) {
                    const trimmedLine = line.trim();
                    // Skip junk lines (asterisks, scores like 10/10, or short "point" labels)
                    if (trimmedLine === "*" || trimmedLine.match(/^\d+\/\d+$/) || (trimmedLine.toLowerCase().includes('point') && trimmedLine.length < 15)) {
                        continue;
                    }

                    const match = trimmedLine.match(optionRegex);
                    if (match) {
                        optionsStarted = true;
                        optionsData.push(match[2].trim());
                    } else if (!optionsStarted) {
                        questionLines.push(line); // Keep original line for question to preserve line breaks
                    } else {
                        // Continuation of an option or noise between options
                        if (trimmedLine !== "" && optionsData.length > 0) {
                            optionsData[optionsData.length - 1] += " " + trimmedLine;
                        }
                    }
                }

                const questionText = questionLines.join('\n').trim();

                if (optionsData.length > 0) {
                    item.querySelector('.q-text').value = questionText;
                    const optContainer = item.querySelector('.options-container');
                    const correctList = item.querySelector('.correct-buttons-list');
                    const qId = item.dataset.qId;

                    // Clear existing
                    optContainer.innerHTML = "";
                    correctList.innerHTML = "";

                    optionsData.forEach(optVal => {
                        addOption(item.querySelector('.options-actions button'), optVal);
                    });

                    showToast("Smart Paste ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÅ‡∏¢‡∏Å‡∏°‡∏≤‡πÑ‡∏î‡πâ " + optionsData.length + " ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å");
                    triggerAutoSave();
                } else {
                    showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô (A. B. C. ...)", "warning");
                }
            }



            function addOption(btn, val = "") {
                const item = btn.closest('.quiz-q-item');
                const container = item.querySelector('.options-container');
                const correctList = item.querySelector('.correct-buttons-list');
                const count = container.querySelectorAll('.q-opt-row').length;
                const qId = item.dataset.qId;

                // Add Option Row
                const row = document.createElement('div');
                row.className = 'q-opt-row';
                row.style.cssText = 'display:flex; align-items:center; gap:8px;';
                row.innerHTML = `
                    <span class="q-opt-prefix" style="min-width:20px;">${count + 1}.</span>
                    <input type="text" class="q-opt" value="${val}" placeholder="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${count + 1}" style="flex:1; margin:0;">
                    <button type="button" onclick="removeOption(this)" style="width:30px; min-height:30px; padding:0; background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; border-radius:4px;">‚úï</button>
                `;
                container.appendChild(row);

                // Add Correct Button
                const corrLabel = document.createElement('label');
                corrLabel.className = 'correct-circle-label';
                corrLabel.innerHTML = `
                    <input type="checkbox" name="q-correct-${qId}" value="${count}" id="corr-${qId}-${count}" class="q-correct-check" onchange="triggerAutoSave()">
                    <span class="circle-content">${count + 1}</span>
                `;
                correctList.appendChild(corrLabel);
                updateOptionNumbers(item);
            }

            function removeOption(btn) {
                const item = btn.closest('.quiz-q-item');
                btn.closest('.q-opt-row').remove();
                updateOptionNumbers(item);
            }

            function updateOptionNumbers(item) {
                const qId = item.dataset.qId;
                const container = item.querySelector('.options-container');
                const correctList = item.querySelector('.correct-buttons-list');

                // Re-number rows
                container.querySelectorAll('.q-opt-row').forEach((row, i) => {
                    row.querySelector('.q-opt-prefix').innerText = `${i + 1}.`;
                    row.querySelector('input').placeholder = `‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${i + 1}`;
                });

                // Re-generate correct buttons to match indices
                const currentCorrects = [...item.querySelectorAll('.q-correct-check:checked')].map(c => parseInt(c.value));
                correctList.innerHTML = "";
                container.querySelectorAll('.q-opt-row').forEach((_, i) => {
                    const corrLabel = document.createElement('label');
                    corrLabel.className = 'correct-circle-label';
                    corrLabel.innerHTML = `
                        <input type="checkbox" name="q-correct-${qId}" value="${i}" id="corr-${qId}-${i}" class="q-correct-check" ${currentCorrects.includes(i) ? 'checked' : ''} onchange="triggerAutoSave()">
                        <span class="circle-content">${i + 1}</span>
                    `;
                    correctList.appendChild(corrLabel);
                });

                // Keep at least 2 options
                const count = container.querySelectorAll('.q-opt-row').length;
                container.querySelectorAll('button').forEach(b => {
                    if (b.innerText === '‚úï') b.style.display = count <= 2 ? 'none' : 'block';
                });
            }

            function updatePollUI() {
                const isPoll = document.getElementById('quiz-is-poll').checked;
                document.querySelectorAll('.quiz-q-item').forEach(item => {
                    const type = item.querySelector('.q-type').value;
                    const correctContainer = item.querySelector('.correct-container');
                    if (isPoll || type === 'short_answer') {
                        correctContainer.style.display = 'none';
                    } else {
                        correctContainer.style.display = 'flex';
                    }
                });
            }

            async function saveQuiz() {
                const id = document.getElementById('edit-quiz-id').value;
                const formData = getQuizFormData();

                if (!formData.title) return alert("Title required");

                // Validate Questions
                const validQuestions = formData.questions.filter(q => {
                    if (q.type === 'short_answer') return q.q;
                    return q.q && q.options && q.options.every(o => o);
                });
                if (validQuestions.length === 0) return alert("Please add at least one complete question.");

                const convertDate = (val) => {
                    if (!val || val.trim() === "") return null;
                    const d = new Date(val);
                    if (isNaN(d.getTime())) return null;
                    return firebase.firestore.Timestamp.fromDate(d);
                };

                const data = {
                    title: formData.title,
                    shortTitle: formData.shortTitle,
                    targetGroup: formData.targetGroup, // Add targetGroup
                    description: formData.description,
                    totalPoints: formData.totalPoints,
                    isPoll: formData.isPoll,
                    questions: validQuestions,
                    startTime: convertDate(formData.startTime),
                    deadline: convertDate(formData.deadline),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    if (id) {
                        await db.collection("quizzes").doc(id).update(data);
                    } else {
                        data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        data.isActive = true;
                        await db.collection("quizzes").add(data);
                    }
                    localStorage.removeItem('quiz_draft'); // Clear draft on success
                    document.getElementById('quizManageModal').style.display = 'none';
                    showToast("Quiz Saved!");
                } catch (e) {
                    console.error("Save Quiz Error:", e);
                    alert(`Error: ${e.message}`);
                }
            }

            async function saveAsTemplate() {
                const formData = getQuizFormData();
                if (!formData.title || !formData.shortTitle) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Title ‡πÅ‡∏•‡∏∞ Short Title ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï");
                if (!confirm("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï? (‡∏´‡∏≤‡∏Å‡∏°‡∏µ Short Title ‡∏ã‡πâ‡∏≥‡πÄ‡∏î‡∏¥‡∏° ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)")) return;

                const data = {
                    ...formData,
                    isActive: false,
                    isTemplate: true,
                    startTime: null,
                    deadline: null,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    // Check if template with this shortTitle already exists
                    const existing = quizzesData.find(q => q.isTemplate === true && q.shortTitle === formData.shortTitle);

                    if (existing) {
                        // Update existing template
                        await db.collection("quizzes").doc(existing.id).update(data);
                        showToast("Template Updated!");
                    } else {
                        // Create new template
                        data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        await db.collection("quizzes").add(data);
                        showToast("Template Saved!");
                    }
                } catch (e) { alert(e.message); }
            }

            async function goLiveNow() {
                const now = new Date();
                // üî• V77.3: Use Local ISO String for datetime-local input
                const tzOffset = now.getTimezoneOffset() * 60000;
                const localISOTime = new Date(now.getTime() - tzOffset).toISOString().slice(0, 16);

                document.getElementById('quiz-start-time').value = localISOTime;
                if (!confirm("üöÄ Launch Quiz Immediately? (Status will be set to ACTIVE)")) return;

                // Force Active
                const formData = getQuizFormData();
                const id = document.getElementById('edit-quiz-id').value;

                const convertDate = (val) => {
                    if (!val || val.trim() === "") return null;
                    const d = new Date(val);
                    if (isNaN(d.getTime())) return null;
                    return firebase.firestore.Timestamp.fromDate(d);
                };

                const data = {
                    ...formData,
                    isActive: true, // Force Active
                    startTime: convertDate(document.getElementById('quiz-start-time').value),
                    deadline: convertDate(document.getElementById('quiz-deadline').value),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    if (id) {
                        await db.collection("quizzes").doc(id).update(data);
                    } else {
                        data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        await db.collection("quizzes").add(data);
                    }
                    showToast("Quiz is now LIVE!");
                    document.getElementById('quizManageModal').style.display = 'none';
                } catch (e) { alert(e.message); }
            }

            async function endQuizNow() {
                const now = new Date();
                document.getElementById('quiz-deadline').value = now.toISOString().slice(0, 16);
                if (!confirm("üõë End Quiz Immediately? (Deadline will be set to NOW)")) return;
                await saveQuiz();
            }

            function renderPendingQuizzes(data) {
                const tbody = document.querySelector("#pendingQuizzesTable tbody");
                const section = document.getElementById('quiz-pending-section');
                if (data.length === 0) {
                    section.style.display = "none";
                    return;
                }
                section.style.display = "block";
                tbody.innerHTML = "";
                data.forEach(att => {
                    const q = quizzesData.find(x => x.id === att.quizId) || {};
                    const qTitle = q.shortTitle || q.title || "Unknown Quiz";
                    const isPoll = q.isPoll === true;
                    const isRequest = att.status === 'requesting';

                    let actionHtml = "";
                    let pointsToAdd = 0;

                    if (isRequest) {
                        actionHtml = `
                            <button class="btn-sm btn-success" onclick="allowLateQuiz('${att.id}')">Allow Request</button>
                            <button class="btn-sm btn-danger" onclick="rejectQuiz('${att.id}')">Deny</button>
                        `;
                    } else {
                        pointsToAdd = isPoll ? (q.totalPoints || 1.0) : (att.correctCount / att.totalQuestions) * (q.totalPoints || 1.0);
                        actionHtml = `
                            ${isPoll ? '<span class="badge" style="background:#6c757d">Poll Response</span>' : `<button class="btn-sm btn-info" onclick="reviewQuiz('${att.id}')">Review</button>`}
                            <button class="btn-sm btn-success" onclick="approveQuiz('${att.id}', '${att.userId}', ${pointsToAdd})">Approve</button>
                            <button class="btn-sm btn-danger" onclick="rejectQuiz('${att.id}')">Reject</button>
                        `;
                    }

                    tbody.innerHTML += `
                    <tr style="${isRequest ? 'background:#fff8e1;' : ''}">
                        <td>${att.timestamp ? att.timestamp.toDate().toLocaleString('th-TH') : '-'}</td>
                        <td>${att.displayName}</td>
                        <td>${qTitle}</td>
                        <td>${isPoll || isRequest ? '-' : `${att.correctCount}/${att.totalQuestions}`}</td>
                        <td style="font-weight:bold; color:var(--primary);">${isRequest ? 'Request' : pointsToAdd.toFixed(3)}</td>
                        <td>${actionHtml}</td>
                    </tr>
                `;
                });
            }

            async function showPollResults(quizId) {
                window.currentPollQuizId = quizId; // Store for refresh logic
                const quiz = quizzesData.find(x => x.id === quizId);
                if (!quiz) return;

                document.getElementById('pollResultModal').style.display = 'block';
                const container = document.getElementById('poll-result-container');
                const info = document.getElementById('poll-result-info');
                container.innerHTML = "<p>Loading statistics...</p>";
                info.innerText = `Title: ${quiz.title}`;

                try {
                    // Fetch from BOTH poll_responses (anon) and quiz_attempts (regular)
                    const pollSnap = await db.collection("poll_responses").where("quizId", "==", quizId).get();
                    const attemptSnap = await db.collection("quiz_attempts").where("quizId", "==", quizId).get();

                    const allDocs = [...pollSnap.docs, ...attemptSnap.docs];
                    const totalResponses = allDocs.length;
                    info.innerText += ` | Total Responses: ${totalResponses}`;

                    if (totalResponses === 0) {
                        container.innerHTML = "<p style='text-align:center; padding:20px;'>No responses yet.</p>";
                        return;
                    }

                    // üî• Add Participants List (Updated V72.5 - Add Delete Btn)
                    const participants = allDocs.map(d => {
                        const data = d.data();
                        const u = usersData.find(u => u.id === data.userId);
                        return {
                            docId: d.id, // Important for deletion
                            userId: data.userId || 'anon',
                            name: u ? u.displayName : (data.displayName || 'Anonymous'),
                            pic: u ? u.pictureUrl : (data.pictureUrl || ''),
                            timestamp: data.timestamp ? data.timestamp.toDate() : null,
                            collection: d.ref.parent.id, // poll_responses or quiz_attempts
                            scoreGiven: data.status === 'approved' ? (parseFloat(quiz.totalPoints) || 0) : 0 // Assuming Poll always gives full points if approved/present
                        };
                    }).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                    let partHtml = `<div style="margin-bottom:20px; padding:15px; border:1px solid #ddd; border-radius:8px; background:#f0f8ff;">
                    <strong style="display:block; margin-bottom:10px;">üë• Participants (${participants.length})</strong>
                    <div style="max-height:150px; overflow-y:auto; display:flex; flex-wrap:wrap; gap:10px;">`;

                    participants.forEach(p => {
                        const dateStr = p.timestamp ? `(${p.timestamp.toLocaleDateString()})` : '';
                        const picHtml = p.pic ? `<img src="${p.pic}" style="width:20px; height:20px; border-radius:50%; margin-right:5px;">` : '';

                        // Escape quiz title for safely passing to onclick
                        const escapedTitle = quiz.title.replace(/'/g, "\\'");

                        partHtml += `
                    <div style="display:flex; align-items:center; background:white; padding:5px 10px; border-radius:20px; border:1px solid #eee; font-size:0.85em;">
                        ${picHtml}
                        <span>${p.name}</span>
                        <span style="color:#999; font-size:0.8em; margin-left:5px;">${dateStr}</span>
                        <button onclick="deletePollParticipant('${p.docId}', '${p.collection}', '${p.userId}', ${p.scoreGiven}, '${escapedTitle}')" 
                            style="margin-left:8px; border:none; background:none; cursor:pointer; color:#ef233c; font-weight:bold; padding:0;">
                            ‚úï
                        </button>
                    </div>`;
                    });
                    partHtml += `</div></div>`;

                    container.innerHTML = partHtml; // Start with participants list

                    const stats = quiz.questions.map((q, qIdx) => {
                        const isChoice = (q.type || 'choice') === 'choice';
                        const counts = isChoice ? new Array(q.options.length).fill(0) : [];
                        const openAnswers = [];

                        allDocs.forEach(doc => {
                            const data = doc.data();
                            const ans = data.answers ? data.answers[qIdx] : null;
                            if (isChoice) {
                                if (ans !== null && counts[ans] !== undefined) counts[ans]++;
                            } else {
                                if (ans !== undefined && ans !== null) {
                                    // For open answers, show display name if available (not anon)
                                    const prefix = data.displayName ? `<b>${data.displayName}:</b> ` : "";
                                    let displayAns = ans;

                                    if (displayAns === "" || (typeof displayAns === 'string' && displayAns.trim() === "")) {
                                        displayAns = `<span style="color:#ccc; font-style:italic;">(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)</span>`;
                                    } else if (Array.isArray(ans)) {
                                        displayAns = ans.join(" / ");
                                    } else if (typeof ans === 'string' && ans.includes("\n---\n")) {
                                        displayAns = ans.split("\n---\n").join(" / ");
                                    }
                                    openAnswers.push(prefix + displayAns);
                                }
                            }
                        });

                        return { q, counts, openAnswers, isChoice };
                    });

                    const statsHtml = stats.map((stat, i) => {
                        let body = "";
                        if (stat.isChoice) {
                            body = stat.q.options.map((opt, optIdx) => {
                                const count = stat.counts[optIdx];
                                const percent = totalResponses > 0 ? (count / totalResponses * 100).toFixed(1) : 0;
                                return `
                                <div style="margin-bottom:10px;">
                                    <div style="display:flex; justify-content:space-between; font-size:0.9em; margin-bottom:4px;">
                                        <span>${optIdx + 1}. ${opt}</span>
                                        <span><b>${count}</b> (${percent}%)</span>
                                    </div>
                                    <div style="height:10px; background:#eee; border-radius:5px; overflow:hidden;">
                                        <div style="height:100%; background:var(--primary); width:${percent}%;"></div>
                                    </div>
                                </div>
                            `;
                            }).join('');
                        } else {
                            body = `<div style="max-height:150px; overflow-y:auto; background:#f8f9fa; padding:10px; border-radius:8px; font-size:0.85em; border:1px solid #eee;">
                            ${stat.openAnswers.length > 0
                                    ? stat.openAnswers.map(a => `<div style="margin-bottom:5px; border-bottom:1px solid #ddd; padding-bottom:5px;">‚Ä¢ ${a}</div>`).join('')
                                    : 'No text responses.'}
                        </div>`;
                        }

                        return `
                        <div style="border:1px solid #eee; padding:15px; margin-bottom:15px; border-radius:10px; background:#fff;">
                            <b style="color:var(--primary); display:block; margin-bottom:10px;">Q${i + 1}: ${stat.q.q}</b>
                            ${body}
                        </div>
                    `;
                    }).join('');

                    container.innerHTML = partHtml + statsHtml; // üî• Fix: Concat both parts

                } catch (e) {
                    container.innerHTML = `<p style="color:red;">Error: ${e.message}</p>`;
                }
            }

            async function deletePollParticipant(docId, collection, userId, scoreToRemove, quizTitle) {
                if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Poll/Quiz ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?\n(‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${scoreToRemove} ‡πÅ‡∏ï‡πâ‡∏° ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏´‡∏±‡∏Å‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢)`)) return;

                try {
                    const b = db.batch();
                    const docRef = db.collection(collection).doc(docId);

                    // 1. Delete the attempt/response
                    b.delete(docRef);

                    // Check if user actually exists in our local cache before trying to update
                    const userExists = userId && userId !== 'anon' && usersData.some(u => u.id === userId);

                    // 2. Revert Score if applicable
                    if (scoreToRemove > 0 && userExists) {
                        const userRef = db.collection("users").doc(userId);
                        b.update(userRef, { score: firebase.firestore.FieldValue.increment(-scoreToRemove) });

                        // 3. Log the reversion
                        const logRef = db.collection("checkin_logs").doc();
                        b.set(logRef, {
                            userId: userId,
                            type: 'manual_adjust',
                            amount: -scoreToRemove,
                            note: `Revert: Removed from Poll '${quizTitle}'`,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }

                    await b.commit();
                    showToast("Participant removed & Score reverted!");

                    // üî• Refresh the Poll Results UI if we have the quizId
                    if (window.currentPollQuizId) {
                        showPollResults(window.currentPollQuizId);
                    } else {
                        document.getElementById('pollResultModal').style.display = 'none';
                    }
                } catch (e) {
                    console.error("Delete Poll Participant Error:", e);
                    // Detailed error message to help identify permission issues
                    if (e.code === 'permission-denied') {
                        alert("‚ùå Error: Missing or insufficient permissions. \n\n‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏£‡∏∞‡∏î‡∏±‡∏ö Admin ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Firebase ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏•‡πÄ‡∏•‡∏Å‡∏ä‡∏±‡∏ô " + collection + " ‡πÅ‡∏•‡∏∞ log\n(‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á Admin ‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏±‡∏á‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase Rules ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)");
                    } else {
                        alert("Error deleting participant: " + e.message);
                    }
                }
            }

            async function reviewQuiz(attemptId) {
                const attemptDoc = await db.collection("quiz_attempts").doc(attemptId).get();
                if (!attemptDoc.exists) return alert("Data not found");
                const att = attemptDoc.data();
                const quiz = quizzesData.find(x => x.id === att.quizId);

                if (!quiz) return alert("Quiz Reference missing");

                document.getElementById('review-attempt-id').value = attemptId;
                const container = document.getElementById('review-quiz-container');
                container.innerHTML = "";

                quiz.questions.forEach((q, i) => {
                    const studentAns = att.answers[i];
                    const isChoice = (q.type || 'choice') === 'choice';
                    const isCorrect = isChoice ? (studentAns == q.correct) : (att.gradedAnswers && att.gradedAnswers[i]);

                    let studentAnsText = "";
                    let correctAnsText = "";

                    if (isChoice) {
                        studentAnsText = `<b>${q.options[studentAns] || '-'}</b> (Choice ${studentAns + 1})`;
                        correctAnsText = `<span style="color:green;">${q.options[q.correct]}</span> (Choice ${q.correct + 1})`;
                    } else {
                        // Handle Tweetstorm (Array) or Flattened string
                        let ansArray = [];
                        if (Array.isArray(studentAns)) {
                            ansArray = studentAns;
                        } else if (typeof studentAns === 'string' && studentAns.includes("\n---\n")) {
                            ansArray = studentAns.split("\n---\n");
                        }

                        if (ansArray.length > 0) {
                            studentAnsText = `<div style="display:flex; flex-direction:column; gap:8px; margin-top:8px;">
                            ${ansArray.map((tweet, tidx) => `
                                <div style="background:#fff; border:1px solid #1da1f2; padding:10px; border-radius:12px; font-size:0.95em; position:relative;">
                                    <span style="position:absolute; top:5px; right:10px; color:#1da1f2; font-size:0.7em; font-weight:bold;">#${tidx + 1}</span>
                                    <div style="white-space:pre-wrap; color:#333;">${tweet || '-'}</div>
                                    <div style="font-size:0.7em; color:#999; text-align:right; margin-top:4px;">${tweet.length || 0} letters</div>
                                </div>
                            `).join('')}
                        </div>`;
                        } else {
                            studentAnsText = `<div style="background:#fff; padding:10px; border-radius:5px; border:1px solid #ccc; margin-top:5px; white-space:pre-wrap;">${studentAns || '-'}</div>`;
                        }
                        correctAnsText = `<span style="color:#666;">(Subjective Answer - No fixed correct answer)</span>`;
                    }

                    container.innerHTML += `
                    <div style="border:1px solid #ddd; padding:10px; margin-bottom:10px; border-radius:8px; background:${isCorrect ? '#d4edda' : '#f8d7da'}">
                        <b>Q${i + 1}: ${q.q}</b> <span class="badge" style="background:#6c757d; font-size:0.7em;">${isChoice ? 'Choice' : 'Short Answer'}</span><br>
                        <div style="margin-top:5px; font-size:0.9em;">
                             Student: ${studentAnsText} <br>
                             Correct: ${correctAnsText}
                        </div>
                        <div style="margin-top:5px;">
                            <label><input type="checkbox" onchange="manualCorrectAns('${attemptId}', ${i}, this.checked)" ${isCorrect ? 'checked disabled' : ''}> Mark as Correct / Graded</label>
                        </div>
                    </div>
                 `;
                });

                document.getElementById('quizReviewModal').style.display = 'block';
            }

            async function manualCorrectAns(attemptId, qIndex, isChecked) {
                if (!isChecked) return;
                if (!confirm("Confirm grading this question as CORRECT/DONE?\n(Score will be recalculated upon Approval)")) return;

                try {
                    const docRef = db.collection("quiz_attempts").doc(attemptId);
                    const docSnap = await docRef.get();
                    const att = docSnap.data();
                    const quiz = quizzesData.find(x => x.id === att.quizId);
                    const q = quiz.questions[qIndex];

                    // For Choice: Update answer to the correct index if we are overriding
                    // For Short Answer: Just increment correctCount and record in gradedAnswers
                    if (!att.gradedAnswers) att.gradedAnswers = {};
                    att.gradedAnswers[qIndex] = true;

                    if ((q.type || 'choice') === 'choice') {
                        att.answers[qIndex] = q.correct;
                    }

                    att.correctCount++;

                    await docRef.update({
                        answers: att.answers,
                        correctCount: att.correctCount,
                        gradedAnswers: att.gradedAnswers
                    });

                    alert("Updated!");
                    reviewQuiz(attemptId); // Refresh UI
                } catch (e) { alert(e.message); }
            }

            async function approveQuiz(attemptId, uid, score) {
                if (!confirm(`‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏ï‡πâ‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${score.toFixed(3)} ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ?`)) return;
                try {
                    const b = db.batch();
                    b.update(db.collection("quiz_attempts").doc(attemptId), { status: 'approved', approvedAt: firebase.firestore.FieldValue.serverTimestamp() });
                    b.update(db.collection("users").doc(uid), { score: firebase.firestore.FieldValue.increment(score) });
                    b.set(db.collection("checkin_logs").doc(), {
                        userId: uid,
                        type: 'quiz',
                        amount: score,
                        note: `Quiz Approved: ${attemptId.split('_')[0]}`,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    await b.commit();
                    showToast("Approved & Points added!");
                } catch (e) { alert(e.message); }
            }

            async function rejectQuiz(attemptId) {
                if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡πÉ‡∏´‡∏°‡πà)")) return;
                await db.collection("quiz_attempts").doc(attemptId).delete();
                showToast("Rejected & Removed");
            }

            function updateQuizCountdown() {
                const els = document.querySelectorAll('.quiz-countdown');
                if (els.length === 0) return;
                const now = new Date();
                let shouldRerender = false;

                els.forEach(el => {
                    const deadStr = el.getAttribute('data-deadline');
                    if (!deadStr) return;
                    const dead = new Date(deadStr);
                    const diff = dead - now;

                    if (diff <= 0) {
                        el.innerText = "Ended";
                        el.style.color = "#666";
                        shouldRerender = true;
                    } else {
                        const hrs = Math.floor(diff / 3600000);
                        const mins = Math.floor((diff % 3600000) / 60000);
                        const secs = Math.floor((diff % 60000) / 1000);
                        el.innerText = `‚è≥ ${hrs}h ${mins}m ${secs}s`;
                    }
                });

                if (shouldRerender) {
                    console.log("Quiz expired, re-rendering...");
                    renderQuizzes();
                }
            }

            function renderQuizzes() {
                const tbodyActive = document.querySelector("#quizzesTableActive tbody");
                const tbodyInactive = document.querySelector("#quizzesTableInactive tbody");
                tbodyActive.innerHTML = "";
                tbodyInactive.innerHTML = "";
                const now = new Date();

                // üî• V75.1: Separating logic with grouping for Inactive/Templates
                const activeList = [];
                const inactiveGroups = {};

                quizzesData.forEach(q => {
                    const dead = q.deadline ? q.deadline.toDate() : null;
                    const isActuallyActive = q.isActive && (!dead || now <= dead);

                    if (isActuallyActive) {
                        activeList.push(q);
                    } else {
                        // For inactive/templates, group by shortTitle and pick most recent
                        const key = q.shortTitle || q.title || q.id;
                        const time = (q.updatedAt || q.createdAt || { toMillis: () => 0 }).toMillis();
                        if (!inactiveGroups[key] || time > inactiveGroups[key].time) {
                            inactiveGroups[key] = { data: q, time: time };
                        }
                    }
                });

                // Helper to render row
                const generateRow = (q, isActiveSection) => {
                    let statusInfo = "";
                    const start = q.startTime ? q.startTime.toDate() : null;
                    const dead = q.deadline ? q.deadline.toDate() : null;

                    if (!q.isActive) {
                        statusInfo = '<span class="badge" style="background:#6c757d">Inactive</span>';
                    } else if (dead && now > dead) {
                        statusInfo = `<span class="badge" style="background:#ef233c">Expired: ${dead.toLocaleString('th-TH')}</span>`;
                    } else {
                        if (start && now < start) {
                            statusInfo = `<span class="badge" style="background:#ff9f1c">Scheduled: ${start.toLocaleString('th-TH')}</span>`;
                        } else {
                            statusInfo = `<span class="badge" style="background:#2ec4b6">Active</span> <br> <small class="quiz-countdown" data-deadline="${dead ? dead.toISOString() : ''}" style="font-weight:bold; color:#ef233c;"></small>`;
                        }
                    }

                    const hasWriting = q.questions && q.questions.some(x => x.type === 'short_answer');
                    const pollLabel = q.isPoll ? '<span class="badge" style="background:var(--primary);">üó≥Ô∏è POLL</span>' : '';
                    const subjLabel = hasWriting ? '<span class="badge" style="background:#e67e22;">üìù SUBJECTIVE</span>' : '';
                    const templateLabel = (q.isTemplate || !isActiveSection) ? '<div style="margin-top:4px;"><span class="badge" style="background:orange; color:white; font-size:0.75em;">TEMPLATE</span></div>' : '';
                    const targetGroupLabel = q.targetGroup && q.targetGroup !== "Public" ? `<span class="badge" style="background:#007bff; margin-left:5px;">${q.targetGroup}</span>` : '';


                    return `
                    <tr>
                        <td>
                            ${q.title ? q.title.replace(/\s*\(Template\)$/i, '') : '-'} 
                            <br><small style="color:#666;">(${q.shortTitle || '-'})</small> 
                            ${templateLabel}
                            ${pollLabel} ${subjLabel} ${targetGroupLabel}
                        </td>
                        <td>${q.questions ? q.questions.length : 0} Qs</td>
                        <td>${q.totalPoints || 1.0}</td>
                        <td>${statusInfo}</td>
                        <td>
                            <button class="btn-sm btn-primary" onclick="openQuizModal('${q.id}')">Edit</button>
                            <button class="btn-sm btn-dark" onclick="toggleQuizStatus('${q.id}', ${q.isActive})">${q.isActive ? 'End Now' : 'Activate'}</button>
                            ${(q.isPoll || hasWriting) ? `<button class="btn-sm btn-info" style="background:#8e44ad;" onclick="showPollResults('${q.id}')">üìä Result</button>` : ''}
                            ${(!isActiveSection) ? `<button class="btn-sm btn-warning" onclick="repostQuiz('${q.id}')">‚ôªÔ∏è Repost</button>` : ''}
                            <button class="btn-sm btn-danger" onclick="deleteQuiz('${q.id}')">Del</button>
                        </td>
                    </tr>
                `;
                };

                // Render Active
                activeList.forEach(q => { tbodyActive.innerHTML += generateRow(q, true); });

                // Render Inactive (Grouped & Sorted)
                Object.values(inactiveGroups)
                    .sort((a, b) => b.time - a.time)
                    .forEach(group => { tbodyInactive.innerHTML += generateRow(group.data, false); });
            }

            async function repostQuiz(id) {
                if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Repost ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏≠‡∏Å)")) return;
                await db.collection("quizzes").doc(id).update({
                    startTime: null,
                    deadline: null,
                    isActive: true,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast("Reposted!");
            }

            async function toggleQuizStatus(id, current) {
                const updates = { isActive: !current };
                // If ending (deactivating), mark as template
                if (current) updates.isTemplate = true;
                await db.collection("quizzes").doc(id).update(updates);
            }
            async function deleteQuiz(id) { if (confirm("Delete this quiz?")) await db.collection("quizzes").doc(id).delete(); }

            function switchTab(id) {
                document.querySelectorAll('.tab-content,.tab-btn').forEach(e => e.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                const btn = document.querySelector(`button[onclick="switchTab('${id}')"]`);
                if (btn) btn.classList.add('active');

                // Reload data for specific tabs if needed
                if (id === 'tab-assignments') {
                    loadActiveQuests();
                    renderQuizzes();
                } else if (id === 'tab-sidequest') {
                    renderKanban();
                    renderTable('works');
                    // Pending quizzes update automatically via listener, but we can force check if needed
                }
            }

            let divisionConfig = {}; // üî• Added for Divisions V77.8

            function loadData() {
                db.collection("works").orderBy("timestamp", "desc").limit(100).onSnapshot(s => { worksData = s.docs.map(d => ({ id: d.id, ...d.data() })); renderTable('works'); });
                db.collection("users").orderBy("score", "desc").onSnapshot(s => { usersData = s.docs.map(d => ({ id: d.id, ...d.data() })); renderTable('users'); renderLeaderboard(); updateAssigneeList(); renderCertTable(); });
                db.collection("side_quests").orderBy("createdAt", "desc").onSnapshot(renderKanban);
                db.collection("quests").onSnapshot(s => { questsCache = s.docs.map(d => ({ id: d.id, ...d.data() })); loadActiveQuests(); loadQuestHistory(); });
                db.collection("quizzes").onSnapshot(s => { quizzesData = s.docs.map(d => ({ id: d.id, ...d.data() })); renderQuizzes(); });
                // üî• Refined V77.6: Listen only for actionable items (Pending Review or New Request)
                db.collection("quiz_attempts").where("status", "in", ["pending", "requesting"]).onSnapshot(s => {
                    renderPendingQuizzes(s.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                // üî• Fix: Query by timestamp first then filter status (avoids missing index issue)
                db.collection("quiz_attempts").orderBy("timestamp", "desc").limit(100).onSnapshot(s => {
                    quizApprovedData = s.docs
                        .map(d => ({ id: d.id, ...d.data(), isQuiz: true, collection: 'quiz_attempts' }))
                        .filter(d => d.status === 'approved');
                    if (!hideCompletedWorks) renderTable('works');
                });
                // üî• Feature: Load Poll Responses for Works Table
                db.collection("poll_responses").orderBy("timestamp", "desc").limit(50).onSnapshot(s => {
                    const polls = s.docs.map(d => ({ id: d.id, ...d.data(), isQuiz: true, isPollResponse: true, status: 'approved', collection: 'poll_responses' }));
                    window.pollData = polls;
                    if (!hideCompletedWorks) renderTable('works');
                });
                db.collection("quest_submissions").onSnapshot(s => { questsSubCache = {}; s.forEach(d => { questsSubCache[`${d.data().questId}_${d.data().userId}`] = d.data(); }); filterBoard(); });

                // üî• Load Division Config (V77.8)
                db.collection("config").doc("divisions").onSnapshot(doc => {
                    if (doc.exists) divisionConfig = doc.data();
                    renderLeaderboard();
                });
            }

            async function allowLateQuiz(id) {
                if (!confirm("‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏±‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
                try {
                    await db.collection("quiz_attempts").doc(id).update({
                        status: 'allowed',
                        allowedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showToast("Request Allowed!");
                } catch (e) { alert(e.message); }
            }

            async function setUserGroup(uid, current) {
                const newGroup = prompt("‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (Audience Group) ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ:", current);
                if (newGroup === null) return;
                try {
                    await db.collection("users").doc(uid).update({ group: newGroup.trim() || "Public" });
                    showToast("User Group Updated!");
                } catch (e) { alert(e.message); }
            }

            function renderTable(type) {
                const tbody = document.querySelector(`#${type}Table tbody`);
                let data = (type === 'works') ? [...worksData] : [...usersData];
                if (type === 'works') {
                    if (!hideCompletedWorks) {
                        data = [...data, ...quizApprovedData, ...(window.pollData || [])];
                        data.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                    } else {
                        data = data.filter(d => d.status !== '‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß');
                    }
                }
                if (type === 'users') { const t = document.getElementById('userSearch').value.toLowerCase(); if (t) data = data.filter(u => u.displayName.toLowerCase().includes(t)); }
                tbody.innerHTML = "";
                data.slice(0, 50).forEach(d => {
                    if (type === 'works') {
                        const st = d.status === '‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß' ? '#2ec4b6' : d.status === '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' ? '#ef233c' : '#ff9f1c';

                        if (d.isQuiz) {
                            const q = quizzesData.find(x => x.id === d.quizId) || {};
                            const qTitle = q.shortTitle || q.title || "Quiz";
                            const isPoll = q.isPoll === true;
                            const points = isPoll ? (q.totalPoints || 1.0) : (d.correctCount / d.totalQuestions) * (q.totalPoints || 1.0);
                            const reviewBtn = isPoll ? '<span class="badge" style="background:#6c757d">Poll (Anon)</span>' : `<button class="btn-sm btn-info" onclick="reviewQuiz('${d.id}')">Review</button>`;

                            // User Lookup fallback
                            let uImg = d.pictureUrl || d.pic || '';
                            let uName = d.displayName || 'Unknown';
                            if (d.userId) {
                                const u = usersData.find(x => x.id === d.userId);
                                if (u) {
                                    if (!uImg) uImg = u.pictureUrl;
                                    if (uName === 'Unknown' || !uName) uName = u.displayName;
                                }
                            }

                            tbody.innerHTML += `<tr><td>${d.timestamp?.toDate().toLocaleString() || '-'}</td><td><img src="${uImg}" class="user-pic">${uName}</td><td>üìù ${isPoll ? 'Poll' : 'Quiz'}: ${qTitle}</td><td>${reviewBtn}</td><td><span class="badge" style="background:${st}">Approved</span></td><td><b style="color:var(--primary);">${points.toFixed(3)}</b></td><td><button class="btn-sm btn-danger" onclick="delQuizAttempt('${d.id}', '${d.collection}')">Del</button></td></tr>`;
                        } else {
                            // üî• Link Fix
                            let linkUrl = d.link || "";
                            let btnClass = "btn-sm btn-dark";
                            let onclickAttr = "";
                            let hrefAttr = "javascript:void(0)";

                            if (linkUrl.trim() !== "") {
                                if (!linkUrl.startsWith('http')) linkUrl = 'https://' + linkUrl.trim();
                                onclickAttr = `onclick="window.open('${linkUrl}', '_blank')"`;
                            } else {
                                btnClass += " disabled";
                                onclickAttr = "onclick='alert(\"No link provided\")'";
                            }

                            tbody.innerHTML += `<tr><td>${d.timestamp?.toDate().toLocaleString() || '-'}</td><td><img src="${d.pictureUrl}" class="user-pic">${d.displayName}</td><td>${d.title}</td><td><a ${hrefAttr} ${onclickAttr} class="${btnClass}">Link</a></td><td><span class="badge" style="background:${st}">${d.status}</span></td><td><div style="display:flex;"><input type="number" id="sc-${d.id}" value="${d.score || 0}" style="width:60px;"><button class="btn-sm btn-primary" onclick="svSc('${d.id}','${d.userId}')">Save</button></div></td><td><button class="btn-sm btn-danger" onclick="delWork('${d.id}')">Del</button></td></tr>`;
                        }
                    }
                    else {
                        const ignored = d.isIgnored;
                        const lv = Math.floor((d.score || 0) / 10) + 1;
                        const group = d.group || "Public";
                        tbody.innerHTML += `<tr class="${ignored ? 'u-ignored' : ''}">
                            <td><img src="${d.pictureUrl}" class="user-pic"> ${d.displayName}</td>
                            <td><button class="btn-sm btn-info" style="font-size:0.75em; padding:2px 8px;" onclick="setUserGroup('${d.id}', '${group}')">${group}</button></td>
                            <td><button class="btn-sm" onclick="toggleIgnoreUser('${d.id}',${ignored})">${ignored ? 'üö´' : 'üëÅÔ∏è'}</button></td>
                            <td><span class="badge" style="background:#eee;color:#333;margin-right:5px;">Lv.${lv}</span><span style="font-weight:bold;color:var(--primary);">${parseFloat((d.score || 0).toFixed(2))}</span></td>
                            <td><div style="display:flex;"><input type="number" step="0.1" id="adj-${d.id}" placeholder="0.0" style="width:70px;margin:0;" onkeypress="if(event.key==='Enter')adjDec('${d.id}')"><button class="btn-sm btn-success" onclick="adjDec('${d.id}')">Adj</button></div></td>
                            <td><button class="btn-sm btn-dark" onclick="showHistory('${d.id}','${d.displayName}',${d.score || 0})">üìú</button></td>
                            <td><button class="btn-sm btn-danger" onclick="delUser('${d.id}')">Del</button></td>
                        </tr>`;
                    }
                });
            }
            function toggleWorkArchive() { hideCompletedWorks = !hideCompletedWorks; document.getElementById('btn-toggle-work-archive').classList.toggle('active'); renderTable('works'); }
            async function adjDec(id) { try { const valInput = document.getElementById(`adj-${id}`); let v = valInput.value; if (!v) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô"); v = v.replace(',', '.'); const scoreVal = parseFloat(v); if (isNaN(scoreVal)) return alert("‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); const n = prompt("‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (Note):"); if (!n) return; await db.collection("users").doc(id).update({ score: firebase.firestore.FieldValue.increment(scoreVal) }); await db.collection("checkin_logs").add({ userId: id, type: 'manual_adjust', amount: scoreVal, note: n, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); showToast("Saved!"); valInput.value = ""; valInput.blur(); } catch (e) { alert("Error saving score: " + e.message); } }

            function renderCertTable() {
                const t = document.querySelector("#certsTable tbody"); t.innerHTML = "";
                if (!usersData.length) { t.innerHTML = "<tr><td colspan='5'>No data.</td></tr>"; return; }
                const sortedUsers = usersData.filter(u => !u.isIgnored).sort((a, b) => (b.certRequested ? 1 : 0) - (a.certRequested ? 1 : 0));
                sortedUsers.forEach(u => {
                    let dateStr = (u.startDate && u.endDate) ? `${u.startDate} - ${u.endDate}` : '<span style="color:#ccc">Waiting Dates</span>';
                    let status = u.certRequested ? '<span class="badge" style="background:#ffc107;color:black;">üîî Requesting</span>' : '-';
                    let btn = `<button class="btn-sm btn-warning" onclick="openCertModal('${u.id}')">Preview / Edit</button>`;

                    // Full Name Input with Auto-Save
                    let nameInput = `<input type="text" class="form-input" style="width:100%; max-width:200px; padding:5px; margin:0;" 
                    placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏à‡∏£‡∏¥‡∏á" value="${u.fullName || ''}" 
                    onchange="updateFullName('${u.id}', this.value)">`;

                    t.innerHTML += `<tr>
                    <td><img src="${u.pictureUrl}" class="user-pic"> ${u.displayName}</td>
                    <td>${nameInput}</td>
                    <td>${dateStr}</td>
                    <td>${status}</td>
                    <td>${btn}</td>
                </tr>`;
                });
            }

            async function updateFullName(uid, newName) {
                try {
                    await db.collection("users").doc(uid).update({ fullName: newName });
                    showToast("Full Name Saved!");
                    // Update local data
                    const user = usersData.find(u => u.id === uid);
                    if (user) user.fullName = newName;
                } catch (e) {
                    console.error(e);
                    alert("Save failed: " + e.message);
                }
            }
            function openCertModal(uid) {
                const u = usersData.find(x => x.id === uid);
                if (!u) return;
                certUser = { uid: u.id, name: u.displayName };
                document.getElementById('cert-fullname').value = u.fullName || u.displayName || "";
                document.getElementById('cert-start').value = u.startDate || "";
                document.getElementById('cert-end').value = u.endDate || "";
                updateCertPreview();
                document.getElementById('certModal').style.display = "block";
            }
            async function saveUserDates() {
                if (!certUser) return;
                const s = document.getElementById('cert-start').value;
                const e = document.getElementById('cert-end').value;
                const fn = document.getElementById('cert-fullname').value;
                await db.collection("users").doc(certUser.uid).update({
                    startDate: s,
                    endDate: e,
                    fullName: fn,
                    certRequested: false
                });
                showToast("Saved & Approved!");
                document.getElementById('certModal').style.display = "none";
            }

            async function showHistory(uid, name, total) {
                currentHistoryUserId = uid;
                document.getElementById("history-title").innerText = `üìú ${name}`;
                document.getElementById("history-summary").innerText = `Total: ${total.toFixed(2)}`;
                document.getElementById("historyModal").style.display = "block";
                document.getElementById("history-list").innerHTML = "<p>Loading...</p>";
                try {
                    let all = [];
                    const [w, q, l] = await Promise.all([
                        db.collection("works").where("userId", "==", uid).get(),
                        db.collection("quest_submissions").where("userId", "==", uid).get(),
                        db.collection("checkin_logs").where("userId", "==", uid).get()
                    ]);
                    w.forEach(d => { const x = d.data(); if (x.score > 0) all.push({ t: x.timestamp?.toDate(), type: 'work', text: `üìÅ ${x.title}`, score: x.score }); });
                    q.forEach(d => {
                        const x = d.data();
                        const s = (x.earnedScore || 0) + (x.bonusGiven || 0);
                        const qObj = questsCache.find(q => q.id === x.questId);
                        const qName = qObj ? qObj.question : 'Quest';
                        const shortName = qName.length > 30 ? qName.substring(0, 30) + '...' : qName;
                        if (x.status !== 'none') all.push({ t: x.receivedAt?.toDate(), type: 'bonus', text: `üöÄ Receive: ${shortName}`, score: 0.1 });
                        if (s > 0) all.push({ t: x.submittedAt?.toDate(), type: 'quest', text: `‚ö° Submit: ${shortName}`, score: s });
                    });

                    // üî• Add Quiz Attempts to History
                    const qAz = await db.collection("quiz_attempts").where("userId", "==", uid).where("status", "==", "approved").get();
                    qAz.forEach(d => {
                        const att = d.data();
                        const qData = quizzesData.find(x => x.id === att.quizId) || {};
                        const qTitle = qData.shortTitle || qData.title || "Quiz";
                        const points = att.gradedAnswers ? Object.keys(att.gradedAnswers).length : 0; // Simple calc, or use stored if available
                        // Recalc points based on logic
                        const isPoll = qData.isPoll === true;
                        // If poll, usually fixed points. If quiz, correct/total * totalPoints
                        let finalScore = 0;
                        if (isPoll) finalScore = (qData.totalPoints || 1.0);
                        else finalScore = (att.correctCount / att.totalQuestions) * (qData.totalPoints || 1.0);

                        all.push({
                            t: att.timestamp?.toDate(),
                            type: 'work',
                            text: `üìù ${isPoll ? 'Poll' : 'Quiz'}: ${qTitle}`,
                            score: finalScore
                        });
                    });

                    l.forEach(d => {
                        const x = d.data();
                        if (x.type === 'streak') all.push({ t: x.timestamp?.toDate(), type: 'bonus', text: `üî• Streak`, score: x.amount, docId: d.id, source: 'checkin_logs' });
                        if (x.type === 'manual_adjust' || x.type === 'manual') all.push({ t: x.timestamp?.toDate(), type: 'manual', text: `üõ†Ô∏è ${x.note}`, score: x.amount, docId: d.id, source: 'checkin_logs' });
                    });
                    all.sort((a, b) => (b.t || 0) - (a.t || 0));
                    historyCache = all; // üî• Fix: Latest first (removed .reverse())
                    historyPage = 1;
                    renderHistoryPage();
                } catch (e) { document.getElementById("history-list").innerHTML = "Error loading history"; }
            }

            async function recalculateUserScore(uid) {
                if (!confirm("Recalculate score from history?")) return;
                showToast("Calculating...");
                try {
                    let totalScore = 0;
                    const wSnap = await db.collection("works").where("userId", "==", uid).get();
                    wSnap.forEach(d => { totalScore += (d.data().score || 0); });
                    const qSnap = await db.collection("quest_submissions").where("userId", "==", uid).get();
                    qSnap.forEach(d => {
                        const data = d.data();
                        if (data.status !== 'none' && data.receivedAt) totalScore += 0.1;
                        totalScore += (data.earnedScore || 0) + (data.bonusGiven || 0);
                    });
                    const lSnap = await db.collection("checkin_logs").where("userId", "==", uid).get();
                    lSnap.forEach(d => {
                        const l = d.data();
                        // Skip 'quiz' type in logs to avoid double counting with quiz_attempts below
                        if (l.type === 'quiz') return;
                        totalScore += (parseFloat(l.amount) || 0);
                    });

                    const quizSnap = await db.collection("quiz_attempts").where("userId", "==", uid).where("status", "==", "approved").get();
                    quizSnap.forEach(d => {
                        const att = d.data();
                        const qData = quizzesData.find(x => x.id === att.quizId) || {};
                        let points = 0;

                        if (qData.isPoll) {
                            points = (parseFloat(qData.totalPoints) || 1.0);
                        } else {
                            const totalQ = att.totalQuestions || 1; // Prevent div by zero
                            const correct = att.correctCount || 0;
                            const maxPoints = parseFloat(qData.totalPoints) || 1.0;
                            points = (correct / totalQ) * maxPoints;
                        }

                        if (isNaN(points)) points = 0;
                        totalScore += points;
                    });

                    await db.collection("users").doc(uid).update({ score: totalScore });
                    showToast(`New Score: ${totalScore.toFixed(2)}`);
                    const user = usersData.find(u => u.id === uid);
                    document.getElementById('historyModal').style.display = 'none'; // Close history modal to refresh
                } catch (e) { alert(e.message); }
            }

            async function openArchiveModal() {
                const l = document.getElementById("archive-list");
                l.innerHTML = "Loading...";
                document.getElementById("archiveModal").style.display = "block";
                const s = await db.collection("side_quests").where("status", "==", "Archived").get();
                archiveCache = s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                archivePage = 1;
                renderArchivePage();
            }

            function renderArchivePage() {
                const l = document.getElementById("archive-list");
                l.innerHTML = "";
                const start = (archivePage - 1) * ARCHIVE_PER_PAGE;
                const paged = archiveCache.slice(start, start + ARCHIVE_PER_PAGE);
                const totalPages = Math.ceil(archiveCache.length / ARCHIVE_PER_PAGE);
                if (paged.length === 0) { l.innerHTML = "<p style='text-align:center;color:#999'>No archived items.</p>"; return; }
                paged.forEach(q => {
                    let imgs = "";
                    if (q.assignees) q.assignees.forEach(u => imgs += `<img src="${u.pic}" style="width:24px;height:24px;border-radius:50%;margin-right:2px;">`);
                    l.innerHTML += `
                <div style="padding:10px;border-bottom:1px solid #ddd;display:flex;justify-content:space-between;align-items:center;">
                    <div><b>${q.title}</b> (+${q.archiveScore || 0})<br>${imgs}</div>
                    <div><button class="btn-sm btn-success" onclick="restoreSQ('${q.id}','Done')">Restore</button> <button class="btn-sm btn-danger" onclick="delArchiveDoc('${q.id}')">Del</button></div>
                </div>`;
                });
                if (totalPages > 1) {
                    const ctrl = document.createElement("div");
                    ctrl.className = "history-controls";
                    ctrl.innerHTML = `<button class="btn-sm btn-dark" ${archivePage === 1 ? 'disabled' : ''} onclick="archivePage--;renderArchivePage()">< Prev</button><span style="align-self:center;">${archivePage} / ${totalPages}</span><button class="btn-sm btn-dark" ${archivePage === totalPages ? 'disabled' : ''} onclick="archivePage++;renderArchivePage()">Next ></button>`;
                    l.appendChild(ctrl);
                }
            }

            async function renderLeaderboard() {
                const l = document.getElementById("leaderboardList");
                l.innerHTML = "";
                if (!usersData.length) { l.innerHTML = "<div style='text-align:center;padding:20px;color:#999;'>No user data found.</div>"; return; }

                // If divisions exist, render grouped
                const divs = Object.entries(divisionConfig);
                if (divs.length > 0) {
                    divs.forEach(([divName, groups]) => {
                        const divUsers = usersData.filter(u => !u.isIgnored && groups.includes(u.group || "Public"));
                        if (divUsers.length === 0) return;

                        l.innerHTML += `<h3 style="border-left:5px solid var(--primary); padding-left:10px; margin-top:30px;">üèÖ ${divName}</h3>`;
                        renderUserStrip(l, divUsers.slice(0, 10));
                    });

                    // Show Ungrouped/Others
                    const allGrouped = divs.flatMap(d => d[1]);
                    const otherUsers = usersData.filter(u => !u.isIgnored && !allGrouped.includes(u.group || "Public"));
                    if (otherUsers.length > 0) {
                        l.innerHTML += `<h3 style="border-left:5px solid #ccc; padding-left:10px; margin-top:30px; color:#666;">üîò Others / Public</h3>`;
                        renderUserStrip(l, otherUsers.slice(0, 10));
                    }
                } else {
                    // Fallback: One list for all
                    renderUserStrip(l, usersData.filter(u => !u.isIgnored).slice(0, 20));
                }
            }

            function renderUserStrip(container, users) {
                users.forEach((u, i) => {
                    const lv = Math.floor((u.score || 0) / 10) + 1;
                    let daysLeftHtml = "";
                    if (u.endDate) {
                        const end = new Date(u.endDate);
                        const now = new Date();
                        const diff = Math.ceil((end - now) / (1000 * 60 * 60 * 24));
                        if (diff < 0) daysLeftHtml = `<span class="badge" style="background:#28a745">‚úÖ ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</span>`;
                        else daysLeftHtml = `<span class="badge" style="background:#17a2b8">‚è≥ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${diff} ‡∏ß‡∏±‡∏ô</span>`;
                    }
                    const rankClass = i < 3 ? `rank-${i + 1}` : '';
                    container.innerHTML += `
                    <div class="lb-row ${rankClass}">
                        <div class="lb-left">
                            <div class="lb-rank">#${i + 1}</div>
                            <div class="lb-profile">
                                <img src="${u.pictureUrl}" class="lb-pic-lg">
                                <div class="lb-info">
                                    <div class="lb-name">${u.displayName} <span class="lb-lv">Lv.${lv}</span></div>
                                    <div class="lb-days">${daysLeftHtml}</div>
                                </div>
                            </div>
                        </div>
                        <div class="lb-mid" id="chart-${u.id}"></div>
                        <div class="lb-right">
                            <div class="lb-score">${parseFloat((u.score || 0).toFixed(2))}</div>
                        </div>
                    </div>`;
                });
                loadLeaderboardCharts(users);
            }

            // üî• Division Management Functions (V77.8)
            function openDivisionsModal() {
                document.getElementById('divisionsModal').style.display = 'flex';
                renderDivisionAdminList();
            }

            function renderDivisionAdminList() {
                const container = document.getElementById('div-list-admin');
                container.innerHTML = "";
                Object.entries(divisionConfig).forEach(([name, groups]) => {
                    container.innerHTML += `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid #eee;">
                            <div>
                                <strong>${name}</strong><br>
                                <small style="color:#666;">Groups: ${groups.join(', ')}</small>
                            </div>
                            <button class="btn-sm btn-danger" onclick="removeDivision('${name}')" style="font-size:0.7em;">‚úï</button>
                        </div>
                    `;
                });
            }

            function addDivision() {
                const name = document.getElementById('new-div-name').value.trim();
                const grps = document.getElementById('new-div-groups').value.split(',').map(g => g.trim()).filter(g => g);
                if (!name || grps.length === 0) return alert("Please enter name and at least one group.");
                divisionConfig[name] = grps;
                renderDivisionAdminList();
                document.getElementById('new-div-name').value = '';
                document.getElementById('new-div-groups').value = '';
            }

            function removeDivision(name) {
                delete divisionConfig[name];
                renderDivisionAdminList();
            }

            async function saveDivisions() {
                try {
                    await db.collection("config").doc("divisions").set(divisionConfig);
                    showToast("Divisions Saved!");
                    document.getElementById('divisionsModal').style.display = 'none';
                } catch (e) { alert(e.message); }
            }

            async function loadLeaderboardCharts(users) {
                // Process individually to avoid complex composite index requirements
                for (const u of users) {
                    const container = document.getElementById(`chart-${u.id}`);
                    if (!container) continue;

                    try {
                        // Default query range: last 120 days for performance.
                        // If user's start date is more recent than 120 days ago, query from user's start date.
                        let queryStart = new Date();
                        queryStart.setDate(queryStart.getDate() - 120); // This is 120 days ago

                        if (u.startDate) {
                            const userStartDate = new Date(u.startDate);
                            if (userStartDate > queryStart) { // If user's start date is more recent than 120 days ago
                                queryStart = userStartDate;
                            }
                        }

                        // Fetch data just for this user
                        const [worksSnap, questsSnap, logsSnap] = await Promise.all([
                            db.collection("works").where("userId", "==", u.id).where("timestamp", ">", queryStart).get(),
                            db.collection("quest_submissions").where("userId", "==", u.id).where("submittedAt", ">", queryStart).get(),
                            db.collection("checkin_logs").where("userId", "==", u.id).where("timestamp", ">", queryStart).get()
                        ]);

                        const pointsMap = {};

                        const addP = (dateObj, score) => {
                            if (!dateObj || !score) return;
                            const d = dateObj.toDate().toISOString().split('T')[0];
                            if (!pointsMap[d]) pointsMap[d] = 0;
                            pointsMap[d] += parseFloat(score);
                        };

                        worksSnap.forEach(doc => { const d = doc.data(); addP(d.timestamp, d.score); });
                        questsSnap.forEach(doc => { const d = doc.data(); addP(d.submittedAt, (d.earnedScore || 0) + (d.bonusGiven || 0)); });
                        logsSnap.forEach(doc => { const d = doc.data(); addP(d.timestamp, d.amount); });

                        container.innerHTML = "";

                        // Determine Display Range
                        const start = u.startDate ? new Date(u.startDate) : new Date(Date.now() - 90 * 86400000);
                        let end = u.endDate ? new Date(u.endDate) : new Date();
                        if (end < start) end = new Date();

                        const totalMs = end - start;
                        const totalDays = Math.ceil(totalMs / (86400000));

                        if (totalDays <= 0) {
                            container.innerHTML = "<span style='font-size:0.7em; color:#ccc'>Invalid Dates</span>";
                            continue;
                        }

                        // Find max score for scaling
                        let maxDaily = 0.5; // Minimum scale
                        Object.values(pointsMap).forEach(s => { if (s > maxDaily) maxDaily = s; });

                        // Render Bars
                        Object.keys(pointsMap).forEach(dateStr => {
                            const d = new Date(dateStr);
                            // Filter points outside the display timeline
                            if (d < start || d > end) return;

                            const dayOffset = (d - start) / 86400000;
                            const leftPct = (dayOffset / totalDays) * 100;
                            const score = pointsMap[dateStr];
                            // If score is negative (penalty), handle differently? For now, clamp to 0 for chart height, or use absolute.
                            // Let's assume positive progress mainly.
                            const heightPct = Math.min((Math.max(0, score) / maxDaily) * 100, 100);

                            if (heightPct > 0) {
                                const bar = document.createElement('div');
                                bar.className = 'chart-bar';
                                bar.style.left = `${leftPct}%`;
                                bar.style.height = `${heightPct * 0.8}%`;
                                bar.style.width = `${Math.max(100 / totalDays, 2)}%`;
                                bar.title = `${dateStr}: ${score.toFixed(2)}`;
                                container.appendChild(bar);
                            }
                        });

                        // Draw Start Marker
                        const sMark = document.createElement('div');
                        sMark.className = 'chart-marker start';
                        sMark.style.left = '0%';
                        sMark.innerHTML = `<span>${start.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' })}</span>`;
                        container.appendChild(sMark);

                        // Draw End Marker
                        const eMark = document.createElement('div');
                        eMark.className = 'chart-marker';
                        eMark.style.left = '100%';
                        eMark.innerHTML = `<span>${end.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' })}</span>`;
                        container.appendChild(eMark);

                        // Draw Today Marker
                        const today = new Date();
                        if (today >= start && today <= end) {
                            const todayOffset = (today - start) / 86400000;
                            const todayPct = (todayOffset / totalDays) * 100;
                            const tMark = document.createElement('div');
                            tMark.className = 'chart-marker';
                            tMark.style.left = `${todayPct}%`;
                            tMark.style.background = '#ffc107';
                            tMark.style.height = '60%';
                            tMark.style.zIndex = '2';
                            tMark.title = "Today";
                            container.appendChild(tMark);
                        }

                    } catch (e) {
                        console.error("Chart Error:", e);
                    }
                }
            }

            function renderKanban(snap) { const cols = { "Backlog": document.getElementById("Backlog"), "Doing": document.getElementById("Doing"), "Review": document.getElementById("Review"), "Done": document.getElementById("Done") }; Object.values(cols).forEach(e => e.innerHTML = ""); const cnt = { "Backlog": 0, "Doing": 0, "Review": 0, "Done": 0 }; const filter = document.getElementById('board-search').value.toLowerCase(); snap.forEach(doc => { const q = doc.data(); sideQuestsCache[doc.id] = q; if (q.status === 'Archived') return; let match = q.title.toLowerCase().includes(filter); if (q.assignees) q.assignees.forEach(u => { if (u.name.toLowerCase().includes(filter)) match = true; }); if (!match) return; if (cols[q.status]) { cnt[q.status]++; const isProj = q.isProject === true; const d = document.createElement('div'); d.className = `kanban-card card-${q.status} ${q.isScored ? 'scored' : ''} ${isProj ? 'project' : ''}`; d.dataset.id = doc.id; let imgs = '<div class="assignee-stack">'; if (q.assignees) q.assignees.forEach(u => imgs += `<img src="${u.pic}" class="assignee-img" title="${u.name}">`); imgs += '</div>'; let timersHtml = ""; if (q.refQuestId && q.assigneeIds && q.assigneeIds.length > 0) { const globalQ = questsCache.find(x => x.id === q.refQuestId); const subKey = `${q.refQuestId}_${q.assigneeIds[0]}`; const sub = questsSubCache[subKey]; if (globalQ && globalQ.deadline && q.status !== 'Done') { timersHtml += `<span class="timer-global" data-dead="${globalQ.deadline.toDate().getTime()}">‚è≥ Exp: ...</span>`; } if (sub) { if (sub.status === 'received' && sub.deadline && q.status === 'Doing') { timersHtml += `<span class="timer-active" data-dead="${sub.deadline.toDate().getTime()}">‚è±Ô∏è ...</span>`; } else if (sub.status === 'unsuccessful' && sub.cooldownUntil && q.status === 'Backlog') { timersHtml += `<span class="timer-cooldown" data-dead="${sub.cooldownUntil.toDate().getTime()}">‚ùÑÔ∏è Cool: ...</span>`; } } } let act = ""; if (q.status === 'Done' && q.doneAt) act = `<button class="btn-sm btn-dark" style="width:100%;margin-top:5px;" onclick="archiveSQ('${doc.id}')">üì• ar¬∑chive</button>`; else if (!q.isScored && q.status !== 'Backlog' && q.status !== 'Done') act = `<button class="btn-sm btn-success" style="width:100%;margin-top:5px;" onclick="giveScore('${doc.id}')">üí∞ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>`; let chatBtn = ""; if (isProj) chatBtn = `<button class="btn-sm" style="color:var(--primary); font-size:1.1em;" onclick="openChat('${doc.id}', '${q.title}')"><i class="fa-solid fa-comments"></i></button>`; let arrows = `<div class="arrow-controls">`; if (q.status !== 'Backlog') arrows += `<button class="btn-arrow" onclick="moveCard('${doc.id}','prev')"><i class="fa-solid fa-chevron-left"></i></button>`; if (q.status !== 'Done') arrows += `<button class="btn-arrow" onclick="moveCard('${doc.id}','next')"><i class="fa-solid fa-chevron-right"></i></button>`; arrows += `</div>`; let pColor = '#17a2b8'; if (q.priority === 'Medium') pColor = '#ff9f1c'; if (q.priority === 'High') pColor = '#ef233c'; d.innerHTML = `<div class="card-header-row"><span class="badge" style="background:${pColor}">${q.priority}</span><div class="card-header-right">${imgs} ${arrows}</div></div><div style="font-weight:bold;">${isProj ? '<span class="badge" style="background:#e83e8c;font-size:0.6em;">PROJ</span>' : ''} ${q.title}</div><div class="card-timers">${timersHtml}</div><p style="font-size:0.85em; color:#666; margin-bottom:5px;">${q.description || '-'}</p><div class="card-tool-row"><div><button class="btn-sm btn-warning" onclick="openTaskModal('${doc.id}')"><i class="fa-solid fa-pen"></i></button><button class="btn-sm btn-danger" onclick="startDeleteCard('${doc.id}')"><i class="fa-solid fa-trash"></i></button></div>${chatBtn}</div>${act}`; cols[q.status].appendChild(d); } }); Object.keys(cnt).forEach(k => document.getElementById(`cnt-${k}`).innerText = cnt[k]); }
            function updateRealtimeTimers() { const now = Date.now(); document.querySelectorAll('.timer-global').forEach(el => { const d = parseInt(el.dataset.dead); const diff = d - now; if (diff <= 0) el.innerText = "‚è≥ Expired"; else { const h = Math.floor(diff / 3600000); const m = Math.floor((diff % 3600000) / 60000); el.innerText = `‚è≥ Ends: ${h}h ${m}m`; } }); document.querySelectorAll('.timer-active').forEach(el => { const d = parseInt(el.dataset.dead); const diff = d - now; if (diff <= 0) { el.innerText = "‚è±Ô∏è Time Up!"; const card = el.closest('.kanban-card'); if (card && card.parentElement.id === 'Doing') { db.collection("side_quests").doc(card.dataset.id).update({ status: 'Review' }); } } else { const m = Math.floor(diff / 60000); const s = Math.floor((diff % 60000) / 1000); el.innerText = `‚è±Ô∏è ${m}m ${s}s`; } }); document.querySelectorAll('.timer-cooldown').forEach(el => { const d = parseInt(el.dataset.dead); const diff = d - now; if (diff <= 0) el.innerText = "‚ùÑÔ∏è Ready"; else { const m = Math.floor(diff / 60000); const s = Math.floor((diff % 60000) / 1000); el.innerText = `‚ùÑÔ∏è Cool: ${m}m ${s}s`; } }); updateQuestTimers(); }
            function startDeleteCard(id) { deleteCardId = id; document.getElementById('delCardModal').style.display = 'block'; const btn = document.getElementById('btn-del-card-confirm'); btn.disabled = false; btn.style.background = '#ef233c'; let c = 5; btn.innerText = `Confirm (${c})`; if (deleteTimer) clearInterval(deleteTimer); deleteTimer = setInterval(() => { c--; btn.innerText = `Confirm (${c})`; if (c <= 0) { clearInterval(deleteTimer); document.getElementById('delCardModal').style.display = 'none'; showToast("Cancelled"); } }, 1000); btn.onclick = executeDeleteCard; }
            async function executeDeleteCard() { if (!deleteCardId) return; clearInterval(deleteTimer); document.getElementById('delCardModal').style.display = 'none'; const deduct = confirm("‡∏´‡∏±‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö?\nOK=‡∏´‡∏±‡∏Å, Cancel=‡πÑ‡∏°‡πà‡∏´‡∏±‡∏Å"); try { const q = sideQuestsCache[deleteCardId]; const b = db.batch(); if (deduct && q.assigneeIds) { const s = prompt("Points to deduct (e.g., 0.5):"); if (s) { q.assigneeIds.forEach(u => { b.update(db.collection("users").doc(u), { score: firebase.firestore.FieldValue.increment(-parseFloat(s)) }); b.set(db.collection("checkin_logs").doc(), { userId: u, type: 'manual_adjust', amount: -parseFloat(s), note: `Del: ${q.title}`, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); }); } } b.delete(db.collection("side_quests").doc(deleteCardId)); await b.commit(); showToast("Deleted!"); } catch (e) { alert(e.message); } }
            function openTaskModal(id = null) { document.getElementById('taskModal').style.display = 'block'; if (id) { const q = sideQuestsCache[id]; document.getElementById('edit-id').value = id; document.getElementById('sq-title').value = q.title; document.getElementById('sq-desc').value = q.description; document.getElementById('sq-priority').value = q.priority; document.getElementById('sq-due').value = q.dueDate || ""; document.getElementById('sq-isProject').checked = q.isProject || false; } else { document.getElementById('edit-id').value = ""; document.getElementById('sq-title').value = ""; document.getElementById('sq-desc').value = ""; } }
            async function saveSideQuest() { const id = document.getElementById('edit-id').value; const t = document.getElementById('sq-title').value; if (!t) return alert("Title?"); const d = { title: t, description: document.getElementById('sq-desc').value, priority: document.getElementById('sq-priority').value, dueDate: document.getElementById('sq-due').value, isProject: document.getElementById('sq-isProject').checked, assigneeIds: [...document.querySelectorAll('.sq-user-check:checked')].map(c => c.value), assignees: [...document.querySelectorAll('.sq-user-check:checked')].map(c => ({ uid: c.value, name: c.dataset.name, pic: c.dataset.pic })) }; if (id) { await db.collection("side_quests").doc(id).update(d); showToast("Updated"); } else { d.status = "Backlog"; d.createdAt = firebase.firestore.FieldValue.serverTimestamp(); await db.collection("side_quests").add(d); showToast("Created"); } document.getElementById('taskModal').style.display = 'none'; }
            let chatUnsub; function openChat(id, title) { document.getElementById('chatModal').style.display = 'block'; document.getElementById('chat-title').innerText = `üí¨ ${title}`; document.getElementById('chat-card-id').value = id; const box = document.getElementById('chat-box'); box.innerHTML = "Loading..."; if (chatUnsub) chatUnsub(); chatUnsub = db.collection("side_quests").doc(id).collection("comments").orderBy("timestamp", "asc").onSnapshot(snap => { box.innerHTML = ""; snap.forEach(d => { const m = d.data(); const cls = m.sender === 'Admin' ? 'msg-admin' : 'msg-user'; let pic = m.pic ? `<img src="${m.pic}" class="chat-avatar">` : '<div class="chat-avatar" style="background:#ccc;">?</div>'; if (m.sender === 'Admin') pic = '<div class="chat-avatar" style="background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;">A</div>'; let msg = m.msg.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color:#007bff;text-decoration:underline;">$1</a>'); msg = msg.replace(/@([^\s]+)/g, (match, name) => { const q = sideQuestsCache[id]; const inP = q.assignees && q.assignees.some(u => u.name.toLowerCase().includes(name.toLowerCase())); return inP ? `<span class="tag-in">${match}</span>` : `<span class="tag-out">${match}</span>`; }); box.innerHTML += `<div class="chat-msg ${cls}">${pic}<div><b>${m.sender}</b>: ${msg}</div></div>`; }); box.scrollTop = box.scrollHeight; }); }
            async function sendChat() { const t = document.getElementById('chat-input').value.trim(); const id = document.getElementById('chat-card-id').value; if (!t) return; await db.collection("side_quests").doc(id).collection("comments").add({ msg: t, sender: 'Admin', timestamp: firebase.firestore.FieldValue.serverTimestamp() }); document.getElementById('chat-input').value = ""; }
            async function openArchiveModal() { const l = document.getElementById("archive-list"); l.innerHTML = "Loading..."; document.getElementById("archiveModal").style.display = "block"; const s = await db.collection("side_quests").where("status", "==", "Archived").get(); let i = s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0)); l.innerHTML = ""; i.forEach(q => { let imgs = ""; if (q.assignees) q.assignees.forEach(u => imgs += `<img src="${u.pic}" style="width:24px;height:24px;border-radius:50%;margin-right:2px;">`); l.innerHTML += `<div style="padding:10px;border-bottom:1px solid #ddd;display:flex;justify-content:space-between;align-items:center;"><div><b>${q.title}</b> (+${q.archiveScore || 0})<br>${imgs}</div><div><button class="btn-sm btn-success" onclick="restoreSQ('${q.id}','Done')">Restore</button> <button class="btn-sm btn-danger" onclick="delArchiveDoc('${q.id}')">Del</button></div></div>` }); }
            async function delArchiveDoc(id) { if (confirm("Del?")) await db.collection("side_quests").doc(id).delete(); openArchiveModal(); }
            async function restoreSQ(id, t) { await db.collection("side_quests").doc(id).update({ status: t, doneAt: firebase.firestore.FieldValue.serverTimestamp() }); openArchiveModal(); showToast("Restored"); }
            function confirmClearArchive() { document.getElementById('clearConfirmModal').style.display = 'block'; const btn = document.getElementById('btn-confirm-clear'); btn.disabled = true; btn.style.background = '#ccc'; let c = 5; btn.innerText = `Confirm (${c})`; const t = setInterval(() => { c--; btn.innerText = `Confirm (${c})`; if (c <= 0) { clearInterval(t); btn.disabled = false; btn.style.background = '#ef233c'; btn.innerText = "CLEAR ALL"; btn.onclick = async () => { document.getElementById('clearConfirmModal').style.display = 'none'; const s = await db.collection("side_quests").where("status", "==", "Archived").get(); const b = db.batch(); s.forEach(d => b.delete(d.ref)); await b.commit(); showToast("Cleared!"); openArchiveModal(); } } }, 1000); }
            function renderHistoryPage() { const l = document.getElementById("history-list"); const c = document.getElementById("history-controls"); l.innerHTML = ""; c.innerHTML = ""; const s = (historyPage - 1) * HISTORY_PER_PAGE; const p = historyCache.slice(s, s + HISTORY_PER_PAGE); const t = Math.ceil(historyCache.length / HISTORY_PER_PAGE); p.forEach(e => { const d = e.t ? e.t.toLocaleString('th-TH') : '-'; let cls = e.type === 'bonus' ? 'bonus' : (e.type === 'manual' ? 'manual' : ''); let delBtn = ""; if (e.source === 'checkin_logs' && e.docId) { delBtn = `<button class="btn-del-hist" onclick="deleteHistoryLog('${e.docId}', ${e.score})">‚úï Delete</button>`; } l.innerHTML += `<li style="padding:10px;border-bottom:1px solid #eee;" class="${cls}"><div style="display:flex;justify-content:space-between;align-items:center;"><div>${e.text} ${delBtn}</div><span style="font-weight:bold;">${e.score > 0 ? '+' : ''}${e.score}</span></div><small style="color:#888">${d}</small></li>` }); if (t > 1) { c.innerHTML = `<button class="btn-sm btn-dark" ${historyPage === 1 ? 'disabled' : ''} onclick="historyPage--;renderHistoryPage()">< Prev</button> <span style="align-self:center;">${historyPage}/${t}</span> <button class="btn-sm btn-dark" ${historyPage === t ? 'disabled' : ''} onclick="historyPage++;renderHistoryPage()">Next ></button>`; } }
            async function deleteHistoryLog(logId, amount) { if (!confirm(`Delete log and revert ${amount} points?`)) return; try { await db.collection("users").doc(currentHistoryUserId).update({ score: firebase.firestore.FieldValue.increment(-amount) }); await db.collection("checkin_logs").doc(logId).delete(); showToast("Reverted!"); const user = usersData.find(u => u.id === currentHistoryUserId); showHistory(currentHistoryUserId, user ? user.displayName : 'User', (user ? user.score : 0) - amount); } catch (e) { alert(e.message); } }
            function updateAssigneeList() { const d = document.getElementById('sq-user-list'); d.innerHTML = ""; usersData.forEach(u => { if (!u.isIgnored) d.innerHTML += `<label style="margin-right:5px"><input type="checkbox" class="sq-user-check" value="${u.id}" data-name="${u.displayName}" data-pic="${u.pictureUrl}"> ${u.displayName}</label>` }); }
            async function moveCard(id, dir) { const q = sideQuestsCache[id]; const f = ['Backlog', 'Doing', 'Review', 'Done']; const c = f.indexOf(q.status); let n = q.status; if (dir === 'next' && c < 3) n = f[c + 1]; if (dir === 'prev' && c > 0) n = f[c - 1]; if (n !== q.status) { const u = { status: n }; if (n === 'Done') u.doneAt = firebase.firestore.FieldValue.serverTimestamp(); await db.collection("side_quests").doc(id).update(u); } }
            async function giveScore(id) { const q = sideQuestsCache[id]; if (!q) return; const s = prompt("Score:", "0.5"); if (!s) return; const n = prompt("Note:", q.title); const b = db.batch(); q.assigneeIds.forEach(u => { b.update(db.collection("users").doc(u), { score: firebase.firestore.FieldValue.increment(parseFloat(s)) }); b.set(db.collection("checkin_logs").doc(), { userId: u, type: 'manual', amount: parseFloat(s), note: n, timestamp: firebase.firestore.FieldValue.serverTimestamp() }) }); b.update(db.collection("side_quests").doc(id), { status: 'Done', isScored: true, archiveScore: parseFloat(s), doneAt: firebase.firestore.FieldValue.serverTimestamp() }); await b.commit(); showToast("Scored!"); }
            async function archiveSQ(id) { if (confirm("Archive?")) await db.collection("side_quests").doc(id).update({ status: 'Archived' }); }
            async function delUser(id) { if (confirm("Del?")) await db.collection("users").doc(id).delete(); }
            async function delWork(id) { if (confirm("Del?")) await db.collection("works").doc(id).delete(); }
            async function delQuizAttempt(id) { if (confirm("Delete this quiz attempt record?")) await db.collection("quiz_attempts").doc(id).delete(); }
            function toggleIgnoreUser(id, s) { db.collection("users").doc(id).update({ isIgnored: !s }); }
            function toggleForm() { const f = document.getElementById('sq-form'); f.style.display = f.style.display === 'none' ? 'block' : 'none'; }
            function filterBoard() { renderKanban({ forEach: cb => { Object.values(sideQuestsCache).forEach(q => cb({ data: () => q, id: Object.keys(sideQuestsCache).find(k => sideQuestsCache[k] === q) })) } }); }
            function filterUsers() { renderTable('users'); }
            function openShareModal() { document.getElementById('shareModal').style.display = 'block'; }
            async function copyLB(showName) { document.getElementById('shareModal').style.display = 'none'; if (!usersData.length) return alert("No Data"); let t = "üèÜ Leaderboard\n"; const top = usersData.filter(u => !u.isIgnored).sort((a, b) => (b.score - a.score)).slice(0, 20); top.forEach((u, i) => { t += `${i + 1}. ${showName ? u.displayName : `Lv.${Math.floor(u.score / 10) + 1}`} (${parseFloat((u.score || 0).toFixed(2))})\n` }); if (liff.isInClient()) liff.shareTargetPicker([{ type: "text", text: t }]); else { try { await navigator.clipboard.writeText(t); alert("Copied!"); } catch (e) { const ta = document.createElement('textarea'); ta.value = t; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert("Copied (Manual)!"); } } }
            function copyHistory() { navigator.clipboard.writeText("Copied!").then(() => showToast("Copied")); }
            function closeModal() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
            function showToast(m) { const x = document.getElementById("toast"); x.innerText = m; x.className = "show"; setTimeout(() => x.className = "", 3000); }
            async function svSc(id, uid) { const v = prompt("Score:"); if (v) { await db.collection("works").doc(id).update({ score: parseFloat(v), status: '‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß' }); await db.collection("users").doc(uid).update({ score: firebase.firestore.FieldValue.increment(parseFloat(v)) }); showToast("Saved"); } }
            async function createQuest() {
                const q = {
                    question: document.getElementById('q-text').value,
                    imageUrl: document.getElementById('q-img').value,
                    questLink: document.getElementById('q-link').value,
                    targetGroup: document.getElementById('q-target-group-manual').value.trim() || "Public", // üî• Added V77.7
                    baseScore: parseFloat(document.getElementById('q-score').value),
                    durationMinutes: parseInt(document.getElementById('q-duration').value),
                    deadline: new Date(Date.now() + parseFloat(document.getElementById('q-hours').value) * 3600000),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                if (q.question) await db.collection("quests").add(q);
                showToast("Posted");
                document.getElementById('q-text').value = ''; // Reset UI
            }
            function loadActiveQuests() { db.collection("quests").orderBy("createdAt", "desc").limit(10).onSnapshot(s => { const t = document.querySelector("#activeQuestTable tbody"); t.innerHTML = ""; let hasActive = false; s.forEach(d => { const q = d.data(); if (q.deadline?.toDate() > new Date()) { hasActive = true; t.innerHTML += `<tr><td>${q.question}</td><td><span class="quest-deadline" data-deadline="${q.deadline.toDate().getTime()}">Loading...</span></td><td>${q.durationMinutes || 30} min</td><td><button class="btn-sm btn-warning" onclick="editQ('${d.id}','${q.question.replace(/'/g, "")}')">‚úèÔ∏è</button> <button class="btn-delete-icon" onclick="stopQ('${d.id}')">‚úï</button></td></tr>`; } }); document.getElementById("active-quest-section").style.display = hasActive ? "block" : "none"; }); }
            function loadQuestHistory() { db.collection("quests").orderBy("createdAt", "desc").limit(20).onSnapshot(s => { const t = document.querySelector("#questHistoryTable tbody"); t.innerHTML = ""; s.forEach(d => { const q = d.data(); if (q.deadline && q.deadline.toDate() > new Date()) return; t.innerHTML += `<tr><td>${q.question}</td><td>${q.baseScore}</td><td><div style="display:flex;gap:5px;"><button class="btn-sm btn-success" onclick="recallQuest('${d.id}')">‚ôªÔ∏è Recall</button><button class="btn-delete-icon" onclick="delQ('${d.id}')">‚úï</button></div></td></tr>`; }) }); }
            function updateQuestTimers() { document.querySelectorAll('.quest-deadline').forEach(el => { const d = parseInt(el.dataset.deadline); const now = Date.now(); if (d - now <= 0) el.innerText = "Expired"; else { const h = Math.floor((d - now) / 3600000); const m = Math.floor(((d - now) % 3600000) / 60000); el.innerText = `${h}h ${m}m left`; } }); }
            function recallQuest(id) { db.collection("quests").doc(id).get().then(doc => { const d = doc.data(); document.getElementById('q-text').value = d.question; document.getElementById('q-img').value = d.imageUrl || ""; document.getElementById('q-link').value = d.questLink || ""; document.getElementById('q-score').value = d.baseScore; document.getElementById('q-duration').value = d.durationMinutes || 30; document.getElementById('q-target-group-manual').value = d.targetGroup || ""; showToast("Recalled!"); }); }
            async function editQ(id, q) { const nq = prompt("Edit Q:", q); if (nq) await db.collection("quests").doc(id).update({ question: nq }); }
            async function stopQ(id) { if (confirm("Stop?")) await db.collection("quests").doc(id).update({ deadline: new Date() }); }
            async function delQ(id) { if (confirm("Del?")) await db.collection("quests").doc(id).delete(); }
            function drawCertificate(ctx, name, dates) {
                const w = 800, h = 600;
                // 1. Background
                ctx.fillStyle = "#ffffff";
                ctx.fillRect(0, 0, w, h);

                // 2. Right Navy Decoration
                ctx.fillStyle = "#001f3f"; // Navy Blue
                ctx.beginPath();
                ctx.moveTo(w * 0.7, 0);
                ctx.bezierCurveTo(w * 0.8, h * 0.3, w * 0.6, h * 0.7, w * 0.8, h);
                ctx.lineTo(w, h);
                ctx.lineTo(w, 0);
                ctx.fill();

                // 3. Gold Accent Line
                ctx.strokeStyle = "#d4af37"; // Gold
                ctx.lineWidth = 8;
                ctx.beginPath();
                ctx.moveTo(w * 0.68, 0);
                ctx.bezierCurveTo(w * 0.78, h * 0.3, w * 0.58, h * 0.7, w * 0.78, h);
                ctx.stroke();

                // 4. Subtle Border
                ctx.strokeStyle = "#eee";
                ctx.lineWidth = 1;
                ctx.strokeRect(20, 20, w - 40, h - 40);

                // 5. Header "CERTIFICATE"
                ctx.textAlign = "left";
                ctx.fillStyle = "#001f3f";
                ctx.font = "bold 56px Georgia, serif";
                ctx.fillText("CERTIFICATE", 60, 160);

                ctx.font = "italic 20px Georgia, serif";
                ctx.fillStyle = "#666";
                ctx.fillText("OF ACHIEVEMENT", 65, 195);

                // 6. Name (Cursive-style)
                ctx.textAlign = "center";
                ctx.fillStyle = "#333";
                ctx.font = "italic 64px 'Brush Script MT', cursive, Georgia";
                ctx.fillText(name || "Student Name", w * 0.38, 330);

                // 7. Divider/Underline for Name
                ctx.strokeStyle = "#d4af37";
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(w * 0.1, 350);
                ctx.lineTo(w * 0.65, 350);
                ctx.stroke();

                // 8. Description
                ctx.textAlign = "left";
                ctx.fillStyle = "#555";
                ctx.font = "16px Arial, sans-serif";
                const desc = "This is to certify that the above-named student has successfully";
                const desc2 = "completed their internship program with excellence and dedication.";
                ctx.fillText(desc, 65, 390);
                ctx.fillText(desc2, 65, 415);

                // 9. Date & Signature
                ctx.font = "bold 14px Arial";
                ctx.fillStyle = "#001f3f";
                ctx.fillText("DATE", 65, 480);
                ctx.fillText("SIGNATURE", 300, 480);

                ctx.font = "16px Arial";
                ctx.fillStyle = "#333";
                ctx.fillText(dates || "Date not set", 65, 510);

                ctx.beginPath();
                ctx.moveTo(300, 505);
                ctx.lineTo(500, 505);
                ctx.strokeStyle = "#ccc";
                ctx.stroke();

                // 10. Golden Seal
                const sealX = w * 0.85, sealY = h * 0.78;
                const grd = ctx.createRadialGradient(sealX, sealY, 10, sealX, sealY, 50);
                grd.addColorStop(0, "#f1c40f");
                grd.addColorStop(1, "#d4af37");

                ctx.fillStyle = grd;
                ctx.beginPath();
                ctx.arc(sealX, sealY, 55, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = "#ffffff";
                ctx.lineWidth = 2;
                ctx.stroke();

                ctx.textAlign = "center";
                ctx.fillStyle = "#fff";
                ctx.font = "bold 10px Arial";
                ctx.fillText("MEDLIFE+", sealX, sealY - 15);
                ctx.font = "bold 12px Arial";
                ctx.fillText("EXCELLENCE", sealX, sealY + 5);
                ctx.font = "9px Arial";
                ctx.fillText("AWARDS", sealX, sealY + 20);
            }

            async function updateCertPreview() {
                const c = document.getElementById('cert-canvas');
                const ctx = c.getContext('2d');

                // üî• Fix: Handle High DPI Screens & Explicit Resolution
                // Get the display size (CSS width)
                // But for certificate generation, we want a fixed internal resolution of 800x600
                // regardless of screen size, so the PDF/Image is consistent.
                c.width = 800;
                c.height = 600;

                // Reset transform to avoid accumulation
                ctx.setTransform(1, 0, 0, 1, 0, 0);

                const s = document.getElementById('cert-start').value;
                const e = document.getElementById('cert-end').value;
                const fn = document.getElementById('cert-fullname').value;
                drawCertificate(ctx, fn || certUser.name, s && e ? `${s} - ${e}` : "");
            }
            async function generateBulkCert() {
                const { jsPDF } = window.jspdf;
                const users = usersData.filter(u => !u.isIgnored && u.startDate && u.endDate);
                if (!users.length) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°-‡∏à‡∏ö‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏à‡∏ö)");

                if (!confirm(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${users.length} ‡πÉ‡∏ö‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

                showToast("Generating Bulk PDF... Please wait.");

                const c = document.createElement('canvas');
                const ctx = c.getContext('2d');
                c.width = 800;
                c.height = 600;

                const doc = new jsPDF('l', 'mm', 'a4');

                for (let i = 0; i < users.length; i++) {
                    const u = users[i];
                    drawCertificate(ctx, u.fullName || u.displayName, `${u.startDate} - ${u.endDate}`);

                    const imgData = c.toDataURL('image/jpeg', 0.95);
                    if (i > 0) doc.addPage();
                    doc.addImage(imgData, 'JPEG', 0, 0, 297, 210); // Fill A4
                }

                doc.save("Bulk_Certificates.pdf");
                showToast("Export Completed!");
            }

            function generateCertPDF() { const { jsPDF } = window.jspdf; const doc = new jsPDF('l'); doc.addImage(document.getElementById('cert-canvas').toDataURL('image/jpeg'), 'JPEG', 10, 10, 280, 190); doc.save("cert.pdf"); }
            async function delQuizAttempt(id, collection = 'quiz_attempts') {
                if (!confirm("Delete this attempt/response?")) return;
                try {
                    await db.collection(collection).doc(id).delete();
                    showToast("Deleted!");
                } catch (e) { alert(e.message); }
            }

            // --- LIFF Preview ---
            function openLiffPreview() {
                document.getElementById('liffPreviewModal').style.display = 'flex';
                // Use current origin + index.html + preview mode
                const url = window.location.href.replace('admin.html', 'index.html?mode=preview');
                document.getElementById('liff-frame').src = url;
            }

            function closeLiffPreview() {
                document.getElementById('liffPreviewModal').style.display = 'none';
                document.getElementById('liff-frame').src = ""; // Clear to stop running
            }
        </script>
</body>

</html>