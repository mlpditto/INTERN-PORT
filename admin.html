<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard (Quest Edition)</title>
    <link rel="stylesheet" href="style.css">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        /* CSS ‡πÄ‡∏î‡∏¥‡∏° */
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background: #f0f2f5; font-family: sans-serif; }
        #dashboard-container { display: none; }
        .login-card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 90%; }
        .input-group { margin-top: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; color: #666; font-size: 0.9em; }
        .input-group input, .input-group textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        .magic-btn { background: #007bff; color: white; border: none; border-radius: 6px; padding: 12px; width: 100%; margin-top: 20px; font-size: 16px; cursor: pointer; transition: 0.2s; font-weight: bold; }
        .magic-btn:hover { background: #0056b3; }
        
        /* CSS Dashboard */
        .tab-nav { display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px; overflow-x: auto; }
        .tab-btn { padding: 15px 20px; cursor: pointer; border: none; background: none; font-weight: 600; color: var(--gray); white-space: nowrap; }
        .tab-btn.active { color: #007bff; border-bottom: 3px solid #007bff; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #555; }
        .btn-sm { padding: 5px 10px; border:none; border-radius:4px; cursor:pointer; color:white; font-size:0.9em;}
        .btn-primary { background:#007bff; } .btn-danger { background:#dc3545; } .btn-secondary { background:#6c757d; }
        .badge { padding:4px 8px; border-radius:10px; font-size:0.8em; }
        
        /* CSS Quest */
        .quest-create-card { background:#fff3cd; padding:20px; border-radius:8px; border:1px solid #ffeeba; margin-bottom:20px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h2>üîê Admin Access</h2>
            <div id="login-form">
                <div class="input-group"><label>Email</label><input type="email" id="email-input" value="medlifeplus@gmail.com"></div>
                <button class="magic-btn" id="send-btn" onclick="sendMagicLink()">‚ú® ‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏•</button>
            </div>
            <div id="status-msg" style="margin-top:15px; color:red;"></div>
        </div>
    </div>

    <div id="dashboard-container" class="container" style="max-width: 1000px; padding: 20px; margin:0 auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>üë®‚Äçüíª Admin Dashboard</h2>
            <div>
                <span id="admin-email" style="color:#666; font-size:0.9em; margin-right:10px;"></span>
                <button class="btn-sm btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('tab-users')">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
            <button class="tab-btn" onclick="switchTab('tab-works')">üìÑ ‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô</button>
            <button class="tab-btn" onclick="switchTab('tab-quest')">‚ö° Daily Quest</button> </div>

        <div id="tab-users" class="tab-content active">
            <div style="overflow-x:auto;"><table id="usersTable"><thead><tr><th>‡∏£‡∏π‡∏õ</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th><th>‡∏•‡∏ö</th></tr></thead><tbody></tbody></table></div>
        </div>

        <div id="tab-works" class="tab-content">
            <div style="overflow-x:auto;"><table id="worksTable"><thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</th><th>‡∏•‡∏ö</th></tr></thead><tbody></tbody></table></div>
        </div>

        <div id="tab-quest" class="tab-content">
            <div class="quest-create-card">
                <h3>üì¢ ‡∏™‡∏£‡πâ‡∏≤‡∏á Quest ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h3>
                <div class="input-group" style="margin-top:0;">
                    <label>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° / ‡πÇ‡∏à‡∏ó‡∏¢‡πå:</label>
                    <input type="text" id="q-text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏õ‡∏ö‡πâ‡∏≤‡∏á?">
                </div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <div style="flex:1;">
                        <label>‡∏´‡∏°‡∏î‡πÄ‡∏Ç‡∏ï (‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤):</label>
                        <input type="number" id="q-hours" value="24" style="width:100%; padding:8px;">
                    </div>
                    <div style="flex:1;">
                        <label>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡∏™‡πà‡∏á‡∏ó‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏¢):</label>
                        <input type="number" id="q-score" value="10" style="width:100%; padding:8px;">
                    </div>
                </div>
                <button class="magic-btn" onclick="createQuest()" style="background:#ffc107; color:black; margin-top:15px;">üöÄ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® Quest</button>
            </div>

            <h3>üìù ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏ô‡πâ‡∏≠‡∏á‡πÜ</h3>
            <div style="overflow-x:auto;">
                <table id="questTable">
                    <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡πÇ‡∏ö‡∏ô‡∏±‡∏™</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        // CONFIG
        const ALLOWED_EMAIL = "medlifeplus@gmail.com";
        const ADMIN_LIFF_ID = "2008959998-yjcNpaGt"; // ‚ö†Ô∏è ‡πÉ‡∏™‡πà ID Admin ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const MY_URL = 'https://mlpditto.github.io/INTERN-PORT/admin.html'; // ‚ö†Ô∏è ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

        const auth = firebase.auth();

        // --- Login Logic ---
        if (auth.isSignInWithEmailLink(window.location.href)) {
            let email = window.localStorage.getItem('emailForSignIn') || window.prompt('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á:');
            auth.signInWithEmailLink(email, window.location.href).then(() => {
                window.localStorage.removeItem('emailForSignIn');
                window.location.replace(MY_URL);
            }).catch((e) => alert(e.message));
        }

        function sendMagicLink() {
            const email = document.getElementById('email-input').value;
            if(email !== ALLOWED_EMAIL) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á");
            auth.sendSignInLinkToEmail(email, { url: MY_URL, handleCodeInApp: true })
                .then(() => { window.localStorage.setItem('emailForSignIn', email); alert("‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå Login ‡∏Ñ‡∏£‡∏±‡∏ö"); })
                .catch(e => alert(e.message));
        }

        auth.onAuthStateChanged((user) => {
            if (user && user.email === ALLOWED_EMAIL) {
                document.getElementById('login-screen').style.display='none';
                document.getElementById('dashboard-container').style.display='block';
                document.getElementById('admin-email').innerText = user.email;
                initSystem();
            }
        });
        function logout() { auth.signOut().then(() => location.reload()); }

        // --- System Logic ---
        let isInit = false;
        async function initSystem() {
            if(isInit) return; isInit = true;
            loadUsers(); loadWorks(); loadQuestSubmissions();
        }
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el=>el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
        }

        // --- Quest Functions (‡πÉ‡∏´‡∏°‡πà) ---
        async function createQuest() {
            const text = document.getElementById('q-text').value;
            const hours = parseInt(document.getElementById('q-hours').value);
            const score = parseInt(document.getElementById('q-score').value);
            
            if(!text) return alert("‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏°‡∏î‡πÄ‡∏Ç‡∏ï
            const deadline = new Date();
            deadline.setHours(deadline.getHours() + hours);

            if(confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Quest?\n"${text}"\n‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${score}`)) {
                try {
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Quest ‡πÉ‡∏´‡∏°‡πà (‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏≠‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£ query ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏≠‡∏≤‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
                    await db.collection("quests").add({
                        question: text,
                        baseScore: score,
                        deadline: firebase.firestore.Timestamp.fromDate(deadline),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        active: true
                    });
                    alert("‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® Quest ‡πÅ‡∏•‡πâ‡∏ß! üéâ");
                    document.getElementById('q-text').value = "";
                } catch(e) { alert(e.message); }
            }
        }

        function loadQuestSubmissions() {
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö Quest ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            db.collection("quest_submissions").orderBy("timestamp", "desc").limit(50).onSnapshot(snapshot => {
                const tbody = document.querySelector("#questTable tbody");
                tbody.innerHTML = "";
                snapshot.forEach(doc => {
                    const d = doc.data();
                    const date = d.timestamp ? d.timestamp.toDate().toLocaleString('th-TH') : "";
                    
                    // ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©
                    let bonusBtn = `<button class="btn-sm btn-primary" onclick="giveBonus('${doc.id}', '${d.userId}', '${d.displayName}')">+ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©</button>`;
                    if(d.bonusGiven) bonusBtn = `<span class="badge" style="background:#28a745; color:white;">‡πÑ‡∏î‡πâ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡πÅ‡∏•‡πâ‡∏ß (+${d.bonusGiven})</span>`;

                    tbody.innerHTML += `
                        <tr>
                            <td style="font-size:0.8em;">${date}</td>
                            <td>${d.displayName}</td>
                            <td>${d.answer}</td>
                            <td>
                                <span class="badge" style="background:${d.isLate ? '#dc3545' : '#28a745'}; color:white;">
                                    ${d.isLate ? '‡∏™‡πà‡∏á‡∏ä‡πâ‡∏≤ (0 ‡πÅ‡∏ï‡πâ‡∏°)' : `‡∏ó‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ (+${d.earnedScore})`}
                                </span>
                            </td>
                            <td>${bonusBtn}</td>
                        </tr>
                    `;
                });
            });
        }

        async function giveBonus(subId, userId, name) {
            const amount = prompt(`‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© ${name} ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà‡∏î‡∏µ?`, "5");
            if(amount) {
                const points = parseInt(amount);
                try {
                    const batch = db.batch();
                    // 1. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡πâ User
                    const userRef = db.collection("users").doc(userId);
                    batch.update(userRef, { score: firebase.firestore.FieldValue.increment(points) });
                    // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô submission ‡∏ß‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß
                    const subRef = db.collection("quest_submissions").doc(subId);
                    batch.update(subRef, { bonusGiven: points });
                    
                    await batch.commit();
                    // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á alert ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏≠‡∏á
                } catch(e) { alert(e.message); }
            }
        }

        // --- Existing Functions (‡∏¢‡πà‡∏≠) ---
        function loadUsers() {
            db.collection("users").orderBy("score", "desc").onSnapshot(snap => {
                const tb = document.querySelector("#usersTable tbody"); tb.innerHTML = "";
                snap.forEach(doc => {
                    const u = doc.data();
                    tb.innerHTML += `<tr><td><img src="${u.pictureUrl}" width="30"></td><td>${u.displayName}</td><td>${u.score}</td>
                    <td><button class="btn-sm btn-primary" onclick="adj('${doc.id}', 1)">+1</button> <button class="btn-sm btn-danger" onclick="adj('${doc.id}', -1)">-1</button></td>
                    <td><button class="btn-sm btn-danger" onclick="delUser('${doc.id}')">‡∏•‡∏ö</button></td></tr>`;
                });
            });
        }
        function loadWorks() {
             db.collection("works").orderBy("timestamp", "desc").limit(20).onSnapshot(snap => {
                const tb = document.querySelector("#worksTable tbody"); tb.innerHTML = "";
                snap.forEach(doc => {
                    const w = doc.data();
                    tb.innerHTML += `<tr><td>${w.timestamp?.toDate().toLocaleString()}</td><td>${w.displayName}</td><td>${w.title}</td><td>${w.status}</td><td>${w.feedback||'-'}</td>
                    <td><button class="btn-sm btn-danger" onclick="delWork('${doc.id}')">‡∏•‡∏ö</button></td></tr>`;
                });
            });
        }
        async function adj(uid, v) { db.collection("users").doc(uid).update({ score: firebase.firestore.FieldValue.increment(v) }); }
        async function delUser(uid) { if(confirm("‡∏•‡∏ö?")) db.collection("users").doc(uid).delete(); }
        async function delWork(wid) { if(confirm("‡∏•‡∏ö?")) db.collection("works").doc(wid).delete(); }

    </script>
</body>
</html>
