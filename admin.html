<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLP INTERNSHIP V.260125 (V16)</title>
    <link rel="stylesheet" href="style.css">
    
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        /* Base */
        body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f4f6f9; margin:0;}
        #login-screen { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; }
        #dashboard-container { display:none; max-width:1100px; margin:20px auto; padding:20px; }
        
        /* Login */
        .login-card { background:white; padding:40px; border-radius:15px; box-shadow:0 10px 25px rgba(0,0,0,0.1); width:90%; max-width:400px; text-align:center; }
        .input-group input { width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box; margin-top:5px; }
        .magic-btn { background:#4361ee; color:white; border:none; padding:12px; width:100%; border-radius:8px; margin-top:20px; cursor:pointer; font-weight:bold; transition:0.2s; }
        .magic-btn:hover { background:#3046b5; }

        /* Navigation */
        .tab-nav { display:flex; border-bottom:2px solid #e0e0e0; margin-bottom:20px; overflow-x:auto; gap:10px; padding-bottom:5px; }
        .tab-btn { padding:10px 20px; border:none; background:none; cursor:pointer; font-weight:600; color:#777; border-radius:8px; transition:0.2s; white-space:nowrap; }
        .tab-btn:hover { background:#eef2f6; color:#333; }
        .tab-btn.active { background:#eef2ff; color:#4361ee; }
        .tab-content { display:none; animation:fadeIn 0.3s; } .tab-content.active { display:block; }
        
        /* Table */
        table { width:100%; border-collapse:collapse; background:white; border-radius:12px; overflow:hidden; box-shadow:0 2px 10px rgba(0,0,0,0.03); margin-bottom:20px; }
        th, td { padding:15px; text-align:left; border-bottom:1px solid #f0f0f0; vertical-align:middle; }
        th { background:#fafafa; color:#555; font-weight:600; font-size:0.9em; text-transform:uppercase; letter-spacing:0.5px; }
        tr:hover { background-color:#f8f9fa; }
        
        /* UI Elements */
        .btn-sm { padding:6px 12px; border-radius:6px; border:none; cursor:pointer; color:white; font-size:0.85em; font-weight:500; transition:0.2s; margin:0 2px; }
        .btn-primary { background:#4361ee; } .btn-danger { background:#ef233c; } .btn-success { background:#2ec4b6; } .btn-warning { background:#ff9f1c; color:white; } .btn-dark { background:#2b2d42; }
        .badge { padding:5px 10px; border-radius:20px; font-size:0.75em; font-weight:bold; color:white; display:inline-block; }
        .user-pic { width:36px; height:36px; border-radius:50%; object-fit:cover; border:2px solid #fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); vertical-align:middle; margin-right:10px; }
        
        /* Leaderboard Specifics */
        .leaderboard-card { background:white; padding:15px 20px; margin-bottom:12px; border-radius:12px; display:flex; align-items:center; justify-content:space-between; box-shadow:0 2px 8px rgba(0,0,0,0.04); transition:transform 0.2s; border-left:6px solid transparent; }
        .leaderboard-card:hover { transform:translateY(-2px); }
        .rank-1 { border-left-color:#FFD700; background:linear-gradient(to right, #fffdf0, #fff); } 
        .rank-2 { border-left-color:#C0C0C0; background:linear-gradient(to right, #f8f9fa, #fff); } 
        .rank-3 { border-left-color:#CD7F32; background:linear-gradient(to right, #fffaf5, #fff); }
        .rank-other { border-left-color:#4361ee; }

        .star-icon { font-size:1.2em; margin-left:5px; }
        .star-gold { color:#FFD700; text-shadow:0 0 5px rgba(255, 215, 0, 0.5); }
        .star-silver { color:#C0C0C0; }
        .star-bronze { color:#CD7F32; }
        .star-blue { color:#4361ee; opacity:0.7; }
        
        .section-header { font-size:1.1em; font-weight:bold; color:#2b2d42; margin:25px 0 15px 0; border-left:4px solid #4361ee; padding-left:10px; }
        
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h2 style="margin-bottom:5px;">üîê Admin Portal</h2>
            <p style="color:#888; margin-bottom:20px;">Internship Management System</p>
            <div id="login-form">
                <div class="input-group"><input type="email" id="email-input" value="medlifeplus@gmail.com" placeholder="Email"></div>
                <button class="magic-btn" onclick="sendMagicLink()">‚ú® ‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏•</button>
            </div>
            <div id="status-msg" style="margin-top:15px; color:#ef233c;"></div>
        </div>
    </div>

    <div id="dashboard-container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <div>
                <h2 style="margin:0; color:#2b2d42;">üë®‚Äçüíª Admin Dashboard</h2>
                <span id="admin-email" style="color:#888; font-size:0.9em;"></span>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-sm btn-success" onclick="shareLeaderboard()">üì§ ‡πÅ‡∏ä‡∏£‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                <button class="btn-sm btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('tab-works')">üìÑ ‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô & Quest</button>
            <button class="tab-btn" onclick="switchTab('tab-manage-quest')">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Quest</button>
            <button class="tab-btn" onclick="switchTab('tab-users')">üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
            <button class="tab-btn" onclick="switchTab('tab-leaderboard')">üèÜ Leaderboard</button>
        </div>

        <div id="tab-works" class="tab-content active">
            <div class="section-header">üìÅ ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ / ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô</div>
            <div style="overflow-x:auto;">
                <table id="worksTable">
                    <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á</th><th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th><th>‡∏•‡∏¥‡∏á‡∏Å‡πå</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</th><th>‡∏•‡∏ö</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="section-header">‚ö° Quest Submissions (‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô)</div>
            <div style="overflow-x:auto;">
                <table id="questTable">
                    <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á</th><th>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="tab-manage-quest" class="tab-content">
            <div style="background:white; padding:25px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.05); margin-bottom:25px;">
                <h3 style="margin-top:0;">üì¢ ‡∏™‡∏£‡πâ‡∏≤‡∏á Quest ‡πÉ‡∏´‡∏°‡πà</h3>
                <input type="text" id="q-text" placeholder="‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° / ‡πÇ‡∏à‡∏ó‡∏¢‡πå..." style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px;">
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <input type="text" id="q-img" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ (Optional)" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:8px;">
                    <input type="text" id="q-link" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ô‡∏ö (Optional)" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:8px;">
                </div>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="q-hours" value="24" placeholder="‡∏ä‡∏°." style="width:80px; padding:10px; border:1px solid #ddd; border-radius:8px;">
                    <input type="number" id="q-score" value="10" placeholder="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô" style="width:80px; padding:10px; border:1px solid #ddd; border-radius:8px;">
                    <button class="btn-sm btn-warning" style="flex:1; font-size:1em;" onclick="createQuest()">üöÄ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® Quest</button>
                </div>
            </div>

            <div id="active-quest-section" style="display:none; background:#d4edda; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #c3e6cb;">
                <h3 style="color:#155724; margin:0 0 10px 0;">üü¢ ‡∏Å‡∏≥‡∏•‡∏±‡∏á Active</h3>
                <table id="activeQuestTable" style="margin:0; background:transparent; box-shadow:none;">
                    <thead><tr><th>‡πÇ‡∏à‡∏ó‡∏¢‡πå</th><th>‡∏´‡∏°‡∏î‡πÄ‡∏Ç‡∏ï</th><th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th><th>‡∏¢‡∏∏‡∏ï‡∏¥</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <h3>‚ôªÔ∏è ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Quest</h3>
            <table id="questHistoryTable">
                <thead><tr><th>‡πÇ‡∏à‡∏ó‡∏¢‡πå</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="tab-users" class="tab-content">
            <input type="text" id="userSearch" style="width:100%; padding:12px; margin-bottom:15px; border:1px solid #ddd; border-radius:8px;" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." onkeyup="filterUsers()">
            <table id="usersTable"><thead><tr><th>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th><th>Level</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</th><th>‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡∏•‡∏ö</th></tr></thead><tbody></tbody></table>
        </div>

        <div id="tab-leaderboard" class="tab-content">
            <div id="leaderboardList" style="max-width:700px; margin:0 auto;"></div>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        const ALLOWED_EMAIL = "medlifeplus@gmail.com";
        const ADMIN_LIFF_ID = "2008959998-yjcNpaGt"; // ‚ö†Ô∏è ID Admin
        const MY_URL = 'https://mlpditto.github.io/INTERN-PORT/admin.html'; // ‚ö†Ô∏è URL Admin

        const auth = firebase.auth();
        let topUsersCache = [];

        // --- Login ---
        if (auth.isSignInWithEmailLink(window.location.href)) {
            let email = window.localStorage.getItem('emailForSignIn') || prompt('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•:');
            auth.signInWithEmailLink(email, window.location.href).then(() => {
                localStorage.removeItem('emailForSignIn'); location.replace(MY_URL);
            }).catch(e => alert(e.message));
        }
        function sendMagicLink() {
            const email = document.getElementById('email-input').value;
            if(email !== ALLOWED_EMAIL) return alert("No Permission");
            auth.sendSignInLinkToEmail(email, { url: MY_URL, handleCodeInApp: true })
                .then(() => { localStorage.setItem('emailForSignIn', email); alert("‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ñ‡∏£‡∏±‡∏ö"); });
        }
        auth.onAuthStateChanged(user => {
            if(user && user.email===ALLOWED_EMAIL) {
                document.getElementById('login-screen').style.display='none';
                document.getElementById('dashboard-container').style.display='block';
                document.getElementById('admin-email').innerText = user.email;
                initSystem();
            }
        });
        function logout() { auth.signOut().then(() => location.reload()); }

        // --- Init ---
        let isInit = false;
        async function initSystem() {
            if(isInit) return; isInit = true;
            try { await liff.init({ liffId: ADMIN_LIFF_ID }); } catch(e) {}
            loadWorks(); loadQuestSubmissions(); loadActiveQuests(); loadQuestHistory(); loadUsers();
        }
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
            document.getElementById(id).classList.add('active'); event.target.classList.add('active');
        }

        // --- Works ---
        function loadWorks() {
            db.collection("works").orderBy("timestamp", "desc").limit(50).onSnapshot(snap => {
                const tb = document.querySelector("#worksTable tbody"); tb.innerHTML = "";
                snap.forEach(doc => {
                    const w = doc.data(); const id = doc.id;
                    const statusColor = w.status==='‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß'?'#d4edda':w.status==='‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'?'#f8d7da':'#fff3cd';
                    
                    tb.innerHTML += `<tr>
                        <td style="font-size:0.8em; color:#888;">${w.timestamp?.toDate().toLocaleString('th-TH')||''}</td>
                        <td><div style="display:flex; align-items:center;"><img src="${w.pictureUrl||'https://via.placeholder.com/35'}" class="user-pic">${w.displayName}</div></td>
                        <td>${w.title}</td>
                        <td><a href="${w.link}" target="_blank" class="btn-sm btn-dark">Link</a></td>
                        <td><select onchange="updateStatus('${id}', this.value)" style="background:${statusColor}; border:none; padding:5px; border-radius:4px;"><option value="‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à" ${w.status==='‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à'?'selected':''}>‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à</option><option value="‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß" ${w.status==='‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß'?'selected':''}>‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß</option><option value="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" ${w.status==='‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'?'selected':''}>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</option></select></td>
                        <td>
                            <div style="display:flex; align-items:center;">
                                <input type="number" step="0.1" id="score-w-${id}" value="${w.score||0}" style="width:60px; padding:5px; border:1px solid #ddd; border-radius:4px; text-align:center;">
                                <button class="btn-sm btn-primary" onclick="saveWorkScore('${id}', '${w.userId}', ${w.score||0})">üíæ</button>
                            </div>
                        </td>
                        <td><button class="btn-sm btn-primary" onclick="addFeedback('${id}', '${w.feedback||''}')">üí¨</button>${w.feedback?`<span style="font-size:0.8em; color:blue;"> ‚úîÔ∏è</span>`:''}</td>
                        <td><button class="btn-sm btn-danger" onclick="delWork('${id}', '${w.title}')">üóëÔ∏è</button></td>
                    </tr>`;
                });
            });
        }
        async function saveWorkScore(workId, userId, oldScore) {
            const newScore = parseFloat(document.getElementById(`score-w-${workId}`).value) || 0;
            if(newScore === oldScore) return;
            const diff = newScore - oldScore;
            const batch = db.batch();
            batch.update(db.collection("works").doc(workId), { score: newScore, status: "‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß" });
            batch.update(db.collection("users").doc(userId), { score: firebase.firestore.FieldValue.increment(diff) });
            await batch.commit(); alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡πâ‡∏ß (+${diff})`);
        }

        // --- Quest Submissions ---
        function loadQuestSubmissions() {
            db.collection("quest_submissions").orderBy("timestamp", "desc").limit(50).onSnapshot(snap => {
                const tb = document.querySelector("#questTable tbody"); tb.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data(); const id = doc.id;
                    const totalScore = (d.earnedScore || 0) + (d.bonusGiven || 0);
                    const statusBadge = d.isLate ? '<span class="badge" style="background:#ef233c">‡∏™‡πà‡∏á‡∏ä‡πâ‡∏≤</span>' : '<span class="badge" style="background:#2ec4b6">‡∏ó‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</span>';
                    
                    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
                    let answerDisplay = d.answer;
                    if (answerDisplay.startsWith('http')) {
                        answerDisplay = `<a href="${answerDisplay}" target="_blank" class="btn-sm btn-dark" style="text-decoration:none;">üîó ‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå</a> <span style="font-size:0.8em; color:#888;">(Link)</span>`;
                    }

                    tb.innerHTML += `<tr>
                        <td style="font-size:0.8em; color:#888;">${d.timestamp?.toDate().toLocaleString('th-TH')||''}</td>
                        <td><div style="display:flex; align-items:center;"><img src="${d.pictureUrl||'https://via.placeholder.com/35'}" class="user-pic">${d.displayName}</div></td>
                        <td>${answerDisplay}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <div style="display:flex; align-items:center;">
                                <input type="number" step="0.1" id="score-q-${id}" value="${totalScore}" style="width:60px; padding:5px; border:1px solid #ddd; border-radius:4px; text-align:center;">
                                <button class="btn-sm btn-warning" onclick="updateQuestScore('${id}', '${d.userId}', ${totalScore}, ${d.earnedScore||0})">‡πÅ‡∏Å‡πâ</button>
                            </div>
                        </td>
                        <td><button class="btn-sm btn-danger" onclick="delQuestSub('${id}', '${d.userId}', ${totalScore})">‡∏•‡∏ö</button></td>
                    </tr>`;
                });
            });
        }
        async function updateQuestScore(subId, userId, currentTotal, baseEarned) {
            const newTotal = parseFloat(document.getElementById(`score-q-${subId}`).value);
            if(isNaN(newTotal)) return;
            const newBonus = parseFloat((newTotal - baseEarned).toFixed(2));
            const diff = parseFloat((newTotal - currentTotal).toFixed(2));
            if(confirm(`‡πÅ‡∏Å‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô ${newTotal}?\n(Bonus: ${newBonus})`)) {
                const batch = db.batch();
                batch.update(db.collection("quest_submissions").doc(subId), { bonusGiven: newBonus });
                batch.update(db.collection("users").doc(userId), { score: firebase.firestore.FieldValue.increment(diff) });
                await batch.commit();
            }
        }
        async function delQuestSub(subId, userId, scoreToRemove) {
            if(confirm("‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ô‡∏µ‡πâ? ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏´‡∏±‡∏Å‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢")) {
                const batch = db.batch();
                batch.delete(db.collection("quest_submissions").doc(subId));
                batch.update(db.collection("users").doc(userId), { score: firebase.firestore.FieldValue.increment(-scoreToRemove) });
                await batch.commit();
            }
        }

        // --- Quests Manage ---
        async function createQuest() {
            const q={ question:getID('q-text').value, imageUrl:getID('q-img').value, questLink:getID('q-link').value, baseScore:parseFloat(getID('q-score').value), deadline: new Date(Date.now() + parseFloat(getID('q-hours').value)*3600000), createdAt: firebase.firestore.FieldValue.serverTimestamp() };
            if(!q.question) return alert("‡πÉ‡∏™‡πà‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Å‡πà‡∏≠‡∏ô");
            if(confirm("‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® Quest?")) { await db.collection("quests").add(q); alert("Done!"); getID('q-text').value=""; }
        }
        function loadActiveQuests() {
            db.collection("quests").orderBy("createdAt", "desc").onSnapshot(snap => {
                const tb = document.querySelector("#activeQuestTable tbody"); tb.innerHTML = "";
                let hasActive = false; const now = new Date();
                snap.forEach(doc => {
                    const q = doc.data();
                    if(q.deadline?.toDate() > now) {
                        hasActive = true;
                        const safeQ=q.question.replace(/'/g,"\\'"), safeImg=(q.imageUrl||"").replace(/'/g,"\\'"), safeLink=(q.questLink||"").replace(/'/g,"\\'");
                        tb.innerHTML += `<tr><td>${q.question}</td><td>${Math.ceil((q.deadline.toDate()-now)/36e5)} ‡∏ä‡∏°.</td>
                        <td><button class="btn-sm btn-warning" onclick="editQ('${doc.id}','${safeQ}','${safeImg}','${safeLink}')">‚úèÔ∏è</button></td>
                        <td><button class="btn-sm btn-dark" onclick="stopQ('${doc.id}')">‚õî</button></td></tr>`;
                    }
                });
                document.getElementById("active-quest-section").style.display = hasActive?"block":"none";
            });
        }
        async function stopQ(id) { if(confirm("‡∏¢‡∏∏‡∏ï‡∏¥ Quest?")) db.collection("quests").doc(id).update({deadline: new Date(Date.now()-1000)}); }
        async function editQ(id,q,i,l) { const nQ=prompt("‡πÇ‡∏à‡∏ó‡∏¢‡πå",q), nI=prompt("‡∏£‡∏π‡∏õ",i), nL=prompt("‡∏•‡∏¥‡∏á‡∏Å‡πå",l); if(nQ) db.collection("quests").doc(id).update({question:nQ, imageUrl:nI, questLink:nL}); }
        function loadQuestHistory() {
            db.collection("quests").orderBy("createdAt","desc").limit(20).onSnapshot(snap=>{
                const tb=document.querySelector("#questHistoryTable tbody"); tb.innerHTML="";
                snap.forEach(doc=>{ const q=doc.data(); tb.innerHTML+=`<tr><td>${q.question}</td><td>${q.baseScore}</td><td><button class="btn-sm btn-success" onclick="reuse('${q.question.replace(/'/g,"\\'")}','${q.baseScore}','${(q.imageUrl||"").replace(/'/g,"\\'")}','${(q.questLink||"").replace(/'/g,"\\'")}')">‚ôªÔ∏è ‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥</button> <button class="btn-sm btn-danger" onclick="delQ('${doc.id}')">üóëÔ∏è</button></td></tr>`; });
            });
        }
        function reuse(q,s,i,l){ getID('q-text').value=q; getID('q-score').value=s; getID('q-img').value=i; getID('q-link').value=l; document.querySelector('.quest-create-card').scrollIntoView({behavior:'smooth'}); }
        async function delQ(id){ if(confirm("‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£?")) db.collection("quests").doc(id).delete(); }

        // --- Users & Leaderboard (Updated Stars) ---
        function loadUsers() {
            db.collection("users").orderBy("score","desc").onSnapshot(snap=>{
                const tb=document.querySelector("#usersTable tbody"); const lb=document.getElementById("leaderboardList");
                tb.innerHTML=""; lb.innerHTML=""; topUsersCache=[]; let r=1;
                
                snap.forEach(doc=>{
                    const u=doc.data(); const score = parseFloat((u.score||0).toFixed(2));
                    const lv=Math.floor(score/10)+1;
                    
                    // Table Row
                    tb.innerHTML+=`<tr class="u-row">
                        <td><div style="display:flex; align-items:center;"><img src="${u.pictureUrl}" class="user-pic"><span>${u.displayName}</span></div></td>
                        <td><span class="badge" style="background:#eee; color:#555">Lv.${lv}</span></td>
                        <td style="font-weight:bold; color:#4361ee;">${score}</td>
                        <td><button class="btn-sm btn-primary" onclick="adj('${doc.id}',1)">+1</button><button class="btn-sm btn-danger" onclick="adj('${doc.id}',-1)">-1</button></td>
                        <td><button class="btn-sm btn-danger" onclick="delUser('${doc.id}')">üóëÔ∏è</button></td>
                    </tr>`;

                    // Leaderboard Card
                    if(r<=20){ // Show top 20
                        topUsersCache.push(`${r}. ${u.displayName} (${score})`);
                        
                        // ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Class ‡πÅ‡∏•‡∏∞ Icon ‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö
                        let rankClass = 'rank-other';
                        let starIcon = '<span class="star-icon star-blue">‚≠ê</span>'; // Default Blue Star
                        
                        if (r === 1) { rankClass = 'rank-1'; starIcon = '<span class="star-icon star-gold">üåü</span>'; }
                        else if (r === 2) { rankClass = 'rank-2'; starIcon = '<span class="star-icon star-silver">ü•à</span>'; }
                        else if (r === 3) { rankClass = 'rank-3'; starIcon = '<span class="star-icon star-bronze">ü•â</span>'; }

                        lb.innerHTML+=`
                            <div class="leaderboard-card ${rankClass}">
                                <div style="display:flex; align-items:center;">
                                    <b style="width:30px; font-size:1.1em; color:#555;">#${r}</b>
                                    <img src="${u.pictureUrl}" class="user-pic">
                                    <span style="font-weight:600; color:#333;">${u.displayName}</span>
                                </div>
                                <div style="display:flex; align-items:center;">
                                    <span style="font-weight:bold; font-size:1.1em; color:#333;">${score}</span>
                                    ${starIcon}
                                </div>
                            </div>
                        `;
                    } r++;
                });
            });
        }

        // Helpers
        function getID(id){ return document.getElementById(id); }
        function filterUsers(){ const t=getID('userSearch').value.toLowerCase(); document.querySelectorAll('.u-row').forEach(r=>r.style.display=r.innerText.toLowerCase().includes(t)?'':'none'); }
        async function adj(id,v){ db.collection("users").doc(id).update({score:firebase.firestore.FieldValue.increment(v)}); }
        async function delUser(id){ if(confirm("‡∏•‡∏ö User?")) db.collection("users").doc(id).delete(); }
        async function delWork(id,t){ if(confirm("‡∏•‡∏ö "+t+"?")) db.collection("works").doc(id).delete(); }
        async function updateStatus(id,v){ db.collection("works").doc(id).update({status:v}); }
        async function addFeedback(id,v){ const f=prompt("Feedback:",v); if(f!==null) db.collection("works").doc(id).update({feedback:f}); }
        async function shareLeaderboard(){ 
            if(!topUsersCache.length) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            const t = "üèÜ ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:\n"+topUsersCache.slice(0,10).join("\n")+"\n..."; // ‡πÅ‡∏ä‡∏£‡πå‡πÅ‡∏Ñ‡πà Top 10 ‡∏û‡∏≠
            if(liff.isInClient()) liff.shareTargetPicker([{type:"text",text:t}]); else navigator.clipboard.writeText(t).then(()=>alert("Copied!")).catch(()=>prompt("Copy:",t));
        }

    </script>
</body>
</html>
