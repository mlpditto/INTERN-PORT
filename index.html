<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLP INTERNSHIP</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8f9fa; padding: 20px; color:#333; margin:0; }
        .container { max-width: 600px; margin: 0 auto; }
        
        /* Cards */
        .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        /* Profile */
        .profile-section { text-align: center; }
        .profile-img { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #06C755; }
        .score-text { color: #06C755; font-weight: bold; font-size: 1.4em; }

        /* Forms */
        input, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; font-family: inherit; }
        button { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; color: white; background-color: #06C755; transition: 0.2s; }
        button:hover { background-color: #05a546; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* üî• Quest Card */
        .quest-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; }
        .quest-timer { font-size: 0.9em; background: rgba(0,0,0,0.25); padding: 5px 12px; border-radius: 20px; display: inline-block; margin-bottom: 10px; }
        .quest-points { background: #ffc107; color: black; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }
        
        /* üìÖ Check-in Card (New) */
        .checkin-card { border-left: 5px solid #17a2b8; }
        .checkin-checkbox { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; cursor: pointer; background: #f1f8ff; padding: 10px; border-radius: 8px; border: 1px solid #cce5ff; }
        .checkin-checkbox input { width: 20px; height: 20px; margin: 0; cursor: pointer; }

        /* Feedback */
        .feedback-box { background-color: #e7f3ff; border-left: 4px solid #1877f2; padding: 10px; margin-top: 10px; border-radius: 4px; font-size: 0.9em; color: #333; }

        /* Utility */
        .hidden { display: none !important; }
        .badge { padding: 4px 8px; border-radius: 4px; color: white; font-size: 0.8em; }
        .bg-yellow { background: #ffc107; color: black; }
        .bg-green { background: #28a745; }
        .bg-red { background: #dc3545; }
    </style>
</head>
<body>

    <div class="container">
        <div id="loading" style="text-align:center; margin-top:50px;">
            <p>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>

        <div id="main-app" class="hidden">
            
            <div class="card profile-section">
                <img id="u-img" class="profile-img" src="">
                <h3 id="u-name" style="margin:10px 0 5px;">User</h3>
                <p>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°: <span id="u-score" class="score-text">0</span> ‡πÅ‡∏ï‡πâ‡∏°</p>
            </div>

            <div id="checkin-container" class="card checkin-card hidden">
                <h3 style="margin-top:0;">üìÖ ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏≠‡πà‡∏≤‡∏ô Daily Quest </h3>
                
                <div id="checkin-form">
                    <p style="font-size:0.9em; color:#666; margin-bottom:10px;">‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°</p>
                    <label class="checkin-checkbox">
                        <input type="checkbox" id="chk-checkin" onchange="toggleCheckinBtn()">
                        <span style="font-weight:bold; color:#0056b3;">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</span>
                    </label>
                    <button id="btn-checkin" onclick="submitCheckIn()" disabled style="background:#17a2b8;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏°</button>
                </div>

                <div id="checkin-done" class="hidden" style="text-align:center; padding:10px;">
                    <h2 style="margin:0; font-size:3em;">‚úÖ</h2>
                    <p style="color:#28a745; font-weight:bold; margin:5px 0;">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡∏±‡∏ö Quest ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
                    <small style="color:#999;">‡πÄ‡∏à‡∏≠‡∏Å‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö!</small>
                </div>
            </div>

            <div id="quest-container" class="card quest-card hidden">
                <div class="quest-timer">‚è∞ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤: <span id="q-countdown">--:--</span></div>
                <h3 style="margin:5px 0;">‚ö° ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                <p id="q-text" style="font-size:1.1em; margin-bottom:15px; line-height:1.4;">...</p>
                <div id="q-input-area">
                    <textarea id="q-answer" rows="3" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." style="color:black;"></textarea>
                    <button onclick="submitQuest()" style="background:#ffc107; color:black;">üöÄ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (‡∏£‡∏±‡∏ö <span id="q-points">0</span> ‡πÅ‡∏ï‡πâ‡∏°)</button>
                </div>
                <div id="q-status" class="hidden" style="background:rgba(255,255,255,0.2); padding:15px; border-radius:8px; margin-top:10px;">
                    ‚úÖ <b>‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß!</b><br><small>‡∏£‡∏≠ Admin ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏û‡∏¥‡πà‡∏°</small>
                </div>
            </div>

            <div class="card">
                <h4>üì§ ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô / ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô</h4>
                <input type="text" id="w-title" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô EP.1 ‡∏™‡∏£‡∏∏‡∏õ...)">
                <input type="url" id="w-link" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏á‡∏≤‡∏ô (Google Drive / Canva)">
                <button onclick="submitWork()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button>
            </div>

            <h4 style="margin-left:5px; color:#666;">üìÇ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</h4>
            <div id="work-list"></div>
            <div style="height:50px;"></div>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        // --- üîí CONFIG ---
        const USER_LIFF_ID = "2008959998-yjcNpaGt"; // ‚ö†Ô∏è ‡πÉ‡∏™‡πà LIFF ID (User) ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

        let userProfile, userId;
        let currentQuestId = null, currentQuestDeadline = null, baseScore = 0;
        let timerInterval = null;

        // --- Init ---
        async function main() {
            try {
                await liff.init({ liffId: USER_LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                userProfile = await liff.getProfile();
                userId = userProfile.userId;

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('u-img').src = userProfile.pictureUrl;
                document.getElementById('u-name').innerText = userProfile.displayName;

                checkAndCreateUser();
                loadMyWorks();
                loadActiveQuest();
            } catch (err) { alert("LIFF Error: " + err.message); }
        }
        main();

        // --- User & Check-in Logic ---
        function checkAndCreateUser() {
            const userRef = db.collection("users").doc(userId);
            userRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)
                    document.getElementById('u-score').innerText = parseFloat((data.score || 0).toFixed(2));
                    
                    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
                    updateCheckInUI(data.lastCheckIn);
                } else {
                    userRef.set({
                        displayName: userProfile.displayName,
                        pictureUrl: userProfile.pictureUrl,
                        score: 0,
                        joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            });
        }

        function updateCheckInUI(lastCheckInTimestamp) {
            const container = document.getElementById('checkin-container');
            const form = document.getElementById('checkin-form');
            const done = document.getElementById('checkin-done');
            
            container.classList.remove('hidden'); // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î

            if (lastCheckInTimestamp) {
                const lastDate = lastCheckInTimestamp.toDate();
                const now = new Date();
                
                // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö ‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ
                if (lastDate.getDate() === now.getDate() && 
                    lastDate.getMonth() === now.getMonth() && 
                    lastDate.getFullYear() === now.getFullYear()) {
                    
                    // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô = ‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß
                    form.classList.add('hidden');
                    done.classList.remove('hidden');
                    return;
                }
            }
            
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏•‡∏á
            form.classList.remove('hidden');
            done.classList.add('hidden');
        }

        function toggleCheckinBtn() {
            const chk = document.getElementById('chk-checkin');
            const btn = document.getElementById('btn-checkin');
            btn.disabled = !chk.checked;
        }

        async function submitCheckIn() {
            try {
                const batch = db.batch();
                const userRef = db.collection("users").doc(userId);
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô + ‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                batch.update(userRef, {
                    score: firebase.firestore.FieldValue.increment(0.1), // ‡πÉ‡∏´‡πâ 0.1 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
                    lastCheckIn: firebase.firestore.FieldValue.serverTimestamp()
                });

                // (Optional) ‡πÄ‡∏Å‡πá‡∏ö Log ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡πÑ‡∏ß‡πâ‡∏î‡∏π‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
                const logRef = db.collection("checkin_logs").doc();
                batch.set(logRef, {
                    userId: userId,
                    displayName: userProfile.displayName,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                await batch.commit();
                
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! (+0.1 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)");
                // UI ‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å onSnapshot
            } catch(e) {
                alert("Error: " + e.message);
            }
        }

        // --- Quest Logic ---
        function loadActiveQuest() {
            db.collection("quests").orderBy("createdAt", "desc").limit(1).onSnapshot((snapshot) => {
                if(snapshot.empty) { document.getElementById('quest-container').classList.add('hidden'); return; }
                const qData = snapshot.docs[0].data();
                if (!qData.deadline) return;
                const now = new Date();
                if (now > qData.deadline.toDate()) { document.getElementById('quest-container').classList.add('hidden'); return; }

                currentQuestId = snapshot.docs[0].id;
                currentQuestDeadline = qData.deadline.toDate();
                baseScore = qData.baseScore || 0;

                document.getElementById('quest-container').classList.remove('hidden');
                document.getElementById('q-text').innerText = qData.question;
                document.getElementById('q-points').innerText = baseScore;

                if(timerInterval) clearInterval(timerInterval);
                startTimer();
                checkIfAnswered();
            });
        }
        function checkIfAnswered() {
            db.collection("quest_submissions").where("questId", "==", currentQuestId).where("userId", "==", userId).limit(1).onSnapshot((snap) => {
                if (!snap.empty) {
                    document.getElementById('q-input-area').classList.add('hidden');
                    document.getElementById('q-status').classList.remove('hidden');
                } else {
                    document.getElementById('q-input-area').classList.remove('hidden');
                    document.getElementById('q-status').classList.add('hidden');
                }
            });
        }
        function startTimer() {
            timerInterval = setInterval(() => {
                const diff = currentQuestDeadline - new Date();
                if (diff <= 0) {
                    document.getElementById('q-countdown').innerText = "‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤";
                    document.getElementById('q-input-area').classList.add('hidden');
                    clearInterval(timerInterval); return;
                }
                const hrs=Math.floor((diff/(1000*60*60*24))/(1000*60*60)), mins=Math.floor((diff%(1000*60*60))/(1000*60));
                document.getElementById('q-countdown').innerText = `${hrs}:${mins.toString().padStart(2,'0')}`;
            }, 1000);
        }
        async function submitQuest() {
            const ans = document.getElementById('q-answer').value.trim();
            if (!ans) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö");
            const earned = (new Date() > currentQuestDeadline) ? 0 : baseScore;
            const batch = db.batch();
            batch.set(db.collection("quest_submissions").doc(), { questId: currentQuestId, userId, displayName: userProfile.displayName, answer: ans, timestamp: firebase.firestore.FieldValue.serverTimestamp(), isLate: earned===0, earnedScore: earned, bonusGiven: 0 });
            if (earned > 0) batch.update(db.collection("users").doc(userId), { score: firebase.firestore.FieldValue.increment(earned) });
            await batch.commit(); alert(`‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ${earned>0?'+'+earned+' ‡πÅ‡∏ï‡πâ‡∏°':''}`);
        }

        // --- Work Logic ---
        async function submitWork() {
            const t=document.getElementById('w-title').value.trim(), l=document.getElementById('w-link').value.trim();
            if(!t||!l) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
            await db.collection("works").add({ userId, displayName: userProfile.displayName, pictureUrl: userProfile.pictureUrl, title: t, link: l, status: "‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à", feedback: "", timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            alert("‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!"); document.getElementById('w-title').value=""; document.getElementById('w-link').value="";
        }
        function loadMyWorks() {
            db.collection("works").where("userId", "==", userId).orderBy("timestamp", "desc").onSnapshot((snap) => {
                const list = document.getElementById('work-list'); list.innerHTML = "";
                if (snap.empty) { list.innerHTML = "<p style='text-align:center; color:#999;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</p>"; return; }
                snap.forEach(doc => {
                    const w = doc.data();
                    let fb = w.feedback ? `<div class="feedback-box"><b>üí¨ Admin:</b> ${w.feedback}</div>` : "";
                    let badge = w.status==="‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß"?"bg-green":w.status==="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"?"bg-red":"bg-yellow";
                    list.innerHTML += `<div class="card" style="padding:15px; border-left:5px solid ${w.status==='‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß'?'#28a745':'#ffc107'}">
                        <div style="display:flex; justify-content:space-between;"><div><h4 style="margin:0;">${w.title}</h4><span class="badge ${badge}">${w.status}</span> <span style="font-size:0.8em; color:#999;">${w.timestamp?w.timestamp.toDate().toLocaleDateString('th-TH'):''}</span></div><a href="${w.link}" target="_blank" style="font-size:1.5em; text-decoration:none;">üîó</a></div>${fb}</div>`;
                });
            });
        }
    </script>
</body>
</html>

