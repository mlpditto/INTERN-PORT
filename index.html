<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLP INTERNSHIP (V43)</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        /* ... (CSS V40) ... */
        body { font-family: 'Kanit', sans-serif; background-color: #f4f6f9; padding: 20px; color:#333; margin:0; }
        .container { max-width: 600px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .profile-img { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 4px solid #fff; box-shadow: 0 5px 15px rgba(6,199,85,0.2); }
        .score-text { color: #4361ee; font-weight: 800; font-size: 1.8em; }
        .hidden { display: none !important; }
        button { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: #4361ee; color: white; }
        .quest-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; }
        .timer-display { font-size: 1.5em; font-weight: bold; margin: 10px 0; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 8px; }
        .retry-wait { color: #ef233c; font-weight: bold; background: #fff; padding: 5px; border-radius: 5px; }
        input, textarea { width: 100%; padding: 10px; margin-top: 5px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        .version-tag { text-align: center; color: #ccc; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="main-app" class="hidden">
            <div class="card" style="text-align:center;">
                <img id="u-img" class="profile-img" src="">
                <h2 id="u-name" style="margin:10px 0;">User</h2>
                <div id="u-score" class="score-text">0</div>
            </div>
            
            <h3>üî• ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à (Timed Quest)</h3>
            <div id="quest-list-container"></div>
            
            <div class="version-tag">System V43 (Timed)</div>
        </div>
    </div>

    <script src="firebase-config.js?v=43"></script>
    <script>
        const USER_LIFF_ID = "2008959998-yjcNpaGt"; 
        let userProfile, userId, myQuestData = {}; 
        
        async function main() {
            try { 
                await liff.init({ liffId: USER_LIFF_ID }); 
                if (!liff.isLoggedIn()) { liff.login(); return; }
                userProfile = await liff.getProfile(); userId = userProfile.userId;
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('u-img').src = userProfile.pictureUrl || "https://via.placeholder.com/150"; 
                document.getElementById('u-name').innerText = userProfile.displayName;
                checkUser(); loadQuests();
                setInterval(checkExpiry, 1000); // ‚è±Ô∏è Global Check
            } catch (e) { alert(e.message); }
        } main();

        function checkUser(){ const r=db.collection("users").doc(userId); r.onSnapshot(d=>{ if(!d.exists) r.set({displayName:userProfile.displayName, pictureUrl:userProfile.pictureUrl||"", score:0}); else document.getElementById('u-score').innerText=parseFloat((d.data().score||0).toFixed(2)); }); }

        function loadQuests() {
            db.collection("quest_submissions").where("userId", "==", userId).onSnapshot(s => {
                myQuestData = {}; s.forEach(doc => { myQuestData[doc.data().questId] = doc.data(); });
                db.collection("quests").orderBy("createdAt", "desc").limit(5).onSnapshot(renderQuests);
            });
        }

        function renderQuests(s) {
            const c = document.getElementById('quest-list-container'); c.innerHTML = "";
            s.forEach(doc => {
                const q = doc.data(); const qId = doc.id;
                const myQ = myQuestData[qId] || {};
                const status = myQ.status || 'none';
                
                let html = `<div class="card quest-card"><h3>${q.question}</h3>`;
                
                if (status === 'none') {
                    // Check Cooldown
                    const cooldown = myQ.cooldownUntil ? myQ.cooldownUntil.toDate() : null;
                    if (cooldown && new Date() < cooldown) {
                        html += `<div class="retry-wait" id="cd-${qId}" data-until="${cooldown.getTime()}">Wait...</div>`;
                    } else {
                        html += `<p>‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥: ${q.durationMinutes || 30} ‡∏ô‡∏≤‡∏ó‡∏µ</p><button onclick="recvQ('${qId}',${q.durationMinutes||30})">Start Quest</button>`;
                    }
                } else if (status === 'received') {
                    const deadline = myQ.deadline ? myQ.deadline.toDate().getTime() : 0;
                    html += `<div class="timer-display" id="timer-${qId}" data-deadline="${deadline}">...</div>
                             <textarea id="ans-${qId}" rows="2"></textarea>
                             <button onclick="subQ('${qId}',${q.baseScore})">Submit</button>`;
                } else if (status === 'unsuccessful') {
                    html += `<div style="color:#ef233c;font-weight:bold;">‚ùå Failed (Time Up)</div><small>Cooldown 2 hours</small>`;
                } else {
                    html += `<div style="color:#2ec4b6;font-weight:bold;">‚úÖ Completed</div>`;
                }
                c.innerHTML += html + `</div>`;
            });
        }

        async function recvQ(qid, dur) {
            const deadline = new Date(Date.now() + dur * 60000);
            const batch = db.batch();
            batch.set(db.collection("quest_submissions").doc(`${qid}_${userId}`), { 
                questId: qid, userId, status: 'received', 
                deadline: firebase.firestore.Timestamp.fromDate(deadline),
                receivedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            // Give initial points (will deduct if fail)
            batch.update(db.collection("users").doc(userId), { score: firebase.firestore.FieldValue.increment(0.1) });
            await batch.commit();
        }

        async function subQ(qid, base) {
            const ans = document.getElementById(`ans-${qid}`).value; if(!ans) return alert("Empty?");
            const batch = db.batch();
            batch.update(db.collection("quest_submissions").doc(`${qid}_${userId}`), { 
                status: 'submitted', answer: ans, 
                submittedAt: firebase.firestore.FieldValue.serverTimestamp(), earnedScore: base 
            });
            batch.update(db.collection("users").doc(userId), { score: firebase.firestore.FieldValue.increment(base) });
            await batch.commit();
        }

        function checkExpiry() {
            // Update Timers UI
            document.querySelectorAll('[id^="timer-"]').forEach(el => {
                const dead = parseInt(el.dataset.deadline); const diff = dead - Date.now();
                if(diff <= 0) el.innerText = "00:00"; // Logic below handles DB update
                else {
                    const m = Math.floor(diff/60000); const s = Math.floor((diff%60000)/1000);
                    el.innerText = `${m}:${s<10?'0':''}${s}`;
                }
            });
            
            // Check Cooldown UI
            document.querySelectorAll('[id^="cd-"]').forEach(el => {
                const until = parseInt(el.dataset.until); const diff = until - Date.now();
                if(diff <= 0) el.innerText = "Ready to Retry (Refresh)";
                else {
                    const h = Math.floor(diff/3600000); const m = Math.floor((diff%3600000)/60000);
                    el.innerText = `Retry in ${h}h ${m}m`;
                }
            });

            // Logic: Auto Fail if expired
            for (let qid in myQuestData) {
                const q = myQuestData[qid];
                if (q.status === 'received' && q.deadline) {
                    if (Date.now() > q.deadline.toDate()) {
                        // Fail!
                        console.log("Time up for", qid);
                        failQuest(qid);
                    }
                }
            }
        }

        async function failQuest(qid) {
            // Prevent multiple triggers
            if(myQuestData[qid].status === 'unsuccessful') return; 
            
            const cooldown = new Date(Date.now() + 2 * 60 * 60 * 1000); // 2 Hours
            const batch = db.batch();
            
            batch.update(db.collection("quest_submissions").doc(`${qid}_${userId}`), { 
                status: 'unsuccessful', 
                cooldownUntil: firebase.firestore.Timestamp.fromDate(cooldown) 
            });
            // Penalty: Return point
            batch.update(db.collection("users").doc(userId), { score: firebase.firestore.FieldValue.increment(-0.1) });
            
            try { await batch.commit(); } catch(e) { console.error(e); }
        }
    </script>
</body>
</html>
