<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLP INTERNSHIP (V47)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <style>
        /* ... (CSS Base from V45/V46) ... */
        body { font-family: 'Kanit', sans-serif; background-color: #f4f6f9; padding: 20px; color:#333; margin:0; }
        .container { max-width: 600px; margin: 0 auto; padding-bottom: 80px; }
        .card { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .profile-img { width: 90px; height: 90px; border-radius: 50%; border: 4px solid #fff; box-shadow: 0 5px 15px rgba(6,199,85,0.2); object-fit: cover; }
        .score-text { color: #4361ee; font-weight: 800; font-size: 1.8em; }
        .hidden { display: none !important; }
        
        .sq-container { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 20px; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; }
        .sq-col { min-width: 85%; background: #f8f9fa; border-radius: 12px; padding: 15px; scroll-snap-align: center; }
        .sq-card { background: white; padding: 15px; border-radius: 10px; border-left: 5px solid #ccc; margin-bottom: 10px; position: relative; }
        .sq-card.project { background-color: #fff0f5; border-left-color: #e83e8c; }
        
        /* Chat */
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .modal-content { background: white; margin: 15% auto; padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; position: relative; }
        .chat-box { height: 250px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #eee; }
        .chat-msg { margin-bottom: 8px; padding: 8px; border-radius: 8px; font-size: 0.9em; max-width: 80%; }
        .msg-admin { background: #d1e7dd; margin-right: auto; text-align: left; color: #0f5132; }
        .msg-user { background: #4361ee; color: white; margin-left: auto; text-align: right; }
        
        /* Utils */
        button { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; min-height: 48px; }
        .btn-primary { background: #4361ee; color: white; }
        .btn-sm { width: auto; min-height: 30px; padding: 5px 10px; font-size: 0.85em; }
        input, textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        .date-input-group { display: flex; gap: 10px; margin-top: 10px; } .date-input-group div { flex: 1; }
        
        /* Refresh Btn */
        .refresh-btn { position: absolute; top: 10px; right: 10px; width:auto; min-height:auto; background:white; border:1px solid #ddd; padding:5px 10px; font-size:0.8em; z-index:99; }
    </style>
</head>
<body>
    <div class="container">
        <button class="refresh-btn" onclick="window.location.reload(true)">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        <div id="loading" style="text-align:center; margin-top:100px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        
        <div id="main-app" class="hidden">
            <div style="height:20px;"></div>
            
            <div class="card" style="text-align:center;">
                <img id="u-img" class="profile-img" src="">
                <h2 id="u-name">User</h2>
                <div id="u-score" class="score-text">0</div>
            </div>

            <div class="card" style="border-left: 5px solid #e67e22; background:#fffbf0;">
                <h4>üéì ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</h4>
                <div class="date-input-group">
                    <div><label>‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input type="date" id="u-start-date" onchange="saveMyDates()"></div>
                    <div><label>‡∏ß‡∏±‡∏ô‡∏à‡∏ö</label><input type="date" id="u-end-date" onchange="saveMyDates()"></div>
                </div>
            </div>
            
            <h3><i class="fa-solid fa-map"></i> ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à (Kanban)</h3>
            <div class="sq-container">
                <div class="sq-col"><div style="font-weight:bold;margin-bottom:10px;">üìå Backlog</div><div id="sq-Backlog"></div></div>
                <div class="sq-col"><div style="font-weight:bold;margin-bottom:10px;">üöß Doing</div><div id="sq-Doing"></div></div>
                <div class="sq-col"><div style="font-weight:bold;margin-bottom:10px;">üëÄ Review</div><div id="sq-Review"></div></div>
                <div class="sq-col"><div style="font-weight:bold;margin-bottom:10px;">‚úÖ Done</div><div id="sq-Done"></div></div>
            </div>

            <div style="height:50px;"></div>
        </div>
    </div>

    <div id="chatModal" class="modal">
        <div class="modal-content">
            <span onclick="document.getElementById('chatModal').style.display='none'" style="float:right;font-size:24px;cursor:pointer;">&times;</span>
            <h3>üí¨ ‡∏™‡∏ô‡∏ó‡∏ô‡∏≤ (Project)</h3>
            <input type="hidden" id="chat-card-id">
            <div id="chat-box" class="chat-box"></div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="chat-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." style="margin:0;">
                <button class="btn-primary" onclick="sendChat()" style="width:auto;"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script src="firebase-config.js?v=47"></script>
    <script>
        const USER_LIFF_ID = "2008959998-yjcNpaGt"; 
        let userProfile, userId; 
        
        async function main() {
            try { 
                await liff.init({ liffId: USER_LIFF_ID }); 
                if (!liff.isLoggedIn()) { liff.login(); return; }
                userProfile = await liff.getProfile(); userId = userProfile.userId;
                document.getElementById('loading').classList.add('hidden'); 
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('u-img').src = userProfile.pictureUrl || "https://via.placeholder.com/150"; 
                document.getElementById('u-name').innerText = userProfile.displayName;
                checkUser(); loadSideQuests();
            } catch (e) { alert(e.message); }
        } main();

        function checkUser(){ const r=db.collection("users").doc(userId); r.onSnapshot(d=>{ if(d.exists) { const da=d.data(); document.getElementById('u-score').innerText=parseFloat((da.score||0).toFixed(2)); if(da.startDate)document.getElementById('u-start-date').value=da.startDate; if(da.endDate)document.getElementById('u-end-date').value=da.endDate; } else r.set({displayName:userProfile.displayName,pictureUrl:userProfile.pictureUrl||"",score:0}); }); }
        async function saveMyDates() { const s=document.getElementById('u-start-date').value, e=document.getElementById('u-end-date').value; if(s||e) await db.collection("users").doc(userId).update({startDate:s,endDate:e}); }

        function loadSideQuests(){
            db.collection("side_quests").where("assigneeIds","array-contains",userId).onSnapshot(s=>{
                const cols={"Backlog":document.getElementById("sq-Backlog"),"Doing":document.getElementById("sq-Doing"),"Review":document.getElementById("sq-Review"),"Done":document.getElementById("sq-Done")};
                Object.values(cols).forEach(c=>c.innerHTML="");
                s.forEach(d=>{
                    const q=d.data();
                    if(cols[q.status]){
                        const isProj = q.isProject === true;
                        let btn = "", chatBtn = "";
                        if(q.status==="Backlog") btn=`<button class="btn-sm btn-primary" onclick="upSQ('${d.id}','Doing')">Start</button>`;
                        else if(q.status==="Doing") btn=`<button class="btn-sm btn-warning" onclick="upSQ('${d.id}','Review')">Send</button>`;
                        
                        if(isProj) chatBtn = `<button class="btn-sm" style="background:#e83e8c; color:white; margin-left:5px;" onclick="openChat('${d.id}')">üí¨ Chat</button>`;

                        const c=document.createElement("div");
                        c.className=`sq-card status-${q.status} ${isProj?'project':''}`;
                        c.innerHTML=`${isProj?'<span class="badge" style="background:#e83e8c;color:white;font-size:0.7em;padding:2px 5px;border-radius:4px;">Project</span>':''} <b>${q.title}</b><br><small>${q.description||""}</small><div style="margin-top:5px;">${btn}${chatBtn}</div>`;
                        cols[q.status].appendChild(c);
                    }
                })
            })
        }
        async function upSQ(id,s){if(confirm("Move?"))await db.collection("side_quests").doc(id).update({status:s})}

        // --- Chat ---
        let chatUnsub;
        function openChat(id) {
            document.getElementById('chatModal').style.display='block';
            document.getElementById('chat-card-id').value = id;
            const box = document.getElementById('chat-box');
            box.innerHTML = "Loading...";
            if(chatUnsub) chatUnsub();
            chatUnsub = db.collection("side_quests").doc(id).collection("comments").orderBy("timestamp","asc")
                .onSnapshot(snap => {
                    box.innerHTML = "";
                    snap.forEach(d => {
                        const m = d.data();
                        const cls = m.sender==='User' ? 'msg-user' : 'msg-admin';
                        box.innerHTML += `<div class="chat-msg ${cls}"><b>${m.sender}</b>: ${m.msg}</div>`;
                    });
                    box.scrollTop = box.scrollHeight;
                });
        }
        async function sendChat() {
            const txt = document.getElementById('chat-input').value.trim();
            const id = document.getElementById('chat-card-id').value;
            if(!txt) return;
            await db.collection("side_quests").doc(id).collection("comments").add({
                msg: txt, sender: 'User', timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            document.getElementById('chat-input').value = "";
        }
    </script>
</body>
</html>
