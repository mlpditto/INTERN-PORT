<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLP INTERNSHIP</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8f9fa; padding: 20px; color:#333; margin:0; }
        .container { max-width: 600px; margin: 0 auto; }
        
        .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .profile-img { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #06C755; }
        .score-text { color: #06C755; font-weight: bold; font-size: 1.4em; }

        input, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; font-family: inherit; }
        button { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; color: white; background-color: #06C755; transition: 0.2s; }
        button:hover { background-color: #05a546; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* üî• Quest Card (Multiple) */
        .quest-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; margin-bottom: 20px; }
        .quest-timer { font-size: 0.9em; background: rgba(0,0,0,0.25); padding: 5px 12px; border-radius: 20px; display: inline-block; margin-bottom: 10px; }
        .quest-image { width: 100%; max-height: 250px; object-fit: cover; border-radius: 8px; margin-bottom: 10px; border: 2px solid rgba(255,255,255,0.3); }
        .quest-link-btn { display: inline-block; background: rgba(255,255,255,0.2); color: white; padding: 8px 15px; border-radius: 20px; text-decoration: none; margin-bottom: 15px; font-size: 0.9em; border: 1px solid rgba(255,255,255,0.4); }
        
        /* Check-in */
        .checkin-card { border-left: 5px solid #17a2b8; }
        .checkin-checkbox { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; cursor: pointer; background: #f1f8ff; padding: 10px; border-radius: 8px; border: 1px solid #cce5ff; }
        .checkin-checkbox input { width: 20px; height: 20px; margin: 0; cursor: pointer; }

        .feedback-box { background-color: #e7f3ff; border-left: 4px solid #1877f2; padding: 10px; margin-top: 10px; border-radius: 4px; font-size: 0.9em; color: #333; }
        .hidden { display: none !important; }
        .badge { padding: 4px 8px; border-radius: 4px; color: white; font-size: 0.8em; }
        .bg-yellow { background: #ffc107; color: black; } .bg-green { background: #28a745; } .bg-red { background: #dc3545; }
    </style>
</head>
<body>

    <div class="container">
        <div id="loading" style="text-align:center; margin-top:50px;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

        <div id="main-app" class="hidden">
            <div class="card" style="text-align:center;">
                <img id="u-img" class="profile-img" src="">
                <h3 id="u-name" style="margin:10px 0 5px;">User</h3>
                <p>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°: <span id="u-score" class="score-text">0</span> ‡πÅ‡∏ï‡πâ‡∏°</p>
            </div>

            <div id="checkin-container" class="card checkin-card hidden">
                <h3 style="margin-top:0;">üìÖ ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏≠‡πà‡∏≤‡∏ô Daily Quest</h3>
                <div id="checkin-form">
                    <label class="checkin-checkbox">
                        <input type="checkbox" id="chk-checkin" onchange="toggleCheckinBtn()">
                        <span style="font-weight:bold; color:#0056b3;">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</span>
                    </label>
                    <button id="btn-checkin" onclick="submitCheckIn()" disabled style="background:#17a2b8;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏°</button>
                </div>
                <div id="checkin-done" class="hidden" style="text-align:center; padding:10px;">
                    <h2 style="margin:0; font-size:3em;">‚úÖ</h2>
                    <p style="color:#28a745; font-weight:bold;">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡∏±‡∏ö Quest ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
                </div>
            </div>

            <div id="quest-list-container">
                </div>

            <div class="card">
                <h4>üì§ ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô / ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô</h4>
                <input type="text" id="w-title" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠">
                <input type="url" id="w-link" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏á‡∏≤‡∏ô">
                <button onclick="submitWork()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button>
            </div>

            <h4 style="margin-left:5px; color:#666;">üìÇ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</h4>
            <div id="work-list"></div>
            <div style="height:50px;"></div>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        const USER_LIFF_ID = "2008959998-yjcNpaGt"; // ‚ö†Ô∏è ‡πÉ‡∏™‡πà LIFF ID User

        let userProfile, userId;
        let submittedQuestIds = new Set(); // ‡πÄ‡∏Å‡πá‡∏ö ID ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß

        async function main() {
            try {
                await liff.init({ liffId: USER_LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                userProfile = await liff.getProfile();
                userId = userProfile.userId;

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('u-img').src = userProfile.pictureUrl;
                document.getElementById('u-name').innerText = userProfile.displayName;

                checkAndCreateUser();
                loadMyWorks();
                loadQuests(); // ‡πÇ‡∏´‡∏•‡∏î Quest ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
            } catch (err) { alert("LIFF Error: " + err.message); }
        }
        main();

        // --- User Logic ---
        function checkAndCreateUser() {
            const userRef = db.collection("users").doc(userId);
            userRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const d = doc.data();
                    document.getElementById('u-score').innerText = parseFloat((d.score||0).toFixed(2));
                    updateCheckInUI(d.lastCheckIn);
                } else {
                    userRef.set({ displayName: userProfile.displayName, pictureUrl: userProfile.pictureUrl, score: 0 });
                }
            });
        }
        function updateCheckInUI(last) {
            const form = document.getElementById('checkin-form'), done = document.getElementById('checkin-done');
            document.getElementById('checkin-container').classList.remove('hidden');
            if(last && isToday(last.toDate())) { form.classList.add('hidden'); done.classList.remove('hidden'); }
            else { form.classList.remove('hidden'); done.classList.add('hidden'); }
        }
        function isToday(d) { const n = new Date(); return d.getDate()===n.getDate() && d.getMonth()===n.getMonth() && d.getFullYear()===n.getFullYear(); }
        function toggleCheckinBtn() { document.getElementById('btn-checkin').disabled = !document.getElementById('chk-checkin').checked; }
        async function submitCheckIn() {
            const batch = db.batch();
            batch.update(db.collection("users").doc(userId), { score: firebase.firestore.FieldValue.increment(0.1), lastCheckIn: firebase.firestore.FieldValue.serverTimestamp() });
            batch.set(db.collection("checkin_logs").doc(), { userId, displayName: userProfile.displayName, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            await batch.commit(); alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß!");
        }

        // --- üî• New Quest Logic (Multiple & Sorted) ---
        function loadQuests() {
            // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á User ‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏≠‡∏Å)
            db.collection("quest_submissions").where("userId", "==", userId).onSnapshot(snap => {
                submittedQuestIds.clear();
                snap.forEach(doc => submittedQuestIds.add(doc.data().questId));
                
                // 2. ‡πÇ‡∏´‡∏•‡∏î Quest ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡πà‡∏≤ -> ‡πÉ‡∏´‡∏°‡πà
                db.collection("quests").orderBy("createdAt", "asc").onSnapshot(renderQuests);
            });
        }

        function renderQuests(snapshot) {
            const container = document.getElementById('quest-list-container');
            container.innerHTML = ""; // Clear
            
            const now = new Date();

            snapshot.forEach(doc => {
                const q = doc.data();
                const qId = doc.id;

                // ‡∏Å‡∏£‡∏≠‡∏á 1: ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?
                if (!q.deadline || now > q.deadline.toDate()) return;

                // ‡∏Å‡∏£‡∏≠‡∏á 2: ‡∏ó‡∏≥‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?
                if (submittedQuestIds.has(qId)) return;

                // ‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (Render Card)
                const deadlineDate = q.deadline.toDate();
                const diff = deadlineDate - now;
                const h = Math.floor(diff / (1000 * 60 * 60));
                const m = Math.floor((diff / (1000 * 60)) % 60);
                const timeLeftText = `${h} ‡∏ä‡∏°. ${m} ‡∏ô‡∏≤‡∏ó‡∏µ`;

                // HTML Structure
                const imgHtml = q.imageUrl ? `<img src="${q.imageUrl}" class="quest-image">` : "";
                const linkHtml = q.questLink ? `<a href="${q.questLink}" target="_blank" class="quest-link-btn">üîó ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</a>` : "";

                const card = document.createElement('div');
                card.className = "card quest-card";
                card.innerHTML = `
                    <div class="quest-timer">‚è∞ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤: ${timeLeftText}</div>
                    ${imgHtml}
                    <h3 style="margin:5px 0;">‚ö° ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</h3>
                    <p style="font-size:1.1em; margin-bottom:15px; line-height:1.4;">${q.question}</p>
                    ${linkHtml}
                    <div id="area-${qId}">
                        <textarea id="ans-${qId}" rows="2" placeholder="‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö..." style="color:black;"></textarea>
                        <button onclick="submitQuest('${qId}', ${q.baseScore})" style="background:#ffc107; color:black;">üöÄ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (+${q.baseScore})</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function submitQuest(qId, baseScore) {
            const ans = document.getElementById(`ans-${qId}`).value.trim();
            if (!ans) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö");
            
            try {
                const batch = db.batch();
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
                batch.set(db.collection("quest_submissions").doc(), { 
                    questId: qId, 
                    userId, 
                    displayName: userProfile.displayName, 
                    answer: ans, 
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(), 
                    isLate: false, 
                    earnedScore: baseScore, 
                    bonusGiven: 0 
                });
                // ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
                batch.update(db.collection("users").doc(userId), { score: firebase.firestore.FieldValue.increment(baseScore) });
                
                await batch.commit();
                alert(`‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! (+${baseScore} ‡πÅ‡∏ï‡πâ‡∏°)`);
                // UI ‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Card ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ï‡∏¥‡∏î filter)
            } catch(e) {
                alert("Error: " + e.message);
            }
        }

        // --- Works ---
        async function submitWork() {
            const t=document.getElementById('w-title').value.trim(), l=document.getElementById('w-link').value.trim();
            if(!t||!l) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
            await db.collection("works").add({ userId, displayName: userProfile.displayName, pictureUrl: userProfile.pictureUrl, title: t, link: l, status: "‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à", feedback: "", timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            alert("‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!"); document.getElementById('w-title').value=""; document.getElementById('w-link').value="";
        }
        function loadMyWorks() {
            db.collection("works").where("userId", "==", userId).orderBy("timestamp", "desc").onSnapshot((snap) => {
                const list = document.getElementById('work-list'); list.innerHTML = "";
                if (snap.empty) { list.innerHTML = "<p style='text-align:center; color:#999;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>"; return; }
                snap.forEach(doc => {
                    const w = doc.data();
                    let fb = w.feedback ? `<div class="feedback-box"><b>üí¨ Admin:</b> ${w.feedback}</div>` : "";
                    let badge = w.status==="‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß"?"bg-green":w.status==="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"?"bg-red":"bg-yellow";
                    list.innerHTML += `<div class="card" style="padding:15px; border-left:5px solid ${w.status==='‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß'?'#28a745':'#ffc107'}"><div style="display:flex; justify-content:space-between;"><div><h4 style="margin:0;">${w.title}</h4><span class="badge ${badge}">${w.status}</span></div><a href="${w.link}" target="_blank" style="font-size:1.5em; text-decoration:none;">üîó</a></div>${fb}</div>`;
                });
            });
        }
    </script>
</body>
</html>
