<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLP INTERNSHIP</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        /* ... (CSS ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) ... */
        body { font-family: 'Kanit', sans-serif; background-color: #f8f9fa; padding: 20px; color:#333; margin:0; }
        .container { max-width: 600px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .profile-img { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #06C755; }
        .score-text { color: #06C755; font-weight: bold; font-size: 1.4em; }
        input, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; font-family: inherit; }
        button { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; color: white; background-color: #06C755; transition: 0.2s; min-height: 44px; }
        button:hover { background-color: #05a546; } button:disabled { background-color: #ccc; }
        
        /* CSS ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á Quest/SideQuest */
        .quest-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; margin-bottom: 20px; }
        .sq-container { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 20px; scroll-snap-type: x mandatory; }
        .sq-col { min-width: 85%; background: #f1f3f5; border-radius: 12px; padding: 15px; scroll-snap-align: center; }
        .sq-card { background: white; padding: 15px; border-radius: 8px; border-left: 5px solid #4361ee; margin-bottom: 10px; }
        .checkin-card { border-left: 5px solid #17a2b8; }
        .hidden { display: none !important; }
        .badge { padding: 4px 8px; border-radius: 4px; color: white; font-size: 0.8em; }

        /* üî• Styles ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á Report */
        .report-card { border-left: 5px solid #ef233c; }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" style="text-align:center; margin-top:50px;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        
        <div id="main-app" class="hidden">
            <div class="card" style="text-align:center;">
                <img id="u-img" class="profile-img" src="">
                <h3 id="u-name" style="margin:10px 0 5px;">User</h3>
                <p>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°: <span id="u-score" class="score-text">0</span> ‡πÅ‡∏ï‡πâ‡∏°</p>
            </div>
            
            <div id="checkin-container" class="card checkin-card hidden">
                <h3>üìÖ ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏≠‡πà‡∏≤‡∏ô Daily Quest</h3>
                <div id="checkin-form">
                    <label style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                        <input type="checkbox" id="chk-checkin" onchange="toggleCheckinBtn()" style="width:20px;height:20px;"> 
                        ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö
                    </label>
                    <button id="btn-checkin" onclick="submitCheckIn()" disabled style="background:#17a2b8;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏°</button>
                </div>
                <div id="checkin-done" class="hidden" style="text-align:center;"><h2 style="margin:0;">‚úÖ</h2><p>‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡∏±‡∏ö Quest ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p></div>
            </div>

            <h3 style="margin-left:5px; color:#4361ee;">üó∫Ô∏è ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à (Side Quest)</h3>
            <div class="sq-container" id="sq-scroll">
                <div class="sq-col" id="col-Backlog"><div id="sq-Backlog"></div></div>
                <div class="sq-col" id="col-Doing"><div id="sq-Doing"></div></div>
                <div class="sq-col" id="col-Review"><div id="sq-Review"></div></div>
                <div class="sq-col" id="col-Done"><div id="sq-Done"></div></div>
            </div>

            <div id="quest-list-container"></div>
            
            <div class="card">
                <h4>üì§ ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô / ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô</h4>
                <input type="text" id="w-title" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠">
                <input type="url" id="w-link" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏á‡∏≤‡∏ô">
                <button onclick="submitWork()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button>
            </div>

            <h4 style="margin-left:5px; color:#666;">üìÇ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</h4>
            <div id="work-list"></div>

            <div class="card report-card">
                <h4>üö© ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤ / ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Admin</h4>
                <p style="font-size:0.9em; color:#666;">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏≤ Admin ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
                <input type="text" id="rpt-subject" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏≤‡∏Å‡∏¥‡∏à, ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ú‡∏¥‡∏î)">
                <textarea id="rpt-msg" rows="3" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..."></textarea>
                <button onclick="sendReport()" style="background:#ef233c;">üìß ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
            </div>

            <div style="height:50px;"></div>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        const USER_LIFF_ID = "2008959998-yjcNpaGt"; // ‚ö†Ô∏è ‡πÉ‡∏™‡πà ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        let userProfile, userId, submittedQuestIds = new Set();
        
        async function main() {
            try { 
                await liff.init({ liffId: USER_LIFF_ID }); 
                if (!liff.isLoggedIn()) { liff.login(); return; }
                userProfile = await liff.getProfile(); 
                userId = userProfile.userId;
                
                document.getElementById('loading').classList.add('hidden'); 
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('u-img').src = userProfile.pictureUrl; 
                document.getElementById('u-name').innerText = userProfile.displayName;
                
                checkUser(); loadMyWorks(); loadQuests(); loadSideQuests();
            } catch (e) { alert("LIFF Error: "+e.message); }
        } main();

        // üî• Report Function
        async function sendReport() {
            const subject = document.getElementById('rpt-subject').value.trim();
            const msg = document.getElementById('rpt-msg').value.trim();
            const adminEmail = "medlifeplus@gmail.com";

            if(!subject || !msg) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏£‡∏±‡∏ö");

            try {
                // 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firestore (‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß)
                await db.collection("reports").add({
                    userId: userId,
                    displayName: userProfile.displayName,
                    subject: subject,
                    message: msg,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: "New"
                });

                // 2. ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡πà‡∏á Email (mailto)
                const body = `‡πÄ‡∏£‡∏µ‡∏¢‡∏ô Admin,\n\n${msg}\n\n----------------\n‡∏à‡∏≤‡∏Å: ${userProfile.displayName}\nID: ${userId}`;
                const mailtoLink = `mailto:${adminEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                
                window.location.href = mailtoLink;

                // 3. Clear Form
                document.getElementById('rpt-subject').value = "";
                document.getElementById('rpt-msg').value = "";

            } catch(e) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: " + e.message);
                // ‡∏ñ‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏Å‡πá‡∏¢‡∏±‡∏á‡πÄ‡∏î‡πâ‡∏á‡πÄ‡∏°‡∏•‡πÉ‡∏´‡πâ user ‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏î‡∏µ
                const body = `‡πÄ‡∏£‡∏µ‡∏¢‡∏ô Admin,\n\n${msg}\n\n----------------\n‡∏à‡∏≤‡∏Å: ${userProfile.displayName}`;
                window.location.href = `mailto:${adminEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            }
        }

        // --- Functions ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á Logic) ---
        function checkUser() { const r=db.collection("users").doc(userId); r.onSnapshot(d=>{ if(d.exists){ const data=d.data(); document.getElementById('u-score').innerText=parseFloat((data.score||0).toFixed(2)); updateCheckIn(data.lastCheckIn); } else r.set({displayName:userProfile.displayName, pictureUrl:userProfile.pictureUrl, score:0}) }) }
        function updateCheckIn(l){ const f=document.getElementById('checkin-form'),d=document.getElementById('checkin-done'); document.getElementById('checkin-container').classList.remove('hidden'); if(l&&isToday(l.toDate())){f.classList.add('hidden');d.classList.remove('hidden')}else{f.classList.remove('hidden');d.classList.add('hidden')} }
        function isToday(d){const n=new Date();return d.getDate()===n.getDate()&&d.getMonth()===n.getMonth()&&d.getFullYear()===n.getFullYear()}
        function toggleCheckinBtn(){document.getElementById('btn-checkin').disabled=!document.getElementById('chk-checkin').checked}
        async function submitCheckIn(){ try{const r=db.collection("users").doc(userId);const doc=await r.get();if(!doc.exists)return;const d=doc.data();let s=d.currentStreak||0;let b=0;if(d.lastCheckIn){const l=d.lastCheckIn.toDate();const y=new Date();y.setDate(new Date().getDate()-1);if(l.getDate()===y.getDate())s++;else s=1}else s=1;if(s>0&&s%5===0)b=0.1;const batch=db.batch();batch.update(r,{score:firebase.firestore.FieldValue.increment(0.1+b),lastCheckIn:firebase.firestore.FieldValue.serverTimestamp(),currentStreak:s});batch.set(db.collection("checkin_logs").doc(),{userId,displayName:userProfile.displayName,timestamp:firebase.firestore.FieldValue.serverTimestamp(),isStreakBonus:b>0});await batch.commit();alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß!")}catch(e){alert(e.message)}}

        // Side Quest Load
        function loadSideQuests(){ db.collection("side_quests").where("assigneeIds","array-contains",userId).onSnapshot(s=>{ const cols={"Backlog":document.getElementById("sq-Backlog"),"Doing":document.getElementById("sq-Doing"),"Review":document.getElementById("sq-Review"),"Done":document.getElementById("sq-Done")}; Object.values(cols).forEach(c=>c.innerHTML=""); s.forEach(d=>{ const q=d.data(); if(cols[q.status]){ let as=""; if(q.assignees)q.assignees.forEach(u=>as+=`<img src="${u.pic}" style="width:20px;height:20px;border-radius:50%;">`); let btn=""; if(q.status==="Backlog")btn=`<button class="badge" onclick="upSQ('${d.id}','Doing')" style="background:#007bff;border:none;">‡πÄ‡∏£‡∏¥‡πà‡∏° ‚ñ∂Ô∏è</button>`; else if(q.status==="Doing")btn=`<button class="badge" onclick="upSQ('${d.id}','Review')" style="background:#ffc107;color:black;border:none;">‡∏™‡πà‡∏á ‚ñ∂Ô∏è</button>`; const c=document.createElement("div"); c.className="sq-card"; c.innerHTML=`<b>${q.title}</b><br><small>${q.description}</small><div style="margin-top:5px;display:flex;justify-content:space-between;"><div>${as}</div>${btn}</div>`; cols[q.status].appendChild(c); } }) }) }
        async function upSQ(id,s){if(confirm("‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞?"))await db.collection("side_quests").doc(id).update({status:s})}

        // Quest & Works
        function loadQuests(){ db.collection("quest_submissions").where("userId","==",userId).onSnapshot(s=>{ submittedQuestIds.clear(); s.forEach(d=>submittedQuestIds.add(d.data().questId)); db.collection("quests").orderBy("createdAt","asc").onSnapshot(renderQuests) }) }
        function renderQuests(s){ const c=document.getElementById('quest-list-container');c.innerHTML="";const now=new Date(); s.forEach(d=>{ const q=d.data(); if(!q.deadline||now>q.deadline.toDate()||submittedQuestIds.has(d.id))return; const h=Math.ceil((q.deadline.toDate()-now)/36e5); const img=q.imageUrl?`<img src="${q.imageUrl}" style="width:100%;border-radius:8px;">`:""; c.innerHTML+=`<div class="card quest-card">‚è∞ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${h} ‡∏ä‡∏°.<br>${img}<h3>${q.question}</h3><textarea id="ans-${d.id}"></textarea><button onclick="subQ('${d.id}',${q.baseScore})">‡∏™‡πà‡∏á</button></div>` }) }
        async function subQ(qid,s){ const a=document.getElementById(`ans-${qid}`).value.trim(); if(!a)return; const b=db.batch(); b.set(db.collection("quest_submissions").doc(),{questId:qid,userId,displayName:userProfile.displayName,pictureUrl:userProfile.pictureUrl,answer:a,timestamp:firebase.firestore.FieldValue.serverTimestamp(),isLate:false,earnedScore:s,bonusGiven:0}); b.update(db.collection("users").doc(userId),{score:firebase.firestore.FieldValue.increment(s)}); await b.commit(); alert("‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß"); }
        async function submitWork(){ const t=document.getElementById('w-title').value, l=document.getElementById('w-link').value; if(!t||!l)return; await db.collection("works").add({userId,displayName:userProfile.displayName,pictureUrl:userProfile.pictureUrl,title:t,link:l,status:"‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à",score:0,timestamp:firebase.firestore.FieldValue.serverTimestamp()}); alert("‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß"); document.getElementById('w-title').value=""; }
        function loadMyWorks(){ db.collection("works").where("userId","==",userId).orderBy("timestamp","desc").onSnapshot(s=>{ const l=document.getElementById('work-list'); l.innerHTML=""; s.forEach(d=>{ const w=d.data(); let sc=w.score>0?`<span class="badge" style="background:#17a2b8">+${w.score}</span>`:""; l.innerHTML+=`<div class="card" style="padding:15px;border-left:5px solid ${w.status==='‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß'?'#28a745':'#ffc107'}"><b>${w.title}</b> ${sc}<br><small>${w.status}</small></div>` }) }) }
    </script>
</body>
</html>
