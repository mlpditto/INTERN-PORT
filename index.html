<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLP INTERNSHIP</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8f9fa; padding: 20px; color:#333; margin:0; }
        .container { max-width: 600px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .profile-img { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #06C755; }
        .score-text { color: #06C755; font-weight: bold; font-size: 1.4em; }
        
        input, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; font-family: inherit; }
        button { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; color: white; background-color: #06C755; transition: 0.2s; min-height: 44px; /* Touch friendly */ }
        button:hover { background-color: #05a546; } button:disabled { background-color: #ccc; }

        /* üî• Updated Side Quest UI */
        .sq-container { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 20px; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; }
        .sq-col { min-width: 85%; background: #f1f3f5; border-radius: 12px; padding: 15px; scroll-snap-align: center; display: flex; flex-direction: column; }
        .sq-header { font-weight: bold; margin-bottom: 10px; border-bottom: 2px solid #ddd; padding-bottom: 5px; display:flex; justify-content:space-between; }
        
        .sq-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 10px; border-left: 5px solid #4361ee; position:relative; }
        .sq-assignee img { width: 25px; height: 25px; border-radius: 50%; margin-right: -8px; border: 2px solid white; }
        
        .empty-state { text-align: center; padding: 20px; color: #888; }
        .empty-state img { width: 60px; opacity: 0.5; margin-bottom: 10px; }

        .priority-badge { font-size: 0.7em; padding: 2px 6px; border-radius: 4px; color: white; display: inline-block; margin-bottom: 5px; }
        .p-High { background: #ef233c; } .p-Medium { background: #ff9f1c; } .p-Low { background: #2ec4b6; }
        
        /* Pagination Dots */
        .dots-container { text-align: center; margin-top: -15px; margin-bottom: 20px; }
        .dot { height: 8px; width: 8px; background-color: #bbb; border-radius: 50%; display: inline-block; margin: 0 4px; }
        .dot.active { background-color: #4361ee; }

        /* Other styles as previous */
        .hidden { display: none !important; }
        .badge { padding: 4px 8px; border-radius: 4px; color: white; font-size: 0.8em; }
        .checkin-card { border-left: 5px solid #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" style="text-align:center; margin-top:50px;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        <div id="main-app" class="hidden">
            <div class="card" style="text-align:center;">
                <img id="u-img" class="profile-img" src="" loading="lazy">
                <h3 id="u-name" style="margin:10px 0 5px;">User</h3>
                <p>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°: <span id="u-score" class="score-text">0</span> ‡πÅ‡∏ï‡πâ‡∏°</p>
            </div>
            
            <div id="checkin-container" class="card checkin-card hidden">
                <h3>üìÖ ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏≠‡πà‡∏≤‡∏ô Daily Quest</h3>
                <button id="btn-checkin" onclick="submitCheckIn()">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</button>
            </div>

            <h3 style="margin-left:5px; color:#4361ee;">üó∫Ô∏è ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à (Side Quest)</h3>
            <div class="sq-container" id="sq-scroll">
                <div class="sq-col" id="col-Backlog">
                    <div class="sq-header">üìå Backlog <span class="badge" style="background:#6c757d" id="sq-c-backlog">0</span></div>
                    <div id="sq-Backlog"></div>
                </div>
                <div class="sq-col" id="col-Doing">
                    <div class="sq-header">üöß Doing <span class="badge" style="background:#007bff" id="sq-c-doing">0</span></div>
                    <div id="sq-Doing"></div>
                </div>
                <div class="sq-col" id="col-Review">
                    <div class="sq-header">üëÄ Review <span class="badge" style="background:#ffc107; color:black;" id="sq-c-review">0</span></div>
                    <div id="sq-Review"></div>
                </div>
                <div class="sq-col" id="col-Done">
                    <div class="sq-header">‚úÖ Done <span class="badge" style="background:#28a745" id="sq-c-done">0</span></div>
                    <div id="sq-Done"></div>
                </div>
            </div>
            <div class="dots-container">
                <span class="dot active"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span>
            </div>
            
            <div id="quest-list-container"></div>
            </div>
    </div>
    <script src="firebase-config.js"></script>
    <script>
        const USER_LIFF_ID = "XXXXXXXX-XXXXXXXX";
        let userProfile, userId;
        
        async function main() {
            try { await liff.init({ liffId: USER_LIFF_ID }); if (!liff.isLoggedIn()) { liff.login(); return; }
                userProfile = await liff.getProfile(); userId = userProfile.userId;
                document.getElementById('loading').classList.add('hidden'); document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('u-img').src = userProfile.pictureUrl; document.getElementById('u-name').innerText = userProfile.displayName;
                checkUser(); loadSideQuests();
            } catch (e) { alert("LIFF Error: "+e.message); }
        } main();

        // Scroll Snap Logic
        const container = document.getElementById('sq-scroll');
        const dots = document.querySelectorAll('.dot');
        container.addEventListener('scroll', () => {
            const index = Math.round(container.scrollLeft / container.offsetWidth);
            dots.forEach(d => d.classList.remove('active'));
            if(dots[index]) dots[index].classList.add('active');
        });

        // Load Side Quests
        function loadSideQuests() {
            db.collection("side_quests").where("assigneeIds", "array-contains", userId).onSnapshot(snap => {
                const cols = { "Backlog": document.getElementById("sq-Backlog"), "Doing": document.getElementById("sq-Doing"), "Review": document.getElementById("sq-Review"), "Done": document.getElementById("sq-Done") };
                Object.values(cols).forEach(c => c.innerHTML = "");
                const counts = { "Backlog": 0, "Doing": 0, "Review": 0, "Done": 0 };

                snap.forEach(doc => {
                    const q = doc.data();
                    counts[q.status]++;
                    
                    let assigneesHtml = '<div class="sq-assignee" style="margin-top:5px;">';
                    if(q.assignees) q.assignees.forEach(u => assigneesHtml += `<img src="${u.pic}">`);
                    assigneesHtml += '</div>';

                    // Actions
                    let btns = "";
                    if(q.status === "Backlog") btns = `<button class="badge" style="border:none; background:#007bff; cursor:pointer;" onclick="upSQ('${doc.id}','Doing')">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥ ‚ñ∂Ô∏è</button>`;
                    else if(q.status === "Doing") {
                        btns = `<button class="badge" style="border:none; background:#17a2b8; cursor:pointer; margin-right:5px;" onclick="uploadProof('${doc.id}')">üìé ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button>
                                <button class="badge" style="border:none; background:#ffc107; color:black; cursor:pointer;" onclick="upSQ('${doc.id}','Review')">‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à ‚ñ∂Ô∏è</button>`;
                    }

                    const priorityBadge = q.priority ? `<span class="priority-badge p-${q.priority}">${q.priority}</span>` : '';

                    const card = document.createElement("div");
                    card.className = "sq-card";
                    card.innerHTML = `${priorityBadge} <b>${q.title}</b><p style="font-size:0.9em; margin:5px 0; color:#666;">${q.description}</p>${assigneesHtml}<div style="text-align:right; margin-top:10px;">${btns}</div>`;
                    
                    if(cols[q.status]) cols[q.status].appendChild(card);
                });
                
                // Empty States
                Object.keys(cols).forEach(k => {
                    document.getElementById(`sq-c-${k.toLowerCase()}`).innerText = counts[k];
                    if(counts[k] === 0) cols[k].innerHTML = `<div class="empty-state">üò¥ ‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏±‡∏á...</div>`;
                });
                
                // Auto Scroll to Doing
                if(counts["Doing"] > 0) {
                     // Simple logic to scroll to 2nd column
                     // container.scrollLeft = container.offsetWidth; 
                }
            });
        }
        
        async function upSQ(id, st) { if(confirm("‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞?")) await db.collection("side_quests").doc(id).update({status:st}); }
        async function uploadProof(id) { 
            const link = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ú‡∏•‡∏á‡∏≤‡∏ô (Google Drive / Canva):");
            if(link) {
                await db.collection("side_quests").doc(id).update({ proofLink: link });
                alert("‡πÅ‡∏ô‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏Å‡∏î‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏∞");
            }
        }
        
        // Functions ‡πÄ‡∏î‡∏¥‡∏° (Checkin, Quest) ‡πÉ‡∏´‡πâ‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô V12 ‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏≥‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢
        function checkUser() { const r=db.collection("users").doc(userId); r.onSnapshot(d=>{ if(d.exists){ const data=d.data(); document.getElementById('u-score').innerText=parseFloat((data.score||0).toFixed(2)); } else r.set({displayName:userProfile.displayName, pictureUrl:userProfile.pictureUrl, score:0}) }) }
        function submitCheckIn(){ /* Logic V12 */ alert("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏°"); }
    </script>
</body>
</html>
