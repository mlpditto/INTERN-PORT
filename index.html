<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLP INTERNSHIP PROGRAM</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8f9fa; padding: 20px; color:#333; margin:0; }
        .container { max-width: 600px; margin: 0 auto; }
        
        /* Cards */
        .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        /* Profile */
        .profile-section { text-align: center; }
        .profile-img { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #06C755; }
        .score-text { color: #06C755; font-weight: bold; font-size: 1.4em; }

        /* Forms */
        input, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; font-family: inherit; }
        button { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; color: white; background-color: #06C755; transition: 0.2s; }
        button:hover { background-color: #05a546; }

        /* üî• Quest Card Styles */
        .quest-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; }
        .quest-timer { font-size: 0.9em; background: rgba(0,0,0,0.25); padding: 5px 12px; border-radius: 20px; display: inline-block; margin-bottom: 10px; }
        .quest-points { background: #ffc107; color: black; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }
        
        /* üí¨ Feedback Box */
        .feedback-box { background-color: #e7f3ff; border-left: 4px solid #1877f2; padding: 10px; margin-top: 10px; border-radius: 4px; font-size: 0.9em; color: #333; }

        /* Utility */
        .hidden { display: none !important; }
        .badge { padding: 4px 8px; border-radius: 4px; color: white; font-size: 0.8em; }
        .bg-yellow { background: #ffc107; color: black; }
        .bg-green { background: #28a745; }
        .bg-red { background: #dc3545; }
    </script>
    </style>
</head>
<body>

    <div class="container">
        <div id="loading" style="text-align:center; margin-top:50px;">
            <p>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>

        <div id="main-app" class="hidden">
            
            <div class="card profile-section">
                <img id="u-img" class="profile-img" src="">
                <h3 id="u-name" style="margin:10px 0 5px;">User</h3>
                <p>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°: <span id="u-score" class="score-text">0</span> ‡πÅ‡∏ï‡πâ‡∏°</p>
            </div>

            <div id="quest-container" class="card quest-card hidden">
                <div class="quest-timer">‚è∞ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤: <span id="q-countdown">--:--</span></div>
                <h3 style="margin:5px 0;">‚ö° ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                <p id="q-text" style="font-size:1.1em; margin-bottom:15px; line-height:1.4;">...</p>
                
                <div id="q-input-area">
                    <textarea id="q-answer" rows="3" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." style="color:black;"></textarea>
                    <button onclick="submitQuest()" style="background:#ffc107; color:black;">
                        üöÄ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (‡∏£‡∏±‡∏ö <span id="q-points">0</span> ‡πÅ‡∏ï‡πâ‡∏°)
                    </button>
                </div>

                <div id="q-status" class="hidden" style="background:rgba(255,255,255,0.2); padding:15px; border-radius:8px; margin-top:10px;">
                    ‚úÖ <b>‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß!</b><br>
                    <small>‡∏£‡∏≠ Admin ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏û‡∏¥‡πà‡∏°</small>
                </div>
            </div>

            <div class="card">
                <h4>üì§ ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô / ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô</h4>
                <input type="text" id="w-title" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô EP.1 ‡∏™‡∏£‡∏∏‡∏õ...)">
                <input type="url" id="w-link" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏á‡∏≤‡∏ô (Google Drive / Canva)">
                <button onclick="submitWork()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button>
            </div>

            <h4 style="margin-left:5px; color:#666;">üìÇ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</h4>
            <div id="work-list">
                </div>
            
            <div style="height:50px;"></div> </div>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        // --- üîí CONFIG ---
        const USER_LIFF_ID = "2008959998-yjcNpaGt"; // ‚ö†Ô∏è ‡πÉ‡∏™‡πà LIFF ID (User) ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏£‡∏∞‡∏ö‡∏ö
        let userProfile, userId;
        let currentQuestId = null, currentQuestDeadline = null, baseScore = 0;
        let timerInterval = null;

        // --- 1. Main Init ---
        async function main() {
            try {
                await liff.init({ liffId: USER_LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                userProfile = await liff.getProfile();
                userId = userProfile.userId;

                // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('u-img').src = userProfile.pictureUrl;
                document.getElementById('u-name').innerText = userProfile.displayName;

                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
                checkAndCreateUser();
                loadMyWorks();
                loadActiveQuest(); // ‡πÇ‡∏´‡∏•‡∏î Quest

            } catch (err) {
                alert("LIFF Error: " + err.message);
                console.error(err);
            }
        }
        main(); // Run

        // --- 2. User & Score Logic ---
        function checkAndCreateUser() {
            const userRef = db.collection("users").doc(userId);
            userRef.onSnapshot((doc) => {
                if (doc.exists) {
                    document.getElementById('u-score').innerText = doc.data().score || 0;
                } else {
                    userRef.set({
                        displayName: userProfile.displayName,
                        pictureUrl: userProfile.pictureUrl,
                        score: 0,
                        joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            });
        }

        // --- 3. üî• Quest Logic (Robust Version) ---
        function loadActiveQuest() {
            // ‡∏î‡∏∂‡∏á Quest ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á)
            db.collection("quests")
              .orderBy("createdAt", "desc")
              .limit(1)
              .onSnapshot((snapshot) => {
                if(snapshot.empty) {
                    // ‡πÑ‡∏°‡πà‡∏°‡∏µ Quest ‡πÄ‡∏•‡∏¢ -> ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á
                    document.getElementById('quest-container').classList.add('hidden');
                    return;
                }

                const qData = snapshot.docs[0].data();
                const qId = snapshot.docs[0].id;

                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ deadline ‡πÑ‡∏´‡∏°
                if (!qData.deadline) return;

                const deadlineDate = qData.deadline.toDate();
                const now = new Date();

                // ‡∏ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß -> ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á
                if (now > deadlineDate) {
                    document.getElementById('quest-container').classList.add('hidden');
                    return;
                }

                // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤ -> ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á
                currentQuestId = qId;
                currentQuestDeadline = deadlineDate;
                baseScore = qData.baseScore || 0;

                document.getElementById('quest-container').classList.remove('hidden');
                document.getElementById('q-text').innerText = qData.question;
                document.getElementById('q-points').innerText = baseScore;

                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
                if(timerInterval) clearInterval(timerInterval);
                startTimer();

                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ User ‡πÄ‡∏Ñ‡∏¢‡∏ï‡∏≠‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?
                checkIfAnswered();
            }, (error) => {
                console.error("Quest Error:", error);
            });
        }

        function checkIfAnswered() {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏ô collection ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö ‡∏ß‡πà‡∏≤‡∏°‡∏µ userId ‡πÄ‡∏£‡∏≤ + questId ‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏°
            db.collection("quest_submissions")
                .where("questId", "==", currentQuestId)
                .where("userId", "==", userId)
                .limit(1)
                .onSnapshot((snap) => {
                    if (!snap.empty) {
                        // ‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß -> ‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° ‡πÇ‡∏ä‡∏ß‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                        document.getElementById('q-input-area').classList.add('hidden');
                        document.getElementById('q-status').classList.remove('hidden');
                    } else {
                        // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö -> ‡πÇ‡∏ä‡∏ß‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°
                        document.getElementById('q-input-area').classList.remove('hidden');
                        document.getElementById('q-status').classList.add('hidden');
                    }
                });
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                const now = new Date();
                const diff = currentQuestDeadline - now;

                if (diff <= 0) {
                    document.getElementById('q-countdown').innerText = "‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤";
                    document.getElementById('q-input-area').classList.add('hidden');
                    clearInterval(timerInterval);
                    return;
                }

                const hrs = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const secs = Math.floor((diff % (1000 * 60)) / 1000);
                
                document.getElementById('q-countdown').innerText = 
                    `${hrs}:${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
            }, 1000);
        }

        async function submitQuest() {
            const answer = document.getElementById('q-answer').value.trim();
            if (!answer) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö"); return; }

            if (!currentQuestId) return;

            const now = new Date();
            const isLate = now > currentQuestDeadline;
            const earned = isLate ? 0 : baseScore;

            try {
                const batch = db.batch();
                
                // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
                const subRef = db.collection("quest_submissions").doc();
                batch.set(subRef, {
                    questId: currentQuestId,
                    userId: userId,
                    displayName: userProfile.displayName,
                    answer: answer,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    isLate: isLate,
                    earnedScore: earned,
                    bonusGiven: 0
                });

                // 2. ‡∏ñ‡πâ‡∏≤‡∏ó‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏•‡∏¢
                if (earned > 0) {
                    const userRef = db.collection("users").doc(userId);
                    batch.update(userRef, { score: firebase.firestore.FieldValue.increment(earned) });
                }

                await batch.commit();
                alert(`‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ${earned > 0 ? '(+'+earned+' ‡πÅ‡∏ï‡πâ‡∏°)' : ''}`);
                
            } catch (e) {
                alert("Error: " + e.message);
            }
        }

        // --- 4. Work Submission Logic ---
        async function submitWork() {
            const title = document.getElementById('w-title').value.trim();
            const link = document.getElementById('w-link').value.trim();

            if (!title || !link) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô"); return; }

            try {
                await db.collection("works").add({
                    userId: userId,
                    displayName: userProfile.displayName,
                    pictureUrl: userProfile.pictureUrl,
                    title: title,
                    link: link,
                    status: "‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à",
                    feedback: "",
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert("‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö! üéâ");
                document.getElementById('w-title').value = "";
                document.getElementById('w-link').value = "";
            } catch (e) {
                alert("Error: " + e.message);
            }
        }

        // --- 5. Work History & Feedback Display ---
        function loadMyWorks() {
            db.collection("works")
              .where("userId", "==", userId)
              .orderBy("timestamp", "desc")
              .onSnapshot((snapshot) => {
                const list = document.getElementById('work-list');
                list.innerHTML = "";

                if (snapshot.empty) {
                    list.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</p>";
                    return;
                }

                snapshot.forEach(doc => {
                    const w = doc.data();
                    
                    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                    let badgeClass = "bg-yellow";
                    if (w.status === "‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß") badgeClass = "bg-green";
                    if (w.status === "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç") badgeClass = "bg-red";

                    // ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á Feedback (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                    let feedbackHtml = "";
                    if (w.feedback && w.feedback.trim() !== "") {
                        feedbackHtml = `
                            <div class="feedback-box">
                                <b>üí¨ Admin ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå:</b><br>
                                ${w.feedback}
                            </div>
                        `;
                    }
                    
                    const dateStr = w.timestamp ? w.timestamp.toDate().toLocaleString('th-TH') : "";

                    list.innerHTML += `
                        <div class="card" style="padding:15px; border-left: 5px solid ${w.status === '‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß' ? '#28a745' : '#ffc107'};">
                            <div style="display:flex; justify-content:space-between; align-items:start;">
                                <div>
                                    <h4 style="margin:0 0 5px 0;">${w.title}</h4>
                                    <span class="badge ${badgeClass}">${w.status}</span>
                                    <span style="font-size:0.8em; color:#999; margin-left:5px;">${dateStr}</span>
                                </div>
                                <a href="${w.link}" target="_blank" style="text-decoration:none; font-size:1.5em;">üîó</a>
                            </div>
                            
                            ${feedbackHtml}
                        </div>
                    `;
                });
            });
        }
    </script>
</body>
</html>
