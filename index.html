<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLP INTERNSHIP</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8f9fa; padding: 20px; color:#333; margin:0; }
        .container { max-width: 600px; margin: 0 auto; }
        
        .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .profile-img { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #06C755; }
        .score-text { color: #06C755; font-weight: bold; font-size: 1.4em; }

        input, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; font-family: inherit; }
        button { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; color: white; background-color: #06C755; transition: 0.2s; }
        button:hover { background-color: #05a546; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* üî• Quest Card (Enhanced) */
        .quest-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; }
        .quest-timer { font-size: 0.9em; background: rgba(0,0,0,0.25); padding: 5px 12px; border-radius: 20px; display: inline-block; margin-bottom: 10px; }
        .quest-image { width: 100%; max-height: 250px; object-fit: cover; border-radius: 8px; margin-bottom: 10px; border: 2px solid rgba(255,255,255,0.3); }
        .quest-link-btn { display: inline-block; background: rgba(255,255,255,0.2); color: white; padding: 8px 15px; border-radius: 20px; text-decoration: none; margin-bottom: 15px; font-size: 0.9em; border: 1px solid rgba(255,255,255,0.4); }
        .quest-link-btn:hover { background: rgba(255,255,255,0.4); }

        /* Check-in */
        .checkin-card { border-left: 5px solid #17a2b8; }
        .checkin-checkbox { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; cursor: pointer; background: #f1f8ff; padding: 10px; border-radius: 8px; border: 1px solid #cce5ff; }
        .checkin-checkbox input { width: 20px; height: 20px; margin: 0; cursor: pointer; }

        .feedback-box { background-color: #e7f3ff; border-left: 4px solid #1877f2; padding: 10px; margin-top: 10px; border-radius: 4px; font-size: 0.9em; color: #333; }
        .hidden { display: none !important; }
        .badge { padding: 4px 8px; border-radius: 4px; color: white; font-size: 0.8em; }
        .bg-yellow { background: #ffc107; color: black; } .bg-green { background: #28a745; } .bg-red { background: #dc3545; }
    </style>
</head>
<body>

    <div class="container">
        <div id="loading" style="text-align:center; margin-top:50px;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

        <div id="main-app" class="hidden">
            <div class="card" style="text-align:center;">
                <img id="u-img" class="profile-img" src="">
                <h3 id="u-name" style="margin:10px 0 5px;">User</h3>
                <p>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°: <span id="u-score" class="score-text">0</span> ‡πÅ‡∏ï‡πâ‡∏°</p>
            </div>

            <div id="checkin-container" class="card checkin-card hidden">
                <h3 style="margin-top:0;">üìÖ ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏≠‡πà‡∏≤‡∏ô Daily Quest</h3>
                <div id="checkin-form">
                    <p style="font-size:0.9em; color:#666;">‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</b></p>
                    <label class="checkin-checkbox">
                        <input type="checkbox" id="chk-checkin" onchange="toggleCheckinBtn()">
                        <span style="font-weight:bold; color:#0056b3;">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</span>
                    </label>
                    <button id="btn-checkin" onclick="submitCheckIn()" disabled style="background:#17a2b8;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏°</button>
                </div>
                <div id="checkin-done" class="hidden" style="text-align:center; padding:10px;">
                    <h2 style="margin:0; font-size:3em;">‚úÖ</h2>
                    <p style="color:#28a745; font-weight:bold;">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡∏±‡∏ö Quest ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
                </div>
            </div>

            <div id="quest-container" class="card quest-card hidden">
                <div class="quest-timer">‚è∞ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤: <span id="q-countdown">--:--</span></div>
                
                <img id="q-image-display" class="quest-image hidden" src="">
                
                <h3 style="margin:5px 0;">‚ö° ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                <p id="q-text" style="font-size:1.1em; margin-bottom:15px; line-height:1.4;">...</p>
                
                <a id="q-link-display" href="#" target="_blank" class="quest-link-btn hidden">üîó ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° / ‡∏î‡∏π‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ô‡∏ö</a>

                <div id="q-input-area">
                    <textarea id="q-answer" rows="3" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." style="color:black;"></textarea>
                    <button onclick="submitQuest()" style="background:#ffc107; color:black;">üöÄ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (‡∏£‡∏±‡∏ö <span id="q-points">0</span> ‡πÅ‡∏ï‡πâ‡∏°)</button>
                </div>
                <div id="q-status" class="hidden" style="background:rgba(255,255,255,0.2); padding:15px; border-radius:8px; margin-top:10px;">
                    ‚úÖ <b>‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß!</b><br><small>‡∏£‡∏≠ Admin ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©</small>
                </div>
            </div>

            <div class="card">
                <h4>üì§ ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô / ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô</h4>
                <input type="text" id="w-title" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠">
                <input type="url" id="w-link" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏á‡∏≤‡∏ô">
                <button onclick="submitWork()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button>
            </div>

            <h4 style="margin-left:5px; color:#666;">üìÇ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</h4>
            <div id="work-list"></div>
            <div style="height:50px;"></div>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        const USER_LIFF_ID = "XXXXXXXX-XXXXXXXX"; // ‚ö†Ô∏è ‡πÉ‡∏™‡πà LIFF ID User

        let userProfile, userId;
        let currentQuestId = null, currentQuestDeadline = null, baseScore = 0;
        let timerInterval = null;

        async function main() {
            try {
                await liff.init({ liffId: USER_LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                userProfile = await liff.getProfile();
                userId = userProfile.userId;

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('u-img').src = userProfile.pictureUrl;
                document.getElementById('u-name').innerText = userProfile.displayName;

                checkAndCreateUser();
                loadMyWorks();
                loadActiveQuest();
            } catch (err) { alert("LIFF Error: " + err.message); }
        }
        main();

        // --- User Logic ---
        function checkAndCreateUser() {
            const userRef = db.collection("users").doc(userId);
            userRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const d = doc.data();
                    document.getElementById('u-score').innerText = parseFloat((d.score||0).toFixed(2));
                    updateCheckInUI(d.lastCheckIn);
                } else {
                    userRef.set({ displayName: userProfile.displayName, pictureUrl: userProfile.pictureUrl, score: 0 });
                }
            });
        }
        function updateCheckInUI(last) {
            const form = document.getElementById('checkin-form'), done = document.getElementById('checkin-done');
            document.getElementById('checkin-container').classList.remove('hidden');
            if(last && isToday(last.toDate())) { form.classList.add('hidden'); done.classList.remove('hidden'); }
            else { form.classList.remove('hidden'); done.classList.add('hidden'); }
        }
        function isToday(d) { const n = new Date(); return d.getDate()===n.getDate() && d.getMonth()===n.getMonth() && d.getFullYear()===n.getFullYear(); }
        function toggleCheckinBtn() { document.getElementById('btn-checkin').disabled = !document.getElementById('chk-checkin').checked; }
        async function submitCheckIn() {
            const batch = db.batch();
            batch.update(db.collection("users").doc(userId), { score: firebase.firestore.FieldValue.increment(0.1), lastCheckIn: firebase.firestore.FieldValue.serverTimestamp() });
            batch.set(db.collection("checkin_logs").doc(), { userId, displayName: userProfile.displayName, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            await batch.commit(); alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß!");
        }

        // --- Quest Logic (Updated Media) ---
        function loadActiveQuest() {
            db.collection("quests").orderBy("createdAt", "desc").limit(1).onSnapshot((snapshot) => {
                if(snapshot.empty) { document.getElementById('quest-container').classList.add('hidden'); return; }
                const q = snapshot.docs[0].data();
                if (!q.deadline || new Date() > q.deadline.toDate()) { document.getElementById('quest-container').classList.add('hidden'); return; }

                currentQuestId = snapshot.docs[0].id;
                currentQuestDeadline = q.deadline.toDate();
                baseScore = q.baseScore || 0;

                // Render Text
                document.getElementById('quest-container').classList.remove('hidden');
                document.getElementById('q-text').innerText = q.question;
                document.getElementById('q-points').innerText = baseScore;

                // Render Image
                const imgEl = document.getElementById('q-image-display');
                if (q.imageUrl && q.imageUrl.trim() !== "") {
                    imgEl.src = q.imageUrl;
                    imgEl.classList.remove('hidden');
                } else {
                    imgEl.classList.add('hidden');
                }

                // Render Link
                const linkEl = document.getElementById('q-link-display');
                if (q.questLink && q.questLink.trim() !== "") {
                    linkEl.href = q.questLink;
                    linkEl.classList.remove('hidden');
                } else {
                    linkEl.classList.add('hidden');
                }

                if(timerInterval) clearInterval(timerInterval);
                startTimer();
                checkIfAnswered();
            });
        }
        function checkIfAnswered() {
            db.collection("quest_submissions").where("questId", "==", currentQuestId).where("userId", "==", userId).limit(1).onSnapshot((snap) => {
                if (!snap.empty) { document.getElementById('q-input-area').classList.add('hidden'); document.getElementById('q-status').classList.remove('hidden'); }
                else { document.getElementById('q-input-area').classList.remove('hidden'); document.getElementById('q-status').classList.add('hidden'); }
            });
        }
        function startTimer() {
            timerInterval = setInterval(() => {
                const diff = currentQuestDeadline - new Date();
                if (diff <= 0) { document.getElementById('quest-container').classList.add('hidden'); clearInterval(timerInterval); return; }
                const h=Math.floor((diff/(1000*3600))%24), m=Math.floor((diff/(1000*60))%60);
                document.getElementById('q-countdown').innerText = `${h}:${m.toString().padStart(2,'0')}`;
            }, 1000);
        }
        async function submitQuest() {
            const ans = document.getElementById('q-answer').value.trim();
            if (!ans) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö");
            const earned = (new Date() > currentQuestDeadline) ? 0 : baseScore;
            const batch = db.batch();
            batch.set(db.collection("quest_submissions").doc(), { questId: currentQuestId, userId, displayName: userProfile.displayName, answer: ans, timestamp: firebase.firestore.FieldValue.serverTimestamp(), isLate: earned===0, earnedScore: earned, bonusGiven: 0 });
            if (earned > 0) batch.update(db.collection("users").doc(userId), { score: firebase.firestore.FieldValue.increment(earned) });
            await batch.commit(); alert(`‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß! ${earned>0?'+'+earned:''}`);
        }

        // --- Works ---
        async function submitWork() {
            const t=document.getElementById('w-title').value.trim(), l=document.getElementById('w-link').value.trim();
            if(!t||!l) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
            await db.collection("works").add({ userId, displayName: userProfile.displayName, pictureUrl: userProfile.pictureUrl, title: t, link: l, status: "‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à", feedback: "", timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            alert("‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!"); document.getElementById('w-title').value=""; document.getElementById('w-link').value="";
        }
        function loadMyWorks() {
            db.collection("works").where("userId", "==", userId).orderBy("timestamp", "desc").onSnapshot((snap) => {
                const list = document.getElementById('work-list'); list.innerHTML = "";
                if (snap.empty) { list.innerHTML = "<p style='text-align:center; color:#999;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>"; return; }
                snap.forEach(doc => {
                    const w = doc.data();
                    let fb = w.feedback ? `<div class="feedback-box"><b>üí¨ Admin:</b> ${w.feedback}</div>` : "";
                    let badge = w.status==="‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß"?"bg-green":w.status==="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"?"bg-red":"bg-yellow";
                    list.innerHTML += `<div class="card" style="padding:15px; border-left:5px solid ${w.status==='‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß'?'#28a745':'#ffc107'}"><div style="display:flex; justify-content:space-between;"><div><h4 style="margin:0;">${w.title}</h4><span class="badge ${badge}">${w.status}</span></div><a href="${w.link}" target="_blank" style="font-size:1.5em; text-decoration:none;">üîó</a></div>${fb}</div>`;
                });
            });
        }
    </script>
</body>
</html>
